<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ìë∏Î•∏ÎÇòÎùºÌïôÍµê - Ïã†Ïïô RPG</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ìë∏Î•∏ÎÇòÎùºÌïôÍµê">
    
    <!-- Firebase CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
// --- Firebase Configuration ---
const firebaseConfig = {
    // Ïã§Ï†ú ÏÇ¨Ïö©ÏùÑ ÏúÑÌï¥ÏÑúÎäî Ïó¨Í∏∞Ïóê Ïã§Ï†ú Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ïÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî
    // Îç∞Î™®Ïö© ÏÑ§Ï†ï (Ïã§Ï†úÎ°úÎäî ÏûëÎèôÌïòÏßÄ ÏïäÏùå)
    apiKey: "demo-api-key",
    authDomain: "bluewind-school-demo.firebaseapp.com",
    databaseURL: "https://bluewind-school-demo-default-rtdb.firebaseio.com",
    projectId: "bluewind-school-demo",
    storageBucket: "bluewind-school-demo.appspot.com",
    messagingSenderId: "123456789",
    appId: "demo-app-id"
};

// Firebase Ï¥àÍ∏∞Ìôî
let database = null;
let isFirebaseEnabled = false;

function initFirebase() {
    try {
        // Ïã§Ï†ú Firebase ÏÑ§Ï†ïÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        if (firebaseConfig.apiKey !== "demo-api-key") {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isFirebaseEnabled = true;
            console.log("Firebase Ïó∞Í≤∞ ÏÑ±Í≥µ!");
            
            // Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupFirebaseListeners();
            showNotification("üî• Ïã§ÏãúÍ∞Ñ Í≥µÏú† Í∏∞Îä•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§!");
            updateFirebaseStatus();
        } else {
            console.log("Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î°úÏª¨ Î™®ÎìúÎ°ú Ïã§ÌñâÎê©ÎãàÎã§.");
            showNotification("üì± Î°úÏª¨ Î™®ÎìúÎ°ú Ïã§ÌñâÎê©ÎãàÎã§. Firebase ÏÑ§Ï†ï Ïãú Ïã§ÏãúÍ∞Ñ Í≥µÏú†Í∞Ä Í∞ÄÎä•Ìï©ÎãàÎã§.");
            updateFirebaseStatus();
        }
    } catch (error) {
        console.error("Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", error);
        isFirebaseEnabled = false;
        showNotification("‚ö†Ô∏è Ïã§ÏãúÍ∞Ñ Í≥µÏú† Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Î°úÏª¨ Î™®ÎìúÎ°ú Ïã§ÌñâÎê©ÎãàÎã§.");
        updateFirebaseStatus();
    }
}

function setupFirebaseListeners() {
    if (!isFirebaseEnabled) return;

    // Í≥µÏßÄÏÇ¨Ìï≠ Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà
    database.ref('notices').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            notices = Object.values(data);
            updateNotices();
        }
    });

    // Ï±ÑÌåÖ Î©îÏãúÏßÄ Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà
    database.ref('chatMessages').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            chatMessages = Object.values(data);
            if (document.getElementById('guildMessages')) {
                updateChatMessages('guild');
            }
        }
    });

    // QT ÎÖ∏Ìä∏ Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà
    database.ref('qtNotes').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            qtNotes = Object.values(data);
            updateQTNotes();
        }
    });
}

function updateFirebaseStatus() {
    const statusElement = document.getElementById('firebaseStatus');
    const statusTextElement = document.getElementById('firebaseStatusText');
    
    if (isFirebaseEnabled) {
        if (statusElement) statusElement.textContent = 'üî• Ïó∞Í≤∞Îê®:';
        if (statusTextElement) statusTextElement.textContent = 'Ïã§ÏãúÍ∞Ñ Í≥µÏú† Í∏∞Îä•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Í≥µÏßÄÏÇ¨Ìï≠, Ï±ÑÌåÖ, QTÎÖ∏Ìä∏Í∞Ä Î™®Îì† ÏÇ¨Ïö©ÏûêÏôÄ Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§!';
    } else {
        if (statusElement) statusElement.textContent = 'üîß ÏÑ§Ï†ï ÌïÑÏöî:';
        if (statusTextElement) statusTextElement.textContent = 'Firebase ÏÑ§Ï†ïÏùÑ ÏôÑÎ£åÌïòÎ©¥ Í≥µÏßÄÏÇ¨Ìï≠, Ï±ÑÌåÖ, QTÎÖ∏Ìä∏Î•º Îã§Î•∏ ÏÇ¨Ïö©ÏûêÏôÄ Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í≥µÏú†Ìï† Ïàò ÏûàÏäµÎãàÎã§.';
    }
}

    
    <style>
        /* Pretendard Ìè∞Ìä∏ ÏûÑÌè¨Ìä∏ */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --app-bg: white;
            --text-color: #333;
            --header-gradient-start: #4facfe;
            --header-gradient-end: #00f2fe;
            --header-text-color: white;
            --nav-bg: #f8f9fa;
            --nav-border: #dee2e6;
            --nav-item-color: #495057;
            --nav-item-active-bg: #4facfe;
            --nav-item-active-color: white;
            --nav-item-hover-bg: #e9ecef;
            --nav-item-active-hover-bg: #3d8bfe;
            --notice-bg-start: #fff3cd;
            --notice-bg-end: #ffeeba;
            --notice-border: #ffc107;
            --notice-text: #856404;
            --mission-card-bg: #f8f9fa;
            --mission-card-border: #dee2e6;
            --mission-button-bg: #4facfe;
            --mission-button-hover-bg: #3d8bfe;
            --mission-button-disabled-bg: #28a745;
            --prayer-card-bg-start: #ffecd2;
            --prayer-card-bg-end: #fcb69f;
            --prayer-card-title: #8b4513;
            --prayer-slot-bg: rgba(255,255,255,0.7);
            --prayer-slot-hover-border: #8b4513;
            --prayer-slot-completed-bg: #d4edda;
            --prayer-slot-completed-border: #28a745;
            --scripture-card-bg-start: #e3f2fd;
            --scripture-card-bg-end: #bbdefb;
            --scripture-card-border: #2196f3;
            --scripture-text: #1565c0;
            --scripture-reference: #0d47a1;
            --chat-container-bg: #f8f9fa;
            --chat-messages-bg: white;
            --chat-input-border: #dee2e6;
            --chat-input-focus-border: #4facfe;
            --chat-send-btn-bg: #4facfe;
            --chat-send-btn-hover-bg: #3d8bfe;
            --image-upload-btn-bg: #17a2b8;
            --image-upload-btn-hover-bg: #138496;
            --message-user-bubble-bg: #4facfe;
            --message-user-bubble-color: white;
            --message-other-bubble-bg: #f1f3f4;
            --message-other-bubble-color: #333;
            --message-user-avatar-bg: #3d8bfe;
            --message-other-avatar-bg: #6c757d;
            --qt-note-card-bg: white;
            --qt-note-card-border: #dee2e6;
            --qt-note-title: #4facfe;
            --qt-note-date: #666;
            --qt-note-content: #333;
            --like-button-color: #e91e63;
            --like-button-hover-color: #c2185b;
            --note-btn-bg: #6c757d;
            --note-btn-edit-bg: #ffc107;
            --note-btn-delete-bg: #dc3545;
            --modal-bg: rgba(0,0,0,0.5);
            --modal-content-bg: white;
            --modal-title-color: #4facfe;
            --modal-input-border: #dee2e6;
            --modal-input-focus-border: #4facfe;
            --modal-button-primary-bg: #4facfe;
            --modal-button-primary-hover-bg: #3d8bfe;
            --modal-button-secondary-bg: #6c757d;
            --modal-button-secondary-hover-bg: #5a6268;
            --lesson-container-bg: white;
            --lesson-header-border: #e9ecef;
            --lesson-title-color: #4facfe;
            --lesson-content-color: #333;
            --lesson-content-h4-color: #4facfe;
            --lesson-content-strong-color: #2c5aa0;
            --stage-card-bg-start: #89f7fe;
            --stage-card-bg-end: #66a6ff;
            --stage-completed-bg: #e8f5e9;
            --stage-completed-color: #2e7d32;
            --stage-completed-border: #a5d6a7;
            --discussion-bg: #f1f8e9;
            --discussion-border-left: #8bc34a;
            --discussion-h4-color: #33691e;
            --discussion-ol-color: #555;
            --badge-bg: #ffd700;
            --badge-color: #333;
            --minigame-canvas-bg: #e0f7fa;
            --quiz-option-border: #4facfe;
            --quiz-option-bg: white;
            --quiz-option-color: #4facfe;
            --quiz-option-hover-bg: #e3f2fd;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-gradient-start: #2c3e50;
            --bg-gradient-end: #34495e;
            --app-bg: #3b4d61;
            --text-color: #ecf0f1;
            --header-gradient-start: #1a2a3a;
            --header-gradient-end: #2a3a4a;
            --header-text-color: #ecf0f1;
            --nav-bg: #2c3e50;
            --nav-border: #44586b;
            --nav-item-color: #bdc3c7;
            --nav-item-active-bg: #1abc9c;
            --nav-item-active-color: white;
            --nav-item-hover-bg: #34495e;
            --nav-item-active-hover-bg: #16a085;
            --notice-bg-start: #4a4a3a;
            --notice-bg-end: #5a5a4a;
            --notice-border: #8b8b7a;
            --notice-text: #e0e0d1;
            --mission-card-bg: #44586b;
            --mission-card-border: #5a6e80;
            --mission-button-bg: #1abc9c;
            --mission-button-hover-bg: #16a085;
            --mission-button-disabled-bg: #27ae60;
            --prayer-card-bg-start: #5a4a3a;
            --prayer-card-bg-end: #6a5a4a;
            --prayer-card-title: #e0d1b1;
            --prayer-slot-bg: rgba(255,255,255,0.1);
            --prayer-slot-hover-border: #e0d1b1;
            --prayer-slot-completed-bg: #27ae60;
            --prayer-slot-completed-border: #2ecc71;
            --scripture-card-bg-start: #3a4a5a;
            --scripture-card-bg-end: #4a5a6a;
            --scripture-card-border: #3498db;
            --scripture-text: #aed6f1;
            --scripture-reference: #85c1e9;
            --chat-container-bg: #44586b;
            --chat-messages-bg: #3b4d61;
            --chat-input-border: #5a6e80;
            --chat-input-focus-border: #1abc9c;
            --chat-send-btn-bg: #1abc9c;
            --chat-send-btn-hover-bg: #16a085;
            --image-upload-btn-bg: #2980b9;
            --image-upload-btn-hover-bg: #2c3e50;
            --message-user-bubble-bg: #1abc9c;
            --message-user-bubble-color: white;
            --message-other-bubble-bg: #5a6e80;
            --message-other-bubble-color: #ecf0f1;
            --message-user-avatar-bg: #16a085;
            --message-other-avatar-bg: #7f8c8d;
            --qt-note-card-bg: #44586b;
            --qt-note-card-border: #5a6e80;
            --qt-note-title: #1abc9c;
            --qt-note-date: #bdc3c7;
            --qt-note-content: #ecf0f1;
            --like-button-color: #e74c3c;
            --like-button-hover-color: #c0392b;
            --note-btn-bg: #7f8c8d;
            --note-btn-edit-bg: #f39c12;
            --note-btn-delete-bg: #e74c3c;
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #3b4d61;
            --modal-title-color: #1abc9c;
            --modal-input-border: #5a6e80;
            --modal-input-focus-border: #1abc9c;
            --modal-button-primary-bg: #1abc9c;
            --modal-button-primary-hover-bg: #16a085;
            --modal-button-secondary-bg: #7f8c8d;
            --modal-button-secondary-hover-bg: #6c757d;
            --lesson-container-bg: #44586b;
            --lesson-header-border: #5a6e80;
            --lesson-title-color: #1abc9c;
            --lesson-content-color: #ecf0f1;
            --lesson-content-h4-color: #1abc9c;
            --lesson-content-strong-color: #3498db;
            --stage-card-bg-start: #1abc9c;
            --stage-card-bg-end: #3498db;
            --stage-completed-bg: #27ae60;
            --stage-completed-color: #d4edda;
            --stage-completed-border: #2ecc71;
            --discussion-bg: #2ecc71;
            --discussion-border-left: #27ae60;
            --discussion-h4-color: #1a532d;
            --discussion-ol-color: #ecf0f1;
            --badge-bg: #f1c40f;
            --badge-color: #333;
            --minigame-canvas-bg: #3a4a5a;
            --quiz-option-border: #1abc9c;
            --quiz-option-bg: #44586b;
            --quiz-option-color: #ecf0f1;
            --quiz-option-hover-bg: #5a6e80;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.5s ease, color 0.5s ease;
        }

        .app-container {
            max-width: 414px;
            margin: 0 auto;
            background: var(--app-bg);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: var(--header-text-color);
            padding: 20px;
            text-align: center;
            position: relative;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .character-avatar {
            width: 80px;
            height: 80px;
            background: var(--app-bg);
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.3s ease, background 0.5s ease;
        }

        .character-avatar:hover {
            transform: scale(1.05);
        }

        .user-name {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .user-name:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 14px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            font-size: 18px;
        }

        .navigation {
            display: flex;
            background: var(--nav-bg);
            border-top: 1px solid var(--nav-border);
            flex-shrink: 0;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .nav-item {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: var(--nav-item-color);
            transition: all 0.3s ease;
        }

        .nav-item.active {
            background: var(--nav-item-active-bg);
            color: var(--nav-item-active-color);
        }

        .nav-item:hover {
            background: var(--nav-item-hover-bg);
        }

        .nav-item.active:hover {
            background: var(--nav-item-active-hover-bg);
        }

        .content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .notice-card {
            background: linear-gradient(135deg, var(--notice-bg-start) 0%, var(--notice-bg-end) 100%);
            border: 1px solid var(--notice-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notice-title {
            font-weight: bold;
            color: var(--notice-text);
        }

        .notice-date {
            font-size: 12px;
            color: var(--notice-text);
            opacity: 0.8;
        }

        .notice-content {
            color: var(--notice-text);
            line-height: 1.5;
        }

        .mission-card {
            background: var(--mission-card-bg);
            border: 1px solid var(--mission-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.5s ease, border-color 0.5s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mission-title {
            font-weight: bold;
            color: var(--text-color);
        }

        .mission-reward {
            background: #ffd700;
            color: #333;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .mission-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .mission-button {
            background: var(--mission-button-bg);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .mission-button:hover {
            background: var(--mission-button-hover-bg);
            transform: scale(1.05);
        }

        .mission-button:disabled {
            background: var(--mission-button-disabled-bg);
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none;
        }

        .floating-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 25px;
            font-weight: bold;
            animation: slideInDown 0.3s ease;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .prayer-time-card {
            background: linear-gradient(135deg, var(--prayer-card-bg-start) 0%, var(--prayer-card-bg-end) 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            transition: background 0.5s ease;
        }

        .prayer-time-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--prayer-card-title);
            margin-bottom: 15px;
        }

        .prayer-time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .prayer-time-slot {
            background: var(--prayer-slot-bg);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease, background 0.5s ease;
        }

        .prayer-time-slot:hover {
            border-color: var(--prayer-slot-hover-border);
            transform: scale(1.05);
        }

        .prayer-time-slot.completed {
            background: var(--prayer-slot-completed-bg);
            border-color: var(--prayer-slot-completed-border);
        }

        .scripture-card {
            background: linear-gradient(135deg, var(--scripture-card-bg-start) 0%, var(--scripture-card-bg-end) 100%);
            border: 1px solid var(--scripture-card-border);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scripture-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--scripture-text);
            margin-bottom: 10px;
            font-style: italic;
        }

        .scripture-reference {
            font-weight: bold;
            color: var(--scripture-reference);
            font-size: 14px;
        }

        .chat-container {
            background: var(--chat-container-bg);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            height: 350px;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--chat-messages-bg);
            border-radius: 10px;
            transition: background 0.5s ease;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.other {
            align-items: flex-start;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            display: inline-block;
        }
        
        .message.user .message-bubble {
            background: var(--message-user-bubble-bg);
            color: var(--message-user-bubble-color);
        }

        .message.other .message-bubble {
            background: var(--message-other-bubble-bg);
            color: var(--message-other-bubble-color);
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
            padding: 0 5px;
        }

        .message-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            margin-right: 8px;
        }
        
        .message.user .message-avatar { background: var(--message-user-avatar-bg); }
        .message.other .message-avatar { background: var(--message-other-avatar-bg); }

        .message-sender {
            font-weight: bold;
            color: var(--text-color);
        }

        .message-time {
            margin-left: 8px;
            opacity: 0.7;
            font-size: 10px;
            color: var(--text-color);
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center; /* Align items vertically in the center */
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--chat-input-border);
            border-radius: 20px;
            font-size: 14px;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--chat-messages-bg); /* Use chat messages bg for input */
            color: var(--text-color);
        }

        .chat-input:focus {
            border-color: var(--chat-input-focus-border);
            outline: none;
        }

        .chat-send-btn {
            background: var(--chat-send-btn-bg);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .chat-send-btn:hover {
            background: var(--chat-send-btn-hover-bg);
        }

        .image-upload-btn {
            background: var(--image-upload-btn-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .image-upload-btn:hover {
            background: var(--image-upload-btn-hover-bg);
        }

        .hidden-file-input {
            display: none;
        }

        .qt-note-card {
            background: var(--qt-note-card-bg);
            border: 1px solid var(--qt-note-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .qt-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--nav-border);
        }

        .qt-note-title {
            font-weight: bold;
            color: var(--qt-note-title);
        }

        .qt-note-date {
            font-size: 12px;
            color: var(--qt-note-date);
        }

        .qt-note-content {
            margin-bottom: 10px;
            line-height: 1.6;
            color: var(--qt-note-content);
        }

        .qt-note-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .like-button {
            background: none;
            border: none;
            color: var(--like-button-color);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-button:hover {
            color: var(--like-button-hover-color);
        }

        .note-buttons {
            display: flex;
            gap: 5px;
        }

        .note-btn {
            background: var(--note-btn-bg);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .note-btn.edit { background: var(--note-btn-edit-bg); }
        .note-btn.delete { background: var(--note-btn-delete-bg); }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--modal-content-bg);
            padding: 30px;
            border-radius: 15px;
            max-width: 380px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
            transition: background 0.5s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--modal-title-color);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--app-bg);
            color: var(--text-color);
        }

        .modal-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--app-bg);
            color: var(--text-color);
        }

        .modal-input:focus, .modal-textarea:focus {
            border-color: var(--modal-input-focus-border);
            outline: none;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-button.primary {
            background: var(--modal-button-primary-bg);
            color: white;
        }

        .modal-button.primary:hover {
            background: var(--modal-button-primary-hover-bg);
        }

        .modal-button.secondary {
            background: var(--modal-button-secondary-bg);
            color: white;
        }

        .modal-button.secondary:hover {
            background: var(--modal-button-secondary-hover-bg);
        }

        .lesson-container {
            background: var(--lesson-container-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            animation: slideInUp 0.4s ease;
            transition: background 0.5s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--lesson-header-border);
        }

        .lesson-icon {
            font-size: 30px;
            margin-right: 15px;
        }

        .lesson-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--lesson-title-color);
        }

        .lesson-content {
            line-height: 1.7;
            color: var(--lesson-content-color);
            font-size: 15px;
        }

        .lesson-content h4 {
            color: var(--lesson-content-h4-color);
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .lesson-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .lesson-content li {
            margin-bottom: 8px;
        }

        .lesson-content p {
            margin-bottom: 12px;
        }

        .lesson-content strong {
            color: var(--lesson-content-strong-color);
        }
        
        .stage-card {
            background: linear-gradient(135deg, var(--stage-card-bg-start) 0%, var(--stage-card-bg-end) 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stage-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .avatar-option {
            font-size: 30px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        .avatar-option:hover {
            background: var(--nav-item-hover-bg);
        }
        
        .discussion-container {
            background: var(--discussion-bg);
            border-left: 5px solid var(--discussion-border-left);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }
        .discussion-container h4 {
            color: var(--discussion-h4-color);
            margin-bottom: 15px;
        }
        .discussion-container ol {
            padding-left: 20px;
            line-height: 1.8;
            color: var(--discussion-ol-color);
        }
        
        #badge-container span {
            display: inline-block;
            background: var(--badge-bg);
            color: var(--badge-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin: 3px;
        }

        #minigame-canvas {
            border-radius: 10px;
            background: var(--minigame-canvas-bg);
            cursor: pointer;
        }

        #minigame-content .quiz-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid var(--quiz-option-border);
            background: var(--quiz-option-bg);
            color: var(--quiz-option-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #minigame-content .quiz-option:hover {
            background: var(--quiz-option-hover-bg);
        }
        
        .stage-completed-notice {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            background: var(--stage-completed-bg);
            color: var(--stage-completed-color);
            font-weight: bold;
            border-radius: 10px;
            border: 2px dashed var(--stage-completed-border);
            transition: background 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        /* Theme Toggle Button */
        .theme-toggle-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--nav-border);
            text-align: center;
        }
        .theme-toggle-button {
            background: var(--modal-button-secondary-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .theme-toggle-button:hover {
            background: var(--modal-button-secondary-hover-bg);
        }

        /* QT Comments */
        .comments-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--nav-border);
            text-align: left;
        }
        .comments-section h5 {
            color: var(--text-color);
            margin-bottom: 10px;
        }
        .comment-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .comment-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }
        .comment-password-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }
        .comment-send-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            align-self: flex-end;
        }
        .comment-send-btn:hover {
            background: #138496;
        }
        .comment-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--nav-border);
            border-radius: 8px;
            padding: 10px;
            background: var(--chat-messages-bg);
        }
        .comment-item {
            background: var(--mission-card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid var(--mission-card-border);
        }
        .comment-item:last-child {
            margin-bottom: 0;
        }
        .comment-header {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--text-color);
        }
        .comment-author {
            font-weight: bold;
            margin-right: 5px;
        }
        .comment-time {
            opacity: 0.7;
        }
        .comment-content {
            font-size: 14px;
            color: var(--text-color);
            word-wrap: break-word;
        }
        .comment-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            align-self: flex-end;
        }
        .comment-action-btn {
            background: var(--note-btn-bg);
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
        }
        .comment-action-btn.edit { background: var(--note-btn-edit-bg); }
        .comment-action-btn.delete { background: var(--note-btn-delete-bg); }

        /* Icebreaker Modal Specific Styles */
        /* These styles will now apply to the inline icebreaker content */
        .icebreaker-section {
            background: var(--prayer-card-bg-start);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--prayer-card-title);
        }
        .icebreaker-section .modal-title { /* Reusing modal-title style */
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--prayer-card-title);
        }
        .icebreaker-section .icebreaker-prompt {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: var(--prayer-card-title);
        }
        .icebreaker-section .icebreaker-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            background: var(--app-bg);
            color: var(--text-color);
        }
        .icebreaker-section .modal-button.primary {
            background: var(--modal-button-primary-bg);
            color: white;
            width: auto;
            padding: 10px 20px;
        }

        /* Quiz Section Styles (inline) */
        .quiz-section {
            background: var(--scripture-card-bg-start);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--scripture-card-border);
        }
        .quiz-section .modal-title { /* Reusing modal-title style */
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--scripture-text);
        }
        .quiz-section p {
            color: var(--scripture-text);
            margin-bottom: 20px;
            font-weight: bold;
        }
        .quiz-section .quiz-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid var(--quiz-option-border);
            background: var(--quiz-option-bg);
            color: var(--quiz-option-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quiz-section .quiz-option:hover {
            background: var(--quiz-option-hover-bg);
        }

        /* Minigame Selection Styles */
        .minigame-selection-card {
            background: var(--mission-card-bg);
            border: 1px solid var(--mission-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        .minigame-selection-card h4 {
            color: var(--text-color);
            margin-bottom: 15px;
        }
        .minigame-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .minigame-button {
            background: var(--mission-button-bg);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        .minigame-button:hover {
            background: var(--mission-button-hover-bg);
        }
        .minigame-button:disabled {
            background: var(--mission-button-disabled-bg);
            cursor: not-allowed;
        }
        .minigame-content-area {
            background: var(--chat-messages-bg);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--text-color);
        }
        .minigame-content-area input {
            width: 80%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            background: var(--app-bg);
            color: var(--text-color);
        }
        .minigame-content-area button {
            margin-top: 10px;
            padding: 8px 15px;
            background: var(--chat-send-btn-bg);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .minigame-content-area button:hover {
            background: var(--chat-send-btn-hover-bg);
        }
    </style>
</head>
<body class="light-mode">
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="character-avatar" id="headerAvatar" onclick="showAvatarModal()">üåü</div>
            <div class="user-name" onclick="showNameModal()">
                <span id="userName">Ìë∏Î•∏Ïù¥</span>
                <span>‚úèÔ∏è</span>
            </div>
            <div class="user-stats">
                <div class="stat">
                    <div class="stat-value" id="userLevel">1</div>
                    <div>Î†àÎ≤®</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userExp">0</div>
                    <div>Í≤ΩÌóòÏπò</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userStreak">1</div>
                    <div>Ïó∞ÏÜçÏùº</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content">
                <!-- Notice Board -->
                <div id="notice-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--text-color);">üì¢ Í≥µÏßÄÏÇ¨Ìï≠</h3>
                        <button style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showNoticeModal()">+ Í≥µÏßÄ ÏûëÏÑ±</button>
                    </div>
                    <div id="notices-container">
                        <!-- Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: var(--text-color);">üìã Ïò§ÎäòÏùò ÎØ∏ÏÖò</h3>
                
                <div class="prayer-time-card">
                    <div class="prayer-time-title">‚è∞ 10-10-10 Í∏∞ÎèÑÎ≤ï</div>
                    <div class="prayer-time-grid">
                        <div class="prayer-time-slot" data-slot="morning" onclick="togglePrayerTime('morning', this)">
                            <div>üåÖ ÏïÑÏπ®</div>
                            <div style="font-size: 12px;">10Î∂Ñ</div>
                        </div>
                        <div class="prayer-time-slot" data-slot="noon" onclick="togglePrayerTime('noon', this)">
                            <div>‚òÄÔ∏è Ï†êÏã¨</div>
                            <div style="font-size: 12px;">10Î∂Ñ</div>
                        </div>
                        <div class="prayer-time-slot" data-slot="evening" onclick="togglePrayerTime('evening', this)">
                            <div>üåô Ï†ÄÎÖÅ</div>
                            <div style="font-size: 12px;">10Î∂Ñ</div>
                        </div>
                    </div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">üìñ ÏÑ±Í≤Ω ÎßêÏîÄ ÏùΩÍ∏∞</div>
                        <div class="mission-reward">+70 EXP</div>
                    </div>
                    <div class="mission-description">Ìë∏Î•∏Î∞îÎûåÏùò ÎÉâÏû•Í≥†ÏóêÏÑú Ïò§ÎäòÏùò ÏòÅÏñëÎ∂ÑÏùÑ ÏÑ≠Ï∑®ÌïòÏÑ∏Ïöî</div>
                    <button class="mission-button" id="mission-btn-scripture" onclick="showScripture()">ÎßêÏîÄ Î≥¥Í∏∞</button>
                    <div id="scripture-container"></div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">üéØ ÏòàÎ∞∞ Ï∞∏Ïó¨ÌïòÍ∏∞</div>
                        <div class="mission-reward">+100 EXP</div>
                    </div>
                    <div class="mission-description">ÌïòÎÇòÎãòÏùÑ ÎßåÎÇòÎäî Í≥µÏãù Ï±ÑÎÑêÏóêÏÑú ÏñëÎ∞©Ìñ• ÏÜåÌÜµÌïòÏÑ∏Ïöî</div>
                    <button class="mission-button" id="mission-btn-worship" onclick="completeMission(this, 'ÏòàÎ∞∞ Ï∞∏Ïó¨ ÏôÑÎ£å! Ïö©ÌäπÏÉà Î©îÏãúÏßÄÎ•º Î∞õÏïòÏäµÎãàÎã§! üôè', 100, 'ÏòàÎ∞∞ Ï∞∏ÏÑù')">Ï∞∏Ïó¨ ÏôÑÎ£å</button>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">üß† Ïã†Ïïô ÌÄ¥Ï¶à ÌíÄÍ∏∞</div>
                        <div class="mission-reward">+50 EXP</div>
                    </div>
                    <div class="mission-description">Ïã†Ïïô ÏßÄÏãùÏùÑ ÌÖåÏä§Ìä∏ÌïòÍ≥† Í≤ΩÌóòÏπòÎ•º ÏñªÏúºÏÑ∏Ïöî!</div>
                    <button class="mission-button" id="mission-btn-quiz" onclick="startQuiz()">ÌÄ¥Ï¶à ÏãúÏûë</button>
                </div>

                <!-- Mini-game Mission Card -->
                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">üéÆ ÎØ∏ÎãàÍ≤åÏûÑ ÌïòÍ∏∞</div>
                        <div class="mission-reward">+30 EXP</div>
                    </div>
                    <div class="mission-description">Îã§ÏñëÌïú ÎØ∏ÎãàÍ≤åÏûÑÏùÑ Ï¶êÍ∏∞Í≥† Í≤ΩÌóòÏπòÎ•º ÏñªÏúºÏÑ∏Ïöî!</div>
                    <button class="mission-button" id="mission-btn-minigame" onclick="showMinigameSelection()">ÎØ∏ÎãàÍ≤åÏûÑ ÏãúÏûë</button>
                    <div id="minigame-selection-container"></div>
                </div>
            </div>

            <!-- Stages Tab -->
            <div id="stages-tab" class="tab-content hidden">
                <div id="stage-list">
                    <h3 style="margin-bottom: 20px; color: var(--text-color);">üéØ ÌïôÏäµ Ïä§ÌÖåÏù¥ÏßÄ</h3>
                    <p style="text-align: center; color: var(--text-color); margin-bottom: 20px;">
                        ÍµêÏû¨ ÎÇ¥Ïö© Í∏∞Î∞ò ÌïôÏäµ Îã®Í≥ÑÏûÖÎãàÎã§
                    </p>
                    
                    <div class="stage-card" onclick="enterStageContent(1)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">1. Ìå®Ïπò ÏãúÏä§ÌÖú</div>
                        <div style="font-size: 14px; opacity: 0.9;">Í±∞Î∂ÄÌï† Ïàò ÏóÜÎäî ÌäπÍ∂å</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">ÏòàÎ∞∞ÌïòÍ∏∞ ‚Ä¢ ÏÑ±Í≤ΩÏùΩÍ∏∞ ‚Ä¢ Í∏∞ÎèÑÌïòÍ∏∞</div>
                    </div>

                    <div class="stage-card" onclick="enterStageContent(2)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">2. Í∏∏Îìú ÏãúÏä§ÌÖú</div>
                        <div style="font-size: 14px; opacity: 0.9;">Ïö∞Î¶¨, Í∞ôÏù¥ Ìï¥Î≥ºÍπåÏöî</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">ÏÑ∏Î°ÄÎ∞õÍ∏∞ ‚Ä¢ Í≥µÎèôÏ≤¥ ÏÜçÌïòÍ∏∞ ‚Ä¢ ÏÑ±Î†π Îî∞Î•¥Í∏∞</div>
                    </div>

                    <div class="stage-card" onclick="enterStageContent(3)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">3. Ïã§Ï†Ñ ÏãúÏä§ÌÖú</div>
                        <div style="font-size: 14px; opacity: 0.9;">Ïù∏ÏÉùÏùÄ Ïû•ÎÇúÏù¥ ÏïÑÎãàÎãàÍπå</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Ïù¥Î°†ÏóêÏÑú ÌòÑÏã§Î°ú ‚Ä¢ Îß§Ïùº Í∑∏Î∂ÑÍ≥º ‚Ä¢ ÏùºÏÉùÏùÑ Ìï®Íªò</div>
                    </div>
                </div>
                    
                <div id="stage-detail" class="hidden">
                    <div id="stage-content"></div>
                    <button style="background: var(--modal-button-secondary-bg); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; width: 100%;" onclick="backToStages()">‚Üê Ïä§ÌÖåÏù¥ÏßÄ Î™©Î°ùÏúºÎ°ú</button>
                </div>

                <!-- New Icebreaker Records Section -->
                <div id="icebreaker-records-section" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-color);">üìù ÎÇòÏùò ÏïÑÏù¥Ïä§Î∏åÎ†àÏù¥ÌÅ¨ Í∏∞Î°ù</h3>
                    <div id="icebreaker-records-container">
                        <!-- Icebreaker records will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Guild Tab -->
            <div id="guild-tab" class="tab-content hidden">
                <div style="background: linear-gradient(135deg, var(--scripture-card-bg-start) 0%, var(--scripture-card-bg-end) 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; position: relative;">
                    <h3 style="color: var(--text-color);">üë• Ìë∏Î•∏Î∞îÎûåÎã®</h3>
                    <strong style="color: var(--text-color);">Í∏∏Îìú Î†àÎ≤®: <span id="guildLevel">1</span></strong><br>
                    <small style="color: var(--text-color);">Îã§Ïùå Î†àÎ≤®ÍπåÏßÄ <span id="guildExp">0</span>/500 EXP</small>
                </div>

                <!-- QT Note Section -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: var(--text-color);">üìî QT ÎÖ∏Ìä∏</h4>
                        <button style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showQTNoteModal()">+ QT ÎÖ∏Ìä∏ ÏûëÏÑ±</button>
                    </div>
                    <div id="qt-notes-container">
                        <!-- QT ÎÖ∏Ìä∏Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>

                <h4 style="margin-bottom: 15px; color: var(--text-color);">üü¢ ÌòÑÏû¨ Ï†ëÏÜç Ï§ëÏù∏ Í∏∏ÎìúÏõê</h4>
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--chat-messages-bg); border-radius: 10px;">
                        <div id="guildUserAvatar" style="width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--modal-button-primary-bg); background: var(--modal-button-primary-bg); color: white;">üåü</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 2px; color: var(--text-color);"><span id="guildUserName">Ìë∏Î•∏Ïù¥</span> (ÎÇò)</div>
                            <div style="font-size: 12px; color: var(--text-color);">Î†àÎ≤® <span id="guildUserLevel">1</span> <span id="guildUserJob">Ìë∏Î•∏Ïù¥</span> ‚Ä¢ <span id="guildUserStreak">1</span>Ïùº Ïó∞ÏÜç Ï†ëÏÜç</div>
                        </div>
                    </div>
                    <div style="text-align: center; color: var(--text-color); padding: 20px;">
                        <p>Îã§Î•∏ Í∏∏ÎìúÏõêÎì§Ïù¥ Ï†ëÏÜçÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§</p>
                        <p>ÏπúÍµ¨Îì§ÏùÑ Ï¥àÎåÄÌï¥Î≥¥ÏÑ∏Ïöî! üéâ</p>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <!-- Guild chat is now always visible on this tab -->
                    <div id="guild-chat-container" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-content hidden">
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 50px; cursor: pointer; border: 3px solid var(--modal-button-primary-bg); background: var(--app-bg); color: var(--text-color);" id="profileAvatar" onclick="showAvatarModal()">üåü</div>
                        <div>
                            <h4 id="profileUserName" style="margin-bottom: 5px; color: var(--text-color);">Ìë∏Î•∏Ïù¥</h4>
                            <p style="color: var(--text-color); font-size: 14px;">Î†àÎ≤® <span id="profileLevel">1</span> <span id="profileJob">Ìë∏Î•∏Ïù¥</span></p>
                            <p style="color: var(--text-color); font-size: 14px;">Ïã†Ïïô Ïó¨Ï†ï <span id="profileStreak">1</span>ÏùºÏ∞®</p>
                        </div>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">üèÜ ÏóÖÏ†Å Î∞è Î±ÉÏßÄ</h4>
                    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
                        <div id="badge-container" style="margin-bottom: 10px; min-height: 25px;">
                            <!-- Badges will be dynamically inserted here -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--nav-border);">
                            <span style="color: var(--text-color);">ÏôÑÎ£åÌïú ÎØ∏ÏÖò</span>
                            <strong id="completedMissionsCount" style="color: var(--text-color);">0</strong><span style="color: var(--text-color);">Í∞ú</span>
                        </div>
                    </div>
                </div>
<div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
    <h4 style="margin-bottom: 15px; color: var(--text-color);">üî• Ïã§ÏãúÍ∞Ñ Í≥µÏú† ÏÑ§Ï†ï</h4>
    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
        <p style="color: var(--text-color); margin-bottom: 15px; font-size: 14px;">
            <strong id="firebaseStatus">üîß ÏÑ§Ï†ï ÌïÑÏöî:</strong> 
            <span id="firebaseStatusText">Firebase ÏÑ§Ï†ïÏùÑ ÏôÑÎ£åÌïòÎ©¥ Í≥µÏßÄÏÇ¨Ìï≠, Ï±ÑÌåÖ, QTÎÖ∏Ìä∏Î•º Îã§Î•∏ ÏÇ¨Ïö©ÏûêÏôÄ Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í≥µÏú†Ìï† Ïàò ÏûàÏäµÎãàÎã§.</span>
        </p>
        <details style="color: var(--text-color); font-size: 12px;">
            <summary style="cursor: pointer; margin-bottom: 10px;">Firebase ÏÑ§Ï†ï Î∞©Î≤ï Î≥¥Í∏∞</summary>
            <ol style="padding-left: 20px; line-height: 1.6;">
                <li>Firebase ÏΩòÏÜî(console.firebase.google.com)ÏóêÏÑú ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±</li>
                <li>Realtime Database ÌôúÏÑ±Ìôî</li>
                <li>ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ïÏóêÏÑú Ïõπ Ïï± Ï∂îÍ∞Ä</li>
                <li>ÏÉùÏÑ±Îêú config Í∞ùÏ≤¥Î•º JavaScript ÏΩîÎìúÏùò firebaseConfigÏóê Î≥µÏÇ¨</li>
                <li>ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÎ©¥ Ïã§ÏãúÍ∞Ñ Í≥µÏú† Í∏∞Îä• ÌôúÏÑ±Ìôî!</li>
            </ol>
        </details>
    </div>
</div>
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">üé® ÌÖåÎßà ÏÑ§Ï†ï</h4>
                    <div class="theme-toggle-container">
                        <button class="theme-toggle-button" onclick="toggleTheme()">ÌÖåÎßà Ï†ÑÌôò</button>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">‚öôÔ∏è Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï</h4>
                    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
                        <button style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;" onclick="showResetModal()">
                            üîÑ Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                        </button>
                        <div style="font-size: 12px; color: var(--text-color); margin-top: 8px; text-align: center;">
                            Î™®Îì† ÏßÑÌñâ ÏÉÅÌô©Ïù¥ Î¶¨ÏÖãÎê©ÎãàÎã§.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-item active" onclick="showTab('home', this)">
                üè†<br>Ìôà
            </button>
            <button class="nav-item" onclick="showTab('stages', this)">
                üéÆ<br>Ïä§ÌÖåÏù¥ÏßÄ
            </button>
            <button class="nav-item" onclick="showTab('guild', this)">
                üë•<br>Í∏∏Îìú
            </button>
            <button class="nav-item" onclick="showTab('profile', this)">
                üë§<br>ÌîÑÎ°úÌïÑ
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω</div>
            <input type="text" id="nameInput" class="modal-input" placeholder="ÏÉàÎ°úÏö¥ ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNameModal()">Ï∑®ÏÜå</button>
                <button class="modal-button primary" onclick="changeName()">Î≥ÄÍ≤Ω</button>
            </div>
        </div>
    </div>

    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Î≥ÄÍ≤Ω</div>
            <div class="avatar-grid">
                <div class="avatar-option" onclick="selectAvatar('üåü')">üåü</div>
                <div class="avatar-option" onclick="selectAvatar('üòä')">üòä</div>
                <div class="avatar-option" onclick="selectAvatar('üôè')">üôè</div>
                <div class="avatar-option" onclick="selectAvatar('‚ú®')">‚ú®</div>
                <div class="avatar-option" onclick="selectAvatar('üïäÔ∏è')">üïäÔ∏è</div>
                <div class="avatar-option" onclick="selectAvatar('üìñ')">üìñ</div>
                <div class="avatar-option" onclick="selectAvatar('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                <div class="avatar-option" onclick="selectAvatar('üåÖ')">üåÖ</div>
                <div class="avatar-option" onclick="selectAvatar('‚≠ê')">‚≠ê</div>
                <div class="avatar-option" onclick="selectAvatar('üéµ')">üéµ</div>
                <div class="avatar-option" onclick="selectAvatar('üå∏')">üå∏</div>
                <div class="avatar-option" onclick="selectAvatar('üåà')">üåà</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeAvatarModal()">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù</div>
            <input type="password" id="adminPassword" class="modal-input" placeholder="Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="4">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeResetModal()">Ï∑®ÏÜå</button>
                <button class="modal-button primary" onclick="confirmReset()">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Í≥µÏßÄÏÇ¨Ìï≠ ÏûëÏÑ±</div>
            <input type="password" id="noticePassword" class="modal-input" placeholder="Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏" maxlength="4">
            <input type="text" id="noticeTitle" class="modal-input" placeholder="Í≥µÏßÄÏÇ¨Ìï≠ Ï†úÎ™©">
            <textarea id="noticeContent" class="modal-textarea" placeholder="Í≥µÏßÄÏÇ¨Ìï≠ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNoticeModal()">Ï∑®ÏÜå</button>
                <button class="modal-button primary" onclick="createNotice()">Í≥µÏßÄ Îì±Î°ù</button>
            </div>
        </div>
    </div>

    <!-- QT Note Modal -->
    <div id="qtNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="qtModalTitle">QT ÎÖ∏Ìä∏ ÏûëÏÑ±</div>
            <input type="text" id="qtNoteTitle" class="modal-input" placeholder="QT ÎÖ∏Ìä∏ Ï†úÎ™©">
            <textarea id="qtNoteContent" class="modal-textarea" placeholder="Ïò§ÎäòÏùò QT ÎÇ¥Ïö©ÏùÑ Í∏∞Î°ùÌï¥Î≥¥ÏÑ∏Ïöî..."></textarea>
            <input type="password" id="qtNotePassword" class="modal-input" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ (ÏàòÏ†ï/ÏÇ≠Ï†úÏö©)" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTNoteModal()">Ï∑®ÏÜå</button>
                <button class="modal-button primary" id="qtSubmitBtn" onclick="createQTNote()">ÏûëÏÑ± ÏôÑÎ£å</button>
            </div>
        </div>
    </div>

    <!-- QT Note Password Modal -->
    <div id="qtPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</div>
            <p id="passwordModalText">ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:</p>
            <input type="password" id="qtActionPassword" class="modal-input" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTPasswordModal()">Ï∑®ÏÜå</button>
                <button class="modal-button primary" id="qtConfirmActionButton" onclick="confirmQTAction()">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <!-- Minigame Modal (now used for image view and general quiz/minigame logic) -->
    <div id="minigameModal" class="modal">
        <div class="modal-content" id="minigame-content">
            <!-- Minigame content will be injected here -->
        </div>
    </div>
    
    <script>
        // --- Global State Variables ---
        let userLevel, userExp, userStreak, completedMissions, userName, userAvatar, userJob, userBadges, completedStages;
        let guildLevel, guildExp;
        let currentStage = null;
        let chatMessages = [];
        let prayerTimes = {};
        let notices = [];
        let qtNotes = [];
        let editingQTNote = null;
        let pendingQTAction = null; // { type: 'qtNote' | 'comment', action: 'edit' | 'delete', noteId: ..., commentId: ... (if comment) }
        let currentTheme = 'light-mode'; // Default theme
        let quizCompletedPerStage = {}; // Track quiz completion for each stage
        let completedIcebreakers = []; // Array of stage numbers for which icebreaker is completed, now stores answers
        let miniGameCompletedToday = false; // Track if the overall mini-game mission is completed today
        let miniGameProgress = {}; // Tracks completion of individual mini-games for the day

        // Î©îÎ™®Î¶¨ Í∏∞Î∞ò Ï†ÄÏû•ÏÜå (localStorage ÎåÄÏ≤¥)
        let memoryStorage = {};
        
        // localStorage Ï≤¥ÌÅ¨ Î∞è ÎåÄÏ≤¥ Ìï®Ïàò
        function isLocalStorageAvailable() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        function safeSetItem(key, value) {
            if (isLocalStorageAvailable()) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.warn('localStorage setItem Ïã§Ìå®, Î©îÎ™®Î¶¨ Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©:', error);
                }
            }
            // localStorage ÏÇ¨Ïö© Î∂àÍ∞Ä Ïãú Î©îÎ™®Î¶¨Ïóê Ï†ÄÏû•
            memoryStorage[key] = value;
            return false;
        }

        function safeGetItem(key) {
            if (isLocalStorageAvailable()) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('localStorage getItem Ïã§Ìå®, Î©îÎ™®Î¶¨ Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©:', error);
                }
            }
            // localStorage ÏÇ¨Ïö© Î∂àÍ∞Ä Ïãú Î©îÎ™®Î¶¨ÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
            return memoryStorage[key] || null;
        }

        function safeRemoveItem(key) {
            if (isLocalStorageAvailable()) {
                try {
                    localStorage.removeItem(key);
                    return;
                } catch (error) {
                    console.warn('localStorage removeItem Ïã§Ìå®, Î©îÎ™®Î¶¨ Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©:', error);
                }
            }
            // localStorage ÏÇ¨Ïö© Î∂àÍ∞Ä Ïãú Î©îÎ™®Î¶¨ÏóêÏÑú ÏÇ≠Ï†ú
            delete memoryStorage[key];
        }

        // --- Data Definitions ---

        const scriptures = [
            { text: "ÎÇ¥ ÏïàÏóê Î®∏Î¨ºÎü¨ ÏûàÏñ¥Îùº. Í∑∏Î¶¨ÌïòÎ©¥ ÎÇòÎèÑ ÎÑàÌù¨ ÏïàÏóê Î®∏Î¨ºÎü¨ ÏûàÍ≤†Îã§. Í∞ÄÏßÄÍ∞Ä Ìè¨ÎèÑÎÇòÎ¨¥Ïóê Î∂ôÏñ¥ ÏûàÏßÄ ÏïÑÎãàÌïòÎ©¥ Ïä§Ïä§Î°ú Ïó¥Îß§Î•º Îß∫ÏùÑ Ïàò ÏóÜÎäî Í≤ÉÍ≥º Í∞ôÏù¥, ÎÑàÌù¨ÎèÑ ÎÇ¥ ÏïàÏóê Î®∏Î¨ºÎü¨ ÏûàÏßÄ ÏïÑÎãàÌïòÎ©¥ Ïó¥Îß§Î•º Îß∫ÏùÑ Ïàò ÏóÜÎã§.", reference: "ÏöîÌïúÎ≥µÏùå 15:4" },
            { text: "ÎÇòÎäî Ï∞∏ Ìè¨ÎèÑÎÇòÎ¨¥Ïöî, ÎÇ¥ ÏïÑÎ≤ÑÏßÄÎäî ÎÜçÎ∂ÄÏù¥ÏãúÎã§.", reference: "ÏöîÌïúÎ≥µÏùå 15:1" },
            { text: "ÎÑàÌù¨Í∞Ä ÎÇòÏùò ÎßêÏóê Î®∏Î¨ºÎü¨ ÏûàÏúºÎ©¥, ÎÑàÌù¨Îäî Ï∞∏ÏúºÎ°ú ÎÇòÏùò Ï†úÏûêÎì§Ïù¥Îã§. Í∑∏Î¶¨Í≥† ÎÑàÌù¨Îäî ÏßÑÎ¶¨Î•º ÏñªÍ≤å Îê† Í≤ÉÏù¥Î©∞, ÏßÑÎ¶¨Í∞Ä ÎÑàÌù¨Î•º ÏûêÏú†Î°≠Í≤å Ìï† Í≤ÉÏù¥Îã§.", reference: "ÏöîÌïúÎ≥µÏùå 8:31-32" },
            { text: "Í∑∏Îü¨ÎØÄÎ°ú ÎÑàÌù¨Îäî Í∞ÄÏÑú, Î™®Îì† ÎØºÏ°±ÏùÑ Ï†úÏûêÎ°ú ÏÇºÏïÑÏÑú, ÏïÑÎ≤ÑÏßÄÏôÄ ÏïÑÎì§Í≥º ÏÑ±Î†πÏùò Ïù¥Î¶ÑÏúºÎ°ú ÏÑ∏Î°ÄÎ•º Ï£ºÍ≥†, ÎÇ¥Í∞Ä ÎÑàÌù¨ÏóêÍ≤å Î™ÖÎ†πÌïú Î™®Îì† Í≤ÉÏùÑ Í∑∏Îì§ÏóêÍ≤å Í∞ÄÎ•¥Ï≥ê ÏßÄÌÇ§Í≤å ÌïòÏó¨Îùº.", reference: "ÎßàÌÉúÎ≥µÏùå 28:19-20" },
            { text: "ÏÇ¨ÎûåÏùÄ ÎßàÏùåÏúºÎ°ú ÎØøÏñ¥ÏÑú ÏùòÏóê Ïù¥Î•¥Í≥†, ÏûÖÏúºÎ°ú Í≥†Î∞±Ìï¥ÏÑú Íµ¨ÏõêÏóê Ïù¥Î•¥Í≤å Îê©ÎãàÎã§.", reference: "Î°úÎßàÏÑú 10:10" }
        ];

        // New Quiz Questions (Church-themed)
        const quizQuestions = [
            {
                question: "ÍµêÌöåÏùò Î®∏Î¶¨Îäî ÎàÑÍµ¨Ïã†Í∞ÄÏöî?",
                options: ["Î≤†ÎìúÎ°ú", "Î∞îÏö∏", "ÏòàÏàò Í∑∏Î¶¨Ïä§ÎèÑ", "ÍµêÌô©"],
                answer: "ÏòàÏàò Í∑∏Î¶¨Ïä§ÎèÑ"
            },
            {
                question: "ÍµêÌöåÏùò ÏÑ∏ Í∞ÄÏßÄ Ï£ºÏöî ÏÇ¨Î™Ö Ï§ë ÌïòÎÇòÍ∞Ä ÏïÑÎãå Í≤ÉÏùÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?",
                options: ["ÏòàÎ∞∞", "ÍµêÏú°", "ÏÇ¨ÏóÖ", "Î¥âÏÇ¨ Î∞è ÏÑ†Íµê"],
                answer: "ÏÇ¨ÏóÖ"
            },
            {
                question: "ÏÇ¨ÎèÑÌñâÏ†ÑÏóê ÎÇòÏò§Îäî Ï¥àÎåÄÍµêÌöåÏùò ÌäπÏßïÏù¥ ÏïÑÎãå Í≤ÉÏùÄ?",
                options: ["ÏÑúÎ°ú Î¨ºÍ±¥ÏùÑ ÌÜµÏö©Ìï®", "Îß§Ïùº ÎßàÏùåÏùÑ Í∞ôÏù¥ÌïòÏó¨ ÏÑ±Ï†ÑÏóê Î™®Ïù¥Í∏∞Î•º ÌûòÏîÄ", "Í∞úÏù∏Ï£ºÏùòÏ†ÅÏù∏ Ïã†ÏïôÏÉùÌôú", "Îñ°ÏùÑ ÎñºÎ©∞ Í∏∞ÏÅ®Í≥º ÏàúÏ†ÑÌïú ÎßàÏùåÏúºÎ°ú ÏùåÏãùÏùÑ Î®πÏùå"],
                answer: "Í∞úÏù∏Ï£ºÏùòÏ†ÅÏù∏ Ïã†ÏïôÏÉùÌôú"
            },
            {
                question: "ÍµêÌöåÍ∞Ä ÏÑ∏ÏÉÅÏùò ÎπõÍ≥º ÏÜåÍ∏àÏùò Ïó≠Ìï†ÏùÑ Ìï¥Ïïº ÌïúÎã§Í≥† ÎßêÏîÄÌïòÏã† ÏÑ±Í≤ΩÏùÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?",
                options: ["ÏöîÌïúÎ≥µÏùå", "ÎßàÌÉúÎ≥µÏùå", "Î°úÎßàÏÑú", "ÌûàÎ∏åÎ¶¨ÏÑú"],
                answer: "ÎßàÌÉúÎ≥µÏùå"
            },
            {
                question: "ÍµêÌöåÏùò Í∞ÄÏû• Ï§ëÏöîÌïú Í≥µÎèôÏ≤¥Ï†Å Î™®ÏûÑÏùÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?",
                options: ["ÏπúÎ™©Ìöå", "Ïö¥ÎèôÌöå", "ÏòàÎ∞∞", "Î∞îÏûêÌöå"],
                answer: "ÏòàÎ∞∞"
            }
        ];

        const stageContents = {
            1: {
                title: "1Í∞ï: Ìå®Ïπò ÏãúÏä§ÌÖú - Í±∞Î∂ÄÌï† Ïàò ÏóÜÎäî ÌäπÍ∂å",
                item: "Ïö©ÌäπÏÉà Î©îÏãúÏßÄ",
                icebreaker: {
                    prompt: "1Í∞ïÏùÑ ÏãúÏûëÌïòÍ∏∞ Ï†ÑÏóê, 'Ìå®Ïπò'ÎùºÎäî Îã®Ïñ¥Î•º Îì§ÏúºÎ©¥ Ïñ¥Îñ§ ÏÉùÍ∞ÅÏù¥ ÎìúÎÇòÏöî? Ïã†ÏïôÏÉùÌôúÏóêÏÑú 'Ìå®Ïπò'Í∞Ä ÌïÑÏöîÌïòÎã§Í≥† ÎäêÎÇÄ Ï†ÅÏù¥ ÏûàÎÇòÏöî?"
                },
                hasQuiz: false, // Quiz removed from Stage 1
                lessons: [
                    {
                        icon: "üõ°Ô∏è",
                        title: "ÏòàÎ∞∞ÌïòÍ∏∞ - ÌïòÎÇòÎãòÏùÑ ÎßåÎÇòÎäî Í≥µÏãù Ï±ÑÎÑê",
                        content: `<h4>üìå ÏòàÎ∞∞Îäî ÏñëÎ∞©Ìñ• ÏÜåÌÜµ</h4><p>ÏòàÏàòÎãòÏùÄ Ïö∞Î¶¨ÏóêÍ≤å ÏÉàÎ°úÏö¥ ÏÉùÎ™ÖÏùÑ Ï£ºÏã§ ÎøêÎßå ÏïÑÎãàÎùº, "Îçî ÎÑòÏπòÍ≤å" ÎàÑÎ¶¨Î©∞ ÏÇ¥Í≤å ÌïòÍ∏∞ ÏúÑÌï¥ ÏûêÍ∏∞ Î™©Ïà®ÏùÑ Î≤ÑÎ¶¨Í≤†Îã§Í≥† ÎßêÏîÄÌïòÏÖ®ÏäµÎãàÎã§.</p><h4>üí° ÏòàÎ∞∞Ïùò ÏùòÎØ∏</h4><ul><li>ÌïòÎÇòÎãòÏù¥ Ïö∞Î¶¨ ÏùºÏÉÅÏóê ÏñºÎßàÎÇò Í¥ÄÏã¨Ïù¥ ÎßéÏùÄÏßÄ Ïïå Ïàò ÏûàÎäî ÏãúÍ∞Ñ</li><li>Ïö∞Î¶¨Î•º ÏñºÎßàÎÇò ÏÜåÏ§ëÌûà Ïó¨Í∏∞ÎäîÏßÄ Íπ®Îã´Îäî ÏãúÍ∞Ñ</li><li>ÌïòÎÇòÎãòÏùò Í≥ÑÌöçÏóêÏÑú Ïö∞Î¶¨Í∞Ä ÏñºÎßàÎÇò Ï§ëÏöîÌïú ÏÇ¨ÎûåÏù∏ÏßÄ Î∞úÍ≤¨ÌïòÎäî ÏãúÍ∞Ñ</li></ul>
                        
                        <h4>‚öîÔ∏è Í±∞Ïßì ÏúÑÌòë vs ÏßÑÏßú Î™©ÏÜåÎ¶¨ (Ïö©ÌäπÏÉà)</h4>
                        <p><strong>Í±∞Ïßì ÏúÑÌòë:</strong> "ÎÑàÎäî Ïôú Í∑∏Í±∞Î∞ñÏóê Ïïà ÎêòÎÉê?", "ÎÑà Îî∞ÏúÑÎäî Ïó¨Í∏∞ÏÑú Ïã§Ìå®ÌïòÎ©¥ Î∞îÎ°ú ÎÅùÏù¥Ïïº"</p>
                        <p><strong>ÏßÑÏßú Î™©ÏÜåÎ¶¨ (Ïö©ÌäπÏÉà):</strong></p>
                        <ul>
                            <li>Í∑∏Î¶¨Ïä§ÎèÑ ÏïàÏóêÏÑú ÎãπÏã†ÏùÄ <strong>Ïö©ÎÇ©</strong>ÎêòÏóàÏäµÎãàÎã§</li>
                            <li>Í∑∏Î¶¨Ïä§ÎèÑ ÏïàÏóêÏÑú ÎãπÏã†ÏùÄ <strong>ÌäπÎ≥ÑÌïú</strong> Ï°¥Ïû¨ÏûÖÎãàÎã§</li>
                            <li>Í∑∏Î¶¨Ïä§ÎèÑ ÏïàÏóêÏÑú ÎãπÏã†ÏùÄ <strong>ÏÉàÎ°úÏö¥</strong> Í≥µÎèôÏ≤¥Ïóê ÏÜçÌñàÏäµÎãàÎã§</li>
                        </ul>
                        <p>ÏòàÎ∞∞Î•º ÎìúÎ¶¨Î©¥ÏÑú, Íπ®ÏßÑ ÏÑ∏ÏÉÅÏù¥ Ï£ºÎäî Í±∞Ïßì ÏúÑÌòëÍ≥ºÎäî Ï†ÑÌòÄ Îã§Î•∏, ÎãπÏã†ÏùÑ Ìñ•Ìïú ÏßÑÏßú Î™©ÏÜåÎ¶¨Ïóê Í∑ÄÎ•º Í∏∞Ïö∏Ïù¥ÏÑ∏Ïöî. ÎãπÏã†ÏùÑ Ìñ•Ìï¥ Î∂àÏñ¥Ïò§Îäî Ìë∏Î•∏Î∞îÎûåÏùò Î©îÏãúÏßÄÎäî Ïñ¥Îñ§ Í≥µÍ≤©ÏóêÎèÑ ÎÅÑÎñ°ÏóÜÎäî Ï≤¥Î†•ÏùÑ Ï£ºÍ≥† Ïâ¥ÎìúÍ∞Ä Îê©ÎãàÎã§.</p>`
                    },
                    {
                        icon: "‚ö°",
                        title: "ÏÑ±Í≤ΩÏùΩÍ∏∞ - Ìë∏Î•∏Î∞îÎûåÏùò ÎÉâÏû•Í≥†",
                        content: `<h4>üçØ ÎÇòÏùò Ìå®Ïπò, ÎÇòÏùò ÌäπÍ∂å</h4><p>ÏÑ±Í≤ΩÏùÄ Ìë∏Î•∏Î∞îÎûåÏùò ÎÇòÎùº ÏóêÎÑàÏßÄÏõêÏù¥ Í∞ÄÎìùÌïú ÎÉâÏû•Í≥†ÏûÖÎãàÎã§. ÏïÑÎ¨¥Î¶¨ ÎÉâÏû•Í≥†Ïóê Î®πÏùÑ Í≤ÉÏù¥ Í∞ÄÎìùÌï¥ÎèÑ Í∫ºÎÇ¥ Î®πÏßÄ ÏïäÏúºÎ©¥ ÏïÑÎ¨¥ ÏÜåÏö©Ïù¥ ÏóÜÏäµÎãàÎã§.</p><h4>üîç ÏÑ±Í≤ΩÏùÑ Í∫ºÎÇ¥ Î®πÎäî ÍøÄÌåÅ</h4><ul><li>ÌïòÎÇòÎãòÏùÄ Ïñ¥Îñ§ Î∂ÑÏùºÍπå? (ÌïòÎÇòÎãòÏùò ÏÑ±ÌíàÍ≥º ÎßêÏîÄÍ≥º ÌïòÏã† Ïùº)</li><li>ÏòàÏàòÎãòÏùÄ Ïñ¥Îñ§ Î∂ÑÏùºÍπå? (ÏòàÏàòÎãòÏùò Í∞ÄÎ•¥Ïπ®Í≥º ÏÇ∂Í≥º ÌñâÎèô)</li><li>ÏÑ†Î∞∞Îì§ÏùÄ Ïñ¥ÎñªÍ≤å ÏÇ¥ÏïòÏùÑÍπå? (Í∑∏Îì§Ïùò ÎØøÏùåÍ≥º Í∏∞ÎèÑ, Ïã§ÏàòÏôÄ ÌöåÎ≥µÍ≥º ÍµêÌõà)</li><li>Í∑∏Îü¨Î©¥ ÎÇòÎäî Ïñ¥ÎñªÍ≤å ÏÇ¥ÏïÑÏïº Ìï†Íπå? (ÎÇ¥ ÌòÑÏã§Ïóê Ï†ÅÏö©Ìï† Ïàò ÏûàÎäî ÏÑ±Í≤Ω ÏõêÎ¶¨)</li></ul>`
                    },
                    {
                        icon: "üîå",
                        title: "Í∏∞ÎèÑÌïòÍ∏∞ - Ïã†ÏóêÍ≤å Îπ®ÎåÄ ÍΩÇÍ∏∞",
                        content: `<h4>üå≥ Ìè¨ÎèÑÎÇòÎ¨¥ÏôÄ Í∞ÄÏßÄÏùò Í¥ÄÍ≥Ñ</h4><p>ÏòàÏàòÎãòÏùÄ Ïö∞Î¶¨Î•º "Í∞ÄÏßÄ"ÎùºÍ≥† Î∂ÄÎ•¥ÏãúÎ©∞, ÏûêÏã†ÏóêÍ≤å Îî± Î∂ôÏñ¥ ÏûàÏúºÎùºÍ≥† ÌïòÏã≠ÎãàÎã§. ÎÇòÎ≠áÍ∞ÄÏßÄÏùò ÏµúÍ≥† ÌäπÍ∂åÏùÄ ÎÜçÎ∂Ä(ÌïòÎÇòÎãò)Í∞Ä ÎïÄ ÌùòÎ†§ ÏùºÌïòÍ≥† ÎÇòÎ¨¥(ÏòàÏàòÎãò)Í∞Ä Ïó¥Ïã¨Ìûà Í≥µÍ∏âÌïú ÏñëÎ∂ÑÏùÑ Í∑∏ÎÉ• Î∞õÏïÑ ÎàÑÎ¶¨Îäî Í≤ÉÏûÖÎãàÎã§.</p><h4>üïê 10-10-10 Í∏∞ÎèÑÎ≤ï</h4><p>ÏïÑÏπ®, Ï†êÏã¨, Ï†ÄÎÖÅ 10Î∂ÑÏî© ÏòàÏàòÎãòÍ≥º ÎåÄÌôîÌïòÎäî ÏãúÍ∞ÑÏùÑ Í∞ÄÏ†∏Î≥¥ÏÑ∏Ïöî. Î∂ÄÎã¥ ÏóÜÏù¥, Í∑∏Ï†Ä ÎßêÏùÑ Í±∞Îäî Í≤ÉÎ∂ÄÌÑ∞ ÏãúÏûëÌïòÎ©¥ Îê©ÎãàÎã§.</p>`
                    }
                ],
                discussionQuestions: [
                    "ÏòàÎ∞∞, ÏÑ±Í≤Ω ÏùΩÍ∏∞, Í∏∞ÎèÑ Ï§ëÏóêÏÑú ÏöîÏ¶ò ÎÇòÏóêÍ≤å Í∞ÄÏû• Í∞ÄÍπùÍ≤å ÎäêÍª¥ÏßÄÎäî Í≤ÉÍ≥º Í∞ÄÏû• Î©ÄÍ≤å ÎäêÍª¥ÏßÄÎäî Í≤ÉÏùÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî? Í∑∏ Ïù¥Ïú†Îäî Î¨¥ÏóáÏùºÍπåÏöî?",
                    "ÎÇòÎ•º Ìñ•Ìïú ÌïòÎÇòÎãòÏùò 'ÏßÑÏßú Î™©ÏÜåÎ¶¨'(Ïö©ÌäπÏÉà: Ïö©ÎÇ©, ÌäπÎ≥ÑÌï®, ÏÉàÎ°úÏö¥ Í≥µÎèôÏ≤¥)Î•º ÏùòÏã¨ÌïòÍ≤å ÎßåÎìúÎäî 'Í±∞Ïßì ÏúÑÌòë'ÏóêÎäî Ïñ¥Îñ§ Í≤ÉÎì§Ïù¥ ÏûàÏóàÎÇòÏöî?",
                    "Ïò§Îäò Î∞∞Ïö¥ '10-10-10 Í∏∞ÎèÑÎ≤ï'ÏùÑ ÎÇ¥ÏùºÎ∂ÄÌÑ∞ ÎãπÏû• Ïã§Ï≤úÌï¥Î≥∏Îã§Î©¥, Ïñ¥Îñ§ Ï†êÏù¥ Í∏∞ÎåÄÎêòÍ≥† Ïñ¥Îñ§ Ï†êÏù¥ Í±±Ï†ïÎêòÎÇòÏöî?"
                ]
            },
            2: {
                title: "2Í∞ï: Í∏∏Îìú ÏãúÏä§ÌÖú - Ïö∞Î¶¨, Í∞ôÏù¥ Ìï¥Î≥ºÍπåÏöî",
                item: "Í∏∏Îìú Î≤ÑÌîÑ",
                icebreaker: {
                    prompt: "2Í∞ïÏùÑ ÏãúÏûëÌïòÍ∏∞ Ï†ÑÏóê, 'Í∏∏Îìú'ÎùºÎäî Îã®Ïñ¥Î•º Îì§ÏúºÎ©¥ Ïñ¥Îñ§ ÏÉùÍ∞ÅÏù¥ ÎìúÎÇòÏöî? Ïã†Ïïô Í≥µÎèôÏ≤¥Í∞Ä 'Í∏∏Îìú'Ï≤òÎüº ÎäêÍª¥ÏßÑ Ï†ÅÏù¥ ÏûàÎÇòÏöî?"
                },
                hasQuiz: false, // This stage does not have a quiz
                lessons: [
                    {
                        icon: "üéØ",
                        title: "ÏÑ∏Î°ÄÎ∞õÍ∏∞ - Í∏∏Îìú Í∞ÄÏûÖÌïòÍ∏∞",
                        content: `<h4>üè∞ Í∏∏Îìú Í∞ÄÏûÖÏùò ÏùòÎØ∏</h4><p>ÌïòÎÇòÎãò ÎÇòÎùº ÏÇ¨ÎûåÏù¥ ÎêòÎäî Í≤ÉÍ≥º Í∑∏ ÎÇòÎùº Î∞©ÏãùÎåÄÎ°ú ÏÇ¨Îäî Í≤É ÏÇ¨Ïù¥Ïóê 'ÏÑ∏Î°Ä'Í∞Ä ÏûàÏäµÎãàÎã§. Í∏∞ÎèÖÍµêÎäî ÏûêÏã†ÎßåÏùò Ï†ÑÏù∏Í≤©Ï†Å Í≥†Î∞±Ïù¥ ÌïÑÏöîÌïú Ï¢ÖÍµêÏù¥Î©∞, Ï†àÎåÄ ÎÇ®ÏóêÍ≤å Î¨ªÏñ¥Í∞à Ïàò ÏóÜÏäµÎãàÎã§.</p><h4>üíç ÎπÑÎ∞Ä Ïó∞Ïï†ÏóêÏÑú Í≥µÏãù Î∞úÌëúÎ°ú</h4><p>ÏÑ∏Î°ÄÎ•º Ï¢Ä Îçî ÏÑ§Î†àÎäî Î≤ÑÏ†ÑÏúºÎ°ú ÏÑ§Î™ÖÌïòÎ©¥, ÎπÑÎ∞Ä Ïó∞Ïï†Î•º ÌïòÎäî Ïó∞Ïù∏Ïù¥ ÏÇ¨Í∑ÑÎã§Í≥† Í≥µÏãùÏ†ÅÏúºÎ°ú Î∞ùÌûàÎäî Í≤ÉÍ≥º Í∞ôÏäµÎãàÎã§. Ïù¥ ÏÇ¨ÎûåÏù¥ÎùºÍ≥† ÌôïÏã†ÌïòÍ∏∞ ÎïåÎ¨∏ÏûÖÎãàÎã§.</p>`
                    },
                    {
                        icon: "üë•",
                        title: "Í≥µÎèôÏ≤¥ ÏÜçÌïòÍ∏∞ - Î≥ëÏïÑÎ¶¨ Í≥µÎèôÏ≤¥",
                        content: `<h4>üê£ Î≥ëÏïÑÎ¶¨Í∞Ä ÏÇ¥ÏïÑÎÇ®Îäî Î≤ï</h4><p>ÌïôÍµê ÏïûÏóêÏÑú ÏÇ∞ Î≥ëÏïÑÎ¶¨Í∞Ä ÏÇ¥ÏïÑÎÇ®Îäî ÎπÑÍ≤∞ÏùÄ 'Í≥µÎèôÏ≤¥'ÏòÄÏäµÎãàÎã§. Í≥µÎèôÏ≤¥Î•º ÌÜµÌï¥ Î¨¥ÏóáÏùÑ Î®πÍ≥†, Ïñ¥ÎñªÍ≤å ÏÇ¥ÏïÑÏïº ÌïòÎäîÏßÄ Î∞∞Ïö∞Î©∞ Í±¥Í∞ïÌï¥ÏßëÎãàÎã§.</p><h4>üéÆ Í∏∏Îìú Î≤ÑÌîÑ Î∞õÎäî Î∞©Î≤ï</h4><p>Í≥µÎèôÏ≤¥ ÏïàÏóêÏÑú ÎßêÏîÄÏùÑ Îì£Í≥† Î∞∞Ïö∞Îäî Î≤ÑÌîÑ, Îã§Î•∏ ÏÇ¨ÎûåÏùò ÏÇ∂ÏùÑ Î≥¥Í≥† Î∞∞Ïö∞Îäî Î≤ÑÌîÑÎ•º ÌÜµÌï¥ Ìï®Íªò ÏÑ±Ïû•Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>`
                    },
                    {
                        icon: "üïäÔ∏è",
                        title: "ÏÑ±Î†π Îî∞Î•¥Í∏∞ - Ïö∞Î¶¨ ÌûòÎßåÏúºÎ°úÎäî Ïñ¥Î†§Ïõå",
                        content: `<h4>ü§ù Îäò Ìï®ÍªòÌïòÎäî Ï∞∏ Ï¢ãÏùÄ Ïä§Ïäπ</h4><p>Ïö∞Î¶¨ ÌûòÎßåÏúºÎ°úÎäî Ïñ¥Î†µÏäµÎãàÎã§. ÏÑ±Î†πÎãòÏùÄ Ïö∞Î¶¨ÏôÄ Ïù∏Í≤©Ï†ÅÏù∏ Í¥ÄÍ≥ÑÎ•º ÏõêÌïòÏãúÎ©∞, Ïö∞Î¶¨Í∞Ä ÏûêÎ∞úÏ†ÅÏúºÎ°ú ÌïòÎÇòÎãòÏùò ÎúªÏùÑ ÏÑ†ÌÉùÌïòÎèÑÎ°ù ÎèÑÏö∞ÏãúÎäî Î∂ÑÏûÖÎãàÎã§.</p><h4>üìñ‚ûïüïäÔ∏è ÏÑ±Í≤ΩÍ≥º ÏÑ±Î†πÏùò ÏΩ§Î≥¥</h4><p>ÏÑ±Í≤ΩÍ≥º ÏÑ±Î†πÎãòÏùÄ Îî∞Î°ú ÎñºÏñ¥ÎÜìÍ≥† ÏÉùÍ∞ÅÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÏÑ±Î†πÎãòÏùÄ ÏÑ±Í≤Ω ÎßêÏîÄÏùÑ Íπ®Îã´Í≥† ÏàúÏ¢ÖÌïòÎèÑÎ°ù ÎèÑÏö∞Ïã≠ÎãàÎã§.</p>`
                    }
                ],
                discussionQuestions: [
                    "ÎÇòÏóêÍ≤å Ïã†Ïïô Í≥µÎèôÏ≤¥(Í∏∏Îìú)Îäî Ïñ¥Îñ§ ÏùòÎØ∏Ïù∏Í∞ÄÏöî? Í≥µÎèôÏ≤¥Î•º ÌÜµÌï¥ 'Í∏∏Îìú Î≤ÑÌîÑ'Î•º Î∞õÏïòÎçò Í≤ΩÌóòÏù¥ ÏûàÎã§Î©¥ ÎÇòÎà†Ï£ºÏÑ∏Ïöî.",
                    "ÏÑ∏Î°ÄÎ•º 'ÎπÑÎ∞Ä Ïó∞Ïï†ÏóêÏÑú Í≥µÏãù Î∞úÌëúÎ°ú' ÎπÑÏú†Ìïú Í≤ÉÏ≤òÎüº, ÎÇòÏùò Ïã†ÏïôÏùÑ Îã§Î•∏ ÏÇ¨ÎûåÎì§ÏóêÍ≤å Í≥µÍ∞úÏ†ÅÏúºÎ°ú ÌëúÌòÑÌïòÎäî Í≤ÉÏóê ÎåÄÌï¥ Ïñ¥ÎñªÍ≤å ÏÉùÍ∞ÅÌïòÎÇòÏöî?",
                    "ÏÑ±Î†πÎãòÏùÑ 'Îäò Ìï®ÍªòÌïòÎäî Ï∞∏ Ï¢ãÏùÄ Ïä§Ïäπ'ÏúºÎ°ú Ïù∏Í≤©Ï†ÅÏúºÎ°ú Ïã†Î¢∞ÌïòÍ≥† Îî∞Î•¥Í∏∞ ÏúÑÌï¥, Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú Ïñ¥Îñ§ ÎÖ∏Î†•ÏùÑ Ìï† Ïàò ÏûàÏùÑÍπåÏöî?"
                ]
            },
            3: {
                title: "3Í∞ï: Ïã§Ï†Ñ ÏãúÏä§ÌÖú - Ïù∏ÏÉùÏùÄ Ïû•ÎÇúÏù¥ ÏïÑÎãàÎãàÍπå",
                item: "ÏÑ±Î†πÏùò Ïó¥Îß§",
                icebreaker: {
                    prompt: "3Í∞ïÏùÑ ÏãúÏûëÌïòÍ∏∞ Ï†ÑÏóê, 'Ïã§Ï†Ñ'Ïù¥ÎùºÎäî Îã®Ïñ¥Î•º Îì§ÏúºÎ©¥ Ïñ¥Îñ§ ÏÉùÍ∞ÅÏù¥ ÎìúÎÇòÏöî? ÎÇòÏùò Ïã†ÏïôÏù¥ 'Ïã§Ï†Ñ'Ïóê Í∞ïÌïòÎã§Í≥† ÏÉùÍ∞ÅÌïòÎÇòÏöî?"
                },
                hasQuiz: false, // This stage does not have a quiz
                lessons: [
                    {
                        icon: "üìñ‚Üíüåç",
                        title: "Ïù¥Î°†ÏóêÏÑú ÌòÑÏã§Î°ú - ÏÑ±Í≤ΩÏùÄ Í∑∏Î¶ºÏùò Îñ°Ïù¥ ÏïÑÎãàÎã§",
                        content: `<h4>üìö Î¨¥Ï±ÖÏûÑÌïú ÎèôÌôîÏóêÏÑú Ï±ÖÏûÑÍ∞ê Ï©åÎäî ÌòÑÏã§Î°ú</h4><p>Ïã†ÏïôÏùÄ 'Ïò§ÎûòÏò§Îûò ÌñâÎ≥µÌïòÍ≤å ÏÇ¥ÏïòÎãµÎãàÎã§'ÏóêÏÑú ÎÅùÎÇòÏßÄ ÏïäÏäµÎãàÎã§. Í∑∏ ÌõÑÏùò ÏÇ∂ÏùÑ ÌïòÎÇòÎãò ÎÇòÎùº Î∞©ÏãùÏúºÎ°ú ÏÇ¥ÏïÑÎÇ¥Îäî Í≤ÉÏù¥ ÏßÑÏßú Ïù¥ÏïºÍ∏∞ÏûÖÎãàÎã§.</p><h4>üéØ ÎÅùÎÇ† ÎïåÍπåÏßÄ ÎÅùÎÇú Í≤å ÏïÑÎãàÎã§</h4><p>ÏùºÏÉÅÏóêÏÑú ÏÑ±Í≤Ω ÏõêÎ¶¨Î•º Ï†ÅÏö©ÌïòÍ≥†, Ïã§Ìå®Î•º ÎëêÎ†§ÏõåÌïòÏßÄ ÎßêÍ≥†, Í≥ÑÏÜçÌï¥ÏÑú ÌïòÎÇòÎãòÏùÑ ÏïåÏïÑÍ∞ÄÎ©∞ Ïã†Î¢∞Î•º ÏåìÏïÑÍ∞ÄÎäî Í≤ÉÏù¥ Ï§ëÏöîÌï©ÎãàÎã§.</p>`
                    },
                    {
                        icon: "‚è∞",
                        title: "Îß§Ïùº Í∑∏Î∂ÑÍ≥º - Î£®Ìã¥! Ïû¨Î∞åÍ≥† Íæ∏Ï§ÄÌïòÍ≤å",
                        content: `<h4>üìÖ ÏùºÎåÄÏùº ÎßåÎÇ®Ïù¥ÎùºÎãà</h4><p>ÌïòÎÇòÎãòÍ≥ºÏùò Í∞úÏù∏Ï†ÅÏù∏ ÎßåÎÇ® ÏãúÍ∞Ñ, Ï¶â ÌÅêÌã∞(QT, Quiet Time)Î•º Íæ∏Ï§ÄÌûà Í∞ÄÏßÄÎäî Í≤ÉÏù¥ Ï§ëÏöîÌï©ÎãàÎã§. Ïû¨Î∞åÍ≥† Íæ∏Ï§ÄÌïòÍ≤å ÏûêÏã†ÎßåÏùò Î£®Ìã¥ÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî.</p><h4>üìñ ÌÅêÌã∞, ÏãúÏûëÌï¥Î≥ºÍπåÏöî</h4><p>ÏÑ±Í≤Ω ÏùΩÍ∏∞ ‚Üí ÌïòÎÇòÎãò ÏïåÍ∏∞ ‚Üí Î©îÏãúÏßÄ Ï∞æÍ∏∞ ‚Üí Ï†ÅÏö©ÌïòÍ∏∞ ‚Üí Í∏∞ÎèÑÌïòÍ∏∞ ÏàúÏÑúÎ°ú ÌÅêÌã∞Î•º ÏßÑÌñâÌï¥Î≥º Ïàò ÏûàÏäµÎãàÎã§.</p>`
                    },
                    {
                        icon: "ü§ó",
                        title: "ÏùºÏÉùÏùÑ Ìï®Íªò - Ïñ¥, ÏÇ¥ÏïÑÏÑú ÏõÄÏßÅÏù¥ÎÑ§",
                        content: `<h4>‚ú® Ï∞¨ÎûÄÌñàÎçò Í∑∏ ÏàúÍ∞ÑÍ≥º Ïñ¥Îë†Ïùò ÏãúÍ∞Ñ</h4><p>Ïù∏ÏÉùÏùò Ï¢ãÏùÄ ÏàúÍ∞ÑÍ≥º ÌûòÎì† ÏàúÍ∞Ñ Î™®Îëê ÌïòÎÇòÎãòÍ≥º Ìï®ÍªòÌïòÎ©∞ Ïã†ÏïôÏùò Í∑ºÏú°ÏùÑ ÌÇ§ÏõåÎÇòÍ∞ÄÏïº Ìï©ÎãàÎã§.</p><h4>üåà Í±∞Î£©Ìïú ÏÉÅÏÉÅ</h4><p>ÌïòÎÇòÎãò ÎÇòÎùºÏùò ÏôÑÏÑ±Îêú Î™®ÏäµÏùÑ ÏÜåÎßùÌïòÎ©∞ Ïò§ÎäòÏùò Ïñ¥Î†§ÏõÄÏùÑ Í≤¨ÎîîÍ≥†, Ïù¥ ÎïÖÏóêÏÑú ÌïòÎÇòÎãò ÎÇòÎùºÎ•º ÎßõÎ≥¥Î©∞ ÏÇ¥ÏïÑÍ∞à Ïàò ÏûàÏäµÎãàÎã§.</p>`
                    }
                ],
                discussionQuestions: [
                    "ÏÑ±Í≤Ω ÎßêÏîÄÏùÑ 'Í∑∏Î¶ºÏùò Îñ°'Ïù¥ ÏïÑÎãå, ÎÇ¥ ÏÇ∂Ïùò 'Ï±ÖÏûÑÍ∞ê Ï©åÎäî ÌòÑÏã§'Î°ú ÎßåÎì§Í∏∞ ÏúÑÌï¥ Ïñ¥Îñ§ ÎÖ∏Î†•ÏùÑ ÌïòÍ≥† ÏûàÎÇòÏöî? ÎòêÎäî Ïñ¥Îñ§ Ï†êÏù¥ Í∞ÄÏû• Ïñ¥Î†µÎÇòÏöî?",
                    "Îß§Ïùº ÌïòÎÇòÎãòÍ≥º ÎßåÎÇòÎäî 'ÌÅêÌã∞' ÏãúÍ∞ÑÏùÑ Íæ∏Ï§ÄÌûà Í∞ñÍ∏∞ ÏúÑÌï¥ ÎÇòÏóêÍ≤å Í∞ÄÏû• ÌïÑÏöîÌïú Í≤ÉÏùÄ Î¨¥ÏóáÏùºÍπåÏöî? (Ïòà: ÏãúÍ∞Ñ, Ïû•ÏÜå, ÏùòÏßÄ, Ï¢ãÏùÄ ÍµêÏû¨ Îì±)",
                    "ÏµúÍ∑º ÎÇòÏùò ÏÇ∂ÏóêÏÑú Í≤ΩÌóòÌïú 'Ï∞¨ÎûÄÌñàÎçò ÏàúÍ∞Ñ'Í≥º 'Ïñ¥Îë†Ïùò ÏãúÍ∞Ñ'ÏùÄ Í∞ÅÍ∞Å Î¨¥ÏóáÏù¥ÏóàÎÇòÏöî? Í∑∏ ÏãúÍ∞ÑÎì§ÏùÑ ÌÜµÌï¥ ÌïòÎÇòÎãòÏóê ÎåÄÌï¥ Î¨¥ÏóáÏùÑ Î∞∞Ïö∞Í≤å ÎêòÏóàÎÇòÏöî?"
                ]
            }
        };

        // --- Job System ---
        function getUserJobTitle(level) {
            if (level >= 90) return 'ÎßàÏä§ÌÑ∞';
            if (level >= 60) return 'Ï≤≠ÎåÄÏû•';
            if (level >= 30) return 'Ï≤≠Í∏∞ÏÇ¨';
            return 'Ìë∏Î•∏Ïù¥';
        }

        // --- Core App Functions ---

        function showTab(tabName, navElement) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            navElement.classList.add('active');

            if (tabName === 'stages') {
                backToStages();
                updateIcebreakerRecordsDisplay(); // Update records when stages tab is shown
            }
            if (tabName === 'guild') {
                updateQTNotes();
                // Directly show guild chat when guild tab is active
                const guildChatContainer = document.getElementById('guild-chat-container');
                if (guildChatContainer) {
                    guildChatContainer.innerHTML = createChatInterface('guild');
                    updateChatMessages('guild');
                }
            }
            if (tabName === 'home') updateNotices();
        }

        function enterStageContent(stageNumber) {
            currentStage = stageNumber;
            const stageData = stageContents[stageNumber];
            
            if (!stageData) {
                showNotification('Ïä§ÌÖåÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            document.getElementById('stage-list').classList.add('hidden');
            document.getElementById('stage-detail').classList.remove('hidden');
            
            let contentHtml = `<h3 style="margin-bottom: 20px; color: var(--lesson-title-color);">${stageData.title}</h3>`;

            // 1. Icebreaker Section
            if (stageData.icebreaker && !completedIcebreakers.some(item => item.stage === stageNumber)) { // Check if icebreaker for this stage is completed
                contentHtml += `
                    <div class="icebreaker-section" id="icebreaker-section-${stageNumber}">
                        <div class="modal-title">ÏïÑÏù¥Ïä§Î∏åÎ†àÏù¥ÌÅ¨</div>
                        <p class="icebreaker-prompt">${stageData.icebreaker.prompt}</p>
                        <textarea id="icebreakerInput-${stageNumber}" class="icebreaker-input" placeholder="ÎãπÏã†Ïùò ÏÉùÍ∞ÅÏùÑ ÏûêÏú†Î°≠Í≤å Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî..."></textarea>
                        <button class="modal-button primary" onclick="completeIcebreaker(${stageNumber})">Ï†úÏ∂úÌïòÍ≥† Í∞ïÏùò Î≥¥Í∏∞</button>
                    </div>
                `;
            }

            // 2. Lessons and Discussion Questions
            // Only show lessons and discussion if icebreaker is completed
            if (!stageData.icebreaker || completedIcebreakers.some(item => item.stage === stageNumber)) {
                contentHtml += stageData.lessons.map(lesson => `
                    <div class="lesson-container">
                        <div class="lesson-header">
                            <div class="lesson-icon">${lesson.icon}</div>
                            <div class="lesson-title">${lesson.title}</div>
                        </div>
                        <div class="lesson-content">${lesson.content}</div>
                    </div>
                `).join('');

                if (stageData.discussionQuestions) {
                    contentHtml += `
                        <div class="discussion-container">
                            <h4>ü§î Ìï®Íªò ÎÇòÎàå ÏßàÎ¨∏</h4>
                            <ol>
                                ${stageData.discussionQuestions.map(q => `<li>${q}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                }
            }

            if (completedStages.includes(stageNumber)) {
                contentHtml += `<div class="stage-completed-notice">‚úîÔ∏è Ïù¥ Ïä§ÌÖåÏù¥ÏßÄÎ•º ÏôÑÎ£åÌñàÏäµÎãàÎã§!</div>`;
            } else if (!stageData.icebreaker || completedIcebreakers.some(item => item.stage === stageNumber)) { // Only show complete button if icebreaker is done
                contentHtml += `<button id="complete-stage-btn" class="modal-button primary" style="width:100%; margin-top:20px; background-color: #28a745;" onclick="completeStage(${stageNumber})">Ïä§ÌÖåÏù¥ÏßÄ ÏôÑÎ£å Î∞è Î≥¥ÏÉÅ Î∞õÍ∏∞ üèÜ</button>`;
            }
            
            const stageContentElement = document.getElementById('stage-content');
            stageContentElement.innerHTML = contentHtml;
            
            document.querySelector('.content').scrollTop = 0;
        }

        // Internal function to render just the main content (lessons, discussion, complete button)
        // This is called after icebreaker is handled
        function _renderStageMainContent(stageNumber) {
            const stageData = stageContents[stageNumber];
            let contentHtml = `<h3 style="margin-bottom: 20px; color: var(--lesson-title-color);">${stageData.title}</h3>`;

            // Render lessons and discussion only if icebreaker is completed
            if (!stageData.icebreaker || completedIcebreakers.some(item => item.stage === stageNumber)) {
                contentHtml += stageData.lessons.map(lesson => `
                    <div class="lesson-container">
                        <div class="lesson-header">
                            <div class="lesson-icon">${lesson.icon}</div>
                            <div class="lesson-title">${lesson.title}</div>
                        </div>
                        <div class="lesson-content">${lesson.content}</div>
                    </div>
                `).join('');

                if (stageData.discussionQuestions) {
                    contentHtml += `
                        <div class="discussion-container">
                            <h4>ü§î Ìï®Íªò ÎÇòÎàå ÏßàÎ¨∏</h4>
                            <ol>
                                ${stageData.discussionQuestions.map(q => `<li>${q}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                }
            }

            if (completedStages.includes(stageNumber)) {
                contentHtml += `<div class="stage-completed-notice">‚úîÔ∏è Ïù¥ Ïä§ÌÖåÏù¥ÏßÄÎ•º ÏôÑÎ£åÌñàÏäµÎãàÎã§!</div>`;
            } else if (!stageData.icebreaker || completedIcebreakers.some(item => item.stage === stageNumber)) { // Only show complete button if icebreaker is done
                contentHtml += `<button id="complete-stage-btn" class="modal-button primary" style="width:100%; margin-top:20px; background-color: #28a745;" onclick="completeStage(${stageNumber})">Ïä§ÌÖåÏù¥ÏßÄ ÏôÑÎ£å Î∞è Î≥¥ÏÉÅ Î∞õÍ∏∞ üèÜ</button>`;
            }

            const stageContentElement = document.getElementById('stage-content');
            stageContentElement.innerHTML = contentHtml;
            document.querySelector('.content').scrollTop = 0;
        }


        function backToStages() {
            document.getElementById('stage-detail').classList.add('hidden');
            document.getElementById('stage-list').classList.remove('hidden');
            currentStage = null;
            updateIcebreakerRecordsDisplay(); // Update records when going back to stage list
        }

        function completeStage(stageNumber) {
            if (completedStages.includes(stageNumber)) return;

            const stageData = stageContents[stageNumber];
            let levelGain = 3000; // Î™®Îì† Ïä§ÌÖåÏù¥ÏßÄ ÏôÑÎ£å Ïãú 3000Î†àÎ≤® Ï¶ùÍ∞Ä
            let itemName = stageData.item || 'ÌäπÎ≥ÑÌïú ÏïÑÏù¥ÌÖú'; // Ïä§ÌÖåÏù¥ÏßÄÎ≥Ñ ÏïÑÏù¥ÌÖú Ïù¥Î¶Ñ

            grantBadge(`${itemName} ÌöçÎìù`); // ÏïÑÏù¥ÌÖú ÌöçÎìù Î±ÉÏßÄ Î∂ÄÏó¨
            addExperience(levelGain, `üéâ Ïä§ÌÖåÏù¥ÏßÄ ${stageNumber} ÏôÑÎ£å! ${itemName} ÌöçÎìù! Î†àÎ≤® +${levelGain}!`);
            completedStages.push(stageNumber);
            
            const button = document.getElementById('complete-stage-btn');
            if (button) {
                button.remove();
                // Ïä§ÌÖåÏù¥ÏßÄ ÏôÑÎ£å ÌõÑ Îã§Ïãú ÏΩòÌÖêÏ∏†Î•º Î°úÎìúÌïòÏó¨ ÏôÑÎ£å Î©îÏãúÏßÄ ÌëúÏãú
                _renderStageMainContent(stageNumber); 
            }

            updateUI();
            saveProgress();
        }

        // Modified togglePrayerTime function
        function togglePrayerTime(timeSlot, element) {
            if (prayerTimes[timeSlot]) {
                // Already completed, un-complete it
                prayerTimes[timeSlot] = false;
                element.classList.remove('completed');
                showNotification(`${timeSlot} Í∏∞ÎèÑ Ï∑®ÏÜå! üôè`);
                // Optionally, deduct EXP or revert badge if desired. For now, just UI.
            } else {
                // Not completed, complete it
                prayerTimes[timeSlot] = true;
                element.classList.add('completed');
                
                let message = '';
                let expGain = 30;
                
                switch(timeSlot) {
                    case 'morning': message = 'üåÖ ÏïÑÏπ® Í∏∞ÎèÑ ÏôÑÎ£å! ÌïòÎ£®Î•º Ï£ºÎãòÍ≥º Ìï®Íªò ÏãúÏûëÌïòÏÑ∏Ïöî!'; break;
                    case 'noon': message = '‚òÄÔ∏è Ï†êÏã¨ Í∏∞ÎèÑ ÏôÑÎ£å! ÌïòÎ£® Ï§ëÎ∞ò, Ï£ºÎãòÍªò Í∞êÏÇ¨ÎìúÎ†§Ïöî!'; break;
                    case 'evening': message = 'üåô Ï†ÄÎÖÅ Í∏∞ÎèÑ ÏôÑÎ£å! ÌïòÎ£®Î•º Ï£ºÎãòÍªò Îß°Í≤®ÎìúÎ†§Ïöî!'; break;
                }
                
                addExperience(expGain, message);
                grantBadge('Ï≤´ Í∏∞ÎèÑ');
                
                if (prayerTimes.morning && prayerTimes.noon && prayerTimes.evening) { // Fixed typo: prayerTimes.timeslot -> prayerTimes.evening
                    setTimeout(() => {
                        addExperience(50, 'üéâ 10-10-10 Í∏∞ÎèÑÎ≤ï ÏôÑÏ£º! Î≥¥ÎÑàÏä§ Í≤ΩÌóòÏπò +50!');
                        grantBadge('10-10-10 ÎßàÏä§ÌÑ∞');
                    }, 1000);
                }
                
                completedMissions++;
            }
            updateUI();
            saveProgress();
        }

        function showScripture() {
            const container = document.getElementById('scripture-container');
            const randomScripture = scriptures[Math.floor(Math.random() * scriptures.length)];
            
            container.innerHTML = `
                <div class="scripture-card">
                    <div class="scripture-text">"${randomScripture.text}"</div>
                    <div class="scripture-reference">- ${randomScripture.reference} -</div>
                </div>
                <button class="mission-button" onclick="completeMission(this, 'ÎßêÏîÄ Î¨µÏÉÅ ÏôÑÎ£å! ÏòÅÏñëÎ∂ÑÏùÑ ÏñªÏóàÏäµÎãàÎã§! üìñ', 70, 'ÏÑ±Í≤Ω ÎèÖÏûê')" style="margin-top: 10px;">Î¨µÏÉÅ ÏôÑÎ£å</button>
            `;
            document.getElementById('mission-btn-scripture').style.display = 'none';
        }
        
        function completeMission(button, message, expGain = 50, badgeToGrant = null) {
            button.textContent = 'ÏôÑÎ£å!';
            button.disabled = true;
            
            addExperience(expGain, message);
            if (badgeToGrant) grantBadge(badgeToGrant);
            
            completedMissions++;
            updateUI();
            saveProgress();
        }

        function addExperience(amount, notificationMessage) {
            userExp += amount;
            
            if (notificationMessage) {
                showNotification(notificationMessage);
            }

            while (userExp >= 100) {
                userLevel++;
                userExp -= 100;
                setTimeout(() => showNotification(`üéâ Î†àÎ≤®ÏóÖ! Lv.${userLevel} Îã¨ÏÑ±!`), 500);
            }
            updateUI();
        }

        // --- UI and Utility Functions ---
        function updateUI() {
            // Update job title based on level
            userJob = getUserJobTitle(userLevel);
            
            // Header
            document.getElementById('userName').textContent = userName;
            document.getElementById('headerAvatar').textContent = userAvatar;
            document.getElementById('userLevel').textContent = userLevel;
            document.getElementById('userExp').textContent = userExp;
            document.getElementById('userStreak').textContent = userStreak;
            
            // Profile Tab
            document.getElementById('profileUserName').textContent = userName;
            document.getElementById('profileAvatar').textContent = userAvatar;
            document.getElementById('profileLevel').textContent = userLevel;
            document.getElementById('profileJob').textContent = userJob;
            document.getElementById('profileStreak').textContent = userStreak;
            document.getElementById('completedMissionsCount').textContent = completedMissions;
            
            // Guild Tab
            document.getElementById('guildUserName').textContent = userName;
            document.getElementById('guildUserAvatar').textContent = userAvatar;
            document.getElementById('guildUserLevel').textContent = userLevel;
            document.getElementById('guildUserJob').textContent = userJob;
            document.getElementById('guildUserStreak').textContent = userStreak;
            document.getElementById('guildLevel').textContent = guildLevel;
            document.getElementById('guildExp').textContent = guildExp;
            
            // Badges
            const badgeContainer = document.getElementById('badge-container');
            if(userBadges.length > 0) {
                badgeContainer.innerHTML = userBadges.map(b => `<span>${b}</span>`).join('');
            } else {
                badgeContainer.innerHTML = `<p style="color: var(--text-color); font-size: 14px;">ÏïÑÏßÅ ÌöçÎìùÌïú Î±ÉÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
            }
        }
        
        function resetMissionUI() {
            // Reset prayer slots
            document.querySelectorAll('.prayer-time-slot').forEach(slot => slot.classList.remove('completed'));
            // Reset mission buttons
            document.querySelectorAll('.mission-button').forEach(btn => {
                btn.disabled = false;
                if(btn.id === 'mission-btn-worship') btn.textContent = 'Ï∞∏Ïó¨ ÏôÑÎ£å';
                if(btn.id === 'mission-btn-quiz') btn.textContent = 'ÌÄ¥Ï¶à ÏãúÏûë';
                if(btn.id === 'mission-btn-minigame') btn.textContent = 'ÎØ∏ÎãàÍ≤åÏûÑ ÏãúÏûë';
            });
            document.getElementById('mission-btn-scripture').style.display = 'inline-block';
            document.getElementById('scripture-container').innerHTML = '';
            document.getElementById('minigame-selection-container').innerHTML = ''; // Clear mini-game selection
            document.getElementById('guild-chat-container').innerHTML = ''; // Clear guild tab chat
        }

        function showNotification(message) {
            const existingNotif = document.querySelector('.floating-notification');
            if(existingNotif) existingNotif.remove();
            const notification = document.createElement('div');
            notification.className = 'floating-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // --- Data Persistence ---
        function saveProgress() {
            try {
                const data = {
                    userName, userAvatar, userJob, userLevel, userExp, userStreak,
                    completedMissions, userBadges, completedStages, guildLevel, guildExp, 
                    chatMessages, prayerTimes, notices, qtNotes, currentTheme,
                    quizCompletedPerStage, completedIcebreakers, miniGameCompletedToday, miniGameProgress, // Save new states
                    lastLogin: new Date().toDateString()
                };
                
                const success = safeSetItem('blueWindProgress', JSON.stringify(data));
                if (!success && !isLocalStorageAvailable()) {
                    // localStorage ÏÇ¨Ïö© Î∂àÍ∞Ä Ïãú Ìïú Î≤àÎßå ÏïåÎ¶º
                    if (!memoryStorage._warningShown) {
                        showNotification('Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏúºÎ°ú Ïù∏Ìï¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ∏ÏÖò ÎèôÏïàÎßå Ïú†ÏßÄÎê©ÎãàÎã§. üìù');
                        memoryStorage._warningShown = true;
                    }
                }
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
                showNotification('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        function loadProgress() {
            try {
                const saved = safeGetItem('blueWindProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    userName = data.userName || 'Ìë∏Î•∏Ïù¥';
                    userAvatar = data.userAvatar || 'üåü';
                    userLevel = data.userLevel || 1;
                    userExp = data.userExp || 0;
                    userStreak = data.userStreak || 1;
                    completedMissions = data.completedMissions || 0;
                    userJob = data.userJob || getUserJobTitle(userLevel);
                    userBadges = data.userBadges || [];
                    completedStages = data.completedStages || [];
                    guildLevel = data.guildLevel || 1;
                    guildExp = data.guildExp || 0;
                    chatMessages = data.chatMessages || [];
                    notices = data.notices || [];
                    qtNotes = data.qtNotes || [];
                    currentTheme = data.currentTheme || 'light-mode'; // Load theme
                    quizCompletedPerStage = data.quizCompletedPerStage || {}; // Load quiz completion per stage
                    completedIcebreakers = data.completedIcebreakers || []; // Load icebreaker completion
                    miniGameCompletedToday = data.miniGameCompletedToday || false; // Load mini-game completion
                    miniGameProgress = data.miniGameProgress || {}; // Load individual mini-game progress

                    const today = new Date().toDateString();
                    const lastLogin = data.lastLogin || today;

                    if (lastLogin !== today) {
                        const lastDate = new Date(lastLogin);
                        const todayDate = new Date(today);
                        const diffTime = todayDate - lastDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            userStreak++;
                            setTimeout(() => grantBadge(`${userStreak}Ïùº Ïó∞ÏÜç`), 500);
                        } else if (diffDays > 1) {
                            userStreak = 1;
                        }
                        prayerTimes = { morning: false, noon: false, evening: false };
                        miniGameCompletedToday = false; // Reset daily mini-game mission
                        miniGameProgress = { bibleVerseFill: false, characterGuess: false, trueFalse: false, wordOrder: false, bibleNumber: false }; // Reset individual mini-game progress
                    } else {
                        prayerTimes = data.prayerTimes || { morning: false, noon: false, evening: false };
                        // Ensure miniGameProgress is initialized if it was missing in old saves
                        if (Object.keys(miniGameProgress).length === 0 && miniGameCompletedToday) {
                             // If miniGameCompletedToday is true but progress is empty, it means it was completed
                             // before individual game tracking was added. Assume all are complete.
                             miniGameProgress = { bibleVerseFill: true, characterGuess: true, trueFalse: true, wordOrder: true, bibleNumber: true };
                        } else if (Object.keys(miniGameProgress).length === 0) {
                            // If it's a new day or new user, initialize to all false
                            miniGameProgress = { bibleVerseFill: false, characterGuess: false, trueFalse: false, wordOrder: false, bibleNumber: false };
                        }
                    }

                    // DOMÏù¥ Î°úÎìúÎêú ÌõÑÏóê Í∏∞ÎèÑ ÏãúÍ∞Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    setTimeout(() => {
                        Object.keys(prayerTimes).forEach(timeSlot => {
                            if (prayerTimes[timeSlot]) {
                                const slotElement = document.querySelector(`.prayer-time-slot[data-slot="${timeSlot}"]`);
                                if (slotElement) slotElement.classList.add('completed');
                            }
                        });
                    }, 100);
                } else {
                    setInitialState();
                }
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                showNotification('Îç∞Ïù¥ÌÑ∞ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ï¥àÍ∏∞ ÏÑ§Ï†ïÏúºÎ°ú ÏãúÏûëÌï©ÎãàÎã§.');
                setInitialState();
            }
            
            // Apply theme after loading
            document.body.className = currentTheme;
            updateUI();
            updateNotices();
            updateQTNotes();
        }
        
        function setInitialState() {
            userLevel = 1;
            userExp = 0;
            userStreak = 1;
            completedMissions = 0;
            userName = 'Ìë∏Î•∏Ïù¥';
            userAvatar = 'üåü';
            userJob = 'Ìë∏Î•∏Ïù¥';
            userBadges = [];
            completedStages = [];
            guildLevel = 1;
            guildExp = 0;
            chatMessages = [];
            prayerTimes = { morning: false, noon: false, evening: false };
            notices = [];
            qtNotes = [];
            currentTheme = 'light-mode';
            quizCompletedPerStage = {}; // Initialize as empty object
            completedIcebreakers = [];
            miniGameCompletedToday = false;
            miniGameProgress = { bibleVerseFill: false, characterGuess: false, trueFalse: false, wordOrder: false, bibleNumber: false }; // Initialize all to false
            
            // Ï¥àÍ∏∞ ÏÉÅÌÉú Ï†ÄÏû• ÏãúÎèÑ
            try {
                saveProgress();
            } catch (error) {
                console.error('Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
            }
        }

        // --- Notice Functions ---
        function showNoticeModal() {
            document.getElementById('noticeModal').style.display = 'flex';
            document.getElementById('noticePassword').focus();
        }

        function createNotice() {
    const password = document.getElementById('noticePassword').value;
    const title = document.getElementById('noticeTitle').value.trim();
    const content = document.getElementById('noticeContent').value.trim();

    if (password !== '0000') {
        showNotification('Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§! ‚ùå');
        return;
    }

    if (!title || !content) {
        showNotification('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
        return;
    }

    const notice = {
        id: Date.now(),
        title: title,
        content: content,
        date: new Date().toLocaleDateString('ko-KR'),
        author: userName
    };

    if (isFirebaseEnabled) {
        // FirebaseÏóê Í≥µÏßÄÏÇ¨Ìï≠ Ï†ÄÏû• (Ïã§ÏãúÍ∞Ñ Í≥µÏú†)
        database.ref('notices').push(notice)
            .then(() => {
                showNotification('Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ Î™®Îì† ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í≥µÏú†ÎêòÏóàÏäµÎãàÎã§! üì¢üî•');
            })
            .catch((error) => {
                console.error('Firebase Ï†ÄÏû• Ïã§Ìå®:', error);
                showNotification('Í≥µÏßÄÏÇ¨Ìï≠ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Î°úÏª¨ÏóêÎßå Ï†ÄÏû•Îê©ÎãàÎã§.');
                notices = [notice];
                updateNotices();
                saveProgress();
            });
    } else {
        notices = [notice];
        updateNotices();
        showNotification('Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§! üì¢ (Î°úÏª¨ Î™®Îìú)');
        saveProgress();
    }

    closeNoticeModal();
}

        function updateNotices() {
            const container = document.getElementById('notices-container');
            if (notices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;">
                        <p>Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                `;
            } else {
                // ÏµúÏã† Í≥µÏßÄÏÇ¨Ìï≠ 1Í∞úÎßå ÌëúÏãú
                const notice = notices[0];
                container.innerHTML = `
                    <div class="notice-card">
                        <div class="notice-header">
                            <div class="notice-title">üì¢ ${notice.title}</div>
                            <div class="notice-date">${notice.date}</div>
                        </div>
                        <div class="notice-content">${notice.content}</div>
                    </div>
                `;
            }
        }

        // --- QT Note Functions ---
        function showQTNoteModal() {
            editingQTNote = null;
            document.getElementById('qtModalTitle').textContent = 'QT ÎÖ∏Ìä∏ ÏûëÏÑ±';
            document.getElementById('qtSubmitBtn').textContent = 'ÏûëÏÑ± ÏôÑÎ£å';
            document.getElementById('qtSubmitBtn').onclick = createQTNote;
            document.getElementById('qtNoteTitle').value = '';
            document.getElementById('qtNoteContent').value = '';
            document.getElementById('qtNotePassword').value = '';
            document.getElementById('qtNoteModal').style.display = 'flex';
        }

        function closeQTNoteModal() {
            document.getElementById('qtNoteModal').style.display = 'none';
        }

        function createQTNote() {
            const title = document.getElementById('qtNoteTitle').value.trim();
            const content = document.getElementById('qtNoteContent').value.trim();
            const password = document.getElementById('qtNotePassword').value.trim();

            if (!title || !content || !password) {
                showNotification('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            if (editingQTNote) {
                // ÏàòÏ†ï Î™®Îìú
                editingQTNote.title = title;
                editingQTNote.content = content;
                editingQTNote.password = password; // ÎπÑÎ∞ÄÎ≤àÌò∏ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ Í∞ÄÎä•
                editingQTNote.date = new Date().toLocaleDateString('ko-KR');
                showNotification('QT ÎÖ∏Ìä∏Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§! ‚úèÔ∏è');
            } else {
                // ÏÉà ÏûëÏÑ± Î™®Îìú
                const qtNote = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    password: password,
                    author: userName,
                    date: new Date().toLocaleDateString('ko-KR'),
                    likes: 0,
                    likedBy: [], // Ï¢ãÏïÑÏöî ÎàÑÎ•∏ ÏÇ¨Ïö©Ïûê ÎãâÎÑ§ÏûÑ Î™©Î°ù
                    comments: [] // Initialize comments array
                };
                qtNotes.unshift(qtNote);
                showNotification('QT ÎÖ∏Ìä∏Í∞Ä ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§! üìù');
            }

            updateQTNotes();
            closeQTNoteModal();
            saveProgress();
        }

        function updateQTNotes() {
            const container = document.getElementById('qt-notes-container');
            if (qtNotes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;">
                        <p>ÏûëÏÑ±Îêú QT ÎÖ∏Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                        <p>Ï≤´ Î≤àÏß∏ QT ÎÖ∏Ìä∏Î•º ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî! üìù</p>
                    </div>
                `;
            } else {
                container.innerHTML = qtNotes.map(note => `
                    <div class="qt-note-card">
                        <div class="qt-note-header">
                            <div class="qt-note-title">${note.title}</div>
                            <div class="qt-note-date">${note.date}</div>
                        </div>
                        <div class="qt-note-content">${note.content}</div>
                        <div class="qt-note-actions">
                            <button class="like-button" onclick="toggleLike(${note.id})">
                                ${note.likedBy.includes(userName) ? '‚ù§Ô∏è' : 'ü§ç'} ${note.likes}
                            </button>
                            ${note.author === userName ? `
                                <div class="note-buttons">
                                    <button class="note-btn edit" onclick="editQTNote(${note.id})">ÏàòÏ†ï</button>
                                    <button class="note-btn delete" onclick="deleteQTNote(${note.id})">ÏÇ≠Ï†ú</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="comments-section">
                            <h5>üí¨ ÎåìÍ∏Ä (${note.comments.length})</h5>
                            <div class="comment-input-container">
                                <textarea id="commentInput-${note.id}" class="comment-input" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." rows="2"></textarea>
                                <input type="password" id="commentPassword-${note.id}" class="comment-password-input" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ (ÏàòÏ†ï/ÏÇ≠Ï†úÏö©)" maxlength="10">
                                <button class="comment-send-btn" onclick="addComment(${note.id})">ÎåìÍ∏Ä ÏûëÏÑ±</button>
                            </div>
                            <div class="comment-list">
                                ${note.comments.length === 0 ? `<p style="color: var(--text-color); text-align: center;">ÏïÑÏßÅ ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</p>` : note.comments.map(comment => `
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <span class="comment-author">${comment.author}</span>
                                            <span class="comment-time">${comment.time}</span>
                                        </div>
                                        <div class="comment-content">${comment.content}</div>
                                        ${comment.author === userName ? `
                                            <div class="comment-actions">
                                                <button class="comment-action-btn edit" onclick="editComment(${note.id}, ${comment.id})">ÏàòÏ†ï</button>
                                                <button class="comment-action-btn delete" onclick="deleteComment(${note.id}, ${comment.id})">ÏÇ≠Ï†ú</button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleLike(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            if (note.likedBy.includes(userName)) {
                // Ï¢ãÏïÑÏöî Ï∑®ÏÜå
                note.likedBy = note.likedBy.filter(name => name !== userName);
                note.likes--;
                showNotification('Ï¢ãÏïÑÏöîÎ•º Ï∑®ÏÜåÌñàÏäµÎãàÎã§ üíî');
            } else {
                // Ï¢ãÏïÑÏöî Ï∂îÍ∞Ä
                note.likedBy.push(userName);
                note.likes++;
                showNotification('Ï¢ãÏïÑÏöîÎ•º ÎàåÎ†ÄÏäµÎãàÎã§! ‚ù§Ô∏è');
            }

            updateQTNotes();
            saveProgress();
        }

        // --- Comment Functions ---
        function addComment(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            const inputElement = document.getElementById(`commentInput-${noteId}`);
            const passwordElement = document.getElementById(`commentPassword-${noteId}`);
            const commentContent = inputElement.value.trim();
            const commentPassword = passwordElement.value.trim();

            if (!commentContent || !commentPassword) {
                showNotification('ÎåìÍ∏Ä ÎÇ¥Ïö©Í≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            const newComment = {
                id: Date.now(),
                author: userName,
                avatar: userAvatar,
                content: commentContent,
                password: commentPassword,
                time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            };

            note.comments.push(newComment);
            inputElement.value = '';
            passwordElement.value = '';
            showNotification('ÎåìÍ∏ÄÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§! üí¨');
            updateQTNotes();
            saveProgress();
        }

        function editComment(noteId, commentId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;
            const comment = note.comments.find(c => c.id === commentId);
            if (!comment) return;

            pendingQTAction = { type: 'comment', action: 'edit', noteId: noteId, commentId: commentId };
            document.getElementById('passwordModalText').textContent = 'ÎåìÍ∏ÄÏùÑ ÏàòÏ†ïÌïòÎ†§Î©¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function deleteComment(noteId, commentId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;
            const comment = note.comments.find(c => c.id === commentId);
            if (!comment) return;

            pendingQTAction = { type: 'comment', action: 'delete', noteId: noteId, commentId: commentId };
            document.getElementById('passwordModalText').textContent = 'ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÎ†§Î©¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        // Modified confirmQTAction to handle both QT notes and comments
        function confirmQTAction() {
            if (!pendingQTAction) return;

            const password = document.getElementById('qtActionPassword').value;
            let targetItem = null; // Either a QT note or a comment

            if (pendingQTAction.type === 'qtNote') {
                targetItem = qtNotes.find(n => n.id === pendingQTAction.noteId);
            } else if (pendingQTAction.type === 'comment') {
                const note = qtNotes.find(n => n.id === pendingQTAction.noteId);
                if (note) {
                    targetItem = note.comments.find(c => c.id === pendingQTAction.commentId);
                }
            }

            if (!targetItem || targetItem.password !== password) {
                showNotification('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§! ‚ùå');
                document.getElementById('qtActionPassword').value = ''; // Clear password on wrong attempt
                return;
            }

            if (pendingQTAction.type === 'qtNote') {
                if (pendingQTAction.action === 'edit') {
                    editingQTNote = targetItem;
                    document.getElementById('qtModalTitle').textContent = 'QT ÎÖ∏Ìä∏ ÏàòÏ†ï';
                    document.getElementById('qtSubmitBtn').textContent = 'ÏàòÏ†ï ÏôÑÎ£å';
                    document.getElementById('qtSubmitBtn').onclick = createQTNote;
                    document.getElementById('qtNoteTitle').value = targetItem.title;
                    document.getElementById('qtNoteContent').value = targetItem.content;
                    document.getElementById('qtNotePassword').value = targetItem.password;
                    document.getElementById('qtNoteModal').style.display = 'flex';
                } else if (pendingQTAction.action === 'delete') {
                    qtNotes = qtNotes.filter(n => n.id !== pendingQTAction.noteId);
                    updateQTNotes();
                    showNotification('QT ÎÖ∏Ìä∏Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§! üóëÔ∏è');
                    saveProgress();
                }
            } else if (pendingQTAction.type === 'comment') {
                const note = qtNotes.find(n => n.id === pendingQTAction.noteId);
                if (!note) return;

                if (pendingQTAction.action === 'edit') {
                    const newContent = prompt('ÏÉàÎ°úÏö¥ ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', targetItem.content);
                    if (newContent !== null) { // User didn't cancel
                        targetItem.content = newContent.trim();
                        targetItem.time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) + ' (ÏàòÏ†ïÎê®)';
                        showNotification('ÎåìÍ∏ÄÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§! ‚úèÔ∏è');
                    }
                } else if (pendingQTAction.action === 'delete') {
                    note.comments = note.comments.filter(c => c.id !== pendingQTAction.commentId);
                    showNotification('ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§! üóëÔ∏è');
                }
                updateQTNotes();
                saveProgress();
            }

            closeQTPasswordModal();
            document.getElementById('qtActionPassword').value = ''; // Clear password after successful action
        }

        function closeQTPasswordModal() {
            document.getElementById('qtPasswordModal').style.display = 'none';
            document.getElementById('qtActionPassword').value = '';
            pendingQTAction = null;
        }

        // --- Badge Functions ---
        function grantBadge(badgeName) {
            if (!userBadges.includes(badgeName)) {
                userBadges.push(badgeName);
                showNotification(`üèÜ Î±ÉÏßÄ ÌöçÎìù: ${badgeName}!`);
                updateUI();
                saveProgress();
            }
        }

        // --- Chat Functions ---
        // showGuildChat is now implicitly handled by showTab('guild', ...)
        // and its content is directly injected.
        function showGuildChat() {
            // This function is no longer needed as chat is direct on guild tab
            showTab('guild', document.querySelector('.nav-item:nth-child(3)')); // Activate guild tab
        }
        
        function createChatInterface(prefix) {
            return `
                <div class="chat-container">
                    <div class="chat-messages" id="${prefix}Messages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="${prefix}Input" placeholder="Í∏∏ÎìúÏõêÎì§Í≥º ÎåÄÌôîÌï¥Î≥¥ÏÑ∏Ïöî..." onkeypress="handleChatKeyPress(event, '${prefix}')">
                        <button class="image-upload-btn" onclick="document.getElementById('${prefix}FileInput').click()">üì∑</button>
                        <button class="chat-send-btn" onclick="sendMessage('${prefix}')">Ï†ÑÏÜ°</button>
                        <input type="file" id="${prefix}FileInput" class="hidden-file-input" accept="image/*" onchange="handleImageUpload(event, '${prefix}')">
                    </div>
                </div>
            `;
        }

        function updateChatMessages(prefix) {
            const messagesContainer = document.getElementById(`${prefix}Messages`);
            if (!messagesContainer) return;
            
            if (chatMessages.length === 0) {
                messagesContainer.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px;"><p>Ï≤´ Î≤àÏß∏ Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥Î≥¥ÏÑ∏Ïöî! üí¨</p></div>`;
            } else {
                messagesContainer.innerHTML = chatMessages.map(msg => {
                    let messageContent = `<div class="message-bubble">${msg.message}</div>`;
                    if (msg.image) {
                        messageContent += `<img src="${msg.image}" alt="ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ" class="message-image" onclick="showImageModal('${msg.image}')">`;
                    }
                    
                    return `
                        <div class="message ${msg.sender === userName ? 'user' : 'other'}">
                            <div class="message-header">
                                <div class="message-avatar">${msg.avatar || 'üë§'}</div>
                                <div class="message-sender">${msg.sender}</div>
                                <div class="message-time">${msg.time}</div>
                            </div>
                            ${messageContent}
                        </div>
                    `;
                }).join('');
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleImageUpload(event, prefix) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) { // 5MB Ï†úÌïú
                showNotification('Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Îäî 5MB Ïù¥ÌïòÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§! üì∑');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                chatMessages.push({ 
                    sender: userName, 
                    avatar: userAvatar, 
                    message: 'ÏÇ¨ÏßÑÏùÑ ÏóÖÎ°úÎìúÌñàÏäµÎãàÎã§ üì∑', 
                    image: e.target.result,
                    time: timeString 
                });
                
                if (document.getElementById('chatMessages')) updateChatMessages('chat');
                if (document.getElementById('guildMessages')) updateChatMessages('guild'); // Changed to guildMessages for guild chat
                
                showNotification('ÏÇ¨ÏßÑÏù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§! üì∑');
                saveProgress();
            };
            reader.readAsDataURL(file);
            
            // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
            event.target.value = '';
        }

        function showImageModal(imageSrc) {
            // Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄ Î≥¥Í∏∞ Î™®Îã¨ ÏÉùÏÑ±
            const existingModal = document.getElementById('imageViewModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'imageViewModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%; padding: 20px;">
                    <div class="modal-title">Ïù¥ÎØ∏ÏßÄ Î≥¥Í∏∞</div>
                    <img src="${imageSrc}" style="max-width: 100%; max-height: 70vh; border-radius: 10px;">
                    <div class="modal-buttons" style="margin-top: 15px;">
                        <button class="modal-button secondary" onclick="closeImageModal()">Îã´Í∏∞</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Î™®Îã¨ Î∞∞Í≤Ω ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeImageModal();
            });
        }

        function closeImageModal() {
            const modal = document.getElementById('imageViewModal');
            if (modal) modal.remove();
        }

        function sendMessage(prefix) {
    const input = document.getElementById(`${prefix}Input`);
    const message = input.value.trim();
    if (message) {
        const now = new Date();
        const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        
        const messageData = { 
            id: Date.now(),
            sender: userName, 
            avatar: userAvatar, 
            message: message, 
            time: timeString,
            timestamp: now.getTime()
        };

        if (isFirebaseEnabled) {
            database.ref('chatMessages').push(messageData)
                .then(() => {
                    console.log('Î©îÏãúÏßÄÍ∞Ä Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í≥µÏú†ÎêòÏóàÏäµÎãàÎã§!');
                })
                .catch((error) => {
                    console.error('Firebase Î©îÏãúÏßÄ Ï†ÄÏû• Ïã§Ìå®:', error);
                    chatMessages.push(messageData);
                    if (document.getElementById('guildMessages')) updateChatMessages('guild');
                    saveProgress();
                });
        } else {
            chatMessages.push(messageData);
            if (document.getElementById('guildMessages')) updateChatMessages('guild');
            saveProgress();
        }

        input.value = '';
    }
}

        function handleChatKeyPress(event, prefix) {
            if (event.key === 'Enter') sendMessage(prefix);
        }

        // --- Quiz Functions (for home tab quiz mission) ---
        let currentQuizIndex = 0;

        function startQuiz() {
            const lastQuizMissionDate = safeGetItem('lastQuizMissionDate');
            const today = new Date().toDateString();

            if (lastQuizMissionDate === today) {
                showNotification('Ïò§ÎäòÏùÄ Ïù¥ÎØ∏ ÌÄ¥Ï¶à ÎØ∏ÏÖòÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§! ÎÇ¥Ïùº Îã§Ïãú ÎèÑÏ†ÑÌï¥Ï£ºÏÑ∏Ïöî. üòä');
                return;
            }

            currentQuizIndex = 0;
            displayQuizQuestion();
            document.getElementById('minigameModal').style.display = 'flex'; // Use minigameModal for quiz
        }

        function displayQuizQuestion() {
            const minigameContent = document.getElementById('minigame-content');
            const questionData = quizQuestions[currentQuizIndex];

            if (!questionData) {
                // All questions answered
                minigameContent.innerHTML = `
                    <div class="modal-title">ÌÄ¥Ï¶à ÏôÑÎ£å!</div>
                    <p style="color: var(--text-color); margin-bottom: 20px;">Î™®Îì† ÌÄ¥Ï¶àÎ•º ÏôÑÎ£åÌñàÏäµÎãàÎã§. ÎåÄÎã®Ìï¥Ïöî! üéâ</p>
                    <div class="modal-buttons">
                        <button class="modal-button primary" onclick="completeQuizMission()">Î≥¥ÏÉÅ Î∞õÍ∏∞</button>
                        <button class="modal-button secondary" onclick="closeMinigameModal()">Îã´Í∏∞</button>
                    </div>
                `;
                return;
            }

            let optionsHtml = questionData.options.map(option => `
                <button class="quiz-option" onclick="checkQuizAnswer('${option}')">${option}</button>
            `).join('');

            minigameContent.innerHTML = `
                <div class="modal-title">Ïã†Ïïô ÌÄ¥Ï¶à (${currentQuizIndex + 1}/${quizQuestions.length})</div>
                <p style="color: var(--text-color); margin-bottom: 20px; font-weight: bold;">${questionData.question}</p>
                <div>${optionsHtml}</div>
            `;
        }

        function checkQuizAnswer(selectedOption) {
            const questionData = quizQuestions[currentQuizIndex];
            if (selectedOption === questionData.answer) {
                showNotification('Ï†ïÎãµÏûÖÎãàÎã§! ü•≥');
                currentQuizIndex++;
                setTimeout(displayQuizQuestion, 500); // Show next question after a short delay
            } else {
                showNotification('Ïò§ÎãµÏûÖÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî. üòî');
            }
        }

        function completeQuizMission() {
            addExperience(50, 'ÌÄ¥Ï¶à ÎØ∏ÏÖò ÏôÑÎ£å! ÏßÄÌòúÍ∞Ä +50 Ï¶ùÍ∞ÄÌñàÏäµÎãàÎã§! üß†');
            grantBadge('ÌÄ¥Ï¶à ÎßàÏä§ÌÑ∞');
            safeSetItem('lastQuizMissionDate', new Date().toDateString()); // Mark daily quiz mission complete
            
            const quizButton = document.getElementById('mission-btn-quiz');
            if (quizButton) {
                quizButton.textContent = 'ÏôÑÎ£å!';
                quizButton.disabled = true;
            }
            closeMinigameModal();
            saveProgress();
        }

        function closeMinigameModal() {
            document.getElementById('minigameModal').style.display = 'none';
        }

        // --- Icebreaker Functions ---
        let currentIcebreakerStage = null;

        function completeIcebreaker(stageNumber) {
            const answer = document.getElementById(`icebreakerInput-${stageNumber}`).value.trim();
            if (!answer) {
                showNotification('ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            // Update completedIcebreakers array
            const today = new Date().toLocaleDateString('ko-KR');
            let existingEntry = completedIcebreakers.find(item => item.stage === stageNumber);
            if (existingEntry) {
                existingEntry.answer = answer;
                existingEntry.date = today;
            } else {
                completedIcebreakers.push({ stage: stageNumber, answer: answer, date: today });
            }
            // Sort to ensure order in display
            completedIcebreakers.sort((a, b) => a.stage - b.stage);

            showNotification(`ÏïÑÏù¥Ïä§Î∏åÎ†àÏù¥ÌÅ¨ ÏôÑÎ£å! Ïä§ÌÖåÏù¥ÏßÄ ${stageNumber}Ïùò Î¨∏Ïù¥ Ïó¥Î†∏ÏäµÎãàÎã§!`);
            saveProgress();
            
            // After icebreaker, proceed to render main content
            _renderStageMainContent(stageNumber); 
            updateIcebreakerRecordsDisplay(); // Update records display immediately
        }

        // Function to display icebreaker records
        function updateIcebreakerRecordsDisplay() {
            const container = document.getElementById('icebreaker-records-container');
            if (!container) return;

            if (completedIcebreakers.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;">
                                            <p>ÏïÑÏßÅ ÏûëÏÑ±Îêú ÏïÑÏù¥Ïä§Î∏åÎ†àÏù¥ÌÅ¨ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                                            <p>ÌïôÏäµ Ïä§ÌÖåÏù¥ÏßÄÎ•º ÏãúÏûëÌïòÏó¨ Ï≤´ Í∏∞Î°ùÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî! ‚ú®</p>
                                        </div>`;
            } else {
                container.innerHTML = completedIcebreakers.map(record => `
                    <div class="qt-note-card" style="margin-bottom: 10px;">
                        <div class="qt-note-header">
                            <div class="qt-note-title">Ïä§ÌÖåÏù¥ÏßÄ ${record.stage} ÏïÑÏù¥Ïä§Î∏åÎ†àÏù¥ÌÅ¨</div>
                            <div class="qt-note-date">${record.date}</div>
                        </div>
                        <div class="qt-note-content">${record.answer}</div>
                    </div>
                `).join('');
            }
        }


        // --- Mini-game Functions (for home tab) ---
        const miniGames = {
            'bibleVerseFill': {
                name: 'ÏÑ±Í≤Ω Íµ¨Ï†à ÎπàÏπ∏ Ï±ÑÏö∞Í∏∞',
                prompt: 'Îã§Ïùå ÏÑ±Í≤Ω Íµ¨Ï†àÏùò ÎπàÏπ∏ÏùÑ Ï±ÑÏö∞ÏÑ∏Ïöî.',
                data: [
                    { verse: "ÌïòÎÇòÎãòÏù¥ ÏÑ∏ÏÉÅÏùÑ Ïù¥Ï≤òÎüº ÏÇ¨ÎûëÌïòÏÇ¨ ÎèÖÏÉùÏûêÎ•º Ï£ºÏÖ®ÏúºÎãà Ïù¥Îäî Í∑∏Î•º ÎØøÎäî ÏûêÎßàÎã§ Î©∏ÎßùÌïòÏßÄ ÏïäÍ≥† [ ]ÏùÑ ÏñªÍ≤å ÌïòÎ†§ ÌïòÏã¨Ïù¥Îùº.", blankWord: "ÏòÅÏÉù", hint: "ÏòÅÏõêÌïú ÏÇ∂" },
                    { verse: "Ïó¨Ìò∏ÏôÄÎäî ÎÇòÏùò [ ]ÏãúÎãà ÎÇ¥Í≤å Î∂ÄÏ°±Ìï®Ïù¥ ÏóÜÏúºÎ¶¨Î°úÎã§.", blankWord: "Î™©Ïûê", hint: "ÏñëÏùÑ ÎèåÎ≥¥Îäî ÏÇ¨Îûå" },
                    { verse: "ÎÇ¥Í≤å Îä•Î†• Ï£ºÏãúÎäî Ïûê ÏïàÏóêÏÑú ÎÇ¥Í∞Ä Î™®Îì† Í≤ÉÏùÑ [ ] Ïàò ÏûàÎäêÎãàÎùº.", blankWord: "Ìï†", hint: "Îä•Î†•" }
                ],
                exp: 10
            },
            'characterGuess': {
                name: 'ÏÑ±Í≤Ω Ïù∏Î¨º ÎßûÏ∂îÍ∏∞',
                prompt: 'ÏÑ§Î™ÖÏùÑ Îì£Í≥† ÏÑ±Í≤Ω Ïù∏Î¨ºÏùÑ ÎßûÏ∂∞Î≥¥ÏÑ∏Ïöî.',
                data: [
                    { description: "Ïù¥Ïä§ÎùºÏóòÏùò Ï≤´ Î≤àÏß∏ Ïôï", answer: "ÏÇ¨Ïö∏" },
                    { description: "Í≥®Î¶¨ÏïóÏùÑ Î¨ºÎ¶¨Ïπú ÏÜåÎÖÑ Î™©Îèô", answer: "Îã§Ïúó" },
                    { description: "ÌôçÌï¥Î•º Í∞ÄÎ•∏ ÏÑ†ÏßÄÏûê", answer: "Î™®ÏÑ∏" }
                ],
                exp: 10
            },
            'trueFalse': {
                name: 'Ï∞∏/Í±∞Ïßì ÌÄ¥Ï¶à',
                prompt: 'Îã§Ïùå Î¨∏Ïû•Ïù¥ Ï∞∏Ïù∏ÏßÄ Í±∞ÏßìÏù∏ÏßÄ ÎßûÏ∂∞Î≥¥ÏÑ∏Ïöî.',
                data: [
                    { question: "ÎÖ∏ÏïÑÎäî Î∞©Ï£ºÎ•º 100ÎÖÑ ÎèôÏïà ÏßÄÏóàÎã§.", answer: "Ï∞∏" },
                    { question: "ÏòàÏàòÎãòÏùÄ Ïã≠ÏûêÍ∞ÄÏóêÏÑú 3Ïùº ÎßåÏóê Î∂ÄÌôúÌïòÏÖ®Îã§.", answer: "Ï∞∏" },
                    { question: "ÏöîÎÇò ÏÑ†ÏßÄÏûêÎäî Î¨ºÍ≥†Í∏∞ Î±ÉÏÜçÏóêÏÑú 3Ïùº Î∞§ÎÇÆÏùÑ Î≥¥ÎÉàÎã§.", answer: "Ï∞∏" }
                ],
                exp: 10
            },
            'wordOrder': {
                name: 'Îã®Ïñ¥ ÏàúÏÑú ÎßûÏ∂îÍ∏∞',
                prompt: 'Îã®Ïñ¥Î•º Ïò¨Î∞îÎ•∏ ÏàúÏÑúÎ°ú Î∞∞Ïó¥ÌïòÏó¨ Î¨∏Ïû•ÏùÑ ÎßåÎìúÏÑ∏Ïöî.',
                data: [
                    { scrambled: ["Ïò§Îûò", "ÏÇ¨ÎûëÏùÄ", "Ï∞∏Í≥†"], answer: "ÏÇ¨ÎûëÏùÄ Ïò§Îûò Ï∞∏Í≥†" },
                    { scrambled: ["ÎÇòÏùò", "Î™©ÏûêÏãúÎãà", "Ïó¨Ìò∏ÏôÄÎäî"], answer: "Ïó¨Ìò∏ÏôÄÎäî ÎÇòÏùò Î™©ÏûêÏãúÎãà" },
                    { scrambled: ["ÏÑ∏ÏÉÅÏùÑ", "ÌïòÎÇòÎãòÏù¥", "Ïù¥Ï≤òÎüº", "ÏÇ¨ÎûëÌïòÏÇ¨"], answer: "ÌïòÎÇòÎãòÏù¥ ÏÑ∏ÏÉÅÏùÑ Ïù¥Ï≤òÎüº ÏÇ¨ÎûëÌïòÏÇ¨" }
                ],
                exp: 10
            },
            'bibleNumber': {
                name: 'ÏÑ±Í≤Ω Ïà´Ïûê ÌÄ¥Ï¶à',
                prompt: 'Îã§Ïùå ÏßàÎ¨∏Ïóê Ìï¥ÎãπÌïòÎäî Ïà´ÏûêÎ•º ÎßûÏ∂∞Î≥¥ÏÑ∏Ïöî.',
                data: [
                    { question: "ÏòàÏàòÎãòÏù¥ Ïò§Î≥ëÏù¥Ïñ¥ Í∏∞Ï†ÅÏùÑ ÏùºÏúºÌÇ§Ïã§ Îïå Î¨ºÍ≥†Í∏∞Îäî Î™á ÎßàÎ¶¨ÏòÄÏùÑÍπåÏöî?", answer: "Îëê ÎßàÎ¶¨" },
                    { question: "ÎÖ∏ÏïÑÏùò Î∞©Ï£ºÏóê Îì§Ïñ¥Í∞Ñ Ï†ïÍ≤∞Ìïú ÏßêÏäπÏùÄ ÏïîÏàò Î™á ÏåçÏù¥ÏóàÏùÑÍπåÏöî?", answer: "ÏùºÍ≥± Ïåç" },
                    { question: "ÏòàÏàòÎãòÏùò 12Ï†úÏûê Ï§ë Ìïú Î™ÖÏùÄ ÏòàÏàòÎãòÏùÑ ÏùÄ 30Ïóê ÌåîÏïòÏäµÎãàÎã§. Í∑∏ Ï†úÏûêÏùò Ïù¥Î¶ÑÏùÄ?", answer: "Ïú†Îã§" }
                ],
                exp: 10
            }
        };

        let currentMiniGameType = null; // Stores the type of the currently active mini-game
        let currentMiniGameData = null; // Stores the specific data for the current mini-game instance
        let miniGameRound = 0; // Tracks which data item is being used for games with multiple data points

        function showMinigameSelection() {
            const container = document.getElementById('minigame-selection-container');
            const minigameButton = document.getElementById('mission-btn-minigame');

            if (miniGameCompletedToday) {
                showNotification('Ïò§ÎäòÏùÄ Ïù¥ÎØ∏ ÎØ∏ÎãàÍ≤åÏûÑÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§! ÎÇ¥Ïùº Îã§Ïãú ÎèÑÏ†ÑÌï¥Ï£ºÏÑ∏Ïöî. üòä');
                return;
            }

            minigameButton.style.display = 'none'; // Hide the main button

            let selectionHtml = `
                <div class="minigame-selection-card">
                    <h4>Ïñ¥Îñ§ ÎØ∏ÎãàÍ≤åÏûÑÏùÑ ÌïòÏãúÍ≤†Ïñ¥Ïöî?</h4>
                    <div class="minigame-selection-grid">
                        <button class="minigame-button" ${miniGameProgress.bibleVerseFill ? 'disabled' : ''} onclick="startMiniGame('bibleVerseFill')">ÏÑ±Í≤Ω Íµ¨Ï†à ÎπàÏπ∏ Ï±ÑÏö∞Í∏∞</button>
                        <button class="minigame-button" ${miniGameProgress.characterGuess ? 'disabled' : ''} onclick="startMiniGame('characterGuess')">ÏÑ±Í≤Ω Ïù∏Î¨º ÎßûÏ∂îÍ∏∞</button>
                        <button class="minigame-button" ${miniGameProgress.trueFalse ? 'disabled' : ''} onclick="startMiniGame('trueFalse')">Ï∞∏/Í±∞Ïßì ÌÄ¥Ï¶à</button>
                        <button class="minigame-button" ${miniGameProgress.wordOrder ? 'disabled' : ''} onclick="startMiniGame('wordOrder')">Îã®Ïñ¥ ÏàúÏÑú ÎßûÏ∂îÍ∏∞</button>
                        <button class="minigame-button" ${miniGameProgress.bibleNumber ? 'disabled' : ''} onclick="startMiniGame('bibleNumber')">ÏÑ±Í≤Ω Ïà´Ïûê ÌÄ¥Ï¶à</button>
                    </div>
                    <button class="modal-button secondary" style="width:100%; margin-top:15px;" onclick="cancelMinigameSelection()">Ï∑®ÏÜå</button>
                </div>
            `;
            container.innerHTML = selectionHtml;
        }

        function cancelMinigameSelection() {
            document.getElementById('minigame-selection-container').innerHTML = '';
            document.getElementById('mission-btn-minigame').style.display = 'inline-block';
        }

        function startMiniGame(gameType) {
            currentMiniGameType = gameType;
            miniGameRound = 0; // Reset round for new game
            displayMiniGame();
        }

        function displayMiniGame() {
            const container = document.getElementById('minigame-selection-container');
            const gameInfo = miniGames[currentMiniGameType];

            if (!gameInfo || miniGameRound >= gameInfo.data.length) {
                // All rounds for this game completed or no data
                miniGameProgress[currentMiniGameType] = true; // Mark this game as completed
                checkOverallMiniGameCompletion(); // Check if all 5 games are done
                showNotification(`${gameInfo.name} Í≤åÏûÑ ÏôÑÎ£å!`);
                
                // If all games are done, the mission button will be updated.
                // Otherwise, go back to selection or show a message.
                if (Object.values(miniGameProgress).every(status => status === true)) {
                    document.getElementById('minigame-selection-container').innerHTML = ''; // Clear game area
                    document.getElementById('mission-btn-minigame').textContent = 'ÏôÑÎ£å!';
                    document.getElementById('mission-btn-minigame').disabled = true;
                    document.getElementById('mission-btn-minigame').style.display = 'inline-block'; // Show main button again
                } else {
                    // If not all games are done, go back to selection screen
                    showMinigameSelection();
                }
                saveProgress();
                return;
            }

            currentMiniGameData = gameInfo.data[miniGameRound];
            let gameHtml = `<div class="minigame-content-area" id="active-minigame-area">`;

            switch (currentMiniGameType) {
                case 'bibleVerseFill':
                    const verseParts = currentMiniGameData.verse.split('[ ]');
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-style: italic; margin: 10px 0;">${verseParts[0]}<input type="text" id="gameInput" placeholder="${currentMiniGameData.hint}" onkeypress="handleGameInputKeyPress(event)">${verseParts[1]}</p>
                        <button onclick="checkGameAnswer('bibleVerseFill')">ÌôïÏù∏</button>
                    `;
                    break;
                case 'characterGuess':
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-style: italic; margin: 10px 0;">"${currentMiniGameData.description}"</p>
                        <input type="text" id="gameInput" placeholder="Ïù∏Î¨º Ïù¥Î¶Ñ" onkeypress="handleGameInputKeyPress(event)">
                        <button onclick="checkGameAnswer('characterGuess')">ÌôïÏù∏</button>
                    `;
                    break;
                case 'trueFalse':
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-weight: bold; margin: 10px 0;">"${currentMiniGameData.question}"</p>
                        <button class="quiz-option" onclick="checkGameAnswer('trueFalse', 'Ï∞∏')">Ï∞∏</button>
                        <button class="quiz-option" onclick="checkGameAnswer('trueFalse', 'Í±∞Ïßì')">Í±∞Ïßì</button>
                    `;
                    break;
                case 'wordOrder':
                    function shuffleArray(array) {
                        for (let i = array.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [array[i], array[j]] = [array[j], array[i]];
                        }
                        return array;
                    }
                    const shuffledWords = shuffleArray([...currentMiniGameData.scrambled]);
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-size: 20px; font-weight: bold; margin: 10px 0;">${shuffledWords.join(' ')}</p>
                        <input type="text" id="gameInput" placeholder="Ï†ïÎãµ Î¨∏Ïû• ÏûÖÎ†•" onkeypress="handleGameInputKeyPress(event)">
                        <button onclick="checkGameAnswer('wordOrder')">ÌôïÏù∏</button>
                    `;
                    break;
                case 'bibleNumber':
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-weight: bold; margin: 10px 0;">"${currentMiniGameData.question}"</p>
                        <input type="text" id="gameInput" placeholder="Ïà´Ïûê ÎòêÎäî Ïù¥Î¶Ñ" onkeypress="handleGameInputKeyPress(event)">
                        <button onclick="checkGameAnswer('bibleNumber')">ÌôïÏù∏</button>
                    `;
                    break;
            }
            gameHtml += `
                <button class="modal-button secondary" style="margin-top: 20px;" onclick="resetMiniGameSelection()">Îã§Î•∏ Í≤åÏûÑ ÏÑ†ÌÉù</button>
                </div>
            `;
            container.innerHTML = gameHtml;
            if (document.getElementById('gameInput')) {
                document.getElementById('gameInput').focus();
            }
        }

        function handleGameInputKeyPress(event) {
            if (event.key === 'Enter') {
                checkGameAnswer(currentMiniGameType);
            }
        }

        function checkGameAnswer(gameType, selectedOption = null) {
            let isCorrect = false;
            const inputElement = document.getElementById('gameInput');
            const inputValue = inputElement ? inputElement.value.trim() : '';

            switch (gameType) {
                case 'bibleVerseFill':
                    isCorrect = (inputValue.toLowerCase() === currentMiniGameData.blankWord.toLowerCase());
                    break;
                case 'characterGuess':
                    isCorrect = (inputValue.toLowerCase() === currentMiniGameData.answer.toLowerCase());
                    break;
                case 'trueFalse':
                    isCorrect = (selectedOption.toLowerCase() === currentMiniGameData.answer.toLowerCase());
                    break;
                case 'wordOrder':
                    isCorrect = (inputValue.toLowerCase() === currentMiniGameData.answer.toLowerCase());
                    break;
                case 'bibleNumber':
                    isCorrect = (inputValue.toLowerCase() === currentMiniGameData.answer.toLowerCase());
                    break;
            }

            if (isCorrect) {
                showNotification('Ï†ïÎãµÏûÖÎãàÎã§! üéâ');
                addExperience(miniGames[gameType].exp, `${miniGames[gameType].name} ÏôÑÎ£å! Í≤ΩÌóòÏπò +${miniGames[gameType].exp}!`);
                miniGameRound++;
                setTimeout(displayMiniGame, 500); // Go to next round or complete game
            } else {
                showNotification('ÌãÄÎ†∏ÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî. üòî');
                if (inputElement) inputElement.value = ''; // Clear input for another try
            }
            saveProgress();
        }

        function resetMiniGameSelection() {
            currentMiniGameType = null;
            currentMiniGameData = null;
            miniGameRound = 0;
            showMinigameSelection(); // Go back to the game selection screen
        }

        function checkOverallMiniGameCompletion() {
            const allGamesCompleted = Object.values(miniGameProgress).every(status => status === true);
            if (allGamesCompleted && !miniGameCompletedToday) {
                miniGameCompletedToday = true;
                addExperience(30, 'üéâ Ïò§ÎäòÏùò ÎØ∏ÎãàÍ≤åÏûÑ ÎØ∏ÏÖò ÏôÑÎ£å! Î≥¥ÎÑàÏä§ Í≤ΩÌóòÏπò +30!');
                grantBadge('ÎØ∏ÎãàÍ≤åÏûÑ ÎßàÏä§ÌÑ∞');
                document.getElementById('mission-btn-minigame').textContent = 'ÏôÑÎ£å!';
                document.getElementById('mission-btn-minigame').disabled = true;
                saveProgress();
            }
        }


        // --- Modal Functions ---
        function showNameModal() {
            const modal = document.getElementById('nameModal');
            document.getElementById('nameInput').value = userName;
            modal.style.display = 'flex';
            document.getElementById('nameInput').focus();
        }
        function closeNameModal() { document.getElementById('nameModal').style.display = 'none'; }
        function changeName() {
            const newName = document.getElementById('nameInput').value.trim();
            if (newName && newName.length > 0 && newName.length <= 10) {
                userName = newName;
                updateUI();
                closeNameModal();
                showNotification('ÎãâÎÑ§ÏûÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§! üéâ');
                saveProgress();
            } else {
                showNotification('ÎãâÎÑ§ÏûÑÏùÄ 1~10Ïûê ÏÇ¨Ïù¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
            }
        }

        function showAvatarModal() { document.getElementById('avatarModal').style.display = 'flex'; }
        function closeAvatarModal() { document.getElementById('avatarModal').style.display = 'none'; }
        function selectAvatar(emoji) {
            userAvatar = emoji;
            updateUI();
            closeAvatarModal();
            showNotification('ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§! ‚ú®');
            saveProgress();
        }

        function showResetModal() { document.getElementById('resetModal').style.display = 'flex'; }
        function closeResetModal() { document.getElementById('resetModal').style.display = 'none'; }
        function confirmReset() {
            if (document.getElementById('adminPassword').value === '0000') {
                try {
                    safeRemoveItem('blueWindProgress');
                } catch (error) {
                    console.error('Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                }
                // Î©îÎ™®Î¶¨ Ï†ÄÏû•ÏÜåÎèÑ Ï¥àÍ∏∞Ìôî
                memoryStorage = {};
                
                setInitialState();
                updateUI();
                resetMissionUI();
                closeResetModal();
                showNotification('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§. üîÑ');
            } else {
                showNotification('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§! ‚ùå');
            }
        }

        // --- Theme Toggle Function ---
        function toggleTheme() {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                currentTheme = 'dark-mode';
                showNotification('Îã§ÌÅ¨ Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§ üåô');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                currentTheme = 'light-mode';
                showNotification('ÎùºÏù¥Ìä∏ Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§ ‚òÄÔ∏è');
            }
            saveProgress();
        }

        // --- App Initialization ---
        function initApp() {
    try {
        // Firebase Ï¥àÍ∏∞Ìôî (Î®ºÏ†Ä Ïã§Ìñâ)
        initFirebase();
        
        loadProgress();
        // ... ÎÇòÎ®∏ÏßÄ ÏΩîÎìúÎäî Í∑∏ÎåÄÎ°ú
                
                setTimeout(() => {
                    showNotification(`${userName}Îãò, Ìë∏Î•∏ÎÇòÎùºÌïôÍµêÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§! üåü`);
                }, 1000);

                // Update home tab quiz button state
                const lastQuizMissionDate = safeGetItem('lastQuizMissionDate');
                const today = new Date().toDateString();
                const quizButton = document.getElementById('mission-btn-quiz');

                if (lastQuizMissionDate === today) {
                    if (quizButton) {
                        quizButton.textContent = 'ÏôÑÎ£å!';
                        quizButton.disabled = true;
                    }
                } else {
                    if (quizButton) {
                        quizButton.textContent = 'ÌÄ¥Ï¶à ÏãúÏûë';
                        quizButton.disabled = false;
                    }
                }

                // Update home tab mini-game button state
                const minigameButton = document.getElementById('mission-btn-minigame');
                if (miniGameCompletedToday) {
                    if (minigameButton) {
                        minigameButton.textContent = 'ÏôÑÎ£å!';
                        minigameButton.disabled = true;
                    }
                } else {
                    if (minigameButton) {
                        minigameButton.textContent = 'ÎØ∏ÎãàÍ≤åÏûÑ ÏãúÏûë';
                        minigameButton.disabled = false;
                    }
                }


                // Modal close events
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });

                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                        closeImageModal();
                    }
                    if (e.key === 'Enter') {
                        const nameModal = document.getElementById('nameModal');
                        const resetModal = document.getElementById('resetModal');
                        const noticeModal = document.getElementById('noticeModal');
                        const qtNoteModal = document.getElementById('qtNoteModal');
                        const qtPasswordModal = document.getElementById('qtPasswordModal');
                        
                        if (nameModal.style.display === 'flex') {
                            e.preventDefault();
                            changeName();
                        } else if (resetModal.style.display === 'flex') {
                            e.preventDefault();
                            confirmReset();
                        } else if (noticeModal.style.display === 'flex') {
                            e.preventDefault();
                            createNotice();
                        } else if (qtNoteModal.style.display === 'flex') {
                            e.preventDefault();
                            createQTNote();
                        } else if (qtPasswordModal.style.display === 'flex') {
                            e.preventDefault();
                            confirmQTAction();
                        }
                        // Inline minigame/icebreaker enter handling is within their specific functions
                    }
                });
            } catch (error) {
                console.error('Ïï± Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                showNotification('Ïï± Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ ÏïàÏ†ÑÌïòÍ≤å Ï¥àÍ∏∞Ìôî
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•ÏùÑ ÏïàÏ†ÑÌïòÍ≤å Ï≤òÎ¶¨
        window.addEventListener('beforeunload', () => {
            try {
                saveProgress();
            } catch (error) {
                console.error('Ï¢ÖÎ£å Ïãú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
            }
        });

    </script>
</body>
</html>
