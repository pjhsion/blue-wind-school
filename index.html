<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>푸른나라학교 - 신앙 RPG</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="푸른나라학교">
    
    <!-- Firebase CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    
    <style>
        /* Pretendard 폰트 임포트 */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --app-bg: white;
            --text-color: #333;
            --header-gradient-start: #4facfe;
            --header-gradient-end: #00f2fe;
            --header-text-color: white;
            --nav-bg: #f8f9fa;
            --nav-border: #dee2e6;
            --nav-item-color: #495057;
            --nav-item-active-bg: #4facfe;
            --nav-item-active-color: white;
            --nav-item-hover-bg: #e9ecef;
            --nav-item-active-hover-bg: #3d8bfe;
            --notice-bg-start: #fff3cd;
            --notice-bg-end: #ffeeba;
            --notice-border: #ffc107;
            --notice-text: #856404;
            --mission-card-bg: #f8f9fa;
            --mission-card-border: #dee2e6;
            --mission-button-bg: #4facfe;
            --mission-button-hover-bg: #3d8bfe;
            --mission-button-disabled-bg: #28a745;
            --prayer-card-bg-start: #ffecd2;
            --prayer-card-bg-end: #fcb69f;
            --prayer-card-title: #8b4513;
            --prayer-slot-bg: rgba(255,255,255,0.7);
            --prayer-slot-hover-border: #8b4513;
            --prayer-slot-completed-bg: #d4edda;
            --prayer-slot-completed-border: #28a745;
            --scripture-card-bg-start: #e3f2fd;
            --scripture-card-bg-end: #bbdefb;
            --scripture-card-border: #2196f3;
            --scripture-text: #1565c0;
            --scripture-reference: #0d47a1;
            --chat-container-bg: #f8f9fa;
            --chat-messages-bg: white;
            --chat-input-border: #dee2e6;
            --chat-input-focus-border: #4facfe;
            --chat-send-btn-bg: #4facfe;
            --chat-send-btn-hover-bg: #3d8bfe;
            --image-upload-btn-bg: #17a2b8;
            --image-upload-btn-hover-bg: #138496;
            --message-user-bubble-bg: #4facfe;
            --message-user-bubble-color: white;
            --message-other-bubble-bg: #f1f3f4;
            --message-other-bubble-color: #333;
            --message-user-avatar-bg: #3d8bfe;
            --message-other-avatar-bg: #6c757d;
            --qt-note-card-bg: white;
            --qt-note-card-border: #dee2e6;
            --qt-note-title: #4facfe;
            --qt-note-date: #666;
            --qt-note-content: #333;
            --like-button-color: #e91e63;
            --like-button-hover-color: #c2185b;
            --note-btn-bg: #6c757d;
            --note-btn-edit-bg: #ffc107;
            --note-btn-delete-bg: #dc3545;
            --modal-bg: rgba(0,0,0,0.5);
            --modal-content-bg: white;
            --modal-title-color: #4facfe;
            --modal-input-border: #dee2e6;
            --modal-input-focus-border: #4facfe;
            --modal-button-primary-bg: #4facfe;
            --modal-button-primary-hover-bg: #3d8bfe;
            --modal-button-secondary-bg: #6c757d;
            --modal-button-secondary-hover-bg: #5a6268;
            --lesson-container-bg: white;
            --lesson-header-border: #e9ecef;
            --lesson-title-color: #4facfe;
            --lesson-content-color: #333;
            --lesson-content-h4-color: #4facfe;
            --lesson-content-strong-color: #2c5aa0;
            --stage-card-bg-start: #89f7fe;
            --stage-card-bg-end: #66a6ff;
            --stage-completed-bg: #e8f5e9;
            --stage-completed-color: #2e7d32;
            --stage-completed-border: #a5d6a7;
            --discussion-bg: #f1f8e9;
            --discussion-border-left: #8bc34a;
            --discussion-h4-color: #33691e;
            --discussion-ol-color: #555;
            --badge-bg: #ffd700;
            --badge-color: #333;
            --minigame-canvas-bg: #e0f7fa;
            --quiz-option-border: #4facfe;
            --quiz-option-bg: white;
            --quiz-option-color: #4facfe;
            --quiz-option-hover-bg: #e3f2fd;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-gradient-start: #2c3e50;
            --bg-gradient-end: #34495e;
            --app-bg: #3b4d61;
            --text-color: #ecf0f1;
            --header-gradient-start: #1a2a3a;
            --header-gradient-end: #2a3a4a;
            --header-text-color: #ecf0f1;
            --nav-bg: #2c3e50;
            --nav-border: #44586b;
            --nav-item-color: #bdc3c7;
            --nav-item-active-bg: #1abc9c;
            --nav-item-active-color: white;
            --nav-item-hover-bg: #34495e;
            --nav-item-active-hover-bg: #16a085;
            --notice-bg-start: #4a4a3a;
            --notice-bg-end: #5a5a4a;
            --notice-border: #8b8b7a;
            --notice-text: #e0e0d1;
            --mission-card-bg: #44586b;
            --mission-card-border: #5a6e80;
            --mission-button-bg: #1abc9c;
            --mission-button-hover-bg: #16a085;
            --mission-button-disabled-bg: #27ae60;
            --prayer-card-bg-start: #5a4a3a;
            --prayer-card-bg-end: #6a5a4a;
            --prayer-card-title: #e0d1b1;
            --prayer-slot-bg: rgba(255,255,255,0.1);
            --prayer-slot-hover-border: #e0d1b1;
            --prayer-slot-completed-bg: #27ae60;
            --prayer-slot-completed-border: #2ecc71;
            --scripture-card-bg-start: #3a4a5a;
            --scripture-card-bg-end: #4a5a6a;
            --scripture-card-border: #3498db;
            --scripture-text: #aed6f1;
            --scripture-reference: #85c1e9;
            --chat-container-bg: #44586b;
            --chat-messages-bg: #3b4d61;
            --chat-input-border: #5a6e80;
            --chat-input-focus-border: #1abc9c;
            --chat-send-btn-bg: #1abc9c;
            --chat-send-btn-hover-bg: #16a085;
            --image-upload-btn-bg: #2980b9;
            --image-upload-btn-hover-bg: #2c3e50;
            --message-user-bubble-bg: #1abc9c;
            --message-user-bubble-color: white;
            --message-other-bubble-bg: #5a6e80;
            --message-other-bubble-color: #ecf0f1;
            --message-user-avatar-bg: #16a085;
            --message-other-avatar-bg: #7f8c8d;
            --qt-note-card-bg: #44586b;
            --qt-note-card-border: #5a6e80;
            --qt-note-title: #1abc9c;
            --qt-note-date: #bdc3c7;
            --qt-note-content: #ecf0f1;
            --like-button-color: #e74c3c;
            --like-button-hover-color: #c0392b;
            --note-btn-bg: #7f8c8d;
            --note-btn-edit-bg: #f39c12;
            --note-btn-delete-bg: #e74c3c;
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #3b4d61;
            --modal-title-color: #1abc9c;
            --modal-input-border: #5a6e80;
            --modal-input-focus-border: #1abc9c;
            --modal-button-primary-bg: #1abc9c;
            --modal-button-primary-hover-bg: #16a085;
            --modal-button-secondary-bg: #7f8c8d;
            --modal-button-secondary-hover-bg: #6c757d;
            --lesson-container-bg: #44586b;
            --lesson-header-border: #5a6e80;
            --lesson-title-color: #1abc9c;
            --lesson-content-color: #ecf0f1;
            --lesson-content-h4-color: #1abc9c;
            --lesson-content-strong-color: #3498db;
            --stage-card-bg-start: #1abc9c;
            --stage-card-bg-end: #3498db;
            --stage-completed-bg: #27ae60;
            --stage-completed-color: #d4edda;
            --stage-completed-border: #2ecc71;
            --discussion-bg: #2ecc71;
            --discussion-border-left: #27ae60;
            --discussion-h4-color: #1a532d;
            --discussion-ol-color: #ecf0f1;
            --badge-bg: #f1c40f;
            --badge-color: #333;
            --minigame-canvas-bg: #3a4a5a;
            --quiz-option-border: #1abc9c;
            --quiz-option-bg: #44586b;
            --quiz-option-color: #ecf0f1;
            --quiz-option-hover-bg: #5a6e80;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.5s ease, color 0.5s ease;
        }

        .app-container {
            max-width: 414px;
            margin: 0 auto;
            background: var(--app-bg);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: var(--header-text-color);
            padding: 20px;
            text-align: center;
            position: relative;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .character-avatar {
            width: 80px;
            height: 80px;
            background: var(--app-bg);
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.3s ease, background 0.5s ease;
        }

        .character-avatar:hover {
            transform: scale(1.05);
        }

        .user-name {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .user-name:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 14px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            font-size: 18px;
        }

        .navigation {
            display: flex;
            background: var(--nav-bg);
            border-top: 1px solid var(--nav-border);
            flex-shrink: 0;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .nav-item {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: var(--nav-item-color);
            transition: all 0.3s ease;
        }

        .nav-item.active {
            background: var(--nav-item-active-bg);
            color: var(--nav-item-active-color);
        }

        .nav-item:hover {
            background: var(--nav-item-hover-bg);
        }

        .nav-item.active:hover {
            background: var(--nav-item-active-hover-bg);
        }

        .content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .notice-card {
            background: linear-gradient(135deg, var(--notice-bg-start) 0%, var(--notice-bg-end) 100%);
            border: 1px solid var(--notice-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notice-title {
            font-weight: bold;
            color: var(--notice-text);
        }

        .notice-date {
            font-size: 12px;
            color: var(--notice-text);
            opacity: 0.8;
        }

        .notice-content {
            color: var(--notice-text);
            line-height: 1.5;
        }

        .mission-card {
            background: var(--mission-card-bg);
            border: 1px solid var(--mission-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.5s ease, border-color 0.5s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mission-title {
            font-weight: bold;
            color: var(--text-color);
        }

        .mission-reward {
            background: #ffd700;
            color: #333;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .mission-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .mission-button {
            background: var(--mission-button-bg);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .mission-button:hover {
            background: var(--mission-button-hover-bg);
            transform: scale(1.05);
        }

        .mission-button:disabled {
            background: var(--mission-button-disabled-bg);
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none;
        }

        .floating-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 25px;
            font-weight: bold;
            animation: slideInDown 0.3s ease;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .prayer-time-card {
            background: linear-gradient(135deg, var(--prayer-card-bg-start) 0%, var(--prayer-card-bg-end) 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            transition: background 0.5s ease;
        }

        .prayer-time-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--prayer-card-title);
            margin-bottom: 15px;
        }

        .prayer-time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .prayer-time-slot {
            background: var(--prayer-slot-bg);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease, background 0.5s ease;
        }

        .prayer-time-slot:hover {
            border-color: var(--prayer-slot-hover-border);
            transform: scale(1.05);
        }

        .prayer-time-slot.completed {
            background: var(--prayer-slot-completed-bg);
            border-color: var(--prayer-slot-completed-border);
        }

        .scripture-card {
            background: linear-gradient(135deg, var(--scripture-card-bg-start) 0%, var(--scripture-card-bg-end) 100%);
            border: 1px solid var(--scripture-card-border);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scripture-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--scripture-text);
            margin-bottom: 10px;
            font-style: italic;
        }

        .scripture-reference {
            font-weight: bold;
            color: var(--scripture-reference);
            font-size: 14px;
        }

        .chat-container {
            background: var(--chat-container-bg);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            height: 350px;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--chat-messages-bg);
            border-radius: 10px;
            transition: background 0.5s ease;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.other {
            align-items: flex-start;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            display: inline-block;
        }
        
        .message.user .message-bubble {
            background: var(--message-user-bubble-bg);
            color: var(--message-user-bubble-color);
        }

        .message.other .message-bubble {
            background: var(--message-other-bubble-bg);
            color: var(--message-other-bubble-color);
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
            padding: 0 5px;
        }

        .message-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            margin-right: 8px;
        }
        
        .message.user .message-avatar { background: var(--message-user-avatar-bg); }
        .message.other .message-avatar { background: var(--message-other-avatar-bg); }

        .message-sender {
            font-weight: bold;
            color: var(--text-color);
        }

        .message-time {
            margin-left: 8px;
            opacity: 0.7;
            font-size: 10px;
            color: var(--text-color);
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--chat-input-border);
            border-radius: 20px;
            font-size: 14px;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }

        .chat-input:focus {
            border-color: var(--chat-input-focus-border);
            outline: none;
        }

        .chat-send-btn {
            background: var(--chat-send-btn-bg);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            white-space: nowrap;
        }

        .chat-send-btn:hover {
            background: var(--chat-send-btn-hover-bg);
        }

        .image-upload-btn {
            background: var(--image-upload-btn-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .image-upload-btn:hover {
            background: var(--image-upload-btn-hover-bg);
        }

        .hidden-file-input {
            display: none;
        }

        .qt-note-card {
            background: var(--qt-note-card-bg);
            border: 1px solid var(--qt-note-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .qt-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--nav-border);
        }

        .qt-note-title {
            font-weight: bold;
            color: var(--qt-note-title);
        }

        .qt-note-date {
            font-size: 12px;
            color: var(--qt-note-date);
        }

        .qt-note-content {
            margin-bottom: 10px;
            line-height: 1.6;
            color: var(--qt-note-content);
        }

        .qt-note-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .like-button {
            background: none;
            border: none;
            color: var(--like-button-color);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-button:hover {
            color: var(--like-button-hover-color);
        }

        .note-buttons {
            display: flex;
            gap: 5px;
        }

        .note-btn {
            background: var(--note-btn-bg);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .note-btn.edit { background: var(--note-btn-edit-bg); }
        .note-btn.delete { background: var(--note-btn-delete-bg); }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--modal-content-bg);
            padding: 30px;
            border-radius: 15px;
            max-width: 380px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
            transition: background 0.5s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--modal-title-color);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--app-bg);
            color: var(--text-color);
        }

        .modal-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--app-bg);
            color: var(--text-color);
        }

        .modal-input:focus, .modal-textarea:focus {
            border-color: var(--modal-input-focus-border);
            outline: none;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-button.primary {
            background: var(--modal-button-primary-bg);
            color: white;
        }

        .modal-button.primary:hover {
            background: var(--modal-button-primary-hover-bg);
        }

        .modal-button.secondary {
            background: var(--modal-button-secondary-bg);
            color: white;
        }

        .modal-button.secondary:hover {
            background: var(--modal-button-secondary-hover-bg);
        }

        .lesson-container {
            background: var(--lesson-container-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            animation: slideInUp 0.4s ease;
            transition: background 0.5s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--lesson-header-border);
        }

        .lesson-icon {
            font-size: 30px;
            margin-right: 15px;
        }

        .lesson-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--lesson-title-color);
        }

        .lesson-content {
            line-height: 1.7;
            color: var(--lesson-content-color);
            font-size: 15px;
        }

        .lesson-content h4 {
            color: var(--lesson-content-h4-color);
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .lesson-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .lesson-content li {
            margin-bottom: 8px;
        }

        .lesson-content p {
            margin-bottom: 12px;
        }

        .lesson-content strong {
            color: var(--lesson-content-strong-color);
        }
        
        .stage-card {
            background: linear-gradient(135deg, var(--stage-card-bg-start) 0%, var(--stage-card-bg-end) 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stage-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .avatar-option {
            font-size: 30px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        .avatar-option:hover {
            background: var(--nav-item-hover-bg);
        }
        
        .discussion-container {
            background: var(--discussion-bg);
            border-left: 5px solid var(--discussion-border-left);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }
        .discussion-container h4 {
            color: var(--discussion-h4-color);
            margin-bottom: 15px;
        }
        .discussion-container ol {
            padding-left: 20px;
            line-height: 1.8;
            color: var(--discussion-ol-color);
        }
        
        #badge-container span {
            display: inline-block;
            background: var(--badge-bg);
            color: var(--badge-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin: 3px;
        }

        #minigame-canvas {
            border-radius: 10px;
            background: var(--minigame-canvas-bg);
            cursor: pointer;
        }

        #quiz-modal-content .quiz-option, .quiz-section .quiz-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid var(--quiz-option-border);
            background: var(--quiz-option-bg);
            color: var(--quiz-option-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #quiz-modal-content .quiz-option:hover, .quiz-section .quiz-option:hover {
            background: var(--quiz-option-hover-bg);
        }
        
        .stage-completed-notice {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            background: var(--stage-completed-bg);
            color: var(--stage-completed-color);
            font-weight: bold;
            border-radius: 10px;
            border: 2px dashed var(--stage-completed-border);
            transition: background 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        .theme-toggle-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--nav-border);
            text-align: center;
        }
        .theme-toggle-button {
            background: var(--modal-button-secondary-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .theme-toggle-button:hover {
            background: var(--modal-button-secondary-hover-bg);
        }

        .comments-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--nav-border);
            text-align: left;
        }
        .comments-section h5 {
            color: var(--text-color);
            margin-bottom: 10px;
        }
        .comment-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .comment-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }
        .comment-password-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }
        .comment-send-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            align-self: flex-end;
        }
        .comment-send-btn:hover {
            background: #138496;
        }
        .comment-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--nav-border);
            border-radius: 8px;
            padding: 10px;
            background: var(--chat-messages-bg);
        }
        .comment-item {
            background: var(--mission-card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid var(--mission-card-border);
        }
        .comment-item:last-child {
            margin-bottom: 0;
        }
        .comment-header {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--text-color);
        }
        .comment-author {
            font-weight: bold;
            margin-right: 5px;
        }
        .comment-time {
            opacity: 0.7;
        }
        .comment-content {
            font-size: 14px;
            color: var(--text-color);
            word-wrap: break-word;
        }
        .comment-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            align-self: flex-end;
        }
        .comment-action-btn {
            background: var(--note-btn-bg);
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
        }
        .comment-action-btn.edit { background: var(--note-btn-edit-bg); }
        .comment-action-btn.delete { background: var(--note-btn-delete-bg); }

        .icebreaker-section {
            background: var(--prayer-card-bg-start);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--prayer-card-title);
        }
        .icebreaker-section .modal-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--prayer-card-title);
        }
        .icebreaker-section .icebreaker-prompt {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: var(--prayer-card-title);
        }
        .icebreaker-section .icebreaker-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            background: var(--app-bg);
            color: var(--text-color);
        }
        .icebreaker-section .modal-button.primary {
            background: var(--modal-button-primary-bg);
            color: white;
            width: auto;
            padding: 10px 20px;
        }

        .quiz-section {
            background: var(--scripture-card-bg-start);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--scripture-card-border);
        }
        .quiz-section .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--scripture-text);
        }
        .quiz-section p {
            color: var(--scripture-text);
            margin-bottom: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body class="light-mode">
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="character-avatar" id="headerAvatar" onclick="showAvatarModal()">🌟</div>
            <div class="user-name" onclick="showNameModal()">
                <span id="userName">푸른이</span>
                <span>✏️</span>
            </div>
            <div class="user-stats">
                <div class="stat">
                    <div class="stat-value" id="userLevel">1</div>
                    <div>레벨</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userExp">0</div>
                    <div>경험치</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userStreak">1</div>
                    <div>연속일</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content">
                <!-- Notice Board -->
                <div id="notice-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--text-color);">📢 공지사항</h3>
                        <button style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showNoticeModal()">+ 공지 작성</button>
                    </div>
                    <div id="notices-container">
                        <!-- 공지사항이 여기에 표시됩니다 -->
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: var(--text-color);">📋 오늘의 미션</h3>
                
                <div class="prayer-time-card">
                    <div class="prayer-time-title">⏰ 10-10-10 기도법</div>
                    <div class="prayer-time-grid">
                        <div class="prayer-time-slot" data-slot="morning" onclick="togglePrayerTime('morning', this)">
                            <div>🌅 아침</div>
                            <div style="font-size: 12px;">10분</div>
                        </div>
                        <div class="prayer-time-slot" data-slot="noon" onclick="togglePrayerTime('noon', this)">
                            <div>☀️ 점심</div>
                            <div style="font-size: 12px;">10분</div>
                        </div>
                        <div class="prayer-time-slot" data-slot="evening" onclick="togglePrayerTime('evening', this)">
                            <div>🌙 저녁</div>
                            <div style="font-size: 12px;">10분</div>
                        </div>
                    </div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">📖 성경 말씀 읽기</div>
                        <div class="mission-reward">+70 EXP</div>
                    </div>
                    <div class="mission-description">푸른바람의 냉장고에서 오늘의 영양분을 섭취하세요</div>
                    <button class="mission-button" id="mission-btn-scripture" onclick="showScripture()">말씀 보기</button>
                    <div id="scripture-container"></div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">🎯 예배 참여하기</div>
                        <div class="mission-reward">+100 EXP</div>
                    </div>
                    <div class="mission-description">하나님을 만나는 공식 채널에서 양방향 소통하세요</div>
                    <button class="mission-button" id="mission-btn-worship" onclick="completeMission(this, '예배 참여 완료! 용특새 메시지를 받았습니다! 🙏', 100, '예배 참석')">참여 완료</button>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">🧠 신앙 퀴즈 풀기</div>
                        <div class="mission-reward">+50 EXP</div>
                    </div>
                    <div class="mission-description">신앙 지식을 테스트하고 경험치를 얻으세요!</div>
                    <button class="mission-button" id="mission-btn-quiz" onclick="startQuiz()">퀴즈 시작</button>
                </div>
            </div>

            <!-- Stages Tab -->
            <div id="stages-tab" class="tab-content hidden">
                <div id="stage-list">
                    <h3 style="margin-bottom: 20px; color: var(--text-color);">🎯 학습 스테이지</h3>
                    <p style="text-align: center; color: var(--text-color); margin-bottom: 20px;">
                        교재 내용 기반 학습 단계입니다
                    </p>
                    
                    <div class="stage-card" onclick="enterStageContent(1)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">1. 패치 시스템</div>
                        <div style="font-size: 14px; opacity: 0.9;">거부할 수 없는 특권</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">예배하기 • 성경읽기 • 기도하기</div>
                    </div>

                    <div class="stage-card" onclick="enterStageContent(2)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">2. 길드 시스템</div>
                        <div style="font-size: 14px; opacity: 0.9;">우리, 같이 해볼까요</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">세례받기 • 공동체 속하기 • 성령 따르기</div>
                    </div>

                    <div class="stage-card" onclick="enterStageContent(3)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">3. 실전 시스템</div>
                        <div style="font-size: 14px; opacity: 0.9;">인생은 장난이 아니니까</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">이론에서 현실로 • 매일 그분과 • 일생을 함께</div>
                    </div>
                </div>
                    
                <div id="stage-detail" class="hidden">
                    <div id="stage-content"></div>
                    <button style="background: var(--modal-button-secondary-bg); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; width: 100%;" onclick="backToStages()">← 스테이지 목록으로</button>
                </div>

                <!-- New Icebreaker Records Section -->
                <div id="icebreaker-records-section" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-color);">📝 아이스브레이크 기록</h3>
                    <div id="icebreaker-records-container">
                        <!-- Icebreaker records will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Guild Tab -->
            <div id="guild-tab" class="tab-content hidden">
                <div style="background: linear-gradient(135deg, var(--scripture-card-bg-start) 0%, var(--scripture-card-bg-end) 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; position: relative;">
                    <h3 style="color: var(--text-color);">👥 푸른바람단</h3>
                    <strong style="color: var(--text-color);">길드 레벨: <span id="guildLevel">1</span></strong><br>
                    <small style="color: var(--text-color);">다음 레벨까지 <span id="guildExp">0</span>/500 EXP</small>
                </div>

                <!-- QT Note Section -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: var(--text-color);">📔 QT 노트</h4>
                        <button style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showQTNoteModal()">+ QT 노트 작성</button>
                    </div>
                    <div id="qt-notes-container">
                        <!-- QT 노트들이 여기에 표시됩니다 -->
                    </div>
                </div>

                <h4 style="margin-bottom: 15px; color: var(--text-color);">🟢 현재 접속 중인 길드원</h4>
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 15px; margin-bottom: 15px;">
                    <div class="guild-members-list">
                        <!-- 온라인 사용자 목록이 여기에 표시됩니다 -->
                        <div style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--chat-messages-bg); border-radius: 10px;">
                            <div id="guildUserAvatar" style="width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--modal-button-primary-bg); background: var(--modal-button-primary-bg); color: white;">🌟</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 2px; color: var(--text-color);"><span id="guildUserName">푸른이</span> (나)</div>
                                <div style="font-size: 12px; color: var(--text-color);">레벨 <span id="guildUserLevel">1</span> <span id="guildUserJob">푸른이</span> • <span id="guildUserStreak">1</span>일 연속 접속</div>
                            </div>
                        </div>
                        <div style="text-align: center; color: var(--text-color); padding: 20px;">
                            <p>다른 길드원들이 접속하면 여기에 표시됩니다</p>
                            <p>친구들을 초대해보세요! 🎉</p>
                        </div>
                    </div>
                </div>

                <h4 style="margin-bottom: 15px; color: var(--text-color);">💬 길드 채팅</h4>
                <div id="guild-chat-container" style="margin-top: 15px;">
                    <!-- 길드 채팅이 여기에 표시됩니다 -->
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-content hidden">
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 50px; cursor: pointer; border: 3px solid var(--modal-button-primary-bg); background: var(--app-bg); color: var(--text-color);" id="profileAvatar" onclick="showAvatarModal()">🌟</div>
                        <div>
                            <h4 id="profileUserName" style="margin-bottom: 5px; color: var(--text-color);">푸른이</h4>
                            <p style="color: var(--text-color); font-size: 14px;">레벨 <span id="profileLevel">1</span> <span id="profileJob">푸른이</span></p>
                            <p style="color: var(--text-color); font-size: 14px;">신앙 여정 <span id="profileStreak">1</span>일차</p>
                        </div>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">🏆 업적 및 뱃지</h4>
                    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
                        <div id="badge-container" style="margin-bottom: 10px; min-height: 25px;">
                            <!-- Badges will be dynamically inserted here -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--nav-border);">
                            <span style="color: var(--text-color);">완료한 미션</span>
                            <strong id="completedMissionsCount" style="color: var(--text-color);">0</strong><span style="color: var(--text-color);">개</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">🎨 테마 설정</h4>
                    <div class="theme-toggle-container">
                        <button class="theme-toggle-button" onclick="toggleTheme()">테마 전환</button>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">⚙️ 관리자 설정</h4>
                    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
                        <button style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;" onclick="showResetModal()">
                            🔄 모든 데이터 초기화
                        </button>
                        <div style="font-size: 12px; color: var(--text-color); margin-top: 8px; text-align: center;">
                            모든 진행 상황이 리셋됩니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-item active" onclick="showTab('home', this)">
                🏠<br>홈
            </button>
            <button class="nav-item" onclick="showTab('stages', this)">
                🎮<br>스테이지
            </button>
            <button class="nav-item" onclick="showTab('guild', this)">
                👥<br>길드
            </button>
            <button class="nav-item" onclick="showTab('profile', this)">
                👤<br>프로필
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">닉네임 변경</div>
            <input type="text" id="nameInput" class="modal-input" placeholder="새로운 닉네임을 입력하세요" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNameModal()">취소</button>
                <button class="modal-button primary" onclick="changeName()">변경</button>
            </div>
        </div>
    </div>

    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">프로필 사진 변경</div>
            <div class="avatar-grid">
                <div class="avatar-option" onclick="selectAvatar('🌟')">🌟</div>
                <div class="avatar-option" onclick="selectAvatar('😊')">😊</div>
                <div class="avatar-option" onclick="selectAvatar('🙏')">🙏</div>
                <div class="avatar-option" onclick="selectAvatar('✨')">✨</div>
                <div class="avatar-option" onclick="selectAvatar('🕊️')">🕊️</div>
                <div class="avatar-option" onclick="selectAvatar('📖')">📖</div>
                <div class="avatar-option" onclick="selectAvatar('❤️')">❤️</div>
                <div class="avatar-option" onclick="selectAvatar('🌅')">🌅</div>
                <div class="avatar-option" onclick="selectAvatar('⭐')">⭐</div>
                <div class="avatar-option" onclick="selectAvatar('🎵')">🎵</div>
                <div class="avatar-option" onclick="selectAvatar('🌸')">🌸</div>
                <div class="avatar-option" onclick="selectAvatar('🌈')">🌈</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeAvatarModal()">취소</button>
            </div>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">관리자 인증</div>
            <input type="password" id="adminPassword" class="modal-input" placeholder="관리자 비밀번호를 입력하세요" maxlength="4">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeResetModal()">취소</button>
                <button class="modal-button primary" onclick="confirmReset()">확인</button>
            </div>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">공지사항 작성</div>
            <input type="password" id="noticePassword" class="modal-input" placeholder="관리자 비밀번호" maxlength="4">
            <input type="text" id="noticeTitle" class="modal-input" placeholder="공지사항 제목">
            <textarea id="noticeContent" class="modal-textarea" placeholder="공지사항 내용을 입력하세요"></textarea>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNoticeModal()">취소</button>
                <button class="modal-button primary" onclick="createNotice()">공지 등록</button>
            </div>
        </div>
    </div>

    <!-- QT Note Modal -->
    <div id="qtNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="qtModalTitle">QT 노트 작성</div>
            <input type="text" id="qtNoteTitle" class="modal-input" placeholder="QT 노트 제목">
            <textarea id="qtNoteContent" class="modal-textarea" placeholder="오늘의 QT 내용을 기록해보세요..."></textarea>
            <input type="password" id="qtNotePassword" class="modal-input" placeholder="비밀번호 (필수)" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTNoteModal()">취소</button>
                <button class="modal-button primary" id="qtSubmitBtn" onclick="createQTNote()">작성 완료</button>
            </div>
        </div>
    </div>

    <!-- QT Note Password Modal -->
    <div id="qtPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">비밀번호 확인</div>
            <p id="passwordModalText">비밀번호를 입력하세요:</p>
            <input type="password" id="qtActionPassword" class="modal-input" placeholder="비밀번호" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTPasswordModal()">취소</button>
                <button class="modal-button primary" id="qtConfirmActionButton" onclick="confirmQTAction()">확인</button>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="modal">
        <div class="modal-content" id="quiz-modal-content">
            <!-- Quiz content will be injected here -->
        </div>
    </div>
    
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCuMttZg-PO-U7rk1kcDswRDfyUoo7pSF0",
            authDomain: "blue-wind-school.firebaseapp.com",
            databaseURL: "https://blue-wind-school-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "blue-wind-school",
            storageBucket: "blue-wind-school.firebasestorage.app",
            messagingSenderId: "321228765213",
            appId: "1:321228765213:web:748d27515e2f14c3076ef4"
        };

        // Firebase 초기화
        let database = null;
        let isFirebaseEnabled = false;

        function initFirebase() {
            try {
                // 실제 Firebase 설정이 있는지 확인 (더 견고한 확인)
                if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    isFirebaseEnabled = true;
                    console.log("Firebase 연결 성공!");
                    
                    // 실시간 리스너 설정
                    setupFirebaseListeners();
                    showNotification("🔥 실시간 공유 기능이 활성화되었습니다!");
                    updateFirebaseStatus();
                } else {
                    console.log("Firebase 설정이 올바르지 않습니다. 로컬 모드로 실행됩니다.");
                    showNotification("📱 로컬 모드로 실행됩니다. Firebase 설정 시 실시간 공유가 가능합니다.");
                    updateFirebaseStatus();
                }
            } catch (error) {
                console.error("Firebase 초기화 실패:", error);
                isFirebaseEnabled = false;
                showNotification("⚠️ 실시간 공유 기능을 사용할 수 없습니다. 로컬 모드로 실행됩니다.");
                updateFirebaseStatus();
            }
        }

        function setupFirebaseListeners() {
            if (!isFirebaseEnabled) return;

            // 공지사항 실시간 리스너
            database.ref('notices').on('value', (snapshot) => {
                const data = snapshot.val();
                notices = data ? Object.values(data).sort((a, b) => b.id - a.id) : [];
                updateNotices();
            });

            // 채팅 메시지 실시간 리스너
            database.ref('chatMessages').on('value', (snapshot) => {
                const data = snapshot.val();
                chatMessages = data ? Object.values(data).sort((a, b) => a.timestamp - b.timestamp) : [];
                
                const activeTab = document.querySelector('.nav-item.active');
                if (activeTab && activeTab.textContent.includes('길드')) {
                    updateChatMessages('guild');
                }
            });

            // QT 노트 실시간 리스너
            database.ref('qtNotes').on('value', (snapshot) => {
                const data = snapshot.val();
                qtNotes = data ? Object.values(data).sort((a, b) => b.id - a.id) : [];
                updateQTNotes();
            });

            // 아이스브레이크 기록 실시간 리스너
            database.ref('icebreakerRecords').on('value', (snapshot) => {
                const data = snapshot.val();
                completedIcebreakers = data ? Object.values(data).sort((a, b) => a.stage - b.stage) : [];
                updateIcebreakerRecordsDisplay();
            });


            // 온라인 사용자 실시간 리스너
            database.ref('onlineUsers').on('value', (snapshot) => {
                onlineUsers = snapshot.val() || {};
                updateOnlineUsers();
            });

            // 현재 사용자를 온라인 상태로 등록
            const userOnlineRef = database.ref(`onlineUsers/${userName}`);
            userOnlineRef.set({
                name: userName,
                avatar: userAvatar,
                level: userLevel,
                job: userJob,
                streak: userStreak,
                lastSeen: Date.now()
            });

            // 연결이 끊어질 때 사용자를 오프라인으로 설정
            userOnlineRef.onDisconnect().remove();

            // 5초마다 온라인 상태 업데이트
            setInterval(() => {
                if (isFirebaseEnabled) {
                    userOnlineRef.update({ lastSeen: Date.now() });
                }
            }, 5000);
        }

        function updateFirebaseStatus() {
            if (isFirebaseEnabled) {
                console.log('🔥 Firebase 연결됨: 실시간 공유 기능이 활성화되어 있습니다.');
            } else {
                console.log('🔧 Firebase 설정 필요: Firebase 설정을 완료하면 실시간 공유 기능을 사용할 수 있습니다.');
            }
        }

        // --- Global State Variables ---
        let userLevel, userExp, userStreak, completedMissions, userName, userAvatar, userJob, userBadges, completedStages;
        let guildLevel, guildExp;
        let currentStage = null;
        let chatMessages = [];
        let prayerTimes = {};
        let notices = [];
        let qtNotes = [];
        let editingQTNote = null;
        let pendingQTAction = null;
        let currentTheme = 'light-mode';
        let quizCompletedPerStage = {};
        let completedIcebreakers = [];
        let onlineUsers = {};
        let dailyQuiz = [];
        let currentQuizIndex = 0;

        // 메모리 기반 저장소 (localStorage 대체)
        let memoryStorage = {};
        
        function isLocalStorageAvailable() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        function safeSetItem(key, value) {
            if (isLocalStorageAvailable()) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.warn('localStorage setItem 실패, 메모리 저장소 사용:', error);
                }
            }
            memoryStorage[key] = value;
            return false;
        }

        function safeGetItem(key) {
            if (isLocalStorageAvailable()) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('localStorage getItem 실패, 메모리 저장소 사용:', error);
                }
            }
            return memoryStorage[key] || null;
        }

        function safeRemoveItem(key) {
            if (isLocalStorageAvailable()) {
                try {
                    localStorage.removeItem(key);
                    return;
                } catch (error) {
                    console.warn('localStorage removeItem 실패, 메모리 저장소 사용:', error);
                }
            }
            delete memoryStorage[key];
        }

        // --- Data Definitions ---
        const scriptures = [
            { text: "내 안에 머물러 있어라. 그리하면 나도 너희 안에 머물러 있겠다. 가지가 포도나무에 붙어 있지 아니하면 스스로 열매를 맺을 수 없는 것과 같이, 너희도 내 안에 머물러 있지 아니하면 열매를 맺을 수 없다.", reference: "요한복음 15:4" },
            { text: "나는 참 포도나무요, 내 아버지는 농부이시다.", reference: "요한복음 15:1" },
            { text: "너희가 나의 말에 머물러 있으면, 너희는 참으로 나의 제자들이다. 그리고 너희는 진리를 얻게 될 것이며, 진리가 너희를 자유롭게 할 것이다.", reference: "요한복음 8:31-32" },
            { text: "그러므로 너희는 가서, 모든 민족을 제자로 삼아서, 아버지와 아들과 성령의 이름으로 세례를 주고, 내가 너희에게 명령한 모든 것을 그들에게 가르쳐 지키게 하여라.", reference: "마태복음 28:19-20" },
            { text: "사람은 마음으로 믿어서 의에 이르고, 입으로 고백해서 구원에 이르게 됩니다.", reference: "로마서 10:10" }
        ];

        const allQuizQuestions = [
            { question: "교회의 머리는 누구신가요?", options: ["베드로", "바울", "예수 그리스도", "교황"], answer: "예수 그리스도" },
            { question: "교회의 세 가지 주요 사명 중 하나가 아닌 것은 무엇인가요?", options: ["예배", "교육", "사업", "봉사 및 선교"], answer: "사업" },
            { question: "사도행전에 나오는 초대교회의 특징이 아닌 것은?", options: ["서로 물건을 통용함", "매일 마음을 같이하여 성전에 모이기를 힘씀", "개인주의적인 신앙생활", "떡을 떼며 기쁨과 순전한 마음으로 음식을 먹음"], answer: "개인주의적인 신앙생활" },
            { question: "교회가 세상의 빛과 소금의 역할을 해야 한다고 말씀하신 성경은 무엇인가요?", options: ["요한복음", "마태복음", "로마서", "히브리서"], answer: "마태복음" },
            { question: "교회의 가장 중요한 공동체적 모임은 무엇인가요?", options: ["친목회", "운동회", "예배", "바자회"], answer: "예배" },
            { question: "예수님의 제자는 총 몇 명이었나요?", options: ["10명", "11명", "12명", "13명"], answer: "12명" },
            { question: "천지창조는 며칠 동안 이루어졌나요?", options: ["3일", "6일", "7일", "40일"], answer: "6일" },
            { question: "모세가 시내산에서 받은 십계명은 몇 개인가요?", options: ["8개", "10개", "12개", "20개"], answer: "10개" },
            { question: "다윗이 물매돌로 싸워 이긴 거인 장수의 이름은 무엇인가요?", options: ["가인", "골리앗", "삼손", "사울"], answer: "골리앗" },
            { question: "예수님께서 태어나신 곳은 어디인가요?", options: ["예루살렘", "나사렛", "갈릴리", "베들레헴"], answer: "베들레헴" }
        ];

        const stageContents = {
            1: {
                title: "1강: 패치 시스템 - 거부할 수 없는 특권",
                item: "용특새 메시지",
                icebreaker: {
                    prompt: "1강을 시작하기 전에, '패치'라는 단어를 들으면 어떤 생각이 드나요? 신앙생활에서 '패치'가 필요하다고 느낀 적이 있나요?"
                },
                lessons: [
                    {
                        icon: "🛡️",
                        title: "예배하기 - 하나님을 만나는 공식 채널",
                        content: `<h4>📌 예배는 양방향 소통</h4><p>예수님은 우리에게 새로운 생명을 주실 뿐만 아니라, "더 넘치게" 누리며 살게 하기 위해 자기 목숨을 버리겠다고 말씀하셨습니다.</p><h4>💡 예배의 의미</h4><ul><li>하나님이 우리 일상에 얼마나 관심이 많은지 알 수 있는 시간</li><li>우리를 얼마나 소중히 여기는지 깨닫는 시간</li><li>하나님의 계획에서 우리가 얼마나 중요한 사람인지 발견하는 시간</li></ul>
                        <h4>⚔️ 거짓 위협 vs 진짜 목소리 (용특새)</h4>
                        <p><strong>거짓 위협:</strong> "너는 왜 그거밖에 안 되냐?", "너 따위는 여기서 실패하면 바로 끝이야"</p>
                        <p><strong>진짜 목소리 (용특새):</strong></p>
                        <ul>
                            <li>그리스도 안에서 당신은 <strong>용납</strong>되었습니다</li>
                            <li>그리스도 안에서 당신은 <strong>특별한</strong> 존재입니다</li>
                            <li>그리스도 안에서 당신은 <strong>새로운</strong> 공동체에 속했습니다</li>
                        </ul>
                        <p>예배를 드리면서, 깨진 세상이 주는 거짓 위협과는 전혀 다른, 당신을 향한 진짜 목소리에 귀를 기울이세요. 당신을 향해 불어오는 푸른바람의 메시지는 어떤 공격에도 끄떡없는 체력을 주고 쉴드가 됩니다.</p>`
                    },
                    {
                        icon: "⚡",
                        title: "성경읽기 - 푸른바람의 냉장고",
                        content: `<h4>🍯 나의 패치, 나의 특권</h4><p>성경은 푸른바람의 나라 에너지원이 가득한 냉장고입니다. 아무리 냉장고에 먹을 것이 가득해도 꺼내 먹지 않으면 아무 소용이 없습니다.</p><h4>🔍 성경을 꺼내 먹는 꿀팁</h4><ul><li>하나님은 어떤 분일까? (하나님의 성품과 말씀과 하신 일)</li><li>예수님은 어떤 분일까? (예수님의 가르침과 삶과 행동)</li><li>선배들은 어떻게 살았을까? (그들의 믿음과 기도, 실수와 회복과 교훈)</li><li>그러면 나는 어떻게 살아야 할까? (내 현실에 적용할 수 있는 성경 원리)</li></ul>`
                    },
                    {
                        icon: "🔌",
                        title: "기도하기 - 신에게 빨대 꽂기",
                        content: `<h4>🌳 포도나무와 가지의 관계</h4><p>예수님은 우리를 "가지"라고 부르시며, 자신에게 딱 붙어 있으라고 하십니다. 나뭇가지의 최고 특권은 농부(하나님)가 땀 흘려 일하고 나무(예수님)가 열심히 공급한 양분을 그냥 받아 누리는 것입니다.</p><h4>🕐 10-10-10 기도법</h4><p>아침, 점심, 저녁 10분씩 예수님과 대화하는 시간을 가져보세요. 부담 없이, 그저 말을 거는 것부터 시작하면 됩니다.</p>`
                    }
                ],
                discussionQuestions: [
                    "예배, 성경 읽기, 기도 중에서 요즘 나에게 가장 가깝게 느껴지는 것과 가장 멀게 느껴지는 것은 무엇인가요? 그 이유는 무엇일까요?",
                    "나를 향한 하나님의 '진짜 목소리'(용특새: 용납, 특별함, 새로운 공동체)를 의심하게 만드는 '거짓 위협'에는 어떤 것들이 있었나요?",
                    "오늘 배운 '10-10-10 기도법'을 내일부터 당장 실천해본다면, 어떤 점이 기대되고 어떤 점이 걱정되나요?"
                ]
            },
            2: {
                title: "2강: 길드 시스템 - 우리, 같이 해볼까요",
                item: "길드 버프",
                icebreaker: {
                    prompt: "2강을 시작하기 전에, '길드'라는 단어를 들으면 어떤 생각이 드나요? 신앙 공동체가 '길드'처럼 느껴진 적이 있나요?"
                },
                lessons: [
                    {
                        icon: "🎯",
                        title: "세례받기 - 길드 가입하기",
                        content: `<h4>🏰 길드 가입의 의미</h4><p>하나님 나라 사람이 되는 것과 그 나라 방식대로 사는 것 사이에 '세례'가 있습니다. 기독교는 자신만의 전인격적 고백이 필요한 종교이며, 절대 남에게 묻어갈 수 없습니다.</p><h4>💍 비밀 연애에서 공식 발표로</h4><p>세례를 좀 더 설레는 버전으로 설명하면, 비밀 연애를 하는 연인이 사귄다고 공식적으로 밝히는 것과 같습니다. 이 사람이라고 확신하기 때문입니다.</p>`
                    },
                    {
                        icon: "👥",
                        title: "공동체 속하기 - 병아리 공동체",
                        content: `<h4>🐣 병아리가 살아남는 법</h4><p>학교 앞에서 산 병아리가 살아남는 비결은 '공동체'였습니다. 공동체를 통해 무엇을 먹고, 어떻게 살아야 하는지 배우며 건강해집니다.</p><h4>🎮 길드 버프 받는 방법</h4><p>공동체 안에서 말씀을 듣고 배우는 버프, 다른 사람의 삶을 보고 배우는 버프를 통해 함께 성장할 수 있습니다.</p>`
                    },
                    {
                        icon: "🕊️",
                        title: "성령 따르기 - 우리 힘만으로는 어려워",
                        content: `<h4>🤝 늘 함께하는 참 좋은 스승</h4><p>우리 힘만으로는 어렵습니다. 성령님은 우리와 인격적인 관계를 원하시며, 우리가 자발적으로 하나님의 뜻을 선택하도록 도우시는 분입니다.</p><h4>📖➕🕊️ 성경과 성령의 콤보</h4><p>성경과 성령님은 따로 떼어놓고 생각할 수 없습니다. 성령님은 성경 말씀을 깨닫고 순종하도록 도우십니다.</p>`
                    }
                ],
                discussionQuestions: [
                    "나에게 신앙 공동체(길드)는 어떤 의미인가요? 공동체를 통해 '길드 버프'를 받았던 경험이 있다면 나눠주세요.",
                    "세례를 '비밀 연애에서 공식 발표로' 비유한 것처럼, 나의 신앙을 다른 사람들에게 공개적으로 표현하는 것에 대해 어떻게 생각하나요?",
                    "성령님을 '늘 함께하는 참 좋은 스승'으로 인격적으로 신뢰하고 따르기 위해, 구체적으로 어떤 노력을 할 수 있을까요?"
                ]
            },
            3: {
                title: "3강: 실전 시스템 - 인생은 장난이 아니니까",
                item: "성령의 열매",
                icebreaker: {
                    prompt: "3강을 시작하기 전에, '실전'이라는 단어를 들으면 어떤 생각이 드나요? 나의 신앙이 '실전'에 강하다고 생각하나요?"
                },
                lessons: [
                    {
                        icon: "📖→🌍",
                        title: "이론에서 현실로 - 성경은 그림의 떡이 아니다",
                        content: `<h4>📚 무책임한 동화에서 책임감 쩌는 현실로</h4><p>신앙은 '오래오래 행복하게 살았답니다'에서 끝나지 않습니다. 그 후의 삶을 하나님 나라 방식으로 살아내는 것이 진짜 이야기입니다.</p><h4>🎯 끝날 때까지 끝난 게 아니다</h4><p>일상에서 성경 원리를 적용하고, 실패를 두려워하지 말고, 계속해서 하나님을 알아가며 신뢰를 쌓아가는 것이 중요합니다.</p>`
                    },
                    {
                        icon: "⏰",
                        title: "매일 그분과 - 루틴! 재밌고 꾸준하게",
                        content: `<h4>📅 일대일 만남이라니</h4><p>하나님과의 개인적인 만남 시간, 즉 큐티(QT, Quiet Time)를 꾸준히 가지는 것이 중요합니다. 재밌고 꾸준하게 자신만의 루틴을 만들어보세요.</p><h4>📖 큐티, 시작해볼까요</h4><p>성경 읽기 → 하나님 알기 → 메시지 찾기 → 적용하기 → 기도하기 순서로 큐티를 진행해볼 수 있습니다.</p>`
                    },
                    {
                        icon: "🤗",
                        title: "일생을 함께 - 어, 살아서 움직이네",
                        content: `<h4>✨ 찬란했던 그 순간과 어둠의 시간</h4><p>인생의 좋은 순간과 힘든 순간 모두 하나님과 함께하며 신앙의 근육을 키워나가야 합니다.</p><h4>🌈 거룩한 상상</h4><p>하나님 나라의 완성된 모습을 소망하며 오늘의 어려움을 견디고, 이 땅에서 하나님 나라를 맛보며 살아갈 수 있습니다.</p>`
                    }
                ],
                discussionQuestions: [
                    "성경 말씀을 '그림의 떡'이 아닌, 내 삶의 '책임감 쩌는 현실'로 만들기 위해 어떤 노력을 하고 있나요? 또는 어떤 점이 가장 어렵나요?",
                    "매일 하나님과 만나는 '큐티' 시간을 꾸준히 갖기 위해 나에게 가장 필요한 것은 무엇일까요? (예: 시간, 장소, 의지, 좋은 교재 등)",
                    "최근 나의 삶에서 경험한 '찬란했던 순간'과 '어둠의 시간'은 각각 무엇이었나요? 그 시간들을 통해 하나님에 대해 무엇을 배우게 되었나요?"
                ]
            }
        };

        // --- Job System ---
        function getUserJobTitle(level) {
            if (level >= 90) return '마스터';
            if (level >= 60) return '청대장';
            if (level >= 30) return '청기사';
            return '푸른이';
        }

        // --- Core App Functions ---
        function showTab(tabName, navElement) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            navElement.classList.add('active');

            if (tabName === 'stages') {
                backToStages();
            }
            if (tabName === 'guild') {
                const guildChatContainer = document.getElementById('guild-chat-container');
                if (guildChatContainer) {
                    guildChatContainer.innerHTML = createChatInterface('guild');
                    updateChatMessages('guild');
                }
            }
        }

        function enterStageContent(stageNumber) {
            currentStage = stageNumber;
            const stageData = stageContents[stageNumber];
            
            if (!stageData) {
                showNotification('스테이지 데이터를 찾을 수 없습니다.');
                return;
            }

            document.getElementById('stage-list').classList.add('hidden');
            document.getElementById('stage-detail').classList.remove('hidden');
            
            let contentHtml = `<h3 style="margin-bottom: 20px; color: var(--lesson-title-color);">${stageData.title}</h3>`;

            if (stageData.icebreaker && !completedIcebreakers.some(item => item.stage === stageNumber && item.author === userName)) {
                contentHtml += `
                    <div class="icebreaker-section" id="icebreaker-section-${stageNumber}">
                        <div class="modal-title">아이스브레이크</div>
                        <p class="icebreaker-prompt">${stageData.icebreaker.prompt}</p>
                        <textarea id="icebreakerInput-${stageNumber}" class="icebreaker-input" placeholder="당신의 생각을 자유롭게 적어보세요..."></textarea>
                        <button class="modal-button primary" onclick="completeIcebreaker(${stageNumber})">제출하고 강의 보기</button>
                    </div>
                `;
            } else {
                contentHtml += stageData.lessons.map(lesson => `
                    <div class="lesson-container">
                        <div class="lesson-header">
                            <div class="lesson-icon">${lesson.icon}</div>
                            <div class="lesson-title">${lesson.title}</div>
                        </div>
                        <div class="lesson-content">${lesson.content}</div>
                    </div>
                `).join('');

                if (stageData.discussionQuestions) {
                    contentHtml += `
                        <div class="discussion-container">
                            <h4>🤔 함께 나눌 질문</h4>
                            <ol>
                                ${stageData.discussionQuestions.map(q => `<li>${q}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                }
                if (completedStages.includes(stageNumber)) {
                    contentHtml += `<div class="stage-completed-notice">✔️ 이 스테이지를 완료했습니다!</div>`;
                } else {
                    contentHtml += `<button id="complete-stage-btn" class="modal-button primary" style="width:100%; margin-top:20px; background-color: #28a745;" onclick="completeStage(${stageNumber})">스테이지 완료 및 보상 받기 🏆</button>`;
                }
            }

            document.getElementById('stage-content').innerHTML = contentHtml;
            document.querySelector('.content').scrollTop = 0;
        }

        function backToStages() {
            document.getElementById('stage-detail').classList.add('hidden');
            document.getElementById('stage-list').classList.remove('hidden');
            currentStage = null;
            updateIcebreakerRecordsDisplay();
        }

        function completeStage(stageNumber) {
            if (completedStages.includes(stageNumber)) {
                showNotification('이미 완료된 스테이지입니다!');
                return;
            }

            const button = document.getElementById('complete-stage-btn');
            if (button) {
                button.disabled = true;
                button.textContent = '완료 처리 중...';
            }

            const stageData = stageContents[stageNumber];
            let expGain = 300;
            let itemName = stageData.item || '특별한 아이템';

            completedStages.push(stageNumber);
            grantBadge(`${itemName} 획득`);
            addExperience(expGain, `🎉 스테이지 ${stageNumber} 완료! ${itemName} 획득! +${expGain} EXP!`);
            
            saveProgress();
            updateUI();
            
            enterStageContent(stageNumber); 
        }

        function togglePrayerTime(timeSlot, element) {
            if (prayerTimes[timeSlot]) {
                prayerTimes[timeSlot] = false;
                element.classList.remove('completed');
                showNotification(`${timeSlot} 기도 취소! 🙏`);
            } else {
                prayerTimes[timeSlot] = true;
                element.classList.add('completed');
                
                let message = '';
                let expGain = 30;
                
                switch(timeSlot) {
                    case 'morning': message = '🌅 아침 기도 완료! 하루를 주님과 함께 시작하세요!'; break;
                    case 'noon': message = '☀️ 점심 기도 완료! 하루 중반, 주님께 감사드려요!'; break;
                    case 'evening': message = '🌙 저녁 기도 완료! 하루를 주님께 맡겨드려요!'; break;
                }
                
                addExperience(expGain, message);
                grantBadge('첫 기도');
                
                if (prayerTimes.morning && prayerTimes.noon && prayerTimes.evening) {
                    setTimeout(() => {
                        addExperience(50, '🎉 10-10-10 기도법 완주! 보너스 경험치 +50!');
                        grantBadge('10-10-10 마스터');
                    }, 1000);
                }
                
                completedMissions++;
            }
            updateUI();
            saveProgress();
        }

        function showScripture() {
            const container = document.getElementById('scripture-container');
            const randomScripture = scriptures[Math.floor(Math.random() * scriptures.length)];
            
            container.innerHTML = `
                <div class="scripture-card">
                    <div class="scripture-text">"${randomScripture.text}"</div>
                    <div class="scripture-reference">- ${randomScripture.reference} -</div>
                </div>
                <button class="mission-button" onclick="completeMission(this, '말씀 묵상 완료! 영양분을 얻었습니다! 📖', 70, '성경 독자')" style="margin-top: 10px;">묵상 완료</button>
            `;
            document.getElementById('mission-btn-scripture').style.display = 'none';
        }
        
        function completeMission(button, message, expGain = 50, badgeToGrant = null) {
            button.textContent = '완료!';
            button.disabled = true;
            
            addExperience(expGain, message);
            if (badgeToGrant) grantBadge(badgeToGrant);
            
            completedMissions++;
            updateUI();
            saveProgress();
        }

        function addExperience(amount, notificationMessage) {
            userExp += amount;
            
            if (notificationMessage) {
                showNotification(notificationMessage);
            }

            while (userExp >= 100) {
                userLevel++;
                userExp -= 100;
                setTimeout(() => showNotification(`🎉 레벨업! Lv.${userLevel} 달성!`), 500);
            }
            updateUI();
        }

        // --- UI and Utility Functions ---
        function updateUI() {
            userJob = getUserJobTitle(userLevel);
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('headerAvatar').textContent = userAvatar;
            document.getElementById('userLevel').textContent = userLevel;
            document.getElementById('userExp').textContent = userExp;
            document.getElementById('userStreak').textContent = userStreak;
            
            document.getElementById('profileUserName').textContent = userName;
            document.getElementById('profileAvatar').textContent = userAvatar;
            document.getElementById('profileLevel').textContent = userLevel;
            document.getElementById('profileJob').textContent = userJob;
            document.getElementById('profileStreak').textContent = userStreak;
            document.getElementById('completedMissionsCount').textContent = completedMissions;
            
            document.getElementById('guildUserName').textContent = userName;
            document.getElementById('guildUserAvatar').textContent = userAvatar;
            document.getElementById('guildUserLevel').textContent = userLevel;
            document.getElementById('guildUserJob').textContent = userJob;
            document.getElementById('guildUserStreak').textContent = userStreak;
            document.getElementById('guildLevel').textContent = guildLevel;
            document.getElementById('guildExp').textContent = guildExp;
            
            const badgeContainer = document.getElementById('badge-container');
            if(userBadges.length > 0) {
                badgeContainer.innerHTML = userBadges.map(b => `<span>${b}</span>`).join('');
            } else {
                badgeContainer.innerHTML = `<p style="color: var(--text-color); font-size: 14px;">아직 획득한 뱃지가 없습니다.</p>`;
            }

            if (isFirebaseEnabled) {
                const userOnlineRef = database.ref(`onlineUsers/${userName}`);
                userOnlineRef.update({
                    name: userName,
                    avatar: userAvatar,
                    level: userLevel,
                    job: userJob,
                    streak: userStreak
                }).catch(error => console.log('사용자 정보 업데이트 실패:', error));
            }
        }

        function updateOnlineUsers() {
            const guildMembersContainer = document.querySelector('#guild-tab .guild-members-list');
            if (!guildMembersContainer) return;

            const now = Date.now();
            const activeUsers = Object.values(onlineUsers).filter(user => (now - user.lastSeen) < 30000);

            let membersHtml = '';
            
            const currentUserInList = activeUsers.find(user => user.name === userName);
            if (!currentUserInList) {
                 activeUsers.push({ name: userName, avatar: userAvatar, level: userLevel, job: userJob, streak: userStreak });
            }

            activeUsers.forEach(user => {
                const isCurrentUser = user.name === userName;
                membersHtml += `
                    <div style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--chat-messages-bg); border-radius: 10px;">
                        <div style="width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid ${isCurrentUser ? 'var(--modal-button-primary-bg)' : '#28a745'}; background: ${isCurrentUser ? 'var(--modal-button-primary-bg)' : '#28a745'}; color: white;">${user.avatar}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 2px; color: var(--text-color);">${user.name} ${isCurrentUser ? '(나)' : ''}</div>
                            <div style="font-size: 12px; color: var(--text-color);">레벨 ${user.level} ${user.job} • ${user.streak}일 연속 접속</div>
                        </div>
                        ${!isCurrentUser ? `<div style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">온라인</div>` : ''}
                    </div>
                `;
            });

            if (activeUsers.length === 0) {
                 membersHtml = `<div style="text-align: center; color: var(--text-color); padding: 20px;"><p>현재 접속 중인 사용자가 없습니다.</p></div>`;
            } else if (activeUsers.length === 1 && activeUsers[0].name === userName) {
                 membersHtml += `<div style="text-align: center; color: var(--text-color); padding: 20px;"><p>다른 길드원들이 접속하면 여기에 표시됩니다</p><p>친구들을 초대해보세요! 🎉</p></div>`;
            }

            guildMembersContainer.innerHTML = membersHtml;
        }
        
        function resetMissionUI() {
            document.querySelectorAll('.prayer-time-slot').forEach(slot => slot.classList.remove('completed'));
            document.querySelectorAll('.mission-button').forEach(btn => {
                btn.disabled = false;
                if(btn.id === 'mission-btn-worship') btn.textContent = '참여 완료';
                if(btn.id === 'mission-btn-quiz') btn.textContent = '퀴즈 시작';
            });
            document.getElementById('mission-btn-scripture').style.display = 'inline-block';
            document.getElementById('scripture-container').innerHTML = '';
            document.getElementById('guild-chat-container').innerHTML = '';
        }

        function showNotification(message) {
            const existingNotif = document.querySelector('.floating-notification');
            if(existingNotif) existingNotif.remove();
            const notification = document.createElement('div');
            notification.className = 'floating-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // --- Data Persistence ---
        function saveProgress() {
            try {
                const data = {
                    userName, userAvatar, userJob, userLevel, userExp, userStreak,
                    completedMissions, userBadges, completedStages, guildLevel, guildExp, 
                    prayerTimes, currentTheme,
                    lastLogin: new Date().toDateString(),
                    lastQuizMissionDate: safeGetItem('lastQuizMissionDate')
                };
                
                // Firebase-managed data is not saved to localStorage
                if (!isFirebaseEnabled) {
                    data.chatMessages = chatMessages;
                    data.notices = notices;
                    data.qtNotes = qtNotes;
                    data.completedIcebreakers = completedIcebreakers;
                }
                
                safeSetItem('blueWindProgress', JSON.stringify(data));
            } catch (error) {
                console.error('데이터 저장 실패:', error);
            }
        }

        function loadProgress() {
            try {
                const saved = safeGetItem('blueWindProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    userName = data.userName || '푸른이';
                    userAvatar = data.userAvatar || '🌟';
                    userLevel = data.userLevel || 1;
                    userExp = data.userExp || 0;
                    userStreak = data.userStreak || 1;
                    completedMissions = data.completedMissions || 0;
                    userJob = data.userJob || getUserJobTitle(userLevel);
                    userBadges = data.userBadges || [];
                    completedStages = data.completedStages || [];
                    guildLevel = data.guildLevel || 1;
                    guildExp = data.guildExp || 0;
                    currentTheme = data.currentTheme || 'light-mode';

                    if (!isFirebaseEnabled) {
                        chatMessages = data.chatMessages || [];
                        notices = data.notices || [];
                        qtNotes = data.qtNotes || [];
                        completedIcebreakers = data.completedIcebreakers || [];
                    }

                    const today = new Date().toDateString();
                    const lastLogin = data.lastLogin || today;

                    if (lastLogin !== today) {
                        const lastDate = new Date(lastLogin);
                        const todayDate = new Date(today);
                        const diffTime = todayDate - lastDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            userStreak++;
                            setTimeout(() => grantBadge(`${userStreak}일 연속`), 500);
                        } else if (diffDays > 1) {
                            userStreak = 1;
                        }
                        prayerTimes = { morning: false, noon: false, evening: false };
                    } else {
                        prayerTimes = data.prayerTimes || { morning: false, noon: false, evening: false };
                    }
                    
                    if (data.lastQuizMissionDate) {
                        safeSetItem('lastQuizMissionDate', data.lastQuizMissionDate);
                    }

                    setTimeout(() => {
                        Object.keys(prayerTimes).forEach(timeSlot => {
                            if (prayerTimes[timeSlot]) {
                                const slotElement = document.querySelector(`.prayer-time-slot[data-slot="${timeSlot}"]`);
                                if (slotElement) slotElement.classList.add('completed');
                            }
                        });
                    }, 100);
                } else {
                    setInitialState();
                }
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                showNotification('데이터 로드에 실패했습니다. 초기 설정으로 시작합니다.');
                setInitialState();
            }
            
            document.body.className = currentTheme;
            updateUI();
            if (!isFirebaseEnabled) {
                updateNotices();
                updateQTNotes();
                updateIcebreakerRecordsDisplay();
            }
        }
        
        function setInitialState() {
            userLevel = 1;
            userExp = 0;
            userStreak = 1;
            completedMissions = 0;
            userName = '푸른이';
            userAvatar = '🌟';
            userJob = '푸른이';
            userBadges = [];
            completedStages = [];
            guildLevel = 1;
            guildExp = 0;
            chatMessages = [];
            prayerTimes = { morning: false, noon: false, evening: false };
            notices = [];
            qtNotes = [];
            currentTheme = 'light-mode';
            completedIcebreakers = [];
            
            saveProgress();
        }

        // --- Notice Functions ---
        function showNoticeModal() {
            document.getElementById('noticeModal').style.display = 'flex';
            document.getElementById('noticePassword').focus();
        }

        function closeNoticeModal() {
            document.getElementById('noticeModal').style.display = 'none';
            document.getElementById('noticePassword').value = '';
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
        }

        function createNotice() {
            const password = document.getElementById('noticePassword').value;
            const title = document.getElementById('noticeTitle').value.trim();
            const content = document.getElementById('noticeContent').value.trim();

            if (password !== '0000') {
                showNotification('관리자 비밀번호가 틀렸습니다! ❌');
                return;
            }

            if (!title || !content) {
                showNotification('제목과 내용을 모두 입력해주세요!');
                return;
            }

            const notice = {
                id: Date.now(),
                title: title,
                content: content,
                date: new Date().toLocaleDateString('ko-KR'),
                author: userName
            };

            if (isFirebaseEnabled) {
                database.ref('notices').push(notice)
                    .then(() => showNotification('공지사항이 모든 사용자에게 실시간으로 공유되었습니다! 📢🔥'))
                    .catch((error) => showNotification('공지사항 저장에 실패했습니다.'));
            } else {
                notices.unshift(notice);
                updateNotices();
                showNotification('공지사항이 등록되었습니다! 📢 (로컬 모드)');
                saveProgress();
            }

            closeNoticeModal();
        }

        function updateNotices() {
            const container = document.getElementById('notices-container');
            if (notices.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;"><p>등록된 공지사항이 없습니다.</p></div>`;
            } else {
                const notice = notices[0];
                container.innerHTML = `
                    <div class="notice-card">
                        <div class="notice-header">
                            <div class="notice-title">📢 ${notice.title}</div>
                            <div class="notice-date">${notice.date}</div>
                        </div>
                        <div class="notice-content">${notice.content}</div>
                    </div>
                `;
            }
        }

        // --- QT Note Functions ---
        function showQTNoteModal() {
            editingQTNote = null;
            document.getElementById('qtModalTitle').textContent = 'QT 노트 작성';
            document.getElementById('qtSubmitBtn').textContent = '작성 완료';
            document.getElementById('qtSubmitBtn').onclick = createQTNote;
            document.getElementById('qtNoteTitle').value = '';
            document.getElementById('qtNoteContent').value = '';
            document.getElementById('qtNotePassword').value = '';
            document.getElementById('qtNoteModal').style.display = 'flex';
            setTimeout(() => document.getElementById('qtNoteTitle').focus(), 100);
        }

        function closeQTNoteModal() {
            document.getElementById('qtNoteModal').style.display = 'none';
        }

        function createQTNote() {
            const title = document.getElementById('qtNoteTitle').value.trim();
            const content = document.getElementById('qtNoteContent').value.trim();
            const password = document.getElementById('qtNotePassword').value.trim();

            if (!title || !content || !password) {
                showNotification('제목, 내용, 비밀번호를 모두 입력해주세요!');
                return;
            }

            if (editingQTNote) {
                const updatedNote = { ...editingQTNote, title, content, password, date: new Date().toLocaleDateString('ko-KR') };
                if (isFirebaseEnabled) {
                    database.ref('qtNotes').once('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const key = Object.keys(data).find(k => data[k].id === editingQTNote.id);
                            if (key) {
                                database.ref(`qtNotes/${key}`).update(updatedNote)
                                    .then(() => showNotification('QT 노트가 수정되었습니다! ✏️🔥'))
                                    .catch(() => showNotification('QT 노트 수정에 실패했습니다.'));
                            }
                        }
                    });
                } else {
                    const index = qtNotes.findIndex(n => n.id === editingQTNote.id);
                    if (index > -1) qtNotes[index] = updatedNote;
                    updateQTNotes();
                    saveProgress();
                    showNotification('QT 노트가 수정되었습니다! ✏️');
                }
            } else {
                const newNote = { id: Date.now(), title, content, password, author: userName, date: new Date().toLocaleDateString('ko-KR'), likes: 0, likedBy: [], comments: [] };
                if (isFirebaseEnabled) {
                    database.ref('qtNotes').push(newNote)
                        .then(() => showNotification('QT 노트가 공유되었습니다! 📝🔥'))
                        .catch(() => showNotification('QT 노트 저장에 실패했습니다.'));
                } else {
                    qtNotes.unshift(newNote);
                    updateQTNotes();
                    saveProgress();
                    showNotification('QT 노트가 작성되었습니다! 📝');
                }
            }
            closeQTNoteModal();
        }

        function updateQTNotes() {
            const container = document.getElementById('qt-notes-container');
            if (!container) return;
            
            if (qtNotes.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;"><p>작성된 QT 노트가 없습니다.</p><p>첫 번째 QT 노트를 작성해보세요! 📝</p></div>`;
            } else {
                container.innerHTML = qtNotes.map(note => {
                    const commentsHtml = (note.comments || []).map(comment => `
                        <div class="comment-item">
                            <div class="comment-header"><span class="comment-author">${comment.author}</span><span class="comment-time">${comment.time}</span></div>
                            <div class="comment-content">${comment.content}</div>
                            ${comment.author === userName ? `<div class="comment-actions"><button class="comment-action-btn edit" onclick="editComment(${note.id}, ${comment.id})">수정</button><button class="comment-action-btn delete" onclick="deleteComment(${note.id}, ${comment.id})">삭제</button></div>` : ''}
                        </div>`).join('');

                    return `
                    <div class="qt-note-card">
                        <div class="qt-note-header"><div class="qt-note-title">${note.title}</div><div class="qt-note-date">${note.date}</div></div>
                        <div class="qt-note-content">${note.content}</div>
                        <div class="qt-note-actions">
                            <button class="like-button" onclick="toggleLike(${note.id})">${(note.likedBy || []).includes(userName) ? '❤️' : '🤍'} ${note.likes || 0}</button>
                            ${note.author === userName ? `<div class="note-buttons"><button class="note-btn edit" onclick="editQTNote(${note.id})">수정</button><button class="note-btn delete" onclick="deleteQTNote(${note.id})">삭제</button></div>` : ''}
                        </div>
                        <div class="comments-section">
                            <h5>💬 댓글 (${(note.comments || []).length})</h5>
                            <div class="comment-input-container">
                                <textarea id="commentInput-${note.id}" class="comment-input" placeholder="댓글을 입력하세요..." rows="2"></textarea>
                                <input type="password" id="commentPassword-${note.id}" class="comment-password-input" placeholder="비밀번호 (수정/삭제용)" maxlength="10">
                                <button class="comment-send-btn" onclick="addComment(${note.id})">댓글 작성</button>
                            </div>
                            <div class="comment-list">${(note.comments && note.comments.length > 0) ? commentsHtml : `<p style="color: var(--text-color); text-align: center;">아직 댓글이 없습니다.</p>`}</div>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function toggleLike(noteId) {
            const noteIndex = qtNotes.findIndex(n => n.id === noteId);
            if (noteIndex === -1) return;
            const note = { ...qtNotes[noteIndex] };
            
            note.likedBy = note.likedBy || [];
            note.likes = note.likes || 0;

            const userIndex = note.likedBy.indexOf(userName);
            if (userIndex > -1) {
                note.likedBy.splice(userIndex, 1);
                note.likes--;
            } else {
                note.likedBy.push(userName);
                note.likes++;
            }

            if (isFirebaseEnabled) {
                database.ref('qtNotes').once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const key = Object.keys(data).find(k => data[k].id === noteId);
                        if (key) database.ref(`qtNotes/${key}`).update({ likes: note.likes, likedBy: note.likedBy });
                    }
                });
            } else {
                qtNotes[noteIndex] = note;
                updateQTNotes();
                saveProgress();
            }
        }

        function editQTNote(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;
            pendingQTAction = { type: 'qtNote', action: 'edit', noteId: noteId };
            document.getElementById('passwordModalText').textContent = 'QT 노트를 수정하려면 비밀번호를 입력하세요:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function deleteQTNote(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;
            pendingQTAction = { type: 'qtNote', action: 'delete', noteId: noteId };
            document.getElementById('passwordModalText').textContent = 'QT 노트를 삭제하려면 비밀번호를 입력하세요:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function addComment(noteId) {
            const noteIndex = qtNotes.findIndex(n => n.id === noteId);
            if (noteIndex === -1) return;

            const inputElement = document.getElementById(`commentInput-${noteId}`);
            const passwordElement = document.getElementById(`commentPassword-${noteId}`);
            const commentContent = inputElement.value.trim();
            const commentPassword = passwordElement.value.trim();

            if (!commentContent || !commentPassword) {
                showNotification('댓글 내용과 비밀번호를 모두 입력해주세요!');
                return;
            }
            
            const note = { ...qtNotes[noteIndex] };
            if (!note.comments) note.comments = [];

            const newComment = { id: Date.now(), author: userName, avatar: userAvatar, content: commentContent, password: commentPassword, time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) };
            note.comments.push(newComment);

            if (isFirebaseEnabled) {
                database.ref('qtNotes').once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const key = Object.keys(data).find(k => data[k].id === noteId);
                        if (key) database.ref(`qtNotes/${key}`).update({ comments: note.comments });
                    }
                });
            } else {
                qtNotes[noteIndex] = note;
                updateQTNotes();
                saveProgress();
            }
            inputElement.value = '';
            passwordElement.value = '';
        }

        function editComment(noteId, commentId) {
            pendingQTAction = { type: 'comment', action: 'edit', noteId, commentId };
            document.getElementById('passwordModalText').textContent = '댓글을 수정하려면 비밀번호를 입력하세요:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function deleteComment(noteId, commentId) {
            pendingQTAction = { type: 'comment', action: 'delete', noteId, commentId };
            document.getElementById('passwordModalText').textContent = '댓글을 삭제하려면 비밀번호를 입력하세요:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function confirmQTAction() {
            if (!pendingQTAction) return;

            const password = document.getElementById('qtActionPassword').value;
            let targetItem, note, noteIndex;

            if (pendingQTAction.type === 'qtNote') {
                targetItem = qtNotes.find(n => n.id === pendingQTAction.noteId);
            } else {
                noteIndex = qtNotes.findIndex(n => n.id === pendingQTAction.noteId);
                if (noteIndex > -1) {
                    note = qtNotes[noteIndex];
                    targetItem = (note.comments || []).find(c => c.id === pendingQTAction.commentId);
                }
            }

            if (!targetItem || targetItem.password !== password) {
                showNotification('비밀번호가 틀렸습니다! ❌');
                return;
            }

            if (pendingQTAction.type === 'qtNote') {
                if (pendingQTAction.action === 'edit') {
                    editingQTNote = targetItem;
                    document.getElementById('qtModalTitle').textContent = 'QT 노트 수정';
                    document.getElementById('qtSubmitBtn').textContent = '수정 완료';
                    document.getElementById('qtNoteTitle').value = targetItem.title;
                    document.getElementById('qtNoteContent').value = targetItem.content;
                    document.getElementById('qtNotePassword').value = targetItem.password;
                    document.getElementById('qtNoteModal').style.display = 'flex';
                } else if (pendingQTAction.action === 'delete') {
                    if (isFirebaseEnabled) {
                         database.ref('qtNotes').once('value', (snapshot) => {
                            const data = snapshot.val();
                            if (data) {
                                const key = Object.keys(data).find(k => data[k].id === pendingQTAction.noteId);
                                if (key) database.ref(`qtNotes/${key}`).remove();
                            }
                        });
                    } else {
                        qtNotes = qtNotes.filter(n => n.id !== pendingQTAction.noteId);
                        updateQTNotes();
                        saveProgress();
                    }
                }
            } else if (pendingQTAction.type === 'comment') {
                const commentIndex = note.comments.findIndex(c => c.id === pendingQTAction.commentId);
                if (commentIndex === -1) return;

                if (pendingQTAction.action === 'edit') {
                    const newContent = prompt('새로운 댓글 내용을 입력하세요:', targetItem.content);
                    if (newContent !== null) {
                        note.comments[commentIndex].content = newContent.trim();
                        note.comments[commentIndex].time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) + ' (수정됨)';
                    }
                } else if (pendingQTAction.action === 'delete') {
                    note.comments.splice(commentIndex, 1);
                }

                if (isFirebaseEnabled) {
                     database.ref('qtNotes').once('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const key = Object.keys(data).find(k => data[k].id === pendingQTAction.noteId);
                            if (key) database.ref(`qtNotes/${key}`).update({ comments: note.comments });
                        }
                    });
                } else {
                    qtNotes[noteIndex] = note;
                    updateQTNotes();
                    saveProgress();
                }
            }
            closeQTPasswordModal();
        }

        function closeQTPasswordModal() {
            document.getElementById('qtPasswordModal').style.display = 'none';
            document.getElementById('qtActionPassword').value = '';
            pendingQTAction = null;
        }

        // --- Badge Functions ---
        function grantBadge(badgeName) {
            if (!userBadges.includes(badgeName)) {
                userBadges.push(badgeName);
                showNotification(`🏆 뱃지 획득: ${badgeName}!`);
                updateUI();
                saveProgress();
            }
        }

        // --- Chat Functions ---
        function createChatInterface(prefix) {
            return `
                <div class="chat-container">
                    <div class="chat-messages" id="${prefix}Messages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="${prefix}Input" placeholder="길드원들과 대화해보세요..." onkeypress="handleChatKeyPress(event, '${prefix}')">
                        <button class="image-upload-btn" onclick="document.getElementById('${prefix}FileInput').click()">📷</button>
                        <button class="chat-send-btn" onclick="sendMessage('${prefix}')">전송</button>
                        <input type="file" id="${prefix}FileInput" class="hidden-file-input" accept="image/*" onchange="handleImageUpload(event, '${prefix}')">
                    </div>
                </div>
            `;
        }

        function updateChatMessages(prefix) {
            const messagesContainer = document.getElementById(`${prefix}Messages`);
            if (!messagesContainer) return;
            
            if (chatMessages.length === 0) {
                messagesContainer.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px;"><p>첫 번째 메시지를 보내보세요! 💬</p></div>`;
            } else {
                messagesContainer.innerHTML = chatMessages.map(msg => `
                    <div class="message ${msg.sender === userName ? 'user' : 'other'}">
                        <div class="message-header">
                            <div class="message-avatar">${msg.avatar || '👤'}</div>
                            <div class="message-sender">${msg.sender}</div>
                            <div class="message-time">${msg.time}</div>
                        </div>
                        <div class="message-bubble">${msg.message}</div>
                        ${msg.image ? `<img src="${msg.image}" alt="업로드된 이미지" class="message-image" onclick="showImageModal('${msg.image}')">` : ''}
                    </div>
                `).join('');
            }
            
            setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 50);
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || file.size > 5 * 1024 * 1024) {
                showNotification('이미지 크기는 5MB 이하만 가능합니다! 📷');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const now = new Date();
                const messageData = { id: Date.now(), sender: userName, avatar: userAvatar, message: '사진을 업로드했습니다 📷', image: e.target.result, time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }), timestamp: now.getTime() };
                if (isFirebaseEnabled) database.ref('chatMessages').push(messageData);
                else { chatMessages.push(messageData); updateChatMessages('guild'); saveProgress(); }
            };
            reader.readAsDataURL(file);
        }

        function showImageModal(imageSrc) {
            const modal = document.getElementById('quizModal');
            document.getElementById('quiz-modal-content').innerHTML = `
                <div class="modal-title">이미지 보기</div>
                <img src="${imageSrc}" style="max-width: 100%; max-height: 70vh; border-radius: 10px;">
                <div class="modal-buttons" style="margin-top: 15px;"><button class="modal-button secondary" onclick="closeQuizModal()">닫기</button></div>`;
            modal.style.display = 'flex';
        }

        function sendMessage(prefix) {
            const input = document.getElementById(`${prefix}Input`);
            const message = input.value.trim();
            if (message) {
                const now = new Date();
                const messageData = { id: Date.now(), sender: userName, avatar: userAvatar, message: message, time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }), timestamp: now.getTime() };
                if (isFirebaseEnabled) database.ref('chatMessages').push(messageData);
                else { chatMessages.push(messageData); updateChatMessages('guild'); saveProgress(); }
                input.value = '';
            }
        }

        function handleChatKeyPress(event, prefix) {
            if (event.key === 'Enter') sendMessage(prefix);
        }

        // --- Quiz Functions ---
        function seededRandom(seed) {
            var x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function getDailyQuizQuestions() {
            const today = new Date();
            const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
            let questions = [...allQuizQuestions];
            for (let i = questions.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom(seed + i) * (i + 1));
                [questions[i], questions[j]] = [questions[j], questions[i]];
            }
            return questions.slice(0, 3);
        }

        function startQuiz() {
            if (safeGetItem('lastQuizMissionDate') === new Date().toDateString()) {
                showNotification('오늘은 이미 퀴즈 미션을 완료했습니다! 내일 다시 도전해주세요. 😊');
                return;
            }
            dailyQuiz = getDailyQuizQuestions();
            currentQuizIndex = 0;
            displayQuizQuestion();
            document.getElementById('quizModal').style.display = 'flex';
        }

        function displayQuizQuestion() {
            const modalContent = document.getElementById('quiz-modal-content');
            if (currentQuizIndex >= dailyQuiz.length) {
                modalContent.innerHTML = `<div class="modal-title">퀴즈 완료!</div><p>모든 퀴즈를 완료했습니다. 🎉</p><div class="modal-buttons"><button class="modal-button primary" onclick="completeQuizMission()">보상 받기</button></div>`;
                return;
            }
            const questionData = dailyQuiz[currentQuizIndex];
            const optionsHtml = questionData.options.map(option => `<button class="quiz-option" onclick="checkQuizAnswer('${option}')">${option}</button>`).join('');
            modalContent.innerHTML = `<div class="modal-title">신앙 퀴즈 (${currentQuizIndex + 1}/${dailyQuiz.length})</div><p style="font-weight: bold;">${questionData.question}</p><div>${optionsHtml}</div>`;
        }

        function checkQuizAnswer(selectedOption) {
            if (selectedOption === dailyQuiz[currentQuizIndex].answer) {
                showNotification('정답입니다! 🥳');
                currentQuizIndex++;
                setTimeout(displayQuizQuestion, 500);
            } else {
                showNotification('오답입니다. 다시 시도해보세요. 😔');
            }
        }

        function completeQuizMission() {
            const rewardButton = document.querySelector('#quiz-modal-content .modal-button.primary');
            if (rewardButton) rewardButton.disabled = true;

            addExperience(50, '퀴즈 미션 완료! 지혜가 +50 증가했습니다! 🧠');
            grantBadge('퀴즈 마스터');
            safeSetItem('lastQuizMissionDate', new Date().toDateString());
            
            const quizButton = document.getElementById('mission-btn-quiz');
            if (quizButton) {
                quizButton.textContent = '완료!';
                quizButton.disabled = true;
            }
            saveProgress();
            setTimeout(closeQuizModal, 1000);
        }

        function closeQuizModal() {
            document.getElementById('quizModal').style.display = 'none';
        }

        // --- Icebreaker Functions ---
        function completeIcebreaker(stageNumber) {
            const answer = document.getElementById(`icebreakerInput-${stageNumber}`).value.trim();
            if (!answer) {
                showNotification('답변을 입력해주세요!');
                return;
            }

            const stageData = stageContents[stageNumber];
            const record = {
                id: Date.now(),
                stage: stageNumber,
                question: stageData.icebreaker ? stageData.icebreaker.prompt : '질문 없음',
                answer: answer,
                author: userName,
                date: new Date().toLocaleDateString('ko-KR')
            };

            if (isFirebaseEnabled) {
                database.ref('icebreakerRecords').push(record)
                    .then(() => showNotification(`아이스브레이크 완료! 스테이지 ${stageNumber}의 문이 열렸습니다!`))
                    .catch(() => showNotification('아이스브레이크 저장에 실패했습니다.'));
            } else {
                completedIcebreakers.push(record);
                updateIcebreakerRecordsDisplay();
                saveProgress();
                showNotification(`아이스브레이크 완료! (로컬 모드)`);
            }
            enterStageContent(stageNumber);
        }

        function updateIcebreakerRecordsDisplay() {
            const container = document.getElementById('icebreaker-records-container');
            if (!container) return;

            if (completedIcebreakers.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;"><p>작성된 아이스브레이크 기록이 없습니다.</p><p>학습 스테이지를 시작하여 첫 기록을 남겨보세요! ✨</p></div>`;
            } else {
                container.innerHTML = completedIcebreakers.map(record => `
                    <div class="qt-note-card" style="margin-bottom: 15px;">
                        <div class="qt-note-header"><div class="qt-note-title">스테이지 ${record.stage} 아이스브레이크</div><div class="qt-note-date">${record.date} | ${record.author}</div></div>
                        <div style="margin-bottom: 10px;"><div style="color: var(--lesson-content-h4-color); font-weight: bold; margin-bottom: 8px; font-size: 14px;">💭 질문:</div><div style="color: var(--qt-note-content); line-height: 1.5; padding: 10px; background: var(--nav-bg); border-radius: 8px; font-style: italic;">${record.question}</div></div>
                        <div><div style="color: var(--lesson-content-h4-color); font-weight: bold; margin-bottom: 8px; font-size: 14px;">✍️ 답변:</div><div class="qt-note-content" style="padding: 10px; background: var(--app-bg); border-radius: 8px; border-left: 4px solid var(--modal-button-primary-bg);">${record.answer}</div></div>
                    </div>`).join('');
            }
        }

        // --- Modal Functions ---
        function showNameModal() {
            document.getElementById('nameInput').value = userName;
            document.getElementById('nameModal').style.display = 'flex';
            document.getElementById('nameInput').focus();
        }
        function closeNameModal() { document.getElementById('nameModal').style.display = 'none'; }
        function changeName() {
            const newName = document.getElementById('nameInput').value.trim();
            if (newName && newName.length > 0 && newName.length <= 10) {
                if (isFirebaseEnabled) database.ref(`onlineUsers/${userName}`).remove();
                userName = newName;
                updateUI();
                closeNameModal();
                showNotification('닉네임이 변경되었습니다! 🎉');
                saveProgress();
            } else {
                showNotification('닉네임은 1~10자 사이로 입력해주세요!');
            }
        }

        function showAvatarModal() { document.getElementById('avatarModal').style.display = 'flex'; }
        function closeAvatarModal() { document.getElementById('avatarModal').style.display = 'none'; }
        function selectAvatar(emoji) {
            userAvatar = emoji;
            updateUI();
            closeAvatarModal();
            showNotification('프로필 사진이 변경되었습니다! ✨');
            saveProgress();
        }

        function showResetModal() { document.getElementById('resetModal').style.display = 'flex'; }
        function closeResetModal() { document.getElementById('resetModal').style.display = 'none'; }
        function confirmReset() {
            if (document.getElementById('adminPassword').value === '0000') {
                if (isFirebaseEnabled) {
                    database.ref().remove()
                        .then(() => showNotification('🔥 Firebase 데이터가 초기화되었습니다!'));
                }
                safeRemoveItem('blueWindProgress');
                safeRemoveItem('lastQuizMissionDate');
                memoryStorage = {};
                
                setInitialState();
                updateUI();
                resetMissionUI();
                updateQTNotes();
                updateNotices();
                updateOnlineUsers();
                updateIcebreakerRecordsDisplay();
                
                closeResetModal();
                showNotification('모든 데이터가 초기화되었습니다. 🔄');
            } else {
                showNotification('비밀번호가 틀렸습니다! ❌');
            }
        }

        // --- Theme Toggle Function ---
        function toggleTheme() {
            currentTheme = document.body.classList.contains('light-mode') ? 'dark-mode' : 'light-mode';
            document.body.className = currentTheme;
            showNotification(currentTheme === 'dark-mode' ? '다크 모드로 전환되었습니다 🌙' : '라이트 모드로 전환되었습니다 ☀️');
            saveProgress();
        }

        // --- App Initialization ---
        function initApp() {
            loadProgress();
            initFirebase();
            
            setTimeout(() => showNotification(`${userName}님, 푸른나라학교에 오신 것을 환영합니다! 🌟`), 1000);

            const lastQuizMissionDate = safeGetItem('lastQuizMissionDate');
            const today = new Date().toDateString();
            const quizButton = document.getElementById('mission-btn-quiz');

            if (lastQuizMissionDate === today) {
                if (quizButton) {
                    quizButton.textContent = '완료!';
                    quizButton.disabled = true;
                }
            }

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
        window.addEventListener('beforeunload', saveProgress);

    </script>
</body>
</html>
