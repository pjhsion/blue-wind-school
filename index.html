<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‘¸ë¥¸ë‚˜ë¼í•™êµ - ì‹ ì•™ RPG</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="í‘¸ë¥¸ë‚˜ë¼í•™êµ">
    
    <style>
        /* Pretendard í°íŠ¸ ì„í¬íŠ¸ */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --app-bg: white;
            --text-color: #333;
            --header-gradient-start: #4facfe;
            --header-gradient-end: #00f2fe;
            --header-text-color: white;
            --nav-bg: #f8f9fa;
            --nav-border: #dee2e6;
            --nav-item-color: #495057;
            --nav-item-active-bg: #4facfe;
            --nav-item-active-color: white;
            --nav-item-hover-bg: #e9ecef;
            --nav-item-active-hover-bg: #3d8bfe;
            --notice-bg-start: #fff3cd;
            --notice-bg-end: #ffeeba;
            --notice-border: #ffc107;
            --notice-text: #856404;
            --mission-card-bg: #f8f9fa;
            --mission-card-border: #dee2e6;
            --mission-button-bg: #4facfe;
            --mission-button-hover-bg: #3d8bfe;
            --mission-button-disabled-bg: #28a745;
            --prayer-card-bg-start: #ffecd2;
            --prayer-card-bg-end: #fcb69f;
            --prayer-card-title: #8b4513;
            --prayer-slot-bg: rgba(255,255,255,0.7);
            --prayer-slot-hover-border: #8b4513;
            --prayer-slot-completed-bg: #d4edda;
            --prayer-slot-completed-border: #28a745;
            --scripture-card-bg-start: #e3f2fd;
            --scripture-card-bg-end: #bbdefb;
            --scripture-card-border: #2196f3;
            --scripture-text: #1565c0;
            --scripture-reference: #0d47a1;
            --chat-container-bg: #f8f9fa;
            --chat-messages-bg: white;
            --chat-input-border: #dee2e6;
            --chat-input-focus-border: #4facfe;
            --chat-send-btn-bg: #4facfe;
            --chat-send-btn-hover-bg: #3d8bfe;
            --image-upload-btn-bg: #17a2b8;
            --image-upload-btn-hover-bg: #138496;
            --message-user-bubble-bg: #4facfe;
            --message-user-bubble-color: white;
            --message-other-bubble-bg: #f1f3f4;
            --message-other-bubble-color: #333;
            --message-user-avatar-bg: #3d8bfe;
            --message-other-avatar-bg: #6c757d;
            --qt-note-card-bg: white;
            --qt-note-card-border: #dee2e6;
            --qt-note-title: #4facfe;
            --qt-note-date: #666;
            --qt-note-content: #333;
            --like-button-color: #e91e63;
            --like-button-hover-color: #c2185b;
            --note-btn-bg: #6c757d;
            --note-btn-edit-bg: #ffc107;
            --note-btn-delete-bg: #dc3545;
            --modal-bg: rgba(0,0,0,0.5);
            --modal-content-bg: white;
            --modal-title-color: #4facfe;
            --modal-input-border: #dee2e6;
            --modal-input-focus-border: #4facfe;
            --modal-button-primary-bg: #4facfe;
            --modal-button-primary-hover-bg: #3d8bfe;
            --modal-button-secondary-bg: #6c757d;
            --modal-button-secondary-hover-bg: #5a6268;
            --lesson-container-bg: white;
            --lesson-header-border: #e9ecef;
            --lesson-title-color: #4facfe;
            --lesson-content-color: #333;
            --lesson-content-h4-color: #4facfe;
            --lesson-content-strong-color: #2c5aa0;
            --stage-card-bg-start: #89f7fe;
            --stage-card-bg-end: #66a6ff;
            --stage-completed-bg: #e8f5e9;
            --stage-completed-color: #2e7d32;
            --stage-completed-border: #a5d6a7;
            --discussion-bg: #f1f8e9;
            --discussion-border-left: #8bc34a;
            --discussion-h4-color: #33691e;
            --discussion-ol-color: #555;
            --badge-bg: #ffd700;
            --badge-color: #333;
            --minigame-canvas-bg: #e0f7fa;
            --quiz-option-border: #4facfe;
            --quiz-option-bg: white;
            --quiz-option-color: #4facfe;
            --quiz-option-hover-bg: #e3f2fd;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-gradient-start: #2c3e50;
            --bg-gradient-end: #34495e;
            --app-bg: #3b4d61;
            --text-color: #ecf0f1;
            --header-gradient-start: #1a2a3a;
            --header-gradient-end: #2a3a4a;
            --header-text-color: #ecf0f1;
            --nav-bg: #2c3e50;
            --nav-border: #44586b;
            --nav-item-color: #bdc3c7;
            --nav-item-active-bg: #1abc9c;
            --nav-item-active-color: white;
            --nav-item-hover-bg: #34495e;
            --nav-item-active-hover-bg: #16a085;
            --notice-bg-start: #4a4a3a;
            --notice-bg-end: #5a5a4a;
            --notice-border: #8b8b7a;
            --notice-text: #e0e0d1;
            --mission-card-bg: #44586b;
            --mission-card-border: #5a6e80;
            --mission-button-bg: #1abc9c;
            --mission-button-hover-bg: #16a085;
            --mission-button-disabled-bg: #27ae60;
            --prayer-card-bg-start: #5a4a3a;
            --prayer-card-bg-end: #6a5a4a;
            --prayer-card-title: #e0d1b1;
            --prayer-slot-bg: rgba(255,255,255,0.1);
            --prayer-slot-hover-border: #e0d1b1;
            --prayer-slot-completed-bg: #27ae60;
            --prayer-slot-completed-border: #2ecc71;
            --scripture-card-bg-start: #3a4a5a;
            --scripture-card-bg-end: #4a5a6a;
            --scripture-card-border: #3498db;
            --scripture-text: #aed6f1;
            --scripture-reference: #85c1e9;
            --chat-container-bg: #44586b;
            --chat-messages-bg: #3b4d61;
            --chat-input-border: #5a6e80;
            --chat-input-focus-border: #1abc9c;
            --chat-send-btn-bg: #1abc9c;
            --chat-send-btn-hover-bg: #16a085;
            --image-upload-btn-bg: #2980b9;
            --image-upload-btn-hover-bg: #2c3e50;
            --message-user-bubble-bg: #1abc9c;
            --message-user-bubble-color: white;
            --message-other-bubble-bg: #5a6e80;
            --message-other-bubble-color: #ecf0f1;
            --message-user-avatar-bg: #16a085;
            --message-other-avatar-bg: #7f8c8d;
            --qt-note-card-bg: #44586b;
            --qt-note-card-border: #5a6e80;
            --qt-note-title: #1abc9c;
            --qt-note-date: #bdc3c7;
            --qt-note-content: #ecf0f1;
            --like-button-color: #e74c3c;
            --like-button-hover-color: #c0392b;
            --note-btn-bg: #7f8c8d;
            --note-btn-edit-bg: #f39c12;
            --note-btn-delete-bg: #e74c3c;
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #3b4d61;
            --modal-title-color: #1abc9c;
            --modal-input-border: #5a6e80;
            --modal-input-focus-border: #1abc9c;
            --modal-button-primary-bg: #1abc9c;
            --modal-button-primary-hover-bg: #16a085;
            --modal-button-secondary-bg: #7f8c8d;
            --modal-button-secondary-hover-bg: #6c757d;
            --lesson-container-bg: #44586b;
            --lesson-header-border: #5a6e80;
            --lesson-title-color: #1abc9c;
            --lesson-content-color: #ecf0f1;
            --lesson-content-h4-color: #1abc9c;
            --lesson-content-strong-color: #3498db;
            --stage-card-bg-start: #1abc9c;
            --stage-card-bg-end: #3498db;
            --stage-completed-bg: #27ae60;
            --stage-completed-color: #d4edda;
            --stage-completed-border: #2ecc71;
            --discussion-bg: #2ecc71;
            --discussion-border-left: #27ae60;
            --discussion-h4-color: #1a532d;
            --discussion-ol-color: #ecf0f1;
            --badge-bg: #f1c40f;
            --badge-color: #333;
            --minigame-canvas-bg: #3a4a5a;
            --quiz-option-border: #1abc9c;
            --quiz-option-bg: #44586b;
            --quiz-option-color: #ecf0f1;
            --quiz-option-hover-bg: #5a6e80;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.5s ease, color 0.5s ease;
        }

        .app-container {
            max-width: 414px;
            margin: 0 auto;
            background: var(--app-bg);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: var(--header-text-color);
            padding: 20px;
            text-align: center;
            position: relative;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .character-avatar {
            width: 80px;
            height: 80px;
            background: var(--app-bg);
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.3s ease, background 0.5s ease;
        }

        .character-avatar:hover {
            transform: scale(1.05);
        }

        .user-name {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .user-name:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 14px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            font-size: 18px;
        }

        .navigation {
            display: flex;
            background: var(--nav-bg);
            border-top: 1px solid var(--nav-border);
            flex-shrink: 0;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .nav-item {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: var(--nav-item-color);
            transition: all 0.3s ease;
        }

        .nav-item.active {
            background: var(--nav-item-active-bg);
            color: var(--nav-item-active-color);
        }

        .nav-item:hover {
            background: var(--nav-item-hover-bg);
        }

        .nav-item.active:hover {
            background: var(--nav-item-active-hover-bg);
        }

        .content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .notice-card {
            background: linear-gradient(135deg, var(--notice-bg-start) 0%, var(--notice-bg-end) 100%);
            border: 1px solid var(--notice-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notice-title {
            font-weight: bold;
            color: var(--notice-text);
        }

        .notice-date {
            font-size: 12px;
            color: var(--notice-text);
            opacity: 0.8;
        }

        .notice-content {
            color: var(--notice-text);
            line-height: 1.5;
        }

        .mission-card {
            background: var(--mission-card-bg);
            border: 1px solid var(--mission-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.5s ease, border-color 0.5s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mission-title {
            font-weight: bold;
            color: var(--text-color);
        }

        .mission-reward {
            background: #ffd700;
            color: #333;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .mission-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .mission-button {
            background: var(--mission-button-bg);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .mission-button:hover {
            background: var(--mission-button-hover-bg);
            transform: scale(1.05);
        }

        .mission-button:disabled {
            background: var(--mission-button-disabled-bg);
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none;
        }

        .floating-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 25px;
            font-weight: bold;
            animation: slideInDown 0.3s ease;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .prayer-time-card {
            background: linear-gradient(135deg, var(--prayer-card-bg-start) 0%, var(--prayer-card-bg-end) 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            transition: background 0.5s ease;
        }

        .prayer-time-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--prayer-card-title);
            margin-bottom: 15px;
        }

        .prayer-time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .prayer-time-slot {
            background: var(--prayer-slot-bg);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease, background 0.5s ease;
        }

        .prayer-time-slot:hover {
            border-color: var(--prayer-slot-hover-border);
            transform: scale(1.05);
        }

        .prayer-time-slot.completed {
            background: var(--prayer-slot-completed-bg);
            border-color: var(--prayer-slot-completed-border);
        }

        .scripture-card {
            background: linear-gradient(135deg, var(--scripture-card-bg-start) 0%, var(--scripture-card-bg-end) 100%);
            border: 1px solid var(--scripture-card-border);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scripture-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--scripture-text);
            margin-bottom: 10px;
            font-style: italic;
        }

        .scripture-reference {
            font-weight: bold;
            color: var(--scripture-reference);
            font-size: 14px;
        }

        .chat-container {
            background: var(--chat-container-bg);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            height: 350px;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--chat-messages-bg);
            border-radius: 10px;
            transition: background 0.5s ease;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.other {
            align-items: flex-start;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            display: inline-block;
        }
        
        .message.user .message-bubble {
            background: var(--message-user-bubble-bg);
            color: var(--message-user-bubble-color);
        }

        .message.other .message-bubble {
            background: var(--message-other-bubble-bg);
            color: var(--message-other-bubble-color);
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
            padding: 0 5px;
        }

        .message-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            margin-right: 8px;
        }
        
        .message.user .message-avatar { background: var(--message-user-avatar-bg); }
        .message.other .message-avatar { background: var(--message-other-avatar-bg); }

        .message-sender {
            font-weight: bold;
            color: var(--text-color);
        }

        .message-time {
            margin-left: 8px;
            opacity: 0.7;
            font-size: 10px;
            color: var(--text-color);
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center; /* Align items vertically in the center */
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--chat-input-border);
            border-radius: 20px;
            font-size: 14px;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--chat-messages-bg); /* Use chat messages bg for input */
            color: var(--text-color);
        }

        .chat-input:focus {
            border-color: var(--chat-input-focus-border);
            outline: none;
        }

        .chat-send-btn {
            background: var(--chat-send-btn-bg);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .chat-send-btn:hover {
            background: var(--chat-send-btn-hover-bg);
        }

        .image-upload-btn {
            background: var(--image-upload-btn-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .image-upload-btn:hover {
            background: var(--image-upload-btn-hover-bg);
        }

        .hidden-file-input {
            display: none;
        }

        .qt-note-card {
            background: var(--qt-note-card-bg);
            border: 1px solid var(--qt-note-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .qt-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--nav-border);
        }

        .qt-note-title {
            font-weight: bold;
            color: var(--qt-note-title);
        }

        .qt-note-date {
            font-size: 12px;
            color: var(--qt-note-date);
        }

        .qt-note-content {
            margin-bottom: 10px;
            line-height: 1.6;
            color: var(--qt-note-content);
        }

        .qt-note-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .like-button {
            background: none;
            border: none;
            color: var(--like-button-color);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-button:hover {
            color: var(--like-button-hover-color);
        }

        .note-buttons {
            display: flex;
            gap: 5px;
        }

        .note-btn {
            background: var(--note-btn-bg);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .note-btn.edit { background: var(--note-btn-edit-bg); }
        .note-btn.delete { background: var(--note-btn-delete-bg); }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--modal-content-bg);
            padding: 30px;
            border-radius: 15px;
            max-width: 380px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
            transition: background 0.5s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--modal-title-color);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--app-bg);
            color: var(--text-color);
        }

        .modal-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--app-bg);
            color: var(--text-color);
        }

        .modal-input:focus, .modal-textarea:focus {
            border-color: var(--modal-input-focus-border);
            outline: none;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-button.primary {
            background: var(--modal-button-primary-bg);
            color: white;
        }

        .modal-button.primary:hover {
            background: var(--modal-button-primary-hover-bg);
        }

        .modal-button.secondary {
            background: var(--modal-button-secondary-bg);
            color: white;
        }

        .modal-button.secondary:hover {
            background: var(--modal-button-secondary-hover-bg);
        }

        .lesson-container {
            background: var(--lesson-container-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            animation: slideInUp 0.4s ease;
            transition: background 0.5s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--lesson-header-border);
        }

        .lesson-icon {
            font-size: 30px;
            margin-right: 15px;
        }

        .lesson-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--lesson-title-color);
        }

        .lesson-content {
            line-height: 1.7;
            color: var(--lesson-content-color);
            font-size: 15px;
        }

        .lesson-content h4 {
            color: var(--lesson-content-h4-color);
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .lesson-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .lesson-content li {
            margin-bottom: 8px;
        }

        .lesson-content p {
            margin-bottom: 12px;
        }

        .lesson-content strong {
            color: var(--lesson-content-strong-color);
        }
        
        .stage-card {
            background: linear-gradient(135deg, var(--stage-card-bg-start) 0%, var(--stage-card-bg-end) 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stage-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .avatar-option {
            font-size: 30px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        .avatar-option:hover {
            background: var(--nav-item-hover-bg);
        }
        
        .discussion-container {
            background: var(--discussion-bg);
            border-left: 5px solid var(--discussion-border-left);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }
        .discussion-container h4 {
            color: var(--discussion-h4-color);
            margin-bottom: 15px;
        }
        .discussion-container ol {
            padding-left: 20px;
            line-height: 1.8;
            color: var(--discussion-ol-color);
        }
        
        #badge-container span {
            display: inline-block;
            background: var(--badge-bg);
            color: var(--badge-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin: 3px;
        }

        #minigame-canvas {
            border-radius: 10px;
            background: var(--minigame-canvas-bg);
            cursor: pointer;
        }

        #minigame-content .quiz-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid var(--quiz-option-border);
            background: var(--quiz-option-bg);
            color: var(--quiz-option-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #minigame-content .quiz-option:hover {
            background: var(--quiz-option-hover-bg);
        }
        
        .stage-completed-notice {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            background: var(--stage-completed-bg);
            color: var(--stage-completed-color);
            font-weight: bold;
            border-radius: 10px;
            border: 2px dashed var(--stage-completed-border);
            transition: background 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        /* Theme Toggle Button */
        .theme-toggle-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--nav-border);
            text-align: center;
        }
        .theme-toggle-button {
            background: var(--modal-button-secondary-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .theme-toggle-button:hover {
            background: var(--modal-button-secondary-hover-bg);
        }

        /* QT Comments */
        .comments-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--nav-border);
            text-align: left;
        }
        .comments-section h5 {
            color: var(--text-color);
            margin-bottom: 10px;
        }
        .comment-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .comment-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }
        .comment-password-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }
        .comment-send-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            align-self: flex-end;
        }
        .comment-send-btn:hover {
            background: #138496;
        }
        .comment-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--nav-border);
            border-radius: 8px;
            padding: 10px;
            background: var(--chat-messages-bg);
        }
        .comment-item {
            background: var(--mission-card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid var(--mission-card-border);
        }
        .comment-item:last-child {
            margin-bottom: 0;
        }
        .comment-header {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--text-color);
        }
        .comment-author {
            font-weight: bold;
            margin-right: 5px;
        }
        .comment-time {
            opacity: 0.7;
        }
        .comment-content {
            font-size: 14px;
            color: var(--text-color);
            word-wrap: break-word;
        }
        .comment-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            align-self: flex-end;
        }
        .comment-action-btn {
            background: var(--note-btn-bg);
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
        }
        .comment-action-btn.edit { background: var(--note-btn-edit-bg); }
        .comment-action-btn.delete { background: var(--note-btn-delete-bg); }

        /* Icebreaker Modal Specific Styles */
        /* These styles will now apply to the inline icebreaker content */
        .icebreaker-section {
            background: var(--prayer-card-bg-start);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--prayer-card-title);
        }
        .icebreaker-section .modal-title { /* Reusing modal-title style */
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--prayer-card-title);
        }
        .icebreaker-section .icebreaker-prompt {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: var(--prayer-card-title);
        }
        .icebreaker-section .icebreaker-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            background: var(--app-bg);
            color: var(--text-color);
        }
        .icebreaker-section .modal-button.primary {
            background: var(--modal-button-primary-bg);
            color: white;
            width: auto;
            padding: 10px 20px;
        }

        /* Quiz Section Styles (inline) */
        .quiz-section {
            background: var(--scripture-card-bg-start);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--scripture-card-border);
        }
        .quiz-section .modal-title { /* Reusing modal-title style */
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--scripture-text);
        }
        .quiz-section p {
            color: var(--scripture-text);
            margin-bottom: 20px;
            font-weight: bold;
        }
        .quiz-section .quiz-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid var(--quiz-option-border);
            background: var(--quiz-option-bg);
            color: var(--quiz-option-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quiz-section .quiz-option:hover {
            background: var(--quiz-option-hover-bg);
        }

        /* Minigame Selection Styles */
        .minigame-selection-card {
            background: var(--mission-card-bg);
            border: 1px solid var(--mission-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        .minigame-selection-card h4 {
            color: var(--text-color);
            margin-bottom: 15px;
        }
        .minigame-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .minigame-button {
            background: var(--mission-button-bg);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        .minigame-button:hover {
            background: var(--mission-button-hover-bg);
        }
        .minigame-button:disabled {
            background: var(--mission-button-disabled-bg);
            cursor: not-allowed;
        }
        .minigame-content-area {
            background: var(--chat-messages-bg);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--text-color);
        }
        .minigame-content-area input {
            width: 80%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            background: var(--app-bg);
            color: var(--text-color);
        }
        .minigame-content-area button {
            margin-top: 10px;
            padding: 8px 15px;
            background: var(--chat-send-btn-bg);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .minigame-content-area button:hover {
            background: var(--chat-send-btn-hover-bg);
        }
    </style>
</head>
<body class="light-mode">
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="character-avatar" id="headerAvatar" onclick="showAvatarModal()">ğŸŒŸ</div>
            <div class="user-name" onclick="showNameModal()">
                <span id="userName">í‘¸ë¥¸ì´</span>
                <span>âœï¸</span>
            </div>
            <div class="user-stats">
                <div class="stat">
                    <div class="stat-value" id="userLevel">1</div>
                    <div>ë ˆë²¨</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userExp">0</div>
                    <div>ê²½í—˜ì¹˜</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userStreak">1</div>
                    <div>ì—°ì†ì¼</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content">
                <!-- Notice Board -->
                <div id="notice-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--text-color);">ğŸ“¢ ê³µì§€ì‚¬í•­</h3>
                        <button style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showNoticeModal()">+ ê³µì§€ ì‘ì„±</button>
                    </div>
                    <div id="notices-container">
                        <!-- ê³µì§€ì‚¬í•­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: var(--text-color);">ğŸ“‹ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</h3>
                
                <div class="prayer-time-card">
                    <div class="prayer-time-title">â° 10-10-10 ê¸°ë„ë²•</div>
                    <div class="prayer-time-grid">
                        <div class="prayer-time-slot" data-slot="morning" onclick="togglePrayerTime('morning', this)">
                            <div>ğŸŒ… ì•„ì¹¨</div>
                            <div style="font-size: 12px;">10ë¶„</div>
                        </div>
                        <div class="prayer-time-slot" data-slot="noon" onclick="togglePrayerTime('noon', this)">
                            <div>â˜€ï¸ ì ì‹¬</div>
                            <div style="font-size: 12px;">10ë¶„</div>
                        </div>
                        <div class="prayer-time-slot" data-slot="evening" onclick="togglePrayerTime('evening', this)">
                            <div>ğŸŒ™ ì €ë…</div>
                            <div style="font-size: 12px;">10ë¶„</div>
                        </div>
                    </div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">ğŸ“– ì„±ê²½ ë§ì”€ ì½ê¸°</div>
                        <div class="mission-reward">+70 EXP</div>
                    </div>
                    <div class="mission-description">í‘¸ë¥¸ë°”ëŒì˜ ëƒ‰ì¥ê³ ì—ì„œ ì˜¤ëŠ˜ì˜ ì˜ì–‘ë¶„ì„ ì„­ì·¨í•˜ì„¸ìš”</div>
                    <button class="mission-button" id="mission-btn-scripture" onclick="showScripture()">ë§ì”€ ë³´ê¸°</button>
                    <div id="scripture-container"></div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">ğŸ¯ ì˜ˆë°° ì°¸ì—¬í•˜ê¸°</div>
                        <div class="mission-reward">+100 EXP</div>
                    </div>
                    <div class="mission-description">í•˜ë‚˜ë‹˜ì„ ë§Œë‚˜ëŠ” ê³µì‹ ì±„ë„ì—ì„œ ì–‘ë°©í–¥ ì†Œí†µí•˜ì„¸ìš”</div>
                    <button class="mission-button" id="mission-btn-worship" onclick="completeMission(this, 'ì˜ˆë°° ì°¸ì—¬ ì™„ë£Œ! ìš©íŠ¹ìƒˆ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤! ğŸ™', 100, 'ì˜ˆë°° ì°¸ì„')">ì°¸ì—¬ ì™„ë£Œ</button>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">ğŸ§  ì‹ ì•™ í€´ì¦ˆ í’€ê¸°</div>
                        <div class="mission-reward">+50 EXP</div>
                    </div>
                    <div class="mission-description">ì‹ ì•™ ì§€ì‹ì„ í…ŒìŠ¤íŠ¸í•˜ê³  ê²½í—˜ì¹˜ë¥¼ ì–»ìœ¼ì„¸ìš”!</div>
                    <button class="mission-button" id="mission-btn-quiz" onclick="startQuiz()">í€´ì¦ˆ ì‹œì‘</button>
                </div>

                <!-- Mini-game Mission Card -->
                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">ğŸ® ë¯¸ë‹ˆê²Œì„ í•˜ê¸°</div>
                        <div class="mission-reward">+30 EXP</div>
                    </div>
                    <div class="mission-description">ë‹¤ì–‘í•œ ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ê³  ê²½í—˜ì¹˜ë¥¼ ì–»ìœ¼ì„¸ìš”!</div>
                    <button class="mission-button" id="mission-btn-minigame" onclick="showMinigameSelection()">ë¯¸ë‹ˆê²Œì„ ì‹œì‘</button>
                    <div id="minigame-selection-container"></div>
                </div>
            </div>

            <!-- Stages Tab -->
            <div id="stages-tab" class="tab-content hidden">
                <div id="stage-list">
                    <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ¯ í•™ìŠµ ìŠ¤í…Œì´ì§€</h3>
                    <p style="text-align: center; color: var(--text-color); margin-bottom: 20px;">
                        êµì¬ ë‚´ìš© ê¸°ë°˜ í•™ìŠµ ë‹¨ê³„ì…ë‹ˆë‹¤
                    </p>
                    
                    <div class="stage-card" onclick="enterStageContent(1)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">1. íŒ¨ì¹˜ ì‹œìŠ¤í…œ</div>
                        <div style="font-size: 14px; opacity: 0.9;">ê±°ë¶€í•  ìˆ˜ ì—†ëŠ” íŠ¹ê¶Œ</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">ì˜ˆë°°í•˜ê¸° â€¢ ì„±ê²½ì½ê¸° â€¢ ê¸°ë„í•˜ê¸°</div>
                    </div>

                    <div class="stage-card" onclick="enterStageContent(2)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">2. ê¸¸ë“œ ì‹œìŠ¤í…œ</div>
                        <div style="font-size: 14px; opacity: 0.9;">ìš°ë¦¬, ê°™ì´ í•´ë³¼ê¹Œìš”</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">ì„¸ë¡€ë°›ê¸° â€¢ ê³µë™ì²´ ì†í•˜ê¸° â€¢ ì„±ë ¹ ë”°ë¥´ê¸°</div>
                    </div>

                    <div class="stage-card" onclick="enterStageContent(3)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">3. ì‹¤ì „ ì‹œìŠ¤í…œ</div>
                        <div style="font-size: 14px; opacity: 0.9;">ì¸ìƒì€ ì¥ë‚œì´ ì•„ë‹ˆë‹ˆê¹Œ</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">ì´ë¡ ì—ì„œ í˜„ì‹¤ë¡œ â€¢ ë§¤ì¼ ê·¸ë¶„ê³¼ â€¢ ì¼ìƒì„ í•¨ê»˜</div>
                    </div>
                </div>
                    
                <div id="stage-detail" class="hidden">
                    <div id="stage-content"></div>
                    <button style="background: var(--modal-button-secondary-bg); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; width: 100%;" onclick="backToStages()">â† ìŠ¤í…Œì´ì§€ ëª©ë¡ìœ¼ë¡œ</button>
                </div>

                <!-- New Icebreaker Records Section -->
                <div id="icebreaker-records-section" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-color);">ğŸ“ ë‚˜ì˜ ì•„ì´ìŠ¤ë¸Œë ˆì´í¬ ê¸°ë¡</h3>
                    <div id="icebreaker-records-container">
                        <!-- Icebreaker records will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Guild Tab -->
            <div id="guild-tab" class="tab-content hidden">
                <div style="background: linear-gradient(135deg, var(--scripture-card-bg-start) 0%, var(--scripture-card-bg-end) 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; position: relative;">
                    <h3 style="color: var(--text-color);">ğŸ‘¥ í‘¸ë¥¸ë°”ëŒë‹¨</h3>
                    <strong style="color: var(--text-color);">ê¸¸ë“œ ë ˆë²¨: <span id="guildLevel">1</span></strong><br>
                    <small style="color: var(--text-color);">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ <span id="guildExp">0</span>/500 EXP</small>
                </div>

                <!-- QT Note Section -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: var(--text-color);">ğŸ“” QT ë…¸íŠ¸</h4>
                        <button style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showQTNoteModal()">+ QT ë…¸íŠ¸ ì‘ì„±</button>
                    </div>
                    <div id="qt-notes-container">
                        <!-- QT ë…¸íŠ¸ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <h4 style="margin-bottom: 15px; color: var(--text-color);">ğŸŸ¢ í˜„ì¬ ì ‘ì† ì¤‘ì¸ ê¸¸ë“œì›</h4>
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--chat-messages-bg); border-radius: 10px;">
                        <div id="guildUserAvatar" style="width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--modal-button-primary-bg); background: var(--modal-button-primary-bg); color: white;">ğŸŒŸ</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 2px; color: var(--text-color);"><span id="guildUserName">í‘¸ë¥¸ì´</span> (ë‚˜)</div>
                            <div style="font-size: 12px; color: var(--text-color);">ë ˆë²¨ <span id="guildUserLevel">1</span> <span id="guildUserJob">í‘¸ë¥¸ì´</span> â€¢ <span id="guildUserStreak">1</span>ì¼ ì—°ì† ì ‘ì†</div>
                        </div>
                    </div>
                    <div style="text-align: center; color: var(--text-color); padding: 20px;">
                        <p>ë‹¤ë¥¸ ê¸¸ë“œì›ë“¤ì´ ì ‘ì†í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                        <p>ì¹œêµ¬ë“¤ì„ ì´ˆëŒ€í•´ë³´ì„¸ìš”! ğŸ‰</p>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <!-- Guild chat is now always visible on this tab -->
                    <div id="guild-chat-container" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-content hidden">
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 50px; cursor: pointer; border: 3px solid var(--modal-button-primary-bg); background: var(--app-bg); color: var(--text-color);" id="profileAvatar" onclick="showAvatarModal()">ğŸŒŸ</div>
                        <div>
                            <h4 id="profileUserName" style="margin-bottom: 5px; color: var(--text-color);">í‘¸ë¥¸ì´</h4>
                            <p style="color: var(--text-color); font-size: 14px;">ë ˆë²¨ <span id="profileLevel">1</span> <span id="profileJob">í‘¸ë¥¸ì´</span></p>
                            <p style="color: var(--text-color); font-size: 14px;">ì‹ ì•™ ì—¬ì • <span id="profileStreak">1</span>ì¼ì°¨</p>
                        </div>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">ğŸ† ì—…ì  ë° ë±ƒì§€</h4>
                    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
                        <div id="badge-container" style="margin-bottom: 10px; min-height: 25px;">
                            <!-- Badges will be dynamically inserted here -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--nav-border);">
                            <span style="color: var(--text-color);">ì™„ë£Œí•œ ë¯¸ì…˜</span>
                            <strong id="completedMissionsCount" style="color: var(--text-color);">0</strong><span style="color: var(--text-color);">ê°œ</span>
                        </div>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">ğŸ¨ í…Œë§ˆ ì„¤ì •</h4>
                    <div class="theme-toggle-container">
                        <button class="theme-toggle-button" onclick="toggleTheme()">í…Œë§ˆ ì „í™˜</button>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h4>
                    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
                        <button style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;" onclick="showResetModal()">
                            ğŸ”„ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                        <div style="font-size: 12px; color: var(--text-color); margin-top: 8px; text-align: center;">
                            ëª¨ë“  ì§„í–‰ ìƒí™©ì´ ë¦¬ì…‹ë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-item active" onclick="showTab('home', this)">
                ğŸ <br>í™ˆ
            </button>
            <button class="nav-item" onclick="showTab('stages', this)">
                ğŸ®<br>ìŠ¤í…Œì´ì§€
            </button>
            <button class="nav-item" onclick="showTab('guild', this)">
                ğŸ‘¥<br>ê¸¸ë“œ
            </button>
            <button class="nav-item" onclick="showTab('profile', this)">
                ğŸ‘¤<br>í”„ë¡œí•„
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ë‹‰ë„¤ì„ ë³€ê²½</div>
            <input type="text" id="nameInput" class="modal-input" placeholder="ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNameModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" onclick="changeName()">ë³€ê²½</button>
            </div>
        </div>
    </div>

    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</div>
            <div class="avatar-grid">
                <div class="avatar-option" onclick="selectAvatar('ğŸŒŸ')">ğŸŒŸ</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸ˜Š')">ğŸ˜Š</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸ™')">ğŸ™</div>
                <div class="avatar-option" onclick="selectAvatar('âœ¨')">âœ¨</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸ•Šï¸')">ğŸ•Šï¸</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸ“–')">ğŸ“–</div>
                <div class="avatar-option" onclick="selectAvatar('â¤ï¸')">â¤ï¸</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸŒ…')">ğŸŒ…</div>
                <div class="avatar-option" onclick="selectAvatar('â­')">â­</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸµ')">ğŸµ</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸŒ¸')">ğŸŒ¸</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸŒˆ')">ğŸŒˆ</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeAvatarModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ê´€ë¦¬ì ì¸ì¦</div>
            <input type="password" id="adminPassword" class="modal-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="4">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeResetModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" onclick="confirmReset()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ê³µì§€ì‚¬í•­ ì‘ì„±</div>
            <input type="password" id="noticePassword" class="modal-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" maxlength="4">
            <input type="text" id="noticeTitle" class="modal-input" placeholder="ê³µì§€ì‚¬í•­ ì œëª©">
            <textarea id="noticeContent" class="modal-textarea" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNoticeModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" onclick="createNotice()">ê³µì§€ ë“±ë¡</button>
            </div>
        </div>
    </div>

    <!-- QT Note Modal -->
    <div id="qtNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="qtModalTitle">QT ë…¸íŠ¸ ì‘ì„±</div>
            <input type="text" id="qtNoteTitle" class="modal-input" placeholder="QT ë…¸íŠ¸ ì œëª©">
            <textarea id="qtNoteContent" class="modal-textarea" placeholder="ì˜¤ëŠ˜ì˜ QT ë‚´ìš©ì„ ê¸°ë¡í•´ë³´ì„¸ìš”..."></textarea>
            <input type="password" id="qtNotePassword" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (ìˆ˜ì •/ì‚­ì œìš©)" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTNoteModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" id="qtSubmitBtn" onclick="createQTNote()">ì‘ì„± ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- QT Note Password Modal -->
    <div id="qtPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</div>
            <p id="passwordModalText">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:</p>
            <input type="password" id="qtActionPassword" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTPasswordModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" id="qtConfirmActionButton" onclick="confirmQTAction()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Minigame Modal (now used for image view and general quiz/minigame logic) -->
    <div id="minigameModal" class="modal">
        <div class="modal-content" id="minigame-content">
            <!-- Minigame content will be injected here -->
        </div>
    </div>
    
    <script>
        // --- Global State Variables ---
        let userLevel, userExp, userStreak, completedMissions, userName, userAvatar, userJob, userBadges, completedStages;
        let guildLevel, guildExp;
        let currentStage = null;
        let chatMessages = [];
        let prayerTimes = {};
        let notices = [];
        let qtNotes = [];
        let editingQTNote = null;
        let pendingQTAction = null; // { type: 'qtNote' | 'comment', action: 'edit' | 'delete', noteId: ..., commentId: ... (if comment) }
        let currentTheme = 'light-mode'; // Default theme
        let quizCompletedPerStage = {}; // Track quiz completion for each stage
        let completedIcebreakers = []; // Array of stage numbers for which icebreaker is completed, now stores answers
        let miniGameCompletedToday = false; // Track if the overall mini-game mission is completed today
        let miniGameProgress = {}; // Tracks completion of individual mini-games for the day

        // ë©”ëª¨ë¦¬ ê¸°ë°˜ ì €ì¥ì†Œ (localStorage ëŒ€ì²´)
        let memoryStorage = {};
        
        // localStorage ì²´í¬ ë° ëŒ€ì²´ í•¨ìˆ˜
        function isLocalStorageAvailable() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        function safeSetItem(key, value) {
            if (isLocalStorageAvailable()) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.warn('localStorage setItem ì‹¤íŒ¨, ë©”ëª¨ë¦¬ ì €ì¥ì†Œ ì‚¬ìš©:', error);
                }
            }
            // localStorage ì‚¬ìš© ë¶ˆê°€ ì‹œ ë©”ëª¨ë¦¬ì— ì €ì¥
            memoryStorage[key] = value;
            return false;
        }

        function safeGetItem(key) {
            if (isLocalStorageAvailable()) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('localStorage getItem ì‹¤íŒ¨, ë©”ëª¨ë¦¬ ì €ì¥ì†Œ ì‚¬ìš©:', error);
                }
            }
            // localStorage ì‚¬ìš© ë¶ˆê°€ ì‹œ ë©”ëª¨ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
            return memoryStorage[key] || null;
        }

        function safeRemoveItem(key) {
            if (isLocalStorageAvailable()) {
                try {
                    localStorage.removeItem(key);
                    return;
                } catch (error) {
                    console.warn('localStorage removeItem ì‹¤íŒ¨, ë©”ëª¨ë¦¬ ì €ì¥ì†Œ ì‚¬ìš©:', error);
                }
            }
            // localStorage ì‚¬ìš© ë¶ˆê°€ ì‹œ ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
            delete memoryStorage[key];
        }

        // --- Data Definitions ---

        const scriptures = [
            { text: "ë‚´ ì•ˆì— ë¨¸ë¬¼ëŸ¬ ìˆì–´ë¼. ê·¸ë¦¬í•˜ë©´ ë‚˜ë„ ë„ˆí¬ ì•ˆì— ë¨¸ë¬¼ëŸ¬ ìˆê² ë‹¤. ê°€ì§€ê°€ í¬ë„ë‚˜ë¬´ì— ë¶™ì–´ ìˆì§€ ì•„ë‹ˆí•˜ë©´ ìŠ¤ìŠ¤ë¡œ ì—´ë§¤ë¥¼ ë§ºì„ ìˆ˜ ì—†ëŠ” ê²ƒê³¼ ê°™ì´, ë„ˆí¬ë„ ë‚´ ì•ˆì— ë¨¸ë¬¼ëŸ¬ ìˆì§€ ì•„ë‹ˆí•˜ë©´ ì—´ë§¤ë¥¼ ë§ºì„ ìˆ˜ ì—†ë‹¤.", reference: "ìš”í•œë³µìŒ 15:4" },
            { text: "ë‚˜ëŠ” ì°¸ í¬ë„ë‚˜ë¬´ìš”, ë‚´ ì•„ë²„ì§€ëŠ” ë†ë¶€ì´ì‹œë‹¤.", reference: "ìš”í•œë³µìŒ 15:1" },
            { text: "ë„ˆí¬ê°€ ë‚˜ì˜ ë§ì— ë¨¸ë¬¼ëŸ¬ ìˆìœ¼ë©´, ë„ˆí¬ëŠ” ì°¸ìœ¼ë¡œ ë‚˜ì˜ ì œìë“¤ì´ë‹¤. ê·¸ë¦¬ê³  ë„ˆí¬ëŠ” ì§„ë¦¬ë¥¼ ì–»ê²Œ ë  ê²ƒì´ë©°, ì§„ë¦¬ê°€ ë„ˆí¬ë¥¼ ììœ ë¡­ê²Œ í•  ê²ƒì´ë‹¤.", reference: "ìš”í•œë³µìŒ 8:31-32" },
            { text: "ê·¸ëŸ¬ë¯€ë¡œ ë„ˆí¬ëŠ” ê°€ì„œ, ëª¨ë“  ë¯¼ì¡±ì„ ì œìë¡œ ì‚¼ì•„ì„œ, ì•„ë²„ì§€ì™€ ì•„ë“¤ê³¼ ì„±ë ¹ì˜ ì´ë¦„ìœ¼ë¡œ ì„¸ë¡€ë¥¼ ì£¼ê³ , ë‚´ê°€ ë„ˆí¬ì—ê²Œ ëª…ë ¹í•œ ëª¨ë“  ê²ƒì„ ê·¸ë“¤ì—ê²Œ ê°€ë¥´ì³ ì§€í‚¤ê²Œ í•˜ì—¬ë¼.", reference: "ë§ˆíƒœë³µìŒ 28:19-20" },
            { text: "ì‚¬ëŒì€ ë§ˆìŒìœ¼ë¡œ ë¯¿ì–´ì„œ ì˜ì— ì´ë¥´ê³ , ì…ìœ¼ë¡œ ê³ ë°±í•´ì„œ êµ¬ì›ì— ì´ë¥´ê²Œ ë©ë‹ˆë‹¤.", reference: "ë¡œë§ˆì„œ 10:10" }
        ];

        // New Quiz Questions (Church-themed)
        const quizQuestions = [
            {
                question: "êµíšŒì˜ ë¨¸ë¦¬ëŠ” ëˆ„êµ¬ì‹ ê°€ìš”?",
                options: ["ë² ë“œë¡œ", "ë°”ìš¸", "ì˜ˆìˆ˜ ê·¸ë¦¬ìŠ¤ë„", "êµí™©"],
                answer: "ì˜ˆìˆ˜ ê·¸ë¦¬ìŠ¤ë„"
            },
            {
                question: "êµíšŒì˜ ì„¸ ê°€ì§€ ì£¼ìš” ì‚¬ëª… ì¤‘ í•˜ë‚˜ê°€ ì•„ë‹Œ ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?",
                options: ["ì˜ˆë°°", "êµìœ¡", "ì‚¬ì—…", "ë´‰ì‚¬ ë° ì„ êµ"],
                answer: "ì‚¬ì—…"
            },
            {
                question: "ì‚¬ë„í–‰ì „ì— ë‚˜ì˜¤ëŠ” ì´ˆëŒ€êµíšŒì˜ íŠ¹ì§•ì´ ì•„ë‹Œ ê²ƒì€?",
                options: ["ì„œë¡œ ë¬¼ê±´ì„ í†µìš©í•¨", "ë§¤ì¼ ë§ˆìŒì„ ê°™ì´í•˜ì—¬ ì„±ì „ì— ëª¨ì´ê¸°ë¥¼ í˜ì”€", "ê°œì¸ì£¼ì˜ì ì¸ ì‹ ì•™ìƒí™œ", "ë–¡ì„ ë–¼ë©° ê¸°ì¨ê³¼ ìˆœì „í•œ ë§ˆìŒìœ¼ë¡œ ìŒì‹ì„ ë¨¹ìŒ"],
                answer: "ê°œì¸ì£¼ì˜ì ì¸ ì‹ ì•™ìƒí™œ"
            },
            {
                question: "êµíšŒê°€ ì„¸ìƒì˜ ë¹›ê³¼ ì†Œê¸ˆì˜ ì—­í• ì„ í•´ì•¼ í•œë‹¤ê³  ë§ì”€í•˜ì‹  ì„±ê²½ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                options: ["ìš”í•œë³µìŒ", "ë§ˆíƒœë³µìŒ", "ë¡œë§ˆì„œ", "íˆë¸Œë¦¬ì„œ"],
                answer: "ë§ˆíƒœë³µìŒ"
            },
            {
                question: "êµíšŒì˜ ê°€ì¥ ì¤‘ìš”í•œ ê³µë™ì²´ì  ëª¨ì„ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                options: ["ì¹œëª©íšŒ", "ìš´ë™íšŒ", "ì˜ˆë°°", "ë°”ìíšŒ"],
                answer: "ì˜ˆë°°"
            }
        ];

        const stageContents = {
            1: {
                title: "1ê°•: íŒ¨ì¹˜ ì‹œìŠ¤í…œ - ê±°ë¶€í•  ìˆ˜ ì—†ëŠ” íŠ¹ê¶Œ",
                item: "ìš©íŠ¹ìƒˆ ë©”ì‹œì§€",
                icebreaker: {
                    prompt: "1ê°•ì„ ì‹œì‘í•˜ê¸° ì „ì—, 'íŒ¨ì¹˜'ë¼ëŠ” ë‹¨ì–´ë¥¼ ë“¤ìœ¼ë©´ ì–´ë–¤ ìƒê°ì´ ë“œë‚˜ìš”? ì‹ ì•™ìƒí™œì—ì„œ 'íŒ¨ì¹˜'ê°€ í•„ìš”í•˜ë‹¤ê³  ëŠë‚€ ì ì´ ìˆë‚˜ìš”?"
                },
                hasQuiz: false, // Quiz removed from Stage 1
                lessons: [
                    {
                        icon: "ğŸ›¡ï¸",
                        title: "ì˜ˆë°°í•˜ê¸° - í•˜ë‚˜ë‹˜ì„ ë§Œë‚˜ëŠ” ê³µì‹ ì±„ë„",
                        content: `<h4>ğŸ“Œ ì˜ˆë°°ëŠ” ì–‘ë°©í–¥ ì†Œí†µ</h4><p>ì˜ˆìˆ˜ë‹˜ì€ ìš°ë¦¬ì—ê²Œ ìƒˆë¡œìš´ ìƒëª…ì„ ì£¼ì‹¤ ë¿ë§Œ ì•„ë‹ˆë¼, "ë” ë„˜ì¹˜ê²Œ" ëˆ„ë¦¬ë©° ì‚´ê²Œ í•˜ê¸° ìœ„í•´ ìê¸° ëª©ìˆ¨ì„ ë²„ë¦¬ê² ë‹¤ê³  ë§ì”€í•˜ì…¨ìŠµë‹ˆë‹¤.</p><h4>ğŸ’¡ ì˜ˆë°°ì˜ ì˜ë¯¸</h4><ul><li>í•˜ë‚˜ë‹˜ì´ ìš°ë¦¬ ì¼ìƒì— ì–¼ë§ˆë‚˜ ê´€ì‹¬ì´ ë§ì€ì§€ ì•Œ ìˆ˜ ìˆëŠ” ì‹œê°„</li><li>ìš°ë¦¬ë¥¼ ì–¼ë§ˆë‚˜ ì†Œì¤‘íˆ ì—¬ê¸°ëŠ”ì§€ ê¹¨ë‹«ëŠ” ì‹œê°„</li><li>í•˜ë‚˜ë‹˜ì˜ ê³„íšì—ì„œ ìš°ë¦¬ê°€ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œ ì‚¬ëŒì¸ì§€ ë°œê²¬í•˜ëŠ” ì‹œê°„</li></ul>
                        
                        <h4>âš”ï¸ ê±°ì§“ ìœ„í˜‘ vs ì§„ì§œ ëª©ì†Œë¦¬ (ìš©íŠ¹ìƒˆ)</h4>
                        <p><strong>ê±°ì§“ ìœ„í˜‘:</strong> "ë„ˆëŠ” ì™œ ê·¸ê±°ë°–ì— ì•ˆ ë˜ëƒ?", "ë„ˆ ë”°ìœ„ëŠ” ì—¬ê¸°ì„œ ì‹¤íŒ¨í•˜ë©´ ë°”ë¡œ ëì´ì•¼"</p>
                        <p><strong>ì§„ì§œ ëª©ì†Œë¦¬ (ìš©íŠ¹ìƒˆ):</strong></p>
                        <ul>
                            <li>ê·¸ë¦¬ìŠ¤ë„ ì•ˆì—ì„œ ë‹¹ì‹ ì€ <strong>ìš©ë‚©</strong>ë˜ì—ˆìŠµë‹ˆë‹¤</li>
                            <li>ê·¸ë¦¬ìŠ¤ë„ ì•ˆì—ì„œ ë‹¹ì‹ ì€ <strong>íŠ¹ë³„í•œ</strong> ì¡´ì¬ì…ë‹ˆë‹¤</li>
                            <li>ê·¸ë¦¬ìŠ¤ë„ ì•ˆì—ì„œ ë‹¹ì‹ ì€ <strong>ìƒˆë¡œìš´</strong> ê³µë™ì²´ì— ì†í–ˆìŠµë‹ˆë‹¤</li>
                        </ul>
                        <p>ì˜ˆë°°ë¥¼ ë“œë¦¬ë©´ì„œ, ê¹¨ì§„ ì„¸ìƒì´ ì£¼ëŠ” ê±°ì§“ ìœ„í˜‘ê³¼ëŠ” ì „í˜€ ë‹¤ë¥¸, ë‹¹ì‹ ì„ í–¥í•œ ì§„ì§œ ëª©ì†Œë¦¬ì— ê·€ë¥¼ ê¸°ìš¸ì´ì„¸ìš”. ë‹¹ì‹ ì„ í–¥í•´ ë¶ˆì–´ì˜¤ëŠ” í‘¸ë¥¸ë°”ëŒì˜ ë©”ì‹œì§€ëŠ” ì–´ë–¤ ê³µê²©ì—ë„ ë„ë–¡ì—†ëŠ” ì²´ë ¥ì„ ì£¼ê³  ì‰´ë“œê°€ ë©ë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "âš¡",
                        title: "ì„±ê²½ì½ê¸° - í‘¸ë¥¸ë°”ëŒì˜ ëƒ‰ì¥ê³ ",
                        content: `<h4>ğŸ¯ ë‚˜ì˜ íŒ¨ì¹˜, ë‚˜ì˜ íŠ¹ê¶Œ</h4><p>ì„±ê²½ì€ í‘¸ë¥¸ë°”ëŒì˜ ë‚˜ë¼ ì—ë„ˆì§€ì›ì´ ê°€ë“í•œ ëƒ‰ì¥ê³ ì…ë‹ˆë‹¤. ì•„ë¬´ë¦¬ ëƒ‰ì¥ê³ ì— ë¨¹ì„ ê²ƒì´ ê°€ë“í•´ë„ êº¼ë‚´ ë¨¹ì§€ ì•Šìœ¼ë©´ ì•„ë¬´ ì†Œìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p><h4>ğŸ” ì„±ê²½ì„ êº¼ë‚´ ë¨¹ëŠ” ê¿€íŒ</h4><ul><li>í•˜ë‚˜ë‹˜ì€ ì–´ë–¤ ë¶„ì¼ê¹Œ? (í•˜ë‚˜ë‹˜ì˜ ì„±í’ˆê³¼ ë§ì”€ê³¼ í•˜ì‹  ì¼)</li><li>ì˜ˆìˆ˜ë‹˜ì€ ì–´ë–¤ ë¶„ì¼ê¹Œ? (ì˜ˆìˆ˜ë‹˜ì˜ ê°€ë¥´ì¹¨ê³¼ ì‚¶ê³¼ í–‰ë™)</li><li>ì„ ë°°ë“¤ì€ ì–´ë–»ê²Œ ì‚´ì•˜ì„ê¹Œ? (ê·¸ë“¤ì˜ ë¯¿ìŒê³¼ ê¸°ë„, ì‹¤ìˆ˜ì™€ íšŒë³µê³¼ êµí›ˆ)</li><li>ê·¸ëŸ¬ë©´ ë‚˜ëŠ” ì–´ë–»ê²Œ ì‚´ì•„ì•¼ í• ê¹Œ? (ë‚´ í˜„ì‹¤ì— ì ìš©í•  ìˆ˜ ìˆëŠ” ì„±ê²½ ì›ë¦¬)</li></ul>`
                    },
                    {
                        icon: "ğŸ”Œ",
                        title: "ê¸°ë„í•˜ê¸° - ì‹ ì—ê²Œ ë¹¨ëŒ€ ê½‚ê¸°",
                        content: `<h4>ğŸŒ³ í¬ë„ë‚˜ë¬´ì™€ ê°€ì§€ì˜ ê´€ê³„</h4><p>ì˜ˆìˆ˜ë‹˜ì€ ìš°ë¦¬ë¥¼ "ê°€ì§€"ë¼ê³  ë¶€ë¥´ì‹œë©°, ìì‹ ì—ê²Œ ë”± ë¶™ì–´ ìˆìœ¼ë¼ê³  í•˜ì‹­ë‹ˆë‹¤. ë‚˜ë­‡ê°€ì§€ì˜ ìµœê³  íŠ¹ê¶Œì€ ë†ë¶€(í•˜ë‚˜ë‹˜)ê°€ ë•€ í˜ë ¤ ì¼í•˜ê³  ë‚˜ë¬´(ì˜ˆìˆ˜ë‹˜)ê°€ ì—´ì‹¬íˆ ê³µê¸‰í•œ ì–‘ë¶„ì„ ê·¸ëƒ¥ ë°›ì•„ ëˆ„ë¦¬ëŠ” ê²ƒì…ë‹ˆë‹¤.</p><h4>ğŸ• 10-10-10 ê¸°ë„ë²•</h4><p>ì•„ì¹¨, ì ì‹¬, ì €ë… 10ë¶„ì”© ì˜ˆìˆ˜ë‹˜ê³¼ ëŒ€í™”í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”. ë¶€ë‹´ ì—†ì´, ê·¸ì € ë§ì„ ê±°ëŠ” ê²ƒë¶€í„° ì‹œì‘í•˜ë©´ ë©ë‹ˆë‹¤.</p>`
                    }
                ],
                discussionQuestions: [
                    "ì˜ˆë°°, ì„±ê²½ ì½ê¸°, ê¸°ë„ ì¤‘ì—ì„œ ìš”ì¦˜ ë‚˜ì—ê²Œ ê°€ì¥ ê°€ê¹ê²Œ ëŠê»´ì§€ëŠ” ê²ƒê³¼ ê°€ì¥ ë©€ê²Œ ëŠê»´ì§€ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”? ê·¸ ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?",
                    "ë‚˜ë¥¼ í–¥í•œ í•˜ë‚˜ë‹˜ì˜ 'ì§„ì§œ ëª©ì†Œë¦¬'(ìš©íŠ¹ìƒˆ: ìš©ë‚©, íŠ¹ë³„í•¨, ìƒˆë¡œìš´ ê³µë™ì²´)ë¥¼ ì˜ì‹¬í•˜ê²Œ ë§Œë“œëŠ” 'ê±°ì§“ ìœ„í˜‘'ì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆì—ˆë‚˜ìš”?",
                    "ì˜¤ëŠ˜ ë°°ìš´ '10-10-10 ê¸°ë„ë²•'ì„ ë‚´ì¼ë¶€í„° ë‹¹ì¥ ì‹¤ì²œí•´ë³¸ë‹¤ë©´, ì–´ë–¤ ì ì´ ê¸°ëŒ€ë˜ê³  ì–´ë–¤ ì ì´ ê±±ì •ë˜ë‚˜ìš”?"
                ]
            },
            2: {
                title: "2ê°•: ê¸¸ë“œ ì‹œìŠ¤í…œ - ìš°ë¦¬, ê°™ì´ í•´ë³¼ê¹Œìš”",
                item: "ê¸¸ë“œ ë²„í”„",
                icebreaker: {
                    prompt: "2ê°•ì„ ì‹œì‘í•˜ê¸° ì „ì—, 'ê¸¸ë“œ'ë¼ëŠ” ë‹¨ì–´ë¥¼ ë“¤ìœ¼ë©´ ì–´ë–¤ ìƒê°ì´ ë“œë‚˜ìš”? ì‹ ì•™ ê³µë™ì²´ê°€ 'ê¸¸ë“œ'ì²˜ëŸ¼ ëŠê»´ì§„ ì ì´ ìˆë‚˜ìš”?"
                },
                hasQuiz: false, // This stage does not have a quiz
                lessons: [
                    {
                        icon: "ğŸ¯",
                        title: "ì„¸ë¡€ë°›ê¸° - ê¸¸ë“œ ê°€ì…í•˜ê¸°",
                        content: `<h4>ğŸ° ê¸¸ë“œ ê°€ì…ì˜ ì˜ë¯¸</h4><p>í•˜ë‚˜ë‹˜ ë‚˜ë¼ ì‚¬ëŒì´ ë˜ëŠ” ê²ƒê³¼ ê·¸ ë‚˜ë¼ ë°©ì‹ëŒ€ë¡œ ì‚¬ëŠ” ê²ƒ ì‚¬ì´ì— 'ì„¸ë¡€'ê°€ ìˆìŠµë‹ˆë‹¤. ê¸°ë…êµëŠ” ìì‹ ë§Œì˜ ì „ì¸ê²©ì  ê³ ë°±ì´ í•„ìš”í•œ ì¢…êµì´ë©°, ì ˆëŒ€ ë‚¨ì—ê²Œ ë¬»ì–´ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><h4>ğŸ’ ë¹„ë°€ ì—°ì• ì—ì„œ ê³µì‹ ë°œí‘œë¡œ</h4><p>ì„¸ë¡€ë¥¼ ì¢€ ë” ì„¤ë ˆëŠ” ë²„ì „ìœ¼ë¡œ ì„¤ëª…í•˜ë©´, ë¹„ë°€ ì—°ì• ë¥¼ í•˜ëŠ” ì—°ì¸ì´ ì‚¬ê·„ë‹¤ê³  ê³µì‹ì ìœ¼ë¡œ ë°íˆëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤. ì´ ì‚¬ëŒì´ë¼ê³  í™•ì‹ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "ğŸ‘¥",
                        title: "ê³µë™ì²´ ì†í•˜ê¸° - ë³‘ì•„ë¦¬ ê³µë™ì²´",
                        content: `<h4>ğŸ£ ë³‘ì•„ë¦¬ê°€ ì‚´ì•„ë‚¨ëŠ” ë²•</h4><p>í•™êµ ì•ì—ì„œ ì‚° ë³‘ì•„ë¦¬ê°€ ì‚´ì•„ë‚¨ëŠ” ë¹„ê²°ì€ 'ê³µë™ì²´'ì˜€ìŠµë‹ˆë‹¤. ê³µë™ì²´ë¥¼ í†µí•´ ë¬´ì—‡ì„ ë¨¹ê³ , ì–´ë–»ê²Œ ì‚´ì•„ì•¼ í•˜ëŠ”ì§€ ë°°ìš°ë©° ê±´ê°•í•´ì§‘ë‹ˆë‹¤.</p><h4>ğŸ® ê¸¸ë“œ ë²„í”„ ë°›ëŠ” ë°©ë²•</h4><p>ê³µë™ì²´ ì•ˆì—ì„œ ë§ì”€ì„ ë“£ê³  ë°°ìš°ëŠ” ë²„í”„, ë‹¤ë¥¸ ì‚¬ëŒì˜ ì‚¶ì„ ë³´ê³  ë°°ìš°ëŠ” ë²„í”„ë¥¼ í†µí•´ í•¨ê»˜ ì„±ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "ğŸ•Šï¸",
                        title: "ì„±ë ¹ ë”°ë¥´ê¸° - ìš°ë¦¬ í˜ë§Œìœ¼ë¡œëŠ” ì–´ë ¤ì›Œ",
                        content: `<h4>ğŸ¤ ëŠ˜ í•¨ê»˜í•˜ëŠ” ì°¸ ì¢‹ì€ ìŠ¤ìŠ¹</h4><p>ìš°ë¦¬ í˜ë§Œìœ¼ë¡œëŠ” ì–´ë µìŠµë‹ˆë‹¤. ì„±ë ¹ë‹˜ì€ ìš°ë¦¬ì™€ ì¸ê²©ì ì¸ ê´€ê³„ë¥¼ ì›í•˜ì‹œë©°, ìš°ë¦¬ê°€ ìë°œì ìœ¼ë¡œ í•˜ë‚˜ë‹˜ì˜ ëœ»ì„ ì„ íƒí•˜ë„ë¡ ë„ìš°ì‹œëŠ” ë¶„ì…ë‹ˆë‹¤.</p><h4>ğŸ“–â•ğŸ•Šï¸ ì„±ê²½ê³¼ ì„±ë ¹ì˜ ì½¤ë³´</h4><p>ì„±ê²½ê³¼ ì„±ë ¹ë‹˜ì€ ë”°ë¡œ ë–¼ì–´ë†“ê³  ìƒê°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„±ë ¹ë‹˜ì€ ì„±ê²½ ë§ì”€ì„ ê¹¨ë‹«ê³  ìˆœì¢…í•˜ë„ë¡ ë„ìš°ì‹­ë‹ˆë‹¤.</p>`
                    }
                ],
                discussionQuestions: [
                    "ë‚˜ì—ê²Œ ì‹ ì•™ ê³µë™ì²´(ê¸¸ë“œ)ëŠ” ì–´ë–¤ ì˜ë¯¸ì¸ê°€ìš”? ê³µë™ì²´ë¥¼ í†µí•´ 'ê¸¸ë“œ ë²„í”„'ë¥¼ ë°›ì•˜ë˜ ê²½í—˜ì´ ìˆë‹¤ë©´ ë‚˜ëˆ ì£¼ì„¸ìš”.",
                    "ì„¸ë¡€ë¥¼ 'ë¹„ë°€ ì—°ì• ì—ì„œ ê³µì‹ ë°œí‘œë¡œ' ë¹„ìœ í•œ ê²ƒì²˜ëŸ¼, ë‚˜ì˜ ì‹ ì•™ì„ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ê³µê°œì ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” ê²ƒì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ë‚˜ìš”?",
                    "ì„±ë ¹ë‹˜ì„ 'ëŠ˜ í•¨ê»˜í•˜ëŠ” ì°¸ ì¢‹ì€ ìŠ¤ìŠ¹'ìœ¼ë¡œ ì¸ê²©ì ìœ¼ë¡œ ì‹ ë¢°í•˜ê³  ë”°ë¥´ê¸° ìœ„í•´, êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë…¸ë ¥ì„ í•  ìˆ˜ ìˆì„ê¹Œìš”?"
                ]
            },
            3: {
                title: "3ê°•: ì‹¤ì „ ì‹œìŠ¤í…œ - ì¸ìƒì€ ì¥ë‚œì´ ì•„ë‹ˆë‹ˆê¹Œ",
                item: "ì„±ë ¹ì˜ ì—´ë§¤",
                icebreaker: {
                    prompt: "3ê°•ì„ ì‹œì‘í•˜ê¸° ì „ì—, 'ì‹¤ì „'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ë“¤ìœ¼ë©´ ì–´ë–¤ ìƒê°ì´ ë“œë‚˜ìš”? ë‚˜ì˜ ì‹ ì•™ì´ 'ì‹¤ì „'ì— ê°•í•˜ë‹¤ê³  ìƒê°í•˜ë‚˜ìš”?"
                },
                hasQuiz: false, // This stage does not have a quiz
                lessons: [
                    {
                        icon: "ğŸ“–â†’ğŸŒ",
                        title: "ì´ë¡ ì—ì„œ í˜„ì‹¤ë¡œ - ì„±ê²½ì€ ê·¸ë¦¼ì˜ ë–¡ì´ ì•„ë‹ˆë‹¤",
                        content: `<h4>ğŸ“š ë¬´ì±…ì„í•œ ë™í™”ì—ì„œ ì±…ì„ê° ì©ŒëŠ” í˜„ì‹¤ë¡œ</h4><p>ì‹ ì•™ì€ 'ì˜¤ë˜ì˜¤ë˜ í–‰ë³µí•˜ê²Œ ì‚´ì•˜ë‹µë‹ˆë‹¤'ì—ì„œ ëë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ í›„ì˜ ì‚¶ì„ í•˜ë‚˜ë‹˜ ë‚˜ë¼ ë°©ì‹ìœ¼ë¡œ ì‚´ì•„ë‚´ëŠ” ê²ƒì´ ì§„ì§œ ì´ì•¼ê¸°ì…ë‹ˆë‹¤.</p><h4>ğŸ¯ ëë‚  ë•Œê¹Œì§€ ëë‚œ ê²Œ ì•„ë‹ˆë‹¤</h4><p>ì¼ìƒì—ì„œ ì„±ê²½ ì›ë¦¬ë¥¼ ì ìš©í•˜ê³ , ì‹¤íŒ¨ë¥¼ ë‘ë ¤ì›Œí•˜ì§€ ë§ê³ , ê³„ì†í•´ì„œ í•˜ë‚˜ë‹˜ì„ ì•Œì•„ê°€ë©° ì‹ ë¢°ë¥¼ ìŒ“ì•„ê°€ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "â°",
                        title: "ë§¤ì¼ ê·¸ë¶„ê³¼ - ë£¨í‹´! ì¬ë°Œê³  ê¾¸ì¤€í•˜ê²Œ",
                        content: `<h4>ğŸ“… ì¼ëŒ€ì¼ ë§Œë‚¨ì´ë¼ë‹ˆ</h4><p>í•˜ë‚˜ë‹˜ê³¼ì˜ ê°œì¸ì ì¸ ë§Œë‚¨ ì‹œê°„, ì¦‰ íí‹°(QT, Quiet Time)ë¥¼ ê¾¸ì¤€íˆ ê°€ì§€ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ì¬ë°Œê³  ê¾¸ì¤€í•˜ê²Œ ìì‹ ë§Œì˜ ë£¨í‹´ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p><h4>ğŸ“– íí‹°, ì‹œì‘í•´ë³¼ê¹Œìš”</h4><p>ì„±ê²½ ì½ê¸° â†’ í•˜ë‚˜ë‹˜ ì•Œê¸° â†’ ë©”ì‹œì§€ ì°¾ê¸° â†’ ì ìš©í•˜ê¸° â†’ ê¸°ë„í•˜ê¸° ìˆœì„œë¡œ íí‹°ë¥¼ ì§„í–‰í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "ğŸ¤—",
                        title: "ì¼ìƒì„ í•¨ê»˜ - ì–´, ì‚´ì•„ì„œ ì›€ì§ì´ë„¤",
                        content: `<h4>âœ¨ ì°¬ë€í–ˆë˜ ê·¸ ìˆœê°„ê³¼ ì–´ë‘ ì˜ ì‹œê°„</h4><p>ì¸ìƒì˜ ì¢‹ì€ ìˆœê°„ê³¼ í˜ë“  ìˆœê°„ ëª¨ë‘ í•˜ë‚˜ë‹˜ê³¼ í•¨ê»˜í•˜ë©° ì‹ ì•™ì˜ ê·¼ìœ¡ì„ í‚¤ì›Œë‚˜ê°€ì•¼ í•©ë‹ˆë‹¤.</p><h4>ğŸŒˆ ê±°ë£©í•œ ìƒìƒ</h4><p>í•˜ë‚˜ë‹˜ ë‚˜ë¼ì˜ ì™„ì„±ëœ ëª¨ìŠµì„ ì†Œë§í•˜ë©° ì˜¤ëŠ˜ì˜ ì–´ë ¤ì›€ì„ ê²¬ë””ê³ , ì´ ë•…ì—ì„œ í•˜ë‚˜ë‹˜ ë‚˜ë¼ë¥¼ ë§›ë³´ë©° ì‚´ì•„ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`
                    }
                ],
                discussionQuestions: [
                    "ì„±ê²½ ë§ì”€ì„ 'ê·¸ë¦¼ì˜ ë–¡'ì´ ì•„ë‹Œ, ë‚´ ì‚¶ì˜ 'ì±…ì„ê° ì©ŒëŠ” í˜„ì‹¤'ë¡œ ë§Œë“¤ê¸° ìœ„í•´ ì–´ë–¤ ë…¸ë ¥ì„ í•˜ê³  ìˆë‚˜ìš”? ë˜ëŠ” ì–´ë–¤ ì ì´ ê°€ì¥ ì–´ë µë‚˜ìš”?",
                    "ë§¤ì¼ í•˜ë‚˜ë‹˜ê³¼ ë§Œë‚˜ëŠ” 'íí‹°' ì‹œê°„ì„ ê¾¸ì¤€íˆ ê°–ê¸° ìœ„í•´ ë‚˜ì—ê²Œ ê°€ì¥ í•„ìš”í•œ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”? (ì˜ˆ: ì‹œê°„, ì¥ì†Œ, ì˜ì§€, ì¢‹ì€ êµì¬ ë“±)",
                    "ìµœê·¼ ë‚˜ì˜ ì‚¶ì—ì„œ ê²½í—˜í•œ 'ì°¬ë€í–ˆë˜ ìˆœê°„'ê³¼ 'ì–´ë‘ ì˜ ì‹œê°„'ì€ ê°ê° ë¬´ì—‡ì´ì—ˆë‚˜ìš”? ê·¸ ì‹œê°„ë“¤ì„ í†µí•´ í•˜ë‚˜ë‹˜ì— ëŒ€í•´ ë¬´ì—‡ì„ ë°°ìš°ê²Œ ë˜ì—ˆë‚˜ìš”?"
                ]
            }
        };

        // --- Job System ---
        function getUserJobTitle(level) {
            if (level >= 90) return 'ë§ˆìŠ¤í„°';
            if (level >= 60) return 'ì²­ëŒ€ì¥';
            if (level >= 30) return 'ì²­ê¸°ì‚¬';
            return 'í‘¸ë¥¸ì´';
        }

        // --- Core App Functions ---

        function showTab(tabName, navElement) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            navElement.classList.add('active');

            if (tabName === 'stages') {
                backToStages();
                updateIcebreakerRecordsDisplay(); // Update records when stages tab is shown
            }
            if (tabName === 'guild') {
                updateQTNotes();
                // Directly show guild chat when guild tab is active
                const guildChatContainer = document.getElementById('guild-chat-container');
                if (guildChatContainer) {
                    guildChatContainer.innerHTML = createChatInterface('guild');
                    updateChatMessages('guild');
                }
            }
            if (tabName === 'home') updateNotices();
        }

        function enterStageContent(stageNumber) {
            currentStage = stageNumber;
            const stageData = stageContents[stageNumber];
            
            if (!stageData) {
                showNotification('ìŠ¤í…Œì´ì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('stage-list').classList.add('hidden');
            document.getElementById('stage-detail').classList.remove('hidden');
            
            let contentHtml = `<h3 style="margin-bottom: 20px; color: var(--lesson-title-color);">${stageData.title}</h3>`;

            // 1. Icebreaker Section
            if (stageData.icebreaker && !completedIcebreakers.some(item => item.stage === stageNumber)) { // Check if icebreaker for this stage is completed
                contentHtml += `
                    <div class="icebreaker-section" id="icebreaker-section-${stageNumber}">
                        <div class="modal-title">ì•„ì´ìŠ¤ë¸Œë ˆì´í¬</div>
                        <p class="icebreaker-prompt">${stageData.icebreaker.prompt}</p>
                        <textarea id="icebreakerInput-${stageNumber}" class="icebreaker-input" placeholder="ë‹¹ì‹ ì˜ ìƒê°ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."></textarea>
                        <button class="modal-button primary" onclick="completeIcebreaker(${stageNumber})">ì œì¶œí•˜ê³  ê°•ì˜ ë³´ê¸°</button>
                    </div>
                `;
            }

            // 2. Lessons and Discussion Questions
            // Only show lessons and discussion if icebreaker is completed
            if (!stageData.icebreaker || completedIcebreakers.some(item => item.stage === stageNumber)) {
                contentHtml += stageData.lessons.map(lesson => `
                    <div class="lesson-container">
                        <div class="lesson-header">
                            <div class="lesson-icon">${lesson.icon}</div>
                            <div class="lesson-title">${lesson.title}</div>
                        </div>
                        <div class="lesson-content">${lesson.content}</div>
                    </div>
                `).join('');

                if (stageData.discussionQuestions) {
                    contentHtml += `
                        <div class="discussion-container">
                            <h4>ğŸ¤” í•¨ê»˜ ë‚˜ëˆŒ ì§ˆë¬¸</h4>
                            <ol>
                                ${stageData.discussionQuestions.map(q => `<li>${q}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                }
            }

            if (completedStages.includes(stageNumber)) {
                contentHtml += `<div class="stage-completed-notice">âœ”ï¸ ì´ ìŠ¤í…Œì´ì§€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</div>`;
            } else if (!stageData.icebreaker || completedIcebreakers.some(item => item.stage === stageNumber)) { // Only show complete button if icebreaker is done
                contentHtml += `<button id="complete-stage-btn" class="modal-button primary" style="width:100%; margin-top:20px; background-color: #28a745;" onclick="completeStage(${stageNumber})">ìŠ¤í…Œì´ì§€ ì™„ë£Œ ë° ë³´ìƒ ë°›ê¸° ğŸ†</button>`;
            }
            
            const stageContentElement = document.getElementById('stage-content');
            stageContentElement.innerHTML = contentHtml;
            
            document.querySelector('.content').scrollTop = 0;
        }

        // Internal function to render just the main content (lessons, discussion, complete button)
        // This is called after icebreaker is handled
        function _renderStageMainContent(stageNumber) {
            const stageData = stageContents[stageNumber];
            let contentHtml = `<h3 style="margin-bottom: 20px; color: var(--lesson-title-color);">${stageData.title}</h3>`;

            // Render lessons and discussion only if icebreaker is completed
            if (!stageData.icebreaker || completedIcebreakers.some(item => item.stage === stageNumber)) {
                contentHtml += stageData.lessons.map(lesson => `
                    <div class="lesson-container">
                        <div class="lesson-header">
                            <div class="lesson-icon">${lesson.icon}</div>
                            <div class="lesson-title">${lesson.title}</div>
                        </div>
                        <div class="lesson-content">${lesson.content}</div>
                    </div>
                `).join('');

                if (stageData.discussionQuestions) {
                    contentHtml += `
                        <div class="discussion-container">
                            <h4>ğŸ¤” í•¨ê»˜ ë‚˜ëˆŒ ì§ˆë¬¸</h4>
                            <ol>
                                ${stageData.discussionQuestions.map(q => `<li>${q}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                }
            }

            if (completedStages.includes(stageNumber)) {
                contentHtml += `<div class="stage-completed-notice">âœ”ï¸ ì´ ìŠ¤í…Œì´ì§€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</div>`;
            } else if (!stageData.icebreaker || completedIcebreakers.some(item => item.stage === stageNumber)) { // Only show complete button if icebreaker is done
                contentHtml += `<button id="complete-stage-btn" class="modal-button primary" style="width:100%; margin-top:20px; background-color: #28a745;" onclick="completeStage(${stageNumber})">ìŠ¤í…Œì´ì§€ ì™„ë£Œ ë° ë³´ìƒ ë°›ê¸° ğŸ†</button>`;
            }

            const stageContentElement = document.getElementById('stage-content');
            stageContentElement.innerHTML = contentHtml;
            document.querySelector('.content').scrollTop = 0;
        }


        function backToStages() {
            document.getElementById('stage-detail').classList.add('hidden');
            document.getElementById('stage-list').classList.remove('hidden');
            currentStage = null;
            updateIcebreakerRecordsDisplay(); // Update records when going back to stage list
        }

        function completeStage(stageNumber) {
            if (completedStages.includes(stageNumber)) return;

            const stageData = stageContents[stageNumber];
            let levelGain = 3000; // ëª¨ë“  ìŠ¤í…Œì´ì§€ ì™„ë£Œ ì‹œ 3000ë ˆë²¨ ì¦ê°€
            let itemName = stageData.item || 'íŠ¹ë³„í•œ ì•„ì´í…œ'; // ìŠ¤í…Œì´ì§€ë³„ ì•„ì´í…œ ì´ë¦„

            grantBadge(`${itemName} íšë“`); // ì•„ì´í…œ íšë“ ë±ƒì§€ ë¶€ì—¬
            addExperience(levelGain, `ğŸ‰ ìŠ¤í…Œì´ì§€ ${stageNumber} ì™„ë£Œ! ${itemName} íšë“! ë ˆë²¨ +${levelGain}!`);
            completedStages.push(stageNumber);
            
            const button = document.getElementById('complete-stage-btn');
            if (button) {
                button.remove();
                // ìŠ¤í…Œì´ì§€ ì™„ë£Œ í›„ ë‹¤ì‹œ ì½˜í…ì¸ ë¥¼ ë¡œë“œí•˜ì—¬ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                _renderStageMainContent(stageNumber); 
            }

            updateUI();
            saveProgress();
        }

        // Modified togglePrayerTime function
        function togglePrayerTime(timeSlot, element) {
            if (prayerTimes[timeSlot]) {
                // Already completed, un-complete it
                prayerTimes[timeSlot] = false;
                element.classList.remove('completed');
                showNotification(`${timeSlot} ê¸°ë„ ì·¨ì†Œ! ğŸ™`);
                // Optionally, deduct EXP or revert badge if desired. For now, just UI.
            } else {
                // Not completed, complete it
                prayerTimes[timeSlot] = true;
                element.classList.add('completed');
                
                let message = '';
                let expGain = 30;
                
                switch(timeSlot) {
                    case 'morning': message = 'ğŸŒ… ì•„ì¹¨ ê¸°ë„ ì™„ë£Œ! í•˜ë£¨ë¥¼ ì£¼ë‹˜ê³¼ í•¨ê»˜ ì‹œì‘í•˜ì„¸ìš”!'; break;
                    case 'noon': message = 'â˜€ï¸ ì ì‹¬ ê¸°ë„ ì™„ë£Œ! í•˜ë£¨ ì¤‘ë°˜, ì£¼ë‹˜ê»˜ ê°ì‚¬ë“œë ¤ìš”!'; break;
                    case 'evening': message = 'ğŸŒ™ ì €ë… ê¸°ë„ ì™„ë£Œ! í•˜ë£¨ë¥¼ ì£¼ë‹˜ê»˜ ë§¡ê²¨ë“œë ¤ìš”!'; break;
                }
                
                addExperience(expGain, message);
                grantBadge('ì²« ê¸°ë„');
                
                if (prayerTimes.morning && prayerTimes.noon && prayerTimes.evening) { // Fixed typo: prayerTimes.timeslot -> prayerTimes.evening
                    setTimeout(() => {
                        addExperience(50, 'ğŸ‰ 10-10-10 ê¸°ë„ë²• ì™„ì£¼! ë³´ë„ˆìŠ¤ ê²½í—˜ì¹˜ +50!');
                        grantBadge('10-10-10 ë§ˆìŠ¤í„°');
                    }, 1000);
                }
                
                completedMissions++;
            }
            updateUI();
            saveProgress();
        }

        function showScripture() {
            const container = document.getElementById('scripture-container');
            const randomScripture = scriptures[Math.floor(Math.random() * scriptures.length)];
            
            container.innerHTML = `
                <div class="scripture-card">
                    <div class="scripture-text">"${randomScripture.text}"</div>
                    <div class="scripture-reference">- ${randomScripture.reference} -</div>
                </div>
                <button class="mission-button" onclick="completeMission(this, 'ë§ì”€ ë¬µìƒ ì™„ë£Œ! ì˜ì–‘ë¶„ì„ ì–»ì—ˆìŠµë‹ˆë‹¤! ğŸ“–', 70, 'ì„±ê²½ ë…ì')" style="margin-top: 10px;">ë¬µìƒ ì™„ë£Œ</button>
            `;
            document.getElementById('mission-btn-scripture').style.display = 'none';
        }
        
        function completeMission(button, message, expGain = 50, badgeToGrant = null) {
            button.textContent = 'ì™„ë£Œ!';
            button.disabled = true;
            
            addExperience(expGain, message);
            if (badgeToGrant) grantBadge(badgeToGrant);
            
            completedMissions++;
            updateUI();
            saveProgress();
        }

        function addExperience(amount, notificationMessage) {
            userExp += amount;
            
            if (notificationMessage) {
                showNotification(notificationMessage);
            }

            while (userExp >= 100) {
                userLevel++;
                userExp -= 100;
                setTimeout(() => showNotification(`ğŸ‰ ë ˆë²¨ì—…! Lv.${userLevel} ë‹¬ì„±!`), 500);
            }
            updateUI();
        }

        // --- UI and Utility Functions ---
        function updateUI() {
            // Update job title based on level
            userJob = getUserJobTitle(userLevel);
            
            // Header
            document.getElementById('userName').textContent = userName;
            document.getElementById('headerAvatar').textContent = userAvatar;
            document.getElementById('userLevel').textContent = userLevel;
            document.getElementById('userExp').textContent = userExp;
            document.getElementById('userStreak').textContent = userStreak;
            
            // Profile Tab
            document.getElementById('profileUserName').textContent = userName;
            document.getElementById('profileAvatar').textContent = userAvatar;
            document.getElementById('profileLevel').textContent = userLevel;
            document.getElementById('profileJob').textContent = userJob;
            document.getElementById('profileStreak').textContent = userStreak;
            document.getElementById('completedMissionsCount').textContent = completedMissions;
            
            // Guild Tab
            document.getElementById('guildUserName').textContent = userName;
            document.getElementById('guildUserAvatar').textContent = userAvatar;
            document.getElementById('guildUserLevel').textContent = userLevel;
            document.getElementById('guildUserJob').textContent = userJob;
            document.getElementById('guildUserStreak').textContent = userStreak;
            document.getElementById('guildLevel').textContent = guildLevel;
            document.getElementById('guildExp').textContent = guildExp;
            
            // Badges
            const badgeContainer = document.getElementById('badge-container');
            if(userBadges.length > 0) {
                badgeContainer.innerHTML = userBadges.map(b => `<span>${b}</span>`).join('');
            } else {
                badgeContainer.innerHTML = `<p style="color: var(--text-color); font-size: 14px;">ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        }
        
        function resetMissionUI() {
            // Reset prayer slots
            document.querySelectorAll('.prayer-time-slot').forEach(slot => slot.classList.remove('completed'));
            // Reset mission buttons
            document.querySelectorAll('.mission-button').forEach(btn => {
                btn.disabled = false;
                if(btn.id === 'mission-btn-worship') btn.textContent = 'ì°¸ì—¬ ì™„ë£Œ';
                if(btn.id === 'mission-btn-quiz') btn.textContent = 'í€´ì¦ˆ ì‹œì‘';
                if(btn.id === 'mission-btn-minigame') btn.textContent = 'ë¯¸ë‹ˆê²Œì„ ì‹œì‘';
            });
            document.getElementById('mission-btn-scripture').style.display = 'inline-block';
            document.getElementById('scripture-container').innerHTML = '';
            document.getElementById('minigame-selection-container').innerHTML = ''; // Clear mini-game selection
            document.getElementById('guild-chat-container').innerHTML = ''; // Clear guild tab chat
        }

        function showNotification(message) {
            const existingNotif = document.querySelector('.floating-notification');
            if(existingNotif) existingNotif.remove();
            const notification = document.createElement('div');
            notification.className = 'floating-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // --- Data Persistence ---
        function saveProgress() {
            try {
                const data = {
                    userName, userAvatar, userJob, userLevel, userExp, userStreak,
                    completedMissions, userBadges, completedStages, guildLevel, guildExp, 
                    chatMessages, prayerTimes, notices, qtNotes, currentTheme,
                    quizCompletedPerStage, completedIcebreakers, miniGameCompletedToday, miniGameProgress, // Save new states
                    lastLogin: new Date().toDateString()
                };
                
                const success = safeSetItem('blueWindProgress', JSON.stringify(data));
                if (!success && !isLocalStorageAvailable()) {
                    // localStorage ì‚¬ìš© ë¶ˆê°€ ì‹œ í•œ ë²ˆë§Œ ì•Œë¦¼
                    if (!memoryStorage._warningShown) {
                        showNotification('ë¸Œë¼ìš°ì € ì„¤ì •ìœ¼ë¡œ ì¸í•´ ë°ì´í„°ê°€ ì„¸ì…˜ ë™ì•ˆë§Œ ìœ ì§€ë©ë‹ˆë‹¤. ğŸ“');
                        memoryStorage._warningShown = true;
                    }
                }
            } catch (error) {
                console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                showNotification('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function loadProgress() {
            try {
                const saved = safeGetItem('blueWindProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    userName = data.userName || 'í‘¸ë¥¸ì´';
                    userAvatar = data.userAvatar || 'ğŸŒŸ';
                    userLevel = data.userLevel || 1;
                    userExp = data.userExp || 0;
                    userStreak = data.userStreak || 1;
                    completedMissions = data.completedMissions || 0;
                    userJob = data.userJob || getUserJobTitle(userLevel);
                    userBadges = data.userBadges || [];
                    completedStages = data.completedStages || [];
                    guildLevel = data.guildLevel || 1;
                    guildExp = data.guildExp || 0;
                    chatMessages = data.chatMessages || [];
                    notices = data.notices || [];
                    qtNotes = data.qtNotes || [];
                    currentTheme = data.currentTheme || 'light-mode'; // Load theme
                    quizCompletedPerStage = data.quizCompletedPerStage || {}; // Load quiz completion per stage
                    completedIcebreakers = data.completedIcebreakers || []; // Load icebreaker completion
                    miniGameCompletedToday = data.miniGameCompletedToday || false; // Load mini-game completion
                    miniGameProgress = data.miniGameProgress || {}; // Load individual mini-game progress

                    const today = new Date().toDateString();
                    const lastLogin = data.lastLogin || today;

                    if (lastLogin !== today) {
                        const lastDate = new Date(lastLogin);
                        const todayDate = new Date(today);
                        const diffTime = todayDate - lastDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            userStreak++;
                            setTimeout(() => grantBadge(`${userStreak}ì¼ ì—°ì†`), 500);
                        } else if (diffDays > 1) {
                            userStreak = 1;
                        }
                        prayerTimes = { morning: false, noon: false, evening: false };
                        miniGameCompletedToday = false; // Reset daily mini-game mission
                        miniGameProgress = { bibleVerseFill: false, characterGuess: false, trueFalse: false, wordOrder: false, bibleNumber: false }; // Reset individual mini-game progress
                    } else {
                        prayerTimes = data.prayerTimes || { morning: false, noon: false, evening: false };
                        // Ensure miniGameProgress is initialized if it was missing in old saves
                        if (Object.keys(miniGameProgress).length === 0 && miniGameCompletedToday) {
                             // If miniGameCompletedToday is true but progress is empty, it means it was completed
                             // before individual game tracking was added. Assume all are complete.
                             miniGameProgress = { bibleVerseFill: true, characterGuess: true, trueFalse: true, wordOrder: true, bibleNumber: true };
                        } else if (Object.keys(miniGameProgress).length === 0) {
                            // If it's a new day or new user, initialize to all false
                            miniGameProgress = { bibleVerseFill: false, characterGuess: false, trueFalse: false, wordOrder: false, bibleNumber: false };
                        }
                    }

                    // DOMì´ ë¡œë“œëœ í›„ì— ê¸°ë„ ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        Object.keys(prayerTimes).forEach(timeSlot => {
                            if (prayerTimes[timeSlot]) {
                                const slotElement = document.querySelector(`.prayer-time-slot[data-slot="${timeSlot}"]`);
                                if (slotElement) slotElement.classList.add('completed');
                            }
                        });
                    }, 100);
                } else {
                    setInitialState();
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ˆê¸° ì„¤ì •ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.');
                setInitialState();
            }
            
            // Apply theme after loading
            document.body.className = currentTheme;
            updateUI();
            updateNotices();
            updateQTNotes();
        }
        
        function setInitialState() {
            userLevel = 1;
            userExp = 0;
            userStreak = 1;
            completedMissions = 0;
            userName = 'í‘¸ë¥¸ì´';
            userAvatar = 'ğŸŒŸ';
            userJob = 'í‘¸ë¥¸ì´';
            userBadges = [];
            completedStages = [];
            guildLevel = 1;
            guildExp = 0;
            chatMessages = [];
            prayerTimes = { morning: false, noon: false, evening: false };
            notices = [];
            qtNotes = [];
            currentTheme = 'light-mode';
            quizCompletedPerStage = {}; // Initialize as empty object
            completedIcebreakers = [];
            miniGameCompletedToday = false;
            miniGameProgress = { bibleVerseFill: false, characterGuess: false, trueFalse: false, wordOrder: false, bibleNumber: false }; // Initialize all to false
            
            // ì´ˆê¸° ìƒíƒœ ì €ì¥ ì‹œë„
            try {
                saveProgress();
            } catch (error) {
                console.error('ì´ˆê¸° ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // --- Notice Functions ---
        function showNoticeModal() {
            document.getElementById('noticeModal').style.display = 'flex';
            document.getElementById('noticePassword').focus();
        }

        function closeNoticeModal() {
            document.getElementById('noticeModal').style.display = 'none';
            document.getElementById('noticePassword').value = '';
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
        }

        function createNotice() {
            const password = document.getElementById('noticePassword').value;
            const title = document.getElementById('noticeTitle').value.trim();
            const content = document.getElementById('noticeContent').value.trim();

            if (password !== '0000') { // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (í•˜ë“œì½”ë”©, ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë³´ì•ˆ ê°•í™” í•„ìš”)
                showNotification('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤! âŒ');
                return;
            }

            if (!title || !content) {
                showNotification('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const notice = {
                id: Date.now(),
                title: title,
                content: content,
                date: new Date().toLocaleDateString('ko-KR')
            };

            // ê¸°ì¡´ ê³µì§€ì‚¬í•­ì„ ìƒˆ ê³µì§€ì‚¬í•­ìœ¼ë¡œ êµì²´ (1ê°œë§Œ ìœ ì§€)
            notices = [notice];
            updateNotices();
            closeNoticeModal();
            showNotification('ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¢');
            saveProgress();
        }

        function updateNotices() {
            const container = document.getElementById('notices-container');
            if (notices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;">
                        <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            } else {
                // ìµœì‹  ê³µì§€ì‚¬í•­ 1ê°œë§Œ í‘œì‹œ
                const notice = notices[0];
                container.innerHTML = `
                    <div class="notice-card">
                        <div class="notice-header">
                            <div class="notice-title">ğŸ“¢ ${notice.title}</div>
                            <div class="notice-date">${notice.date}</div>
                        </div>
                        <div class="notice-content">${notice.content}</div>
                    </div>
                `;
            }
        }

        // --- QT Note Functions ---
        function showQTNoteModal() {
            editingQTNote = null;
            document.getElementById('qtModalTitle').textContent = 'QT ë…¸íŠ¸ ì‘ì„±';
            document.getElementById('qtSubmitBtn').textContent = 'ì‘ì„± ì™„ë£Œ';
            document.getElementById('qtSubmitBtn').onclick = createQTNote;
            document.getElementById('qtNoteTitle').value = '';
            document.getElementById('qtNoteContent').value = '';
            document.getElementById('qtNotePassword').value = '';
            document.getElementById('qtNoteModal').style.display = 'flex';
        }

        function closeQTNoteModal() {
            document.getElementById('qtNoteModal').style.display = 'none';
        }

        function createQTNote() {
            const title = document.getElementById('qtNoteTitle').value.trim();
            const content = document.getElementById('qtNoteContent').value.trim();
            const password = document.getElementById('qtNotePassword').value.trim();

            if (!title || !content || !password) {
                showNotification('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (editingQTNote) {
                // ìˆ˜ì • ëª¨ë“œ
                editingQTNote.title = title;
                editingQTNote.content = content;
                editingQTNote.password = password; // ë¹„ë°€ë²ˆí˜¸ë„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
                editingQTNote.date = new Date().toLocaleDateString('ko-KR');
                showNotification('QT ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœï¸');
            } else {
                // ìƒˆ ì‘ì„± ëª¨ë“œ
                const qtNote = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    password: password,
                    author: userName,
                    date: new Date().toLocaleDateString('ko-KR'),
                    likes: 0,
                    likedBy: [], // ì¢‹ì•„ìš” ëˆ„ë¥¸ ì‚¬ìš©ì ë‹‰ë„¤ì„ ëª©ë¡
                    comments: [] // Initialize comments array
                };
                qtNotes.unshift(qtNote);
                showNotification('QT ë…¸íŠ¸ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“');
            }

            updateQTNotes();
            closeQTNoteModal();
            saveProgress();
        }

        function updateQTNotes() {
            const container = document.getElementById('qt-notes-container');
            if (qtNotes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;">
                        <p>ì‘ì„±ëœ QT ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>ì²« ë²ˆì§¸ QT ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”! ğŸ“</p>
                    </div>
                `;
            } else {
                container.innerHTML = qtNotes.map(note => `
                    <div class="qt-note-card">
                        <div class="qt-note-header">
                            <div class="qt-note-title">${note.title}</div>
                            <div class="qt-note-date">${note.date}</div>
                        </div>
                        <div class="qt-note-content">${note.content}</div>
                        <div class="qt-note-actions">
                            <button class="like-button" onclick="toggleLike(${note.id})">
                                ${note.likedBy.includes(userName) ? 'â¤ï¸' : 'ğŸ¤'} ${note.likes}
                            </button>
                            ${note.author === userName ? `
                                <div class="note-buttons">
                                    <button class="note-btn edit" onclick="editQTNote(${note.id})">ìˆ˜ì •</button>
                                    <button class="note-btn delete" onclick="deleteQTNote(${note.id})">ì‚­ì œ</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="comments-section">
                            <h5>ğŸ’¬ ëŒ“ê¸€ (${note.comments.length})</h5>
                            <div class="comment-input-container">
                                <textarea id="commentInput-${note.id}" class="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="2"></textarea>
                                <input type="password" id="commentPassword-${note.id}" class="comment-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (ìˆ˜ì •/ì‚­ì œìš©)" maxlength="10">
                                <button class="comment-send-btn" onclick="addComment(${note.id})">ëŒ“ê¸€ ì‘ì„±</button>
                            </div>
                            <div class="comment-list">
                                ${note.comments.length === 0 ? `<p style="color: var(--text-color); text-align: center;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>` : note.comments.map(comment => `
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <span class="comment-author">${comment.author}</span>
                                            <span class="comment-time">${comment.time}</span>
                                        </div>
                                        <div class="comment-content">${comment.content}</div>
                                        ${comment.author === userName ? `
                                            <div class="comment-actions">
                                                <button class="comment-action-btn edit" onclick="editComment(${note.id}, ${comment.id})">ìˆ˜ì •</button>
                                                <button class="comment-action-btn delete" onclick="deleteComment(${note.id}, ${comment.id})">ì‚­ì œ</button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleLike(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            if (note.likedBy.includes(userName)) {
                // ì¢‹ì•„ìš” ì·¨ì†Œ
                note.likedBy = note.likedBy.filter(name => name !== userName);
                note.likes--;
                showNotification('ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤ ğŸ’”');
            } else {
                // ì¢‹ì•„ìš” ì¶”ê°€
                note.likedBy.push(userName);
                note.likes++;
                showNotification('ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤! â¤ï¸');
            }

            updateQTNotes();
            saveProgress();
        }

        // --- Comment Functions ---
        function addComment(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            const inputElement = document.getElementById(`commentInput-${noteId}`);
            const passwordElement = document.getElementById(`commentPassword-${noteId}`);
            const commentContent = inputElement.value.trim();
            const commentPassword = passwordElement.value.trim();

            if (!commentContent || !commentPassword) {
                showNotification('ëŒ“ê¸€ ë‚´ìš©ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const newComment = {
                id: Date.now(),
                author: userName,
                avatar: userAvatar,
                content: commentContent,
                password: commentPassword,
                time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            };

            note.comments.push(newComment);
            inputElement.value = '';
            passwordElement.value = '';
            showNotification('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’¬');
            updateQTNotes();
            saveProgress();
        }

        function editComment(noteId, commentId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;
            const comment = note.comments.find(c => c.id === commentId);
            if (!comment) return;

            pendingQTAction = { type: 'comment', action: 'edit', noteId: noteId, commentId: commentId };
            document.getElementById('passwordModalText').textContent = 'ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function deleteComment(noteId, commentId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;
            const comment = note.comments.find(c => c.id === commentId);
            if (!comment) return;

            pendingQTAction = { type: 'comment', action: 'delete', noteId: noteId, commentId: commentId };
            document.getElementById('passwordModalText').textContent = 'ëŒ“ê¸€ì„ ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        // Modified confirmQTAction to handle both QT notes and comments
        function confirmQTAction() {
            if (!pendingQTAction) return;

            const password = document.getElementById('qtActionPassword').value;
            let targetItem = null; // Either a QT note or a comment

            if (pendingQTAction.type === 'qtNote') {
                targetItem = qtNotes.find(n => n.id === pendingQTAction.noteId);
            } else if (pendingQTAction.type === 'comment') {
                const note = qtNotes.find(n => n.id === pendingQTAction.noteId);
                if (note) {
                    targetItem = note.comments.find(c => c.id === pendingQTAction.commentId);
                }
            }

            if (!targetItem || targetItem.password !== password) {
                showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤! âŒ');
                document.getElementById('qtActionPassword').value = ''; // Clear password on wrong attempt
                return;
            }

            if (pendingQTAction.type === 'qtNote') {
                if (pendingQTAction.action === 'edit') {
                    editingQTNote = targetItem;
                    document.getElementById('qtModalTitle').textContent = 'QT ë…¸íŠ¸ ìˆ˜ì •';
                    document.getElementById('qtSubmitBtn').textContent = 'ìˆ˜ì • ì™„ë£Œ';
                    document.getElementById('qtSubmitBtn').onclick = createQTNote;
                    document.getElementById('qtNoteTitle').value = targetItem.title;
                    document.getElementById('qtNoteContent').value = targetItem.content;
                    document.getElementById('qtNotePassword').value = targetItem.password;
                    document.getElementById('qtNoteModal').style.display = 'flex';
                } else if (pendingQTAction.action === 'delete') {
                    qtNotes = qtNotes.filter(n => n.id !== pendingQTAction.noteId);
                    updateQTNotes();
                    showNotification('QT ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ—‘ï¸');
                    saveProgress();
                }
            } else if (pendingQTAction.type === 'comment') {
                const note = qtNotes.find(n => n.id === pendingQTAction.noteId);
                if (!note) return;

                if (pendingQTAction.action === 'edit') {
                    const newContent = prompt('ìƒˆë¡œìš´ ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:', targetItem.content);
                    if (newContent !== null) { // User didn't cancel
                        targetItem.content = newContent.trim();
                        targetItem.time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) + ' (ìˆ˜ì •ë¨)';
                        showNotification('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœï¸');
                    }
                } else if (pendingQTAction.action === 'delete') {
                    note.comments = note.comments.filter(c => c.id !== pendingQTAction.commentId);
                    showNotification('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ—‘ï¸');
                }
                updateQTNotes();
                saveProgress();
            }

            closeQTPasswordModal();
            document.getElementById('qtActionPassword').value = ''; // Clear password after successful action
        }

        function closeQTPasswordModal() {
            document.getElementById('qtPasswordModal').style.display = 'none';
            document.getElementById('qtActionPassword').value = '';
            pendingQTAction = null;
        }

        // --- Badge Functions ---
        function grantBadge(badgeName) {
            if (!userBadges.includes(badgeName)) {
                userBadges.push(badgeName);
                showNotification(`ğŸ† ë±ƒì§€ íšë“: ${badgeName}!`);
                updateUI();
                saveProgress();
            }
        }

        // --- Chat Functions ---
        // showGuildChat is now implicitly handled by showTab('guild', ...)
        // and its content is directly injected.
        function showGuildChat() {
            // This function is no longer needed as chat is direct on guild tab
            showTab('guild', document.querySelector('.nav-item:nth-child(3)')); // Activate guild tab
        }
        
        function createChatInterface(prefix) {
            return `
                <div class="chat-container">
                    <div class="chat-messages" id="${prefix}Messages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="${prefix}Input" placeholder="ê¸¸ë“œì›ë“¤ê³¼ ëŒ€í™”í•´ë³´ì„¸ìš”..." onkeypress="handleChatKeyPress(event, '${prefix}')">
                        <button class="image-upload-btn" onclick="document.getElementById('${prefix}FileInput').click()">ğŸ“·</button>
                        <button class="chat-send-btn" onclick="sendMessage('${prefix}')">ì „ì†¡</button>
                        <input type="file" id="${prefix}FileInput" class="hidden-file-input" accept="image/*" onchange="handleImageUpload(event, '${prefix}')">
                    </div>
                </div>
            `;
        }

        function updateChatMessages(prefix) {
            const messagesContainer = document.getElementById(`${prefix}Messages`);
            if (!messagesContainer) return;
            
            if (chatMessages.length === 0) {
                messagesContainer.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px;"><p>ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”! ğŸ’¬</p></div>`;
            } else {
                messagesContainer.innerHTML = chatMessages.map(msg => {
                    let messageContent = `<div class="message-bubble">${msg.message}</div>`;
                    if (msg.image) {
                        messageContent += `<img src="${msg.image}" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€" class="message-image" onclick="showImageModal('${msg.image}')">`;
                    }
                    
                    return `
                        <div class="message ${msg.sender === userName ? 'user' : 'other'}">
                            <div class="message-header">
                                <div class="message-avatar">${msg.avatar || 'ğŸ‘¤'}</div>
                                <div class="message-sender">${msg.sender}</div>
                                <div class="message-time">${msg.time}</div>
                            </div>
                            ${messageContent}
                        </div>
                    `;
                }).join('');
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleImageUpload(event, prefix) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) { // 5MB ì œí•œ
                showNotification('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤! ğŸ“·');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                chatMessages.push({ 
                    sender: userName, 
                    avatar: userAvatar, 
                    message: 'ì‚¬ì§„ì„ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤ ğŸ“·', 
                    image: e.target.result,
                    time: timeString 
                });
                
                if (document.getElementById('chatMessages')) updateChatMessages('chat');
                if (document.getElementById('guildMessages')) updateChatMessages('guild'); // Changed to guildMessages for guild chat
                
                showNotification('ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“·');
                saveProgress();
            };
            reader.readAsDataURL(file);
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        function showImageModal(imageSrc) {
            // ì´ë¯¸ì§€ í™•ëŒ€ ë³´ê¸° ëª¨ë‹¬ ìƒì„±
            const existingModal = document.getElementById('imageViewModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'imageViewModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%; padding: 20px;">
                    <div class="modal-title">ì´ë¯¸ì§€ ë³´ê¸°</div>
                    <img src="${imageSrc}" style="max-width: 100%; max-height: 70vh; border-radius: 10px;">
                    <div class="modal-buttons" style="margin-top: 15px;">
                        <button class="modal-button secondary" onclick="closeImageModal()">ë‹«ê¸°</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeImageModal();
            });
        }

        function closeImageModal() {
            const modal = document.getElementById('imageViewModal');
            if (modal) modal.remove();
        }

        function sendMessage(prefix) {
            const input = document.getElementById(`${prefix}Input`);
            const message = input.value.trim();
            if (message) {
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                chatMessages.push({ sender: userName, avatar: userAvatar, message: message, time: timeString });
                input.value = '';
                
                if (document.getElementById('chatMessages')) updateChatMessages('chat');
                if (document.getElementById('guildMessages')) updateChatMessages('guild'); // Changed to guildMessages for guild chat
                
                saveProgress();
            }
        }

        function handleChatKeyPress(event, prefix) {
            if (event.key === 'Enter') sendMessage(prefix);
        }

        // --- Quiz Functions (for home tab quiz mission) ---
        let currentQuizIndex = 0;

        function startQuiz() {
            const lastQuizMissionDate = safeGetItem('lastQuizMissionDate');
            const today = new Date().toDateString();

            if (lastQuizMissionDate === today) {
                showNotification('ì˜¤ëŠ˜ì€ ì´ë¯¸ í€´ì¦ˆ ë¯¸ì…˜ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ë‚´ì¼ ë‹¤ì‹œ ë„ì „í•´ì£¼ì„¸ìš”. ğŸ˜Š');
                return;
            }

            currentQuizIndex = 0;
            displayQuizQuestion();
            document.getElementById('minigameModal').style.display = 'flex'; // Use minigameModal for quiz
        }

        function displayQuizQuestion() {
            const minigameContent = document.getElementById('minigame-content');
            const questionData = quizQuestions[currentQuizIndex];

            if (!questionData) {
                // All questions answered
                minigameContent.innerHTML = `
                    <div class="modal-title">í€´ì¦ˆ ì™„ë£Œ!</div>
                    <p style="color: var(--text-color); margin-bottom: 20px;">ëª¨ë“  í€´ì¦ˆë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ëŒ€ë‹¨í•´ìš”! ğŸ‰</p>
                    <div class="modal-buttons">
                        <button class="modal-button primary" onclick="completeQuizMission()">ë³´ìƒ ë°›ê¸°</button>
                        <button class="modal-button secondary" onclick="closeMinigameModal()">ë‹«ê¸°</button>
                    </div>
                `;
                return;
            }

            let optionsHtml = questionData.options.map(option => `
                <button class="quiz-option" onclick="checkQuizAnswer('${option}')">${option}</button>
            `).join('');

            minigameContent.innerHTML = `
                <div class="modal-title">ì‹ ì•™ í€´ì¦ˆ (${currentQuizIndex + 1}/${quizQuestions.length})</div>
                <p style="color: var(--text-color); margin-bottom: 20px; font-weight: bold;">${questionData.question}</p>
                <div>${optionsHtml}</div>
            `;
        }

        function checkQuizAnswer(selectedOption) {
            const questionData = quizQuestions[currentQuizIndex];
            if (selectedOption === questionData.answer) {
                showNotification('ì •ë‹µì…ë‹ˆë‹¤! ğŸ¥³');
                currentQuizIndex++;
                setTimeout(displayQuizQuestion, 500); // Show next question after a short delay
            } else {
                showNotification('ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”. ğŸ˜”');
            }
        }

        function completeQuizMission() {
            addExperience(50, 'í€´ì¦ˆ ë¯¸ì…˜ ì™„ë£Œ! ì§€í˜œê°€ +50 ì¦ê°€í–ˆìŠµë‹ˆë‹¤! ğŸ§ ');
            grantBadge('í€´ì¦ˆ ë§ˆìŠ¤í„°');
            safeSetItem('lastQuizMissionDate', new Date().toDateString()); // Mark daily quiz mission complete
            
            const quizButton = document.getElementById('mission-btn-quiz');
            if (quizButton) {
                quizButton.textContent = 'ì™„ë£Œ!';
                quizButton.disabled = true;
            }
            closeMinigameModal();
            saveProgress();
        }

        function closeMinigameModal() {
            document.getElementById('minigameModal').style.display = 'none';
        }

        // --- Icebreaker Functions ---
        let currentIcebreakerStage = null;

        function completeIcebreaker(stageNumber) {
            const answer = document.getElementById(`icebreakerInput-${stageNumber}`).value.trim();
            if (!answer) {
                showNotification('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // Update completedIcebreakers array
            const today = new Date().toLocaleDateString('ko-KR');
            let existingEntry = completedIcebreakers.find(item => item.stage === stageNumber);
            if (existingEntry) {
                existingEntry.answer = answer;
                existingEntry.date = today;
            } else {
                completedIcebreakers.push({ stage: stageNumber, answer: answer, date: today });
            }
            // Sort to ensure order in display
            completedIcebreakers.sort((a, b) => a.stage - b.stage);

            showNotification(`ì•„ì´ìŠ¤ë¸Œë ˆì´í¬ ì™„ë£Œ! ìŠ¤í…Œì´ì§€ ${stageNumber}ì˜ ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!`);
            saveProgress();
            
            // After icebreaker, proceed to render main content
            _renderStageMainContent(stageNumber); 
            updateIcebreakerRecordsDisplay(); // Update records display immediately
        }

        // Function to display icebreaker records
        function updateIcebreakerRecordsDisplay() {
            const container = document.getElementById('icebreaker-records-container');
            if (!container) return;

            if (completedIcebreakers.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;">
                                            <p>ì•„ì§ ì‘ì„±ëœ ì•„ì´ìŠ¤ë¸Œë ˆì´í¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                            <p>í•™ìŠµ ìŠ¤í…Œì´ì§€ë¥¼ ì‹œì‘í•˜ì—¬ ì²« ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”! âœ¨</p>
                                        </div>`;
            } else {
                container.innerHTML = completedIcebreakers.map(record => `
                    <div class="qt-note-card" style="margin-bottom: 10px;">
                        <div class="qt-note-header">
                            <div class="qt-note-title">ìŠ¤í…Œì´ì§€ ${record.stage} ì•„ì´ìŠ¤ë¸Œë ˆì´í¬</div>
                            <div class="qt-note-date">${record.date}</div>
                        </div>
                        <div class="qt-note-content">${record.answer}</div>
                    </div>
                `).join('');
            }
        }


        // --- Mini-game Functions (for home tab) ---
        const miniGames = {
            'bibleVerseFill': {
                name: 'ì„±ê²½ êµ¬ì ˆ ë¹ˆì¹¸ ì±„ìš°ê¸°',
                prompt: 'ë‹¤ìŒ ì„±ê²½ êµ¬ì ˆì˜ ë¹ˆì¹¸ì„ ì±„ìš°ì„¸ìš”.',
                data: [
                    { verse: "í•˜ë‚˜ë‹˜ì´ ì„¸ìƒì„ ì´ì²˜ëŸ¼ ì‚¬ë‘í•˜ì‚¬ ë…ìƒìë¥¼ ì£¼ì…¨ìœ¼ë‹ˆ ì´ëŠ” ê·¸ë¥¼ ë¯¿ëŠ” ìë§ˆë‹¤ ë©¸ë§í•˜ì§€ ì•Šê³  [ ]ì„ ì–»ê²Œ í•˜ë ¤ í•˜ì‹¬ì´ë¼.", blankWord: "ì˜ìƒ", hint: "ì˜ì›í•œ ì‚¶" },
                    { verse: "ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ [ ]ì‹œë‹ˆ ë‚´ê²Œ ë¶€ì¡±í•¨ì´ ì—†ìœ¼ë¦¬ë¡œë‹¤.", blankWord: "ëª©ì", hint: "ì–‘ì„ ëŒë³´ëŠ” ì‚¬ëŒ" },
                    { verse: "ë‚´ê²Œ ëŠ¥ë ¥ ì£¼ì‹œëŠ” ì ì•ˆì—ì„œ ë‚´ê°€ ëª¨ë“  ê²ƒì„ [ ] ìˆ˜ ìˆëŠë‹ˆë¼.", blankWord: "í• ", hint: "ëŠ¥ë ¥" }
                ],
                exp: 10
            },
            'characterGuess': {
                name: 'ì„±ê²½ ì¸ë¬¼ ë§ì¶”ê¸°',
                prompt: 'ì„¤ëª…ì„ ë“£ê³  ì„±ê²½ ì¸ë¬¼ì„ ë§ì¶°ë³´ì„¸ìš”.',
                data: [
                    { description: "ì´ìŠ¤ë¼ì—˜ì˜ ì²« ë²ˆì§¸ ì™•", answer: "ì‚¬ìš¸" },
                    { description: "ê³¨ë¦¬ì•—ì„ ë¬¼ë¦¬ì¹œ ì†Œë…„ ëª©ë™", answer: "ë‹¤ìœ—" },
                    { description: "í™í•´ë¥¼ ê°€ë¥¸ ì„ ì§€ì", answer: "ëª¨ì„¸" }
                ],
                exp: 10
            },
            'trueFalse': {
                name: 'ì°¸/ê±°ì§“ í€´ì¦ˆ',
                prompt: 'ë‹¤ìŒ ë¬¸ì¥ì´ ì°¸ì¸ì§€ ê±°ì§“ì¸ì§€ ë§ì¶°ë³´ì„¸ìš”.',
                data: [
                    { question: "ë…¸ì•„ëŠ” ë°©ì£¼ë¥¼ 100ë…„ ë™ì•ˆ ì§€ì—ˆë‹¤.", answer: "ì°¸" },
                    { question: "ì˜ˆìˆ˜ë‹˜ì€ ì‹­ìê°€ì—ì„œ 3ì¼ ë§Œì— ë¶€í™œí•˜ì…¨ë‹¤.", answer: "ì°¸" },
                    { question: "ìš”ë‚˜ ì„ ì§€ìëŠ” ë¬¼ê³ ê¸° ë±ƒì†ì—ì„œ 3ì¼ ë°¤ë‚®ì„ ë³´ëƒˆë‹¤.", answer: "ì°¸" }
                ],
                exp: 10
            },
            'wordOrder': {
                name: 'ë‹¨ì–´ ìˆœì„œ ë§ì¶”ê¸°',
                prompt: 'ë‹¨ì–´ë¥¼ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ë°°ì—´í•˜ì—¬ ë¬¸ì¥ì„ ë§Œë“œì„¸ìš”.',
                data: [
                    { scrambled: ["ì˜¤ë˜", "ì‚¬ë‘ì€", "ì°¸ê³ "], answer: "ì‚¬ë‘ì€ ì˜¤ë˜ ì°¸ê³ " },
                    { scrambled: ["ë‚˜ì˜", "ëª©ìì‹œë‹ˆ", "ì—¬í˜¸ì™€ëŠ”"], answer: "ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ" },
                    { scrambled: ["ì„¸ìƒì„", "í•˜ë‚˜ë‹˜ì´", "ì´ì²˜ëŸ¼", "ì‚¬ë‘í•˜ì‚¬"], answer: "í•˜ë‚˜ë‹˜ì´ ì„¸ìƒì„ ì´ì²˜ëŸ¼ ì‚¬ë‘í•˜ì‚¬" }
                ],
                exp: 10
            },
            'bibleNumber': {
                name: 'ì„±ê²½ ìˆ«ì í€´ì¦ˆ',
                prompt: 'ë‹¤ìŒ ì§ˆë¬¸ì— í•´ë‹¹í•˜ëŠ” ìˆ«ìë¥¼ ë§ì¶°ë³´ì„¸ìš”.',
                data: [
                    { question: "ì˜ˆìˆ˜ë‹˜ì´ ì˜¤ë³‘ì´ì–´ ê¸°ì ì„ ì¼ìœ¼í‚¤ì‹¤ ë•Œ ë¬¼ê³ ê¸°ëŠ” ëª‡ ë§ˆë¦¬ì˜€ì„ê¹Œìš”?", answer: "ë‘ ë§ˆë¦¬" },
                    { question: "ë…¸ì•„ì˜ ë°©ì£¼ì— ë“¤ì–´ê°„ ì •ê²°í•œ ì§ìŠ¹ì€ ì•”ìˆ˜ ëª‡ ìŒì´ì—ˆì„ê¹Œìš”?", answer: "ì¼ê³± ìŒ" },
                    { question: "ì˜ˆìˆ˜ë‹˜ì˜ 12ì œì ì¤‘ í•œ ëª…ì€ ì˜ˆìˆ˜ë‹˜ì„ ì€ 30ì— íŒ”ì•˜ìŠµë‹ˆë‹¤. ê·¸ ì œìì˜ ì´ë¦„ì€?", answer: "ìœ ë‹¤" }
                ],
                exp: 10
            }
        };

        let currentMiniGameType = null; // Stores the type of the currently active mini-game
        let currentMiniGameData = null; // Stores the specific data for the current mini-game instance
        let miniGameRound = 0; // Tracks which data item is being used for games with multiple data points

        function showMinigameSelection() {
            const container = document.getElementById('minigame-selection-container');
            const minigameButton = document.getElementById('mission-btn-minigame');

            if (miniGameCompletedToday) {
                showNotification('ì˜¤ëŠ˜ì€ ì´ë¯¸ ë¯¸ë‹ˆê²Œì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ë‚´ì¼ ë‹¤ì‹œ ë„ì „í•´ì£¼ì„¸ìš”. ğŸ˜Š');
                return;
            }

            minigameButton.style.display = 'none'; // Hide the main button

            let selectionHtml = `
                <div class="minigame-selection-card">
                    <h4>ì–´ë–¤ ë¯¸ë‹ˆê²Œì„ì„ í•˜ì‹œê² ì–´ìš”?</h4>
                    <div class="minigame-selection-grid">
                        <button class="minigame-button" ${miniGameProgress.bibleVerseFill ? 'disabled' : ''} onclick="startMiniGame('bibleVerseFill')">ì„±ê²½ êµ¬ì ˆ ë¹ˆì¹¸ ì±„ìš°ê¸°</button>
                        <button class="minigame-button" ${miniGameProgress.characterGuess ? 'disabled' : ''} onclick="startMiniGame('characterGuess')">ì„±ê²½ ì¸ë¬¼ ë§ì¶”ê¸°</button>
                        <button class="minigame-button" ${miniGameProgress.trueFalse ? 'disabled' : ''} onclick="startMiniGame('trueFalse')">ì°¸/ê±°ì§“ í€´ì¦ˆ</button>
                        <button class="minigame-button" ${miniGameProgress.wordOrder ? 'disabled' : ''} onclick="startMiniGame('wordOrder')">ë‹¨ì–´ ìˆœì„œ ë§ì¶”ê¸°</button>
                        <button class="minigame-button" ${miniGameProgress.bibleNumber ? 'disabled' : ''} onclick="startMiniGame('bibleNumber')">ì„±ê²½ ìˆ«ì í€´ì¦ˆ</button>
                    </div>
                    <button class="modal-button secondary" style="width:100%; margin-top:15px;" onclick="cancelMinigameSelection()">ì·¨ì†Œ</button>
                </div>
            `;
            container.innerHTML = selectionHtml;
        }

        function cancelMinigameSelection() {
            document.getElementById('minigame-selection-container').innerHTML = '';
            document.getElementById('mission-btn-minigame').style.display = 'inline-block';
        }

        function startMiniGame(gameType) {
            currentMiniGameType = gameType;
            miniGameRound = 0; // Reset round for new game
            displayMiniGame();
        }

        function displayMiniGame() {
            const container = document.getElementById('minigame-selection-container');
            const gameInfo = miniGames[currentMiniGameType];

            if (!gameInfo || miniGameRound >= gameInfo.data.length) {
                // All rounds for this game completed or no data
                miniGameProgress[currentMiniGameType] = true; // Mark this game as completed
                checkOverallMiniGameCompletion(); // Check if all 5 games are done
                showNotification(`${gameInfo.name} ê²Œì„ ì™„ë£Œ!`);
                
                // If all games are done, the mission button will be updated.
                // Otherwise, go back to selection or show a message.
                if (Object.values(miniGameProgress).every(status => status === true)) {
                    document.getElementById('minigame-selection-container').innerHTML = ''; // Clear game area
                    document.getElementById('mission-btn-minigame').textContent = 'ì™„ë£Œ!';
                    document.getElementById('mission-btn-minigame').disabled = true;
                    document.getElementById('mission-btn-minigame').style.display = 'inline-block'; // Show main button again
                } else {
                    // If not all games are done, go back to selection screen
                    showMinigameSelection();
                }
                saveProgress();
                return;
            }

            currentMiniGameData = gameInfo.data[miniGameRound];
            let gameHtml = `<div class="minigame-content-area" id="active-minigame-area">`;

            switch (currentMiniGameType) {
                case 'bibleVerseFill':
                    const verseParts = currentMiniGameData.verse.split('[ ]');
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-style: italic; margin: 10px 0;">${verseParts[0]}<input type="text" id="gameInput" placeholder="${currentMiniGameData.hint}" onkeypress="handleGameInputKeyPress(event)">${verseParts[1]}</p>
                        <button onclick="checkGameAnswer('bibleVerseFill')">í™•ì¸</button>
                    `;
                    break;
                case 'characterGuess':
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-style: italic; margin: 10px 0;">"${currentMiniGameData.description}"</p>
                        <input type="text" id="gameInput" placeholder="ì¸ë¬¼ ì´ë¦„" onkeypress="handleGameInputKeyPress(event)">
                        <button onclick="checkGameAnswer('characterGuess')">í™•ì¸</button>
                    `;
                    break;
                case 'trueFalse':
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-weight: bold; margin: 10px 0;">"${currentMiniGameData.question}"</p>
                        <button class="quiz-option" onclick="checkGameAnswer('trueFalse', 'ì°¸')">ì°¸</button>
                        <button class="quiz-option" onclick="checkGameAnswer('trueFalse', 'ê±°ì§“')">ê±°ì§“</button>
                    `;
                    break;
                case 'wordOrder':
                    function shuffleArray(array) {
                        for (let i = array.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [array[i], array[j]] = [array[j], array[i]];
                        }
                        return array;
                    }
                    const shuffledWords = shuffleArray([...currentMiniGameData.scrambled]);
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-size: 20px; font-weight: bold; margin: 10px 0;">${shuffledWords.join(' ')}</p>
                        <input type="text" id="gameInput" placeholder="ì •ë‹µ ë¬¸ì¥ ì…ë ¥" onkeypress="handleGameInputKeyPress(event)">
                        <button onclick="checkGameAnswer('wordOrder')">í™•ì¸</button>
                    `;
                    break;
                case 'bibleNumber':
                    gameHtml += `
                        <p>${gameInfo.prompt}</p>
                        <p style="font-weight: bold; margin: 10px 0;">"${currentMiniGameData.question}"</p>
                        <input type="text" id="gameInput" placeholder="ìˆ«ì ë˜ëŠ” ì´ë¦„" onkeypress="handleGameInputKeyPress(event)">
                        <button onclick="checkGameAnswer('bibleNumber')">í™•ì¸</button>
                    `;
                    break;
            }
            gameHtml += `
                <button class="modal-button secondary" style="margin-top: 20px;" onclick="resetMiniGameSelection()">ë‹¤ë¥¸ ê²Œì„ ì„ íƒ</button>
                </div>
            `;
            container.innerHTML = gameHtml;
            if (document.getElementById('gameInput')) {
                document.getElementById('gameInput').focus();
            }
        }

        function handleGameInputKeyPress(event) {
            if (event.key === 'Enter') {
                checkGameAnswer(currentMiniGameType);
            }
        }

        function checkGameAnswer(gameType, selectedOption = null) {
            let isCorrect = false;
            const inputElement = document.getElementById('gameInput');
            const inputValue = inputElement ? inputElement.value.trim() : '';

            switch (gameType) {
                case 'bibleVerseFill':
                    isCorrect = (inputValue.toLowerCase() === currentMiniGameData.blankWord.toLowerCase());
                    break;
                case 'characterGuess':
                    isCorrect = (inputValue.toLowerCase() === currentMiniGameData.answer.toLowerCase());
                    break;
                case 'trueFalse':
                    isCorrect = (selectedOption.toLowerCase() === currentMiniGameData.answer.toLowerCase());
                    break;
                case 'wordOrder':
                    isCorrect = (inputValue.toLowerCase() === currentMiniGameData.answer.toLowerCase());
                    break;
                case 'bibleNumber':
                    isCorrect = (inputValue.toLowerCase() === currentMiniGameData.answer.toLowerCase());
                    break;
            }

            if (isCorrect) {
                showNotification('ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰');
                addExperience(miniGames[gameType].exp, `${miniGames[gameType].name} ì™„ë£Œ! ê²½í—˜ì¹˜ +${miniGames[gameType].exp}!`);
                miniGameRound++;
                setTimeout(displayMiniGame, 500); // Go to next round or complete game
            } else {
                showNotification('í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”. ğŸ˜”');
                if (inputElement) inputElement.value = ''; // Clear input for another try
            }
            saveProgress();
        }

        function resetMiniGameSelection() {
            currentMiniGameType = null;
            currentMiniGameData = null;
            miniGameRound = 0;
            showMinigameSelection(); // Go back to the game selection screen
        }

        function checkOverallMiniGameCompletion() {
            const allGamesCompleted = Object.values(miniGameProgress).every(status => status === true);
            if (allGamesCompleted && !miniGameCompletedToday) {
                miniGameCompletedToday = true;
                addExperience(30, 'ğŸ‰ ì˜¤ëŠ˜ì˜ ë¯¸ë‹ˆê²Œì„ ë¯¸ì…˜ ì™„ë£Œ! ë³´ë„ˆìŠ¤ ê²½í—˜ì¹˜ +30!');
                grantBadge('ë¯¸ë‹ˆê²Œì„ ë§ˆìŠ¤í„°');
                document.getElementById('mission-btn-minigame').textContent = 'ì™„ë£Œ!';
                document.getElementById('mission-btn-minigame').disabled = true;
                saveProgress();
            }
        }


        // --- Modal Functions ---
        function showNameModal() {
            const modal = document.getElementById('nameModal');
            document.getElementById('nameInput').value = userName;
            modal.style.display = 'flex';
            document.getElementById('nameInput').focus();
        }
        function closeNameModal() { document.getElementById('nameModal').style.display = 'none'; }
        function changeName() {
            const newName = document.getElementById('nameInput').value.trim();
            if (newName && newName.length > 0 && newName.length <= 10) {
                userName = newName;
                updateUI();
                closeNameModal();
                showNotification('ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                saveProgress();
            } else {
                showNotification('ë‹‰ë„¤ì„ì€ 1~10ì ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            }
        }

        function showAvatarModal() { document.getElementById('avatarModal').style.display = 'flex'; }
        function closeAvatarModal() { document.getElementById('avatarModal').style.display = 'none'; }
        function selectAvatar(emoji) {
            userAvatar = emoji;
            updateUI();
            closeAvatarModal();
            showNotification('í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
            saveProgress();
        }

        function showResetModal() { document.getElementById('resetModal').style.display = 'flex'; }
        function closeResetModal() { document.getElementById('resetModal').style.display = 'none'; }
        function confirmReset() {
            if (document.getElementById('adminPassword').value === '0000') {
                try {
                    safeRemoveItem('blueWindProgress');
                } catch (error) {
                    console.error('ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
                }
                // ë©”ëª¨ë¦¬ ì €ì¥ì†Œë„ ì´ˆê¸°í™”
                memoryStorage = {};
                
                setInitialState();
                updateUI();
                resetMissionUI();
                closeResetModal();
                showNotification('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ”„');
            } else {
                showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤! âŒ');
            }
        }

        // --- Theme Toggle Function ---
        function toggleTheme() {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                currentTheme = 'dark-mode';
                showNotification('ë‹¤í¬ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸŒ™');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                currentTheme = 'light-mode';
                showNotification('ë¼ì´íŠ¸ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤ â˜€ï¸');
            }
            saveProgress();
        }

        // --- App Initialization ---
        function initApp() {
            try {
                loadProgress();
                
                setTimeout(() => {
                    showNotification(`${userName}ë‹˜, í‘¸ë¥¸ë‚˜ë¼í•™êµì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸŒŸ`);
                }, 1000);

                // Update home tab quiz button state
                const lastQuizMissionDate = safeGetItem('lastQuizMissionDate');
                const today = new Date().toDateString();
                const quizButton = document.getElementById('mission-btn-quiz');

                if (lastQuizMissionDate === today) {
                    if (quizButton) {
                        quizButton.textContent = 'ì™„ë£Œ!';
                        quizButton.disabled = true;
                    }
                } else {
                    if (quizButton) {
                        quizButton.textContent = 'í€´ì¦ˆ ì‹œì‘';
                        quizButton.disabled = false;
                    }
                }

                // Update home tab mini-game button state
                const minigameButton = document.getElementById('mission-btn-minigame');
                if (miniGameCompletedToday) {
                    if (minigameButton) {
                        minigameButton.textContent = 'ì™„ë£Œ!';
                        minigameButton.disabled = true;
                    }
                } else {
                    if (minigameButton) {
                        minigameButton.textContent = 'ë¯¸ë‹ˆê²Œì„ ì‹œì‘';
                        minigameButton.disabled = false;
                    }
                }


                // Modal close events
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });

                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                        closeImageModal();
                    }
                    if (e.key === 'Enter') {
                        const nameModal = document.getElementById('nameModal');
                        const resetModal = document.getElementById('resetModal');
                        const noticeModal = document.getElementById('noticeModal');
                        const qtNoteModal = document.getElementById('qtNoteModal');
                        const qtPasswordModal = document.getElementById('qtPasswordModal');
                        
                        if (nameModal.style.display === 'flex') {
                            e.preventDefault();
                            changeName();
                        } else if (resetModal.style.display === 'flex') {
                            e.preventDefault();
                            confirmReset();
                        } else if (noticeModal.style.display === 'flex') {
                            e.preventDefault();
                            createNotice();
                        } else if (qtNoteModal.style.display === 'flex') {
                            e.preventDefault();
                            createQTNote();
                        } else if (qtPasswordModal.style.display === 'flex') {
                            e.preventDefault();
                            confirmQTAction();
                        }
                        // Inline minigame/icebreaker enter handling is within their specific functions
                    }
                });
            } catch (error) {
                console.error('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showNotification('ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ í›„ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // ë°ì´í„° ì €ì¥ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        window.addEventListener('beforeunload', () => {
            try {
                saveProgress();
            } catch (error) {
                console.error('ì¢…ë£Œ ì‹œ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
            }
        });

    </script>
</body>
</html>
