<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>푸른나라학교 - 신앙 RPG</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="푸른나라학교">
    
    <style>
        /* Pretendard 폰트 임포트 */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --app-bg: white;
            --text-color: #333;
            --header-gradient-start: #4facfe;
            --header-gradient-end: #00f2fe;
            --header-text-color: white;
            --nav-bg: #f8f9fa;
            --nav-border: #dee2e6;
            --nav-item-color: #495057;
            --nav-item-active-bg: #4facfe;
            --nav-item-active-color: white;
            --nav-item-hover-bg: #e9ecef;
            --nav-item-active-hover-bg: #3d8bfe;
            --notice-bg-start: #fff3cd;
            --notice-bg-end: #ffeeba;
            --notice-border: #ffc107;
            --notice-text: #856404;
            --mission-card-bg: #f8f9fa;
            --mission-card-border: #dee2e6;
            --mission-button-bg: #4facfe;
            --mission-button-hover-bg: #3d8bfe;
            --mission-button-disabled-bg: #28a745;
            --prayer-card-bg-start: #ffecd2;
            --prayer-card-bg-end: #fcb69f;
            --prayer-card-title: #8b4513;
            --prayer-slot-bg: rgba(255,255,255,0.7);
            --prayer-slot-hover-border: #8b4513;
            --prayer-slot-completed-bg: #d4edda;
            --prayer-slot-completed-border: #28a745;
            --scripture-card-bg-start: #e3f2fd;
            --scripture-card-bg-end: #bbdefb;
            --scripture-card-border: #2196f3;
            --scripture-text: #1565c0;
            --scripture-reference: #0d47a1;
            --chat-container-bg: #f8f9fa;
            --chat-messages-bg: white;
            --chat-input-border: #dee2e6;
            --chat-input-focus-border: #4facfe;
            --chat-send-btn-bg: #4facfe;
            --chat-send-btn-hover-bg: #3d8bfe;
            --image-upload-btn-bg: #17a2b8;
            --image-upload-btn-hover-bg: #138496;
            --message-user-bubble-bg: #4facfe;
            --message-user-bubble-color: white;
            --message-other-bubble-bg: #f1f3f4;
            --message-other-bubble-color: #333;
            --message-user-avatar-bg: #3d8bfe;
            --message-other-avatar-bg: #6c757d;
            --qt-note-card-bg: white;
            --qt-note-card-border: #dee2e6;
            --qt-note-title: #4facfe;
            --qt-note-date: #666;
            --qt-note-content: #333;
            --like-button-color: #e91e63;
            --like-button-hover-color: #c2185b;
            --note-btn-bg: #6c757d;
            --note-btn-edit-bg: #ffc107;
            --note-btn-delete-bg: #dc3545;
            --modal-bg: rgba(0,0,0,0.5);
            --modal-content-bg: white;
            --modal-title-color: #4facfe;
            --modal-input-border: #dee2e6;
            --modal-input-focus-border: #4facfe;
            --modal-button-primary-bg: #4facfe;
            --modal-button-primary-hover-bg: #3d8bfe;
            --modal-button-secondary-bg: #6c757d;
            --modal-button-secondary-hover-bg: #5a6268;
            --lesson-container-bg: white;
            --lesson-header-border: #e9ecef;
            --lesson-title-color: #4facfe;
            --lesson-content-color: #333;
            --lesson-content-h4-color: #4facfe;
            --lesson-content-strong-color: #2c5aa0;
            --stage-card-bg-start: #89f7fe;
            --stage-card-bg-end: #66a6ff;
            --stage-completed-bg: #e8f5e9;
            --stage-completed-color: #2e7d32;
            --stage-completed-border: #a5d6a7;
            --discussion-bg: #f1f8e9;
            --discussion-border-left: #8bc34a;
            --discussion-h4-color: #33691e;
            --discussion-ol-color: #555;
            --badge-bg: #ffd700;
            --badge-color: #333;
            --minigame-canvas-bg: #e0f7fa;
            --quiz-option-border: #4facfe;
            --quiz-option-bg: white;
            --quiz-option-color: #4facfe;
            --quiz-option-hover-bg: #e3f2fd;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-gradient-start: #2c3e50;
            --bg-gradient-end: #34495e;
            --app-bg: #3b4d61;
            --text-color: #ecf0f1;
            --header-gradient-start: #1a2a3a;
            --header-gradient-end: #2a3a4a;
            --header-text-color: #ecf0f1;
            --nav-bg: #2c3e50;
            --nav-border: #44586b;
            --nav-item-color: #bdc3c7;
            --nav-item-active-bg: #1abc9c;
            --nav-item-active-color: white;
            --nav-item-hover-bg: #34495e;
            --nav-item-active-hover-bg: #16a085;
            --notice-bg-start: #4a4a3a;
            --notice-bg-end: #5a5a4a;
            --notice-border: #8b8b7a;
            --notice-text: #e0e0d1;
            --mission-card-bg: #44586b;
            --mission-card-border: #5a6e80;
            --mission-button-bg: #1abc9c;
            --mission-button-hover-bg: #16a085;
            --mission-button-disabled-bg: #27ae60;
            --prayer-card-bg-start: #5a4a3a;
            --prayer-card-bg-end: #6a5a4a;
            --prayer-card-title: #e0d1b1;
            --prayer-slot-bg: rgba(255,255,255,0.1);
            --prayer-slot-hover-border: #e0d1b1;
            --prayer-slot-completed-bg: #27ae60;
            --prayer-slot-completed-border: #2ecc71;
            --scripture-card-bg-start: #3a4a5a;
            --scripture-card-bg-end: #4a5a6a;
            --scripture-card-border: #3498db;
            --scripture-text: #aed6f1;
            --scripture-reference: #85c1e9;
            --chat-container-bg: #44586b;
            --chat-messages-bg: #3b4d61;
            --chat-input-border: #5a6e80;
            --chat-input-focus-border: #1abc9c;
            --chat-send-btn-bg: #1abc9c;
            --chat-send-btn-hover-bg: #16a085;
            --image-upload-btn-bg: #2980b9;
            --image-upload-btn-hover-bg: #2c3e50;
            --message-user-bubble-bg: #1abc9c;
            --message-user-bubble-color: white;
            --message-other-bubble-bg: #5a6e80;
            --message-other-bubble-color: #ecf0f1;
            --message-user-avatar-bg: #16a085;
            --message-other-avatar-bg: #7f8c8d;
            --qt-note-card-bg: #44586b;
            --qt-note-card-border: #5a6e80;
            --qt-note-title: #1abc9c;
            --qt-note-date: #bdc3c7;
            --qt-note-content: #ecf0f1;
            --like-button-color: #e74c3c;
            --like-button-hover-color: #c0392b;
            --note-btn-bg: #7f8c8d;
            --note-btn-edit-bg: #f39c12;
            --note-btn-delete-bg: #e74c3c;
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #3b4d61;
            --modal-title-color: #1abc9c;
            --modal-input-border: #5a6e80;
            --modal-input-focus-border: #1abc9c;
            --modal-button-primary-bg: #1abc9c;
            --modal-button-primary-hover-bg: #16a085;
            --modal-button-secondary-bg: #7f8c8d;
            --modal-button-secondary-hover-bg: #6c757d;
            --lesson-container-bg: #44586b;
            --lesson-header-border: #5a6e80;
            --lesson-title-color: #1abc9c;
            --lesson-content-color: #ecf0f1;
            --lesson-content-h4-color: #1abc9c;
            --lesson-content-strong-color: #3498db;
            --stage-card-bg-start: #1abc9c;
            --stage-card-bg-end: #3498db;
            --stage-completed-bg: #27ae60;
            --stage-completed-color: #d4edda;
            --stage-completed-border: #2ecc71;
            --discussion-bg: #2ecc71;
            --discussion-border-left: #27ae60;
            --discussion-h4-color: #1a532d;
            --discussion-ol-color: #ecf0f1;
            --badge-bg: #f1c40f;
            --badge-color: #333;
            --minigame-canvas-bg: #3a4a5a;
            --quiz-option-border: #1abc9c;
            --quiz-option-bg: #44586b;
            --quiz-option-color: #ecf0f1;
            --quiz-option-hover-bg: #5a6e80;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.5s ease, color 0.5s ease;
        }

        .app-container {
            max-width: 414px;
            margin: 0 auto;
            background: var(--app-bg);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: var(--header-text-color);
            padding: 20px;
            text-align: center;
            position: relative;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .character-avatar {
            width: 80px;
            height: 80px;
            background: var(--app-bg);
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.3s ease, background 0.5s ease;
        }

        .character-avatar:hover {
            transform: scale(1.05);
        }

        .user-name {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .user-name:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 14px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            font-size: 18px;
        }

        .navigation {
            display: flex;
            background: var(--nav-bg);
            border-top: 1px solid var(--nav-border);
            flex-shrink: 0;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .nav-item {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: var(--nav-item-color);
            transition: all 0.3s ease;
        }

        .nav-item.active {
            background: var(--nav-item-active-bg);
            color: var(--nav-item-active-color);
        }

        .nav-item:hover {
            background: var(--nav-item-hover-bg);
        }

        .nav-item.active:hover {
            background: var(--nav-item-active-hover-bg);
        }

        .content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .notice-card {
            background: linear-gradient(135deg, var(--notice-bg-start) 0%, var(--notice-bg-end) 100%);
            border: 1px solid var(--notice-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notice-title {
            font-weight: bold;
            color: var(--notice-text);
        }

        .notice-date {
            font-size: 12px;
            color: var(--notice-text);
            opacity: 0.8;
        }

        .notice-content {
            color: var(--notice-text);
            line-height: 1.5;
        }

        .mission-card {
            background: var(--mission-card-bg);
            border: 1px solid var(--mission-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.5s ease, border-color 0.5s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mission-title {
            font-weight: bold;
            color: var(--text-color);
        }

        .mission-reward {
            background: #ffd700;
            color: #333;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .mission-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .mission-button {
            background: var(--mission-button-bg);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .mission-button:hover {
            background: var(--mission-button-hover-bg);
            transform: scale(1.05);
        }

        .mission-button:disabled {
            background: var(--mission-button-disabled-bg);
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none;
        }

        .floating-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 25px;
            font-weight: bold;
            animation: slideInDown 0.3s ease;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .prayer-time-card {
            background: linear-gradient(135deg, var(--prayer-card-bg-start) 0%, var(--prayer-card-bg-end) 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            transition: background 0.5s ease;
        }

        .prayer-time-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--prayer-card-title);
            margin-bottom: 15px;
        }

        .prayer-time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .prayer-time-slot {
            background: var(--prayer-slot-bg);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease, background 0.5s ease;
        }

        .prayer-time-slot:hover {
            border-color: var(--prayer-slot-hover-border);
            transform: scale(1.05);
        }

        .prayer-time-slot.completed {
            background: var(--prayer-slot-completed-bg);
            border-color: var(--prayer-slot-completed-border);
        }

        .scripture-card {
            background: linear-gradient(135deg, var(--scripture-card-bg-start) 0%, var(--scripture-card-bg-end) 100%);
            border: 1px solid var(--scripture-card-border);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scripture-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--scripture-text);
            margin-bottom: 10px;
            font-style: italic;
        }

        .scripture-reference {
            font-weight: bold;
            color: var(--scripture-reference);
            font-size: 14px;
        }

        .chat-container {
            background: var(--chat-container-bg);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            height: 350px;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--chat-messages-bg);
            border-radius: 10px;
            transition: background 0.5s ease;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.other {
            align-items: flex-start;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            display: inline-block;
        }
        
        .message.user .message-bubble {
            background: var(--message-user-bubble-bg);
            color: var(--message-user-bubble-color);
        }

        .message.other .message-bubble {
            background: var(--message-other-bubble-bg);
            color: var(--message-other-bubble-color);
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
            padding: 0 5px;
        }

        .message-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            margin-right: 8px;
        }
        
        .message.user .message-avatar { background: var(--message-user-avatar-bg); }
        .message.other .message-avatar { background: var(--message-other-avatar-bg); }

        .message-sender {
            font-weight: bold;
            color: var(--text-color);
        }

        .message-time {
            margin-left: 8px;
            opacity: 0.7;
            font-size: 10px;
            color: var(--text-color);
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--chat-input-border);
            border-radius: 20px;
            font-size: 14px;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--chat-messages-bg); /* Use chat messages bg for input */
            color: var(--text-color);
        }

        .chat-input:focus {
            border-color: var(--chat-input-focus-border);
            outline: none;
        }

        .chat-send-btn {
            background: var(--chat-send-btn-bg);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .chat-send-btn:hover {
            background: var(--chat-send-btn-hover-bg);
        }

        .image-upload-btn {
            background: var(--image-upload-btn-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .image-upload-btn:hover {
            background: var(--image-upload-btn-hover-bg);
        }

        .hidden-file-input {
            display: none;
        }

        .qt-note-card {
            background: var(--qt-note-card-bg);
            border: 1px solid var(--qt-note-card-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .qt-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--nav-border);
        }

        .qt-note-title {
            font-weight: bold;
            color: var(--qt-note-title);
        }

        .qt-note-date {
            font-size: 12px;
            color: var(--qt-note-date);
        }

        .qt-note-content {
            margin-bottom: 10px;
            line-height: 1.6;
            color: var(--qt-note-content);
        }

        .qt-note-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .like-button {
            background: none;
            border: none;
            color: var(--like-button-color);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-button:hover {
            color: var(--like-button-hover-color);
        }

        .note-buttons {
            display: flex;
            gap: 5px;
        }

        .note-btn {
            background: var(--note-btn-bg);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .note-btn.edit { background: var(--note-btn-edit-bg); }
        .note-btn.delete { background: var(--note-btn-delete-bg); }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--modal-content-bg);
            padding: 30px;
            border-radius: 15px;
            max-width: 380px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
            transition: background 0.5s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--modal-title-color);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--app-bg);
            color: var(--text-color);
        }

        .modal-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s ease, background 0.5s ease, color 0.5s ease;
            background: var(--app-bg);
            color: var(--text-color);
        }

        .modal-input:focus, .modal-textarea:focus {
            border-color: var(--modal-input-focus-border);
            outline: none;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-button.primary {
            background: var(--modal-button-primary-bg);
            color: white;
        }

        .modal-button.primary:hover {
            background: var(--modal-button-primary-hover-bg);
        }

        .modal-button.secondary {
            background: var(--modal-button-secondary-bg);
            color: white;
        }

        .modal-button.secondary:hover {
            background: var(--modal-button-secondary-hover-bg);
        }

        .lesson-container {
            background: var(--lesson-container-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            animation: slideInUp 0.4s ease;
            transition: background 0.5s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--lesson-header-border);
        }

        .lesson-icon {
            font-size: 30px;
            margin-right: 15px;
        }

        .lesson-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--lesson-title-color);
        }

        .lesson-content {
            line-height: 1.7;
            color: var(--lesson-content-color);
            font-size: 15px;
        }

        .lesson-content h4 {
            color: var(--lesson-content-h4-color);
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .lesson-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .lesson-content li {
            margin-bottom: 8px;
        }

        .lesson-content p {
            margin-bottom: 12px;
        }

        .lesson-content strong {
            color: var(--lesson-content-strong-color);
        }
        
        .stage-card {
            background: linear-gradient(135deg, var(--stage-card-bg-start) 0%, var(--stage-card-bg-end) 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stage-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .avatar-option {
            font-size: 30px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        .avatar-option:hover {
            background: var(--nav-item-hover-bg);
        }
        
        .discussion-container {
            background: var(--discussion-bg);
            border-left: 5px solid var(--discussion-border-left);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }
        .discussion-container h4 {
            color: var(--discussion-h4-color);
            margin-bottom: 15px;
        }
        .discussion-container ol {
            padding-left: 20px;
            line-height: 1.8;
            color: var(--discussion-ol-color);
        }
        
        #badge-container span {
            display: inline-block;
            background: var(--badge-bg);
            color: var(--badge-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin: 3px;
        }

        #minigame-canvas {
            border-radius: 10px;
            background: var(--minigame-canvas-bg);
            cursor: pointer;
        }

        #minigame-content .quiz-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid var(--quiz-option-border);
            background: var(--quiz-option-bg);
            color: var(--quiz-option-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #minigame-content .quiz-option:hover {
            background: var(--quiz-option-hover-bg);
        }
        
        .stage-completed-notice {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            background: var(--stage-completed-bg);
            color: var(--stage-completed-color);
            font-weight: bold;
            border-radius: 10px;
            border: 2px dashed var(--stage-completed-border);
            transition: background 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        /* Theme Toggle Button */
        .theme-toggle-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--nav-border);
            text-align: center;
        }
        .theme-toggle-button {
            background: var(--modal-button-secondary-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .theme-toggle-button:hover {
            background: var(--modal-button-secondary-hover-bg);
        }

        /* QT Comments */
        .comments-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--nav-border);
            text-align: left;
        }
        .comments-section h5 {
            color: var(--text-color);
            margin-bottom: 10px;
        }
        .comment-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .comment-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }
        .comment-password-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--chat-input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--chat-messages-bg);
            color: var(--text-color);
        }
        .comment-send-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            align-self: flex-end;
        }
        .comment-send-btn:hover {
            background: #138496;
        }
        .comment-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--nav-border);
            border-radius: 8px;
            padding: 10px;
            background: var(--chat-messages-bg);
        }
        .comment-item {
            background: var(--mission-card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid var(--mission-card-border);
        }
        .comment-item:last-child {
            margin-bottom: 0;
        }
        .comment-header {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--text-color);
        }
        .comment-author {
            font-weight: bold;
            margin-right: 5px;
        }
        .comment-time {
            opacity: 0.7;
        }
        .comment-content {
            font-size: 14px;
            color: var(--text-color);
            word-wrap: break-word;
        }
        .comment-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            align-self: flex-end;
        }
        .comment-action-btn {
            background: var(--note-btn-bg);
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
        }
        .comment-action-btn.edit { background: var(--note-btn-edit-bg); }
        .comment-action-btn.delete { background: var(--note-btn-delete-bg); }

        /* Icebreaker Modal Specific Styles */
        #icebreakerModal .modal-content {
            padding: 25px;
        }
        #icebreakerModal .modal-title {
            font-size: 20px;
            margin-bottom: 15px;
        }
        #icebreakerModal .icebreaker-prompt {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: var(--text-color);
        }
        #icebreakerModal .icebreaker-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid var(--modal-input-border);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            background: var(--app-bg);
            color: var(--text-color);
        }
    </style>
</head>
<body class="light-mode">
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="character-avatar" id="headerAvatar" onclick="showAvatarModal()">🌟</div>
            <div class="user-name" onclick="showNameModal()">
                <span id="userName">푸른이</span>
                <span>✏️</span>
            </div>
            <div class="user-stats">
                <div class="stat">
                    <div class="stat-value" id="userLevel">1</div>
                    <div>레벨</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userExp">0</div>
                    <div>경험치</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userStreak">1</div>
                    <div>연속일</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content">
                <!-- Notice Board -->
                <div id="notice-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--text-color);">📢 공지사항</h3>
                        <button style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showNoticeModal()">+ 공지 작성</button>
                    </div>
                    <div id="notices-container">
                        <!-- 공지사항이 여기에 표시됩니다 -->
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: var(--text-color);">📋 오늘의 미션</h3>
                
                <div class="prayer-time-card">
                    <div class="prayer-time-title">⏰ 10-10-10 기도법</div>
                    <div class="prayer-time-grid">
                        <div class="prayer-time-slot" onclick="completePrayerTime('morning', this)">
                            <div>🌅 아침</div>
                            <div style="font-size: 12px;">10분</div>
                        </div>
                        <div class="prayer-time-slot" onclick="completePrayerTime('noon', this)">
                            <div>☀️ 점심</div>
                            <div style="font-size: 12px;">10분</div>
                        </div>
                        <div class="prayer-time-slot" onclick="completePrayerTime('evening', this)">
                            <div>🌙 저녁</div>
                            <div style="font-size: 12px;">10분</div>
                        </div>
                    </div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">📖 성경 말씀 읽기</div>
                        <div class="mission-reward">+70 EXP</div>
                    </div>
                    <div class="mission-description">푸른바람의 냉장고에서 오늘의 영양분을 섭취하세요</div>
                    <button class="mission-button" id="mission-btn-scripture" onclick="showScripture()">말씀 보기</button>
                    <div id="scripture-container"></div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">🎯 예배 참여하기</div>
                        <div class="mission-reward">+100 EXP</div>
                    </div>
                    <div class="mission-description">하나님을 만나는 공식 채널에서 양방향 소통하세요</div>
                    <button class="mission-button" id="mission-btn-worship" onclick="completeMission(this, '예배 참여 완료! 용특새 메시지를 받았습니다! 🙏', 100, '예배 참석')">참여 완료</button>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">🧠 신앙 퀴즈 풀기</div>
                        <div class="mission-reward">+50 EXP</div>
                    </div>
                    <div class="mission-description">신앙 지식을 테스트하고 경험치를 얻으세요!</div>
                    <button class="mission-button" id="mission-btn-quiz" onclick="showMinigameModal('quiz')">퀴즈 시작</button>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">👥 길드원과 대화하기</div>
                        <div class="mission-reward">+30 EXP</div>
                    </div>
                    <div class="mission-description">병아리 공동체에서 길드 버프를 받아보세요</div>
                    <button class="mission-button" id="mission-btn-chat" onclick="openChat()">채팅 참여</button>
                    <div id="chat-container"></div>
                </div>
            </div>

            <!-- Stages Tab -->
            <div id="stages-tab" class="tab-content hidden">
                    <div id="stage-list">
                        <h3 style="margin-bottom: 20px; color: var(--text-color);">🎯 학습 스테이지</h3>
                        <p style="text-align: center; color: var(--text-color); margin-bottom: 20px;">
                            교재 내용 기반 학습 단계입니다
                        </p>
                        
                        <div class="stage-card" onclick="enterStageContent(1)">
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">1. 패치 시스템</div>
                            <div style="font-size: 14px; opacity: 0.9;">거부할 수 없는 특권</div>
                            <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">예배하기 • 성경읽기 • 기도하기</div>
                        </div>

                        <div class="stage-card" onclick="enterStageContent(2)">
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">2. 길드 시스템</div>
                            <div style="font-size: 14px; opacity: 0.9;">우리, 같이 해볼까요</div>
                            <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">세례받기 • 공동체 속하기 • 성령 따르기</div>
                        </div>

                        <div class="stage-card" onclick="enterStageContent(3)">
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">3. 실전 시스템</div>
                            <div style="font-size: 14px; opacity: 0.9;">인생은 장난이 아니니까</div>
                            <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">이론에서 현실로 • 매일 그분과 • 일생을 함께</div>
                        </div>
                    </div>
                    
                    <div id="stage-detail" class="hidden">
                        <div id="stage-content"></div>
                        <button style="background: var(--modal-button-secondary-bg); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; width: 100%;" onclick="backToStages()">← 스테이지 목록으로</button>
                    </div>
            </div>

            <!-- Guild Tab -->
            <div id="guild-tab" class="tab-content hidden">
                <div style="background: linear-gradient(135deg, var(--scripture-card-bg-start) 0%, var(--scripture-card-bg-end) 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; position: relative;">
                    <h3 style="color: var(--text-color);">👥 푸른바람단</h3>
                    <strong style="color: var(--text-color);">길드 레벨: <span id="guildLevel">1</span></strong><br>
                    <small style="color: var(--text-color);">다음 레벨까지 <span id="guildExp">0</span>/500 EXP</small>
                </div>

                <!-- QT Note Section -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: var(--text-color);">📔 QT 노트</h4>
                        <button style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showQTNoteModal()">+ QT 노트 작성</button>
                    </div>
                    <div id="qt-notes-container">
                        <!-- QT 노트들이 여기에 표시됩니다 -->
                    </div>
                </div>

                <h4 style="margin-bottom: 15px; color: var(--text-color);">🟢 현재 접속 중인 길드원</h4>
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--chat-messages-bg); border-radius: 10px;">
                        <div id="guildUserAvatar" style="width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--modal-button-primary-bg); background: var(--modal-button-primary-bg); color: white;">🌟</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 2px; color: var(--text-color);"><span id="guildUserName">푸른이</span> (나)</div>
                            <div style="font-size: 12px; color: var(--text-color);">레벨 <span id="guildUserLevel">1</span> <span id="guildUserJob">푸른이</span> • <span id="guildUserStreak">1</span>일 연속 접속</div>
                        </div>
                    </div>
                    <div style="text-align: center; color: var(--text-color); padding: 20px;">
                        <p>다른 길드원들이 접속하면 여기에 표시됩니다</p>
                        <p>친구들을 초대해보세요! 🎉</p>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 10px; font-weight: bold;" onclick="showGuildChat()">
                        💬 길드 채팅 참여하기
                    </button>
                    <div id="guild-chat-container" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-content hidden">
                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 50px; cursor: pointer; border: 3px solid var(--modal-button-primary-bg); background: var(--app-bg); color: var(--text-color);" id="profileAvatar" onclick="showAvatarModal()">🌟</div>
                        <div>
                            <h4 id="profileUserName" style="margin-bottom: 5px; color: var(--text-color);">푸른이</h4>
                            <p style="color: var(--text-color); font-size: 14px;">레벨 <span id="profileLevel">1</span> <span id="profileJob">푸른이</span></p>
                            <p style="color: var(--text-color); font-size: 14px;">신앙 여정 <span id="profileStreak">1</span>일차</p>
                        </div>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">🏆 업적 및 뱃지</h4>
                    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
                        <div id="badge-container" style="margin-bottom: 10px; min-height: 25px;">
                            <!-- Badges will be dynamically inserted here -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--nav-border);">
                            <span style="color: var(--text-color);">완료한 미션</span>
                            <strong id="completedMissionsCount" style="color: var(--text-color);">0</strong><span style="color: var(--text-color);">개</span>
                        </div>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">🎨 테마 설정</h4>
                    <div class="theme-toggle-container">
                        <button class="theme-toggle-button" onclick="toggleTheme()">테마 전환</button>
                    </div>
                </div>

                <div style="background: var(--mission-card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-color);">⚙️ 관리자 설정</h4>
                    <div style="background: var(--chat-messages-bg); padding: 15px; border-radius: 10px;">
                        <button style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;" onclick="showResetModal()">
                            🔄 모든 데이터 초기화
                        </button>
                        <div style="font-size: 12px; color: var(--text-color); margin-top: 8px; text-align: center;">
                            모든 진행 상황이 리셋됩니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-item active" onclick="showTab('home', this)">
                🏠<br>홈
            </button>
            <button class="nav-item" onclick="showTab('stages', this)">
                🎮<br>스테이지
            </button>
            <button class="nav-item" onclick="showTab('guild', this)">
                👥<br>길드
            </button>
            <button class="nav-item" onclick="showTab('profile', this)">
                👤<br>프로필
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">닉네임 변경</div>
            <input type="text" id="nameInput" class="modal-input" placeholder="새로운 닉네임을 입력하세요" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNameModal()">취소</button>
                <button class="modal-button primary" onclick="changeName()">변경</button>
            </div>
        </div>
    </div>

    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">프로필 사진 변경</div>
            <div class="avatar-grid">
                <div class="avatar-option" onclick="selectAvatar('🌟')">🌟</div>
                <div class="avatar-option" onclick="selectAvatar('😊')">😊</div>
                <div class="avatar-option" onclick="selectAvatar('🙏')">🙏</div>
                <div class="avatar-option" onclick="selectAvatar('✨')">✨</div>
                <div class="avatar-option" onclick="selectAvatar('🕊️')">🕊️</div>
                <div class="avatar-option" onclick="selectAvatar('📖')">📖</div>
                <div class="avatar-option" onclick="selectAvatar('❤️')">❤️</div>
                <div class="avatar-option" onclick="selectAvatar('🌅')">🌅</div>
                <div class="avatar-option" onclick="selectAvatar('⭐')">⭐</div>
                <div class="avatar-option" onclick="selectAvatar('🎵')">🎵</div>
                <div class="avatar-option" onclick="selectAvatar('🌸')">🌸</div>
                <div class="avatar-option" onclick="selectAvatar('🌈')">🌈</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeAvatarModal()">취소</button>
            </div>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">관리자 인증</div>
            <input type="password" id="adminPassword" class="modal-input" placeholder="관리자 비밀번호를 입력하세요" maxlength="4">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeResetModal()">취소</button>
                <button class="modal-button primary" onclick="confirmReset()">확인</button>
            </div>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">공지사항 작성</div>
            <input type="password" id="noticePassword" class="modal-input" placeholder="관리자 비밀번호" maxlength="4">
            <input type="text" id="noticeTitle" class="modal-input" placeholder="공지사항 제목">
            <textarea id="noticeContent" class="modal-textarea" placeholder="공지사항 내용을 입력하세요"></textarea>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNoticeModal()">취소</button>
                <button class="modal-button primary" onclick="createNotice()">공지 등록</button>
            </div>
        </div>
    </div>

    <!-- QT Note Modal -->
    <div id="qtNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="qtModalTitle">QT 노트 작성</div>
            <input type="text" id="qtNoteTitle" class="modal-input" placeholder="QT 노트 제목">
            <textarea id="qtNoteContent" class="modal-textarea" placeholder="오늘의 QT 내용을 기록해보세요..."></textarea>
            <input type="password" id="qtNotePassword" class="modal-input" placeholder="비밀번호 (수정/삭제용)" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTNoteModal()">취소</button>
                <button class="modal-button primary" id="qtSubmitBtn" onclick="createQTNote()">작성 완료</button>
            </div>
        </div>
    </div>

    <!-- QT Note Password Modal -->
    <div id="qtPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">비밀번호 확인</div>
            <p id="passwordModalText">비밀번호를 입력하세요:</p>
            <input type="password" id="qtActionPassword" class="modal-input" placeholder="비밀번호" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTPasswordModal()">취소</button>
                <button class="modal-button primary" id="qtConfirmActionButton" onclick="confirmQTAction()">확인</button>
            </div>
        </div>
    </div>

    <!-- Minigame Modal -->
    <div id="minigameModal" class="modal">
        <div class="modal-content" id="minigame-content">
            <!-- Minigame content will be injected here -->
        </div>
    </div>

    <!-- Icebreaker Modal -->
    <div id="icebreakerModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">아이스브레이크</div>
            <p class="icebreaker-prompt" id="icebreakerPrompt"></p>
            <textarea id="icebreakerInput" class="icebreaker-input" placeholder="당신의 생각을 자유롭게 적어보세요..."></textarea>
            <div class="modal-buttons">
                <button class="modal-button primary" id="icebreakerSubmitBtn" onclick="completeIcebreaker()">제출하고 강의 보기</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Global State Variables ---
        let userLevel, userExp, userStreak, completedMissions, userName, userAvatar, userJob, userBadges, completedStages;
        let guildLevel, guildExp;
        let currentStage = null;
        let chatMessages = [];
        let prayerTimes = {};
        let notices = [];
        let qtNotes = [];
        let editingQTNote = null;
        let pendingQTAction = null; // { type: 'qtNote' | 'comment', action: 'edit' | 'delete', noteId: ..., commentId: ... (if comment) }
        let activeGame = { id: null, interval: null, stage: 0 };
        let currentTheme = 'light-mode'; // Default theme
        let quizCompletedToday = false; // To track daily quiz completion
        let completedIcebreakers = []; // Array of stage numbers for which icebreaker is completed

        // 메모리 기반 저장소 (localStorage 대체)
        let memoryStorage = {};
        
        // localStorage 체크 및 대체 함수
        function isLocalStorageAvailable() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        function safeSetItem(key, value) {
            if (isLocalStorageAvailable()) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.warn('localStorage setItem 실패, 메모리 저장소 사용:', error);
                }
            }
            // localStorage 사용 불가 시 메모리에 저장
            memoryStorage[key] = value;
            return false;
        }

        function safeGetItem(key) {
            if (isLocalStorageAvailable()) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('localStorage getItem 실패, 메모리 저장소 사용:', error);
                }
            }
            // localStorage 사용 불가 시 메모리에서 가져오기
            return memoryStorage[key] || null;
        }

        function safeRemoveItem(key) {
            if (isLocalStorageAvailable()) {
                try {
                    localStorage.removeItem(key);
                    return;
                } catch (error) {
                    console.warn('localStorage removeItem 실패, 메모리 저장소 사용:', error);
                }
            }
            // localStorage 사용 불가 시 메모리에서 삭제
            delete memoryStorage[key];
        }

        // --- Data Definitions ---

        const scriptures = [
            { text: "내 안에 머물러 있어라. 그리하면 나도 너희 안에 머물러 있겠다. 가지가 포도나무에 붙어 있지 아니하면 스스로 열매를 맺을 수 없는 것과 같이, 너희도 내 안에 머물러 있지 아니하면 열매를 맺을 수 없다.", reference: "요한복음 15:4" },
            { text: "나는 참 포도나무요, 내 아버지는 농부이시다.", reference: "요한복음 15:1" },
            { text: "너희가 나의 말에 머물러 있으면, 너희는 참으로 나의 제자들이다. 그리고 너희는 진리를 얻게 될 것이며, 진리가 너희를 자유롭게 할 것이다.", reference: "요한복음 8:31-32" },
            { text: "그러므로 너희는 가서, 모든 민족을 제자로 삼아서, 아버지와 아들과 성령의 이름으로 세례를 주고, 내가 너희에게 명령한 모든 것을 그들에게 가르쳐 지키게 하여라.", reference: "마태복음 28:19-20" },
            { text: "사람은 마음으로 믿어서 의에 이르고, 입으로 고백해서 구원에 이르게 됩니다.", reference: "로마서 10:10" }
        ];

        const quizQuestions = [
            {
                question: "성경에서 예수님을 '참 포도나무'로, 하나님 아버지를 '농부'로 비유하며, 우리가 예수님 안에 '머물러' 있어야 열매를 맺을 수 있다고 말씀하신 성경 구절은 어디인가요?",
                options: ["마태복음 5:1-2", "요한복음 15:1-5", "로마서 8:28", "빌립보서 4:13"],
                answer: "요한복음 15:1-5"
            },
            {
                question: "예수님께서 우리에게 새로운 생명을 주시고 '더 넘치게' 누리게 하시려고 자기 목숨을 버리겠다고 말씀하신 성경 구절은 어디인가요?",
                options: ["창세기 1:1", "시편 23:1", "요한복음 10:10-11", "고린도전서 13:4-7"],
                answer: "요한복음 10:10-11"
            },
            {
                question: "'그리스도 안에서 당신은 용납되었습니다', '그리스도 안에서 당신은 특별한 존재입니다', '그리스도 안에서 당신은 새로운 공동체에 속했습니다' 이 세 가지를 줄여서 무엇이라고 부르나요?",
                options: ["용기백배", "용특새", "새로운 시작", "믿음의 3단계"],
                answer: "용특새"
            },
            {
                question: "성경은 푸른바람의 나라 에너지원이 가득한 무엇에 비유되나요?",
                options: ["보물상자", "냉장고", "도서관", "놀이터"],
                answer: "냉장고"
            },
            {
                question: "예수님께서 부활하신 후 제자들을 찾아가 차려 주신 아침 식사 장소는 어디였나요?",
                options: ["갈릴리 호숫가", "예루살렘 성전", "감람산", "베다니"],
                answer: "갈릴리 호숫가"
            }
        ];

        const stageContents = {
            1: {
                title: "1강: 패치 시스템 - 거부할 수 없는 특권",
                item: "용특새 메시지",
                icebreaker: {
                    prompt: "1강을 시작하기 전에, '패치'라는 단어를 들으면 어떤 생각이 드나요? 신앙생활에서 '패치'가 필요하다고 느낀 적이 있나요?"
                },
                lessons: [
                    {
                        icon: "🛡️",
                        title: "예배하기 - 하나님을 만나는 공식 채널",
                        content: `<h4>📌 예배는 양방향 소통</h4><p>예수님은 우리에게 새로운 생명을 주실 뿐만 아니라, "더 넘치게" 누리며 살게 하기 위해 자기 목숨을 버리겠다고 말씀하셨습니다.</p><h4>💡 예배의 의미</h4><ul><li>하나님이 우리 일상에 얼마나 관심이 많은지 알 수 있는 시간</li><li>우리를 얼마나 소중히 여기는지 깨닫는 시간</li><li>하나님의 계획에서 우리가 얼마나 중요한 사람인지 발견하는 시간</li></ul>
                        
                        <h4>⚔️ 거짓 위협 vs 진짜 목소리 (용특새)</h4>
                        <p><strong>거짓 위협:</strong> "너는 왜 그거밖에 안 되냐?", "너 따위는 여기서 실패하면 바로 끝이야"</p>
                        <p><strong>진짜 목소리 (용특새):</strong></p>
                        <ul>
                            <li>그리스도 안에서 당신은 <strong>용납</strong>되었습니다</li>
                            <li>그리스도 안에서 당신은 <strong>특별한</strong> 존재입니다</li>
                            <li>그리스도 안에서 당신은 <strong>새로운</strong> 공동체에 속했습니다</li>
                        </ul>
                        <p>예배를 드리면서, 깨진 세상이 주는 거짓 위협과는 전혀 다른, 당신을 향한 진짜 목소리에 귀를 기울이세요. 당신을 향해 불어오는 푸른바람의 메시지는 어떤 공격에도 끄떡없는 체력을 주고 쉴드가 됩니다.</p>`
                    },
                    {
                        icon: "⚡",
                        title: "성경읽기 - 푸른바람의 냉장고",
                        content: `<h4>🍯 나의 패치, 나의 특권</h4><p>성경은 푸른바람의 나라 에너지원이 가득한 냉장고입니다. 아무리 냉장고에 먹을 것이 가득해도 꺼내 먹지 않으면 아무 소용이 없습니다.</p><h4>🔍 성경을 꺼내 먹는 꿀팁</h4><ul><li>하나님은 어떤 분일까? (하나님의 성품과 말씀과 하신 일)</li><li>예수님은 어떤 분일까? (예수님의 가르침과 삶과 행동)</li><li>선배들은 어떻게 살았을까? (그들의 믿음과 기도, 실수와 회복과 교훈)</li><li>그러면 나는 어떻게 살아야 할까? (내 현실에 적용할 수 있는 성경 원리)</li></ul>`
                    },
                    {
                        icon: "🔌",
                        title: "기도하기 - 신에게 빨대 꽂기",
                        content: `<h4>🌳 포도나무와 가지의 관계</h4><p>예수님은 우리를 "가지"라고 부르시며, 자신에게 딱 붙어 있으라고 하십니다. 나뭇가지의 최고 특권은 농부(하나님)가 땀 흘려 일하고 나무(예수님)가 열심히 공급한 양분을 그냥 받아 누리는 것입니다.</p><h4>🕐 10-10-10 기도법</h4><p>아침, 점심, 저녁 10분씩 예수님과 대화하는 시간을 가져보세요. 부담 없이, 그저 말을 거는 것부터 시작하면 됩니다.</p>`
                    }
                ],
                discussionQuestions: [
                    "예배, 성경 읽기, 기도 중에서 요즘 나에게 가장 가깝게 느껴지는 것과 가장 멀게 느껴지는 것은 무엇인가요? 그 이유는 무엇일까요?",
                    "나를 향한 하나님의 '진짜 목소리'(용특새: 용납, 특별함, 새로운 공동체)를 의심하게 만드는 '거짓 위협'에는 어떤 것들이 있었나요?",
                    "오늘 배운 '10-10-10 기도법'을 내일부터 당장 실천해본다면, 어떤 점이 기대되고 어떤 점이 걱정되나요?"
                ]
            },
            2: {
                title: "2강: 길드 시스템 - 우리, 같이 해볼까요",
                item: "길드 버프",
                icebreaker: {
                    prompt: "2강을 시작하기 전에, '길드'라는 단어를 들으면 어떤 생각이 드나요? 신앙 공동체가 '길드'처럼 느껴진 적이 있나요?"
                },
                lessons: [
                    {
                        icon: "🎯",
                        title: "세례받기 - 길드 가입하기",
                        content: `<h4>🏰 길드 가입의 의미</h4><p>하나님 나라 사람이 되는 것과 그 나라 방식대로 사는 것 사이에 '세례'가 있습니다. 기독교는 자신만의 전인격적 고백이 필요한 종교이며, 절대 남에게 묻어갈 수 없습니다.</p><h4>💍 비밀 연애에서 공식 발표로</h4><p>세례를 좀 더 설레는 버전으로 설명하면, 비밀 연애를 하는 연인이 사귄다고 공식적으로 밝히는 것과 같습니다. 이 사람이라고 확신하기 때문입니다.</p>`
                    },
                    {
                        icon: "👥",
                        title: "공동체 속하기 - 병아리 공동체",
                        content: `<h4>🐣 병아리가 살아남는 법</h4><p>학교 앞에서 산 병아리가 살아남는 비결은 '공동체'였습니다. 공동체를 통해 무엇을 먹고, 어떻게 살아야 하는지 배우며 건강해집니다.</p><h4>🎮 길드 버프 받는 방법</h4><p>공동체 안에서 말씀을 듣고 배우는 버프, 다른 사람의 삶을 보고 배우는 버프를 통해 함께 성장할 수 있습니다.</p>`
                    },
                    {
                        icon: "🕊️",
                        title: "성령 따르기 - 우리 힘만으로는 어려워",
                        content: `<h4>🤝 늘 함께하는 참 좋은 스승</h4><p>우리 힘만으로는 어렵습니다. 성령님은 우리와 인격적인 관계를 원하시며, 우리가 자발적으로 하나님의 뜻을 선택하도록 도우시는 분입니다.</p><h4>📖➕🕊️ 성경과 성령의 콤보</h4><p>성경과 성령님은 따로 떼어놓고 생각할 수 없습니다. 성령님은 성경 말씀을 깨닫고 순종하도록 도우십니다.</p>`
                    }
                ],
                discussionQuestions: [
                    "나에게 신앙 공동체(길드)는 어떤 의미인가요? 공동체를 통해 '길드 버프'를 받았던 경험이 있다면 나눠주세요.",
                    "세례를 '비밀 연애에서 공식 발표로' 비유한 것처럼, 나의 신앙을 다른 사람들에게 공개적으로 표현하는 것에 대해 어떻게 생각하나요?",
                    "성령님을 '늘 함께하는 참 좋은 스승'으로 인격적으로 신뢰하고 따르기 위해, 구체적으로 어떤 노력을 할 수 있을까요?"
                ]
            },
            3: {
                title: "3강: 실전 시스템 - 인생은 장난이 아니니까",
                item: "성령의 열매",
                icebreaker: {
                    prompt: "3강을 시작하기 전에, '실전'이라는 단어를 들으면 어떤 생각이 드나요? 나의 신앙이 '실전'에 강하다고 생각하나요?"
                },
                lessons: [
                    {
                        icon: "📖→🌍",
                        title: "이론에서 현실로 - 성경은 그림의 떡이 아니다",
                        content: `<h4>📚 무책임한 동화에서 책임감 쩌는 현실로</h4><p>신앙은 '오래오래 행복하게 살았답니다'에서 끝나지 않습니다. 그 후의 삶을 하나님 나라 방식으로 살아내는 것이 진짜 이야기입니다.</p><h4>🎯 끝날 때까지 끝난 게 아니다</h4><p>일상에서 성경 원리를 적용하고, 실패를 두려워하지 말고, 계속해서 하나님을 알아가며 신뢰를 쌓아가는 것이 중요합니다.</p>`
                    },
                    {
                        icon: "⏰",
                        title: "매일 그분과 - 루틴! 재밌고 꾸준하게",
                        content: `<h4>📅 일대일 만남이라니</h4><p>하나님과의 개인적인 만남 시간, 즉 큐티(QT, Quiet Time)를 꾸준히 가지는 것이 중요합니다. 재밌고 꾸준하게 자신만의 루틴을 만들어보세요.</p><h4>📖 큐티, 시작해볼까요</h4><p>성경 읽기 → 하나님 알기 → 메시지 찾기 → 적용하기 → 기도하기 순서로 큐티를 진행해볼 수 있습니다.</p>`
                    },
                    {
                        icon: "🤗",
                        title: "일생을 함께 - 어, 살아서 움직이네",
                        content: `<h4>✨ 찬란했던 그 순간과 어둠의 시간</h4><p>인생의 좋은 순간과 힘든 순간 모두 하나님과 함께하며 신앙의 근육을 키워나가야 합니다.</p><h4>🌈 거룩한 상상</h4><p>하나님 나라의 완성된 모습을 소망하며 오늘의 어려움을 견디고, 이 땅에서 하나님 나라를 맛보며 살아갈 수 있습니다.</p>`
                    }
                ],
                discussionQuestions: [
                    "성경 말씀을 '그림의 떡'이 아닌, 내 삶의 '책임감 쩌는 현실'로 만들기 위해 어떤 노력을 하고 있나요? 또는 어떤 점이 가장 어렵나요?",
                    "매일 하나님과 만나는 '큐티' 시간을 꾸준히 갖기 위해 나에게 가장 필요한 것은 무엇일까요? (예: 시간, 장소, 의지, 좋은 교재 등)",
                    "최근 나의 삶에서 경험한 '찬란했던 순간'과 '어둠의 시간'은 각각 무엇이었나요? 그 시간들을 통해 하나님에 대해 무엇을 배우게 되었나요?"
                ]
            }
        };

        // --- Job System ---
        function getUserJobTitle(level) {
            if (level >= 90) return '마스터';
            if (level >= 60) return '청대장';
            if (level >= 30) return '청기사';
            return '푸른이';
        }

        // --- Core App Functions ---

        function showTab(tabName, navElement) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            navElement.classList.add('active');

            if (tabName === 'stages') backToStages();
            if (tabName === 'guild') updateQTNotes();
            if (tabName === 'home') updateNotices();
        }

        function enterStageContent(stageNumber) {
            currentStage = stageNumber;
            const stageData = stageContents[stageNumber];
            
            if (!stageData) {
                showNotification('스테이지 데이터를 찾을 수 없습니다.');
                return;
            }

            // Check if icebreaker needs to be shown
            if (stageData.icebreaker && !completedIcebreakers.includes(stageNumber)) {
                showIcebreakerModal(stageNumber, stageData.icebreaker.prompt);
            } else {
                // If no icebreaker or already completed, proceed to show stage details
                _showStageContentDetails(stageNumber);
            }
        }

        // Internal function to show stage content details after icebreaker
        function _showStageContentDetails(stageNumber) {
            const stageData = stageContents[stageNumber];
            
            document.getElementById('stage-list').classList.add('hidden');
            document.getElementById('stage-detail').classList.remove('hidden');
            
            let contentHtml = stageData.lessons.map(lesson => `
                <div class="lesson-container">
                    <div class="lesson-header">
                        <div class="lesson-icon">${lesson.icon}</div>
                        <div class="lesson-title">${lesson.title}</div>
                    </div>
                    <div class="lesson-content">${lesson.content}</div>
                </div>
            `).join('');

            if (stageData.discussionQuestions) {
                contentHtml += `
                    <div class="discussion-container">
                        <h4>🤔 함께 나눌 질문</h4>
                        <ol>
                            ${stageData.discussionQuestions.map(q => `<li>${q}</li>`).join('')}
                        </ol>
                    </div>
                `;
            }

            if (completedStages.includes(stageNumber)) {
                contentHtml += `<div class="stage-completed-notice">✔️ 이 스테이지를 완료했습니다!</div>`;
            } else {
                contentHtml += `<button id="complete-stage-btn" class="modal-button primary" style="width:100%; margin-top:20px; background-color: #28a745;" onclick="completeStage(${stageNumber})">스테이지 완료 및 보상 받기 🏆</button>`;
            }
            
            const stageContentElement = document.getElementById('stage-content');
            stageContentElement.innerHTML = `
                <h3 style="margin-bottom: 20px; color: var(--lesson-title-color);">${stageData.title}</h3>
                ${contentHtml}
            `;
            
            document.querySelector('.content').scrollTop = 0;
        }


        function backToStages() {
            document.getElementById('stage-detail').classList.add('hidden');
            document.getElementById('stage-list').classList.remove('hidden');
            currentStage = null;
        }

        function completeStage(stageNumber) {
            if (completedStages.includes(stageNumber)) return;

            const stageData = stageContents[stageNumber];
            let levelGain = 3000; // 모든 스테이지 완료 시 3000레벨 증가
            let itemName = stageData.item || '특별한 아이템'; // 스테이지별 아이템 이름

            grantBadge(`${itemName} 획득`); // 아이템 획득 뱃지 부여
            addExperience(levelGain, `🎉 스테이지 ${stageNumber} 완료! ${itemName} 획득! 레벨 +${levelGain}!`);
            completedStages.push(stageNumber);
            
            const button = document.getElementById('complete-stage-btn');
            if (button) {
                button.remove();
                // 스테이지 완료 후 다시 콘텐츠를 로드하여 완료 메시지 표시
                _showStageContentDetails(stageNumber); 
            }

            updateUI();
            saveProgress();
        }

        function completePrayerTime(timeSlot, element) {
            if (prayerTimes[timeSlot]) {
                showNotification('이미 완료한 기도 시간입니다!');
                return;
            }
            
            prayerTimes[timeSlot] = true;
            element.classList.add('completed');
            
            let message = '';
            let expGain = 30;
            
            switch(timeSlot) {
                case 'morning': message = '🌅 아침 기도 완료! 하루를 주님과 함께 시작하세요!'; break;
                case 'noon': message = '☀️ 점심 기도 완료! 하루 중반, 주님께 감사드려요!'; break;
                case 'evening': message = '🌙 저녁 기도 완료! 하루를 주님께 맡겨드려요!'; break;
            }
            
            addExperience(expGain, message);
            grantBadge('첫 기도');
            
            if (prayerTimes.morning && prayerTimes.noon && prayerTimes.evening) {
                setTimeout(() => {
                    addExperience(50, '🎉 10-10-10 기도법 완주! 보너스 경험치 +50!');
                    grantBadge('10-10-10 마스터');
                }, 1000);
            }
            
            completedMissions++;
            updateUI();
            saveProgress();
        }

        function showScripture() {
            const container = document.getElementById('scripture-container');
            const randomScripture = scriptures[Math.floor(Math.random() * scriptures.length)];
            
            container.innerHTML = `
                <div class="scripture-card">
                    <div class="scripture-text">"${randomScripture.text}"</div>
                    <div class="scripture-reference">- ${randomScripture.reference} -</div>
                </div>
                <button class="mission-button" onclick="completeMission(this, '말씀 묵상 완료! 영양분을 얻었습니다! 📖', 70, '성경 독자')" style="margin-top: 10px;">묵상 완료</button>
            `;
            document.getElementById('mission-btn-scripture').style.display = 'none';
        }
        
        function completeMission(button, message, expGain = 50, badgeToGrant = null) {
            button.textContent = '완료!';
            button.disabled = true;
            
            addExperience(expGain, message);
            if (badgeToGrant) grantBadge(badgeToGrant);
            
            completedMissions++;
            updateUI();
            saveProgress();
        }

        function addExperience(amount, notificationMessage) {
            userExp += amount;
            
            if (notificationMessage) {
                showNotification(notificationMessage);
            }

            while (userExp >= 100) {
                userLevel++;
                userExp -= 100;
                setTimeout(() => showNotification(`🎉 레벨업! Lv.${userLevel} 달성!`), 500);
            }
            updateUI();
        }

        // --- UI and Utility Functions ---
        function updateUI() {
            // Update job title based on level
            userJob = getUserJobTitle(userLevel);
            
            // Header
            document.getElementById('userName').textContent = userName;
            document.getElementById('headerAvatar').textContent = userAvatar;
            document.getElementById('userLevel').textContent = userLevel;
            document.getElementById('userExp').textContent = userExp;
            document.getElementById('userStreak').textContent = userStreak;
            
            // Profile Tab
            document.getElementById('profileUserName').textContent = userName;
            document.getElementById('profileAvatar').textContent = userAvatar;
            document.getElementById('profileLevel').textContent = userLevel;
            document.getElementById('profileJob').textContent = userJob;
            document.getElementById('profileStreak').textContent = userStreak;
            document.getElementById('completedMissionsCount').textContent = completedMissions;
            
            // Guild Tab
            document.getElementById('guildUserName').textContent = userName;
            document.getElementById('guildUserAvatar').textContent = userAvatar;
            document.getElementById('guildUserLevel').textContent = userLevel;
            document.getElementById('guildUserJob').textContent = userJob;
            document.getElementById('guildUserStreak').textContent = userStreak;
            document.getElementById('guildLevel').textContent = guildLevel;
            document.getElementById('guildExp').textContent = guildExp;
            
            // Badges
            const badgeContainer = document.getElementById('badge-container');
            if(userBadges.length > 0) {
                badgeContainer.innerHTML = userBadges.map(b => `<span>${b}</span>`).join('');
            } else {
                badgeContainer.innerHTML = `<p style="color: var(--text-color); font-size: 14px;">아직 획득한 뱃지가 없습니다.</p>`;
            }
        }
        
        function resetMissionUI() {
            // Reset prayer slots
            document.querySelectorAll('.prayer-time-slot').forEach(slot => slot.classList.remove('completed'));
            // Reset mission buttons
            document.querySelectorAll('.mission-button').forEach(btn => {
                btn.disabled = false;
                if(btn.id === 'mission-btn-worship') btn.textContent = '참여 완료';
                if(btn.id === 'mission-btn-quiz') btn.textContent = '퀴즈 시작';
            });
            document.getElementById('mission-btn-scripture').style.display = 'inline-block';
            document.getElementById('scripture-container').innerHTML = '';
            document.getElementById('mission-btn-chat').style.display = 'inline-block';
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('guild-chat-container').innerHTML = '';
        }

        function showNotification(message) {
            const existingNotif = document.querySelector('.floating-notification');
            if(existingNotif) existingNotif.remove();
            const notification = document.createElement('div');
            notification.className = 'floating-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // --- Data Persistence ---
        function saveProgress() {
            try {
                const data = {
                    userName, userAvatar, userJob, userLevel, userExp, userStreak,
                    completedMissions, userBadges, completedStages, guildLevel, guildExp, 
                    chatMessages, prayerTimes, notices, qtNotes, currentTheme,
                    quizCompletedToday, completedIcebreakers, // Save new states
                    lastLogin: new Date().toDateString()
                };
                
                const success = safeSetItem('blueWindProgress', JSON.stringify(data));
                if (!success && !isLocalStorageAvailable()) {
                    // localStorage 사용 불가 시 한 번만 알림
                    if (!memoryStorage._warningShown) {
                        showNotification('브라우저 설정으로 인해 데이터가 세션 동안만 유지됩니다. 📝');
                        memoryStorage._warningShown = true;
                    }
                }
            } catch (error) {
                console.error('데이터 저장 실패:', error);
                showNotification('데이터 저장에 실패했습니다.');
            }
        }

        function loadProgress() {
            try {
                const saved = safeGetItem('blueWindProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    userName = data.userName || '푸른이';
                    userAvatar = data.userAvatar || '🌟';
                    userLevel = data.userLevel || 1;
                    userExp = data.userExp || 0;
                    userStreak = data.userStreak || 1;
                    completedMissions = data.completedMissions || 0;
                    userJob = data.userJob || getUserJobTitle(userLevel);
                    userBadges = data.userBadges || [];
                    completedStages = data.completedStages || [];
                    guildLevel = data.guildLevel || 1;
                    guildExp = data.guildExp || 0;
                    chatMessages = data.chatMessages || [];
                    notices = data.notices || [];
                    qtNotes = data.qtNotes || [];
                    currentTheme = data.currentTheme || 'light-mode'; // Load theme
                    quizCompletedToday = data.quizCompletedToday || false; // Load quiz completion
                    completedIcebreakers = data.completedIcebreakers || []; // Load icebreaker completion

                    const today = new Date().toDateString();
                    const lastLogin = data.lastLogin || today;

                    if (lastLogin !== today) {
                        const lastDate = new Date(lastLogin);
                        const todayDate = new Date(today);
                        const diffTime = todayDate - lastDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            userStreak++;
                            setTimeout(() => grantBadge(`${userStreak}일 연속`), 500);
                        } else if (diffDays > 1) {
                            userStreak = 1;
                        }
                        prayerTimes = { morning: false, noon: false, evening: false };
                        quizCompletedToday = false; // Reset daily quiz completion
                    } else {
                        prayerTimes = data.prayerTimes || { morning: false, noon: false, evening: false };
                    }

                    // DOM이 로드된 후에 기도 시간 상태 업데이트
                    setTimeout(() => {
                        Object.keys(prayerTimes).forEach(timeSlot => {
                            if (prayerTimes[timeSlot]) {
                                const slots = document.querySelectorAll('.prayer-time-slot');
                                if (timeSlot === 'morning' && slots[0]) slots[0].classList.add('completed');
                                if (timeSlot === 'noon' && slots[1]) slots[1].classList.add('completed');
                                if (timeSlot === 'evening' && slots[2]) slots[2].classList.add('completed');
                            }
                        });
                    }, 100);
                } else {
                    setInitialState();
                }
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                showNotification('데이터 로드에 실패했습니다. 초기 설정으로 시작합니다.');
                setInitialState();
            }
            
            // Apply theme after loading
            document.body.className = currentTheme;
            updateUI();
            updateNotices();
            updateQTNotes();
        }
        
        function setInitialState() {
            userLevel = 1;
            userExp = 0;
            userStreak = 1;
            completedMissions = 0;
            userName = '푸른이';
            userAvatar = '🌟';
            userJob = '푸른이';
            userBadges = [];
            completedStages = [];
            guildLevel = 1;
            guildExp = 0;
            chatMessages = [];
            prayerTimes = { morning: false, noon: false, evening: false };
            notices = [];
            qtNotes = [];
            currentTheme = 'light-mode';
            quizCompletedToday = false;
            completedIcebreakers = [];
            
            // 초기 상태 저장 시도
            try {
                saveProgress();
            } catch (error) {
                console.error('초기 데이터 저장 실패:', error);
            }
        }

        // --- Notice Functions ---
        function showNoticeModal() {
            document.getElementById('noticeModal').style.display = 'flex';
            document.getElementById('noticePassword').focus();
        }

        function closeNoticeModal() {
            document.getElementById('noticeModal').style.display = 'none';
            document.getElementById('noticePassword').value = '';
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
        }

        function createNotice() {
            const password = document.getElementById('noticePassword').value;
            const title = document.getElementById('noticeTitle').value.trim();
            const content = document.getElementById('noticeContent').value.trim();

            if (password !== '0000') { // 관리자 비밀번호 (하드코딩, 실제 서비스에서는 보안 강화 필요)
                showNotification('관리자 비밀번호가 틀렸습니다! ❌');
                return;
            }

            if (!title || !content) {
                showNotification('제목과 내용을 모두 입력해주세요!');
                return;
            }

            const notice = {
                id: Date.now(),
                title: title,
                content: content,
                date: new Date().toLocaleDateString('ko-KR')
            };

            // 기존 공지사항을 새 공지사항으로 교체 (1개만 유지)
            notices = [notice];
            updateNotices();
            closeNoticeModal();
            showNotification('공지사항이 등록되었습니다! 📢');
            saveProgress();
        }

        function updateNotices() {
            const container = document.getElementById('notices-container');
            if (notices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;">
                        <p>등록된 공지사항이 없습니다.</p>
                    </div>
                `;
            } else {
                // 최신 공지사항 1개만 표시
                const notice = notices[0];
                container.innerHTML = `
                    <div class="notice-card">
                        <div class="notice-header">
                            <div class="notice-title">📢 ${notice.title}</div>
                            <div class="notice-date">${notice.date}</div>
                        </div>
                        <div class="notice-content">${notice.content}</div>
                    </div>
                `;
            }
        }

        // --- QT Note Functions ---
        function showQTNoteModal() {
            editingQTNote = null;
            document.getElementById('qtModalTitle').textContent = 'QT 노트 작성';
            document.getElementById('qtSubmitBtn').textContent = '작성 완료';
            document.getElementById('qtSubmitBtn').onclick = createQTNote;
            document.getElementById('qtNoteTitle').value = '';
            document.getElementById('qtNoteContent').value = '';
            document.getElementById('qtNotePassword').value = '';
            document.getElementById('qtNoteModal').style.display = 'flex';
        }

        function closeQTNoteModal() {
            document.getElementById('qtNoteModal').style.display = 'none';
        }

        function createQTNote() {
            const title = document.getElementById('qtNoteTitle').value.trim();
            const content = document.getElementById('qtNoteContent').value.trim();
            const password = document.getElementById('qtNotePassword').value.trim();

            if (!title || !content || !password) {
                showNotification('모든 필드를 입력해주세요!');
                return;
            }

            if (editingQTNote) {
                // 수정 모드
                editingQTNote.title = title;
                editingQTNote.content = content;
                editingQTNote.password = password; // 비밀번호도 업데이트 가능
                editingQTNote.date = new Date().toLocaleDateString('ko-KR');
                showNotification('QT 노트가 수정되었습니다! ✏️');
            } else {
                // 새 작성 모드
                const qtNote = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    password: password,
                    author: userName,
                    date: new Date().toLocaleDateString('ko-KR'),
                    likes: 0,
                    likedBy: [], // 좋아요 누른 사용자 닉네임 목록
                    comments: [] // Initialize comments array
                };
                qtNotes.unshift(qtNote);
                showNotification('QT 노트가 작성되었습니다! 📝');
            }

            updateQTNotes();
            closeQTNoteModal();
            saveProgress();
        }

        function updateQTNotes() {
            const container = document.getElementById('qt-notes-container');
            if (qtNotes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-color); padding: 20px; background: var(--mission-card-bg); border-radius: 10px;">
                        <p>작성된 QT 노트가 없습니다.</p>
                        <p>첫 번째 QT 노트를 작성해보세요! 📝</p>
                    </div>
                `;
            } else {
                container.innerHTML = qtNotes.map(note => `
                    <div class="qt-note-card">
                        <div class="qt-note-header">
                            <div class="qt-note-title">${note.title}</div>
                            <div class="qt-note-date">${note.date}</div>
                        </div>
                        <div class="qt-note-content">${note.content}</div>
                        <div class="qt-note-actions">
                            <button class="like-button" onclick="toggleLike(${note.id})">
                                ${note.likedBy.includes(userName) ? '❤️' : '🤍'} ${note.likes}
                            </button>
                            ${note.author === userName ? `
                                <div class="note-buttons">
                                    <button class="note-btn edit" onclick="editQTNote(${note.id})">수정</button>
                                    <button class="note-btn delete" onclick="deleteQTNote(${note.id})">삭제</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="comments-section">
                            <h5>💬 댓글 (${note.comments.length})</h5>
                            <div class="comment-input-container">
                                <textarea id="commentInput-${note.id}" class="comment-input" placeholder="댓글을 입력하세요..." rows="2"></textarea>
                                <input type="password" id="commentPassword-${note.id}" class="comment-password-input" placeholder="비밀번호 (수정/삭제용)" maxlength="10">
                                <button class="comment-send-btn" onclick="addComment(${note.id})">댓글 작성</button>
                            </div>
                            <div class="comment-list">
                                ${note.comments.length === 0 ? `<p style="color: var(--text-color); text-align: center;">아직 댓글이 없습니다.</p>` : note.comments.map(comment => `
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <span class="comment-author">${comment.author}</span>
                                            <span class="comment-time">${comment.time}</span>
                                        </div>
                                        <div class="comment-content">${comment.content}</div>
                                        ${comment.author === userName ? `
                                            <div class="comment-actions">
                                                <button class="comment-action-btn edit" onclick="editComment(${note.id}, ${comment.id})">수정</button>
                                                <button class="comment-action-btn delete" onclick="deleteComment(${note.id}, ${comment.id})">삭제</button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleLike(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            if (note.likedBy.includes(userName)) {
                // 좋아요 취소
                note.likedBy = note.likedBy.filter(name => name !== userName);
                note.likes--;
                showNotification('좋아요를 취소했습니다 💔');
            } else {
                // 좋아요 추가
                note.likedBy.push(userName);
                note.likes++;
                showNotification('좋아요를 눌렀습니다! ❤️');
            }

            updateQTNotes();
            saveProgress();
        }

        // --- Comment Functions ---
        function addComment(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            const inputElement = document.getElementById(`commentInput-${noteId}`);
            const passwordElement = document.getElementById(`commentPassword-${noteId}`);
            const commentContent = inputElement.value.trim();
            const commentPassword = passwordElement.value.trim();

            if (!commentContent || !commentPassword) {
                showNotification('댓글 내용과 비밀번호를 모두 입력해주세요!');
                return;
            }

            const newComment = {
                id: Date.now(),
                author: userName,
                avatar: userAvatar,
                content: commentContent,
                password: commentPassword,
                time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            };

            note.comments.push(newComment);
            inputElement.value = '';
            passwordElement.value = '';
            showNotification('댓글이 작성되었습니다! 💬');
            updateQTNotes();
            saveProgress();
        }

        function editComment(noteId, commentId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;
            const comment = note.comments.find(c => c.id === commentId);
            if (!comment) return;

            pendingQTAction = { type: 'comment', action: 'edit', noteId: noteId, commentId: commentId };
            document.getElementById('passwordModalText').textContent = '댓글을 수정하려면 비밀번호를 입력하세요:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function deleteComment(noteId, commentId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;
            const comment = note.comments.find(c => c.id === commentId);
            if (!comment) return;

            pendingQTAction = { type: 'comment', action: 'delete', noteId: noteId, commentId: commentId };
            document.getElementById('passwordModalText').textContent = '댓글을 삭제하려면 비밀번호를 입력하세요:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        // Modified confirmQTAction to handle both QT notes and comments
        function confirmQTAction() {
            if (!pendingQTAction) return;

            const password = document.getElementById('qtActionPassword').value;
            let targetItem = null; // Either a QT note or a comment

            if (pendingQTAction.type === 'qtNote') {
                targetItem = qtNotes.find(n => n.id === pendingQTAction.noteId);
            } else if (pendingQTAction.type === 'comment') {
                const note = qtNotes.find(n => n.id === pendingQTAction.noteId);
                if (note) {
                    targetItem = note.comments.find(c => c.id === pendingQTAction.commentId);
                }
            }

            if (!targetItem || targetItem.password !== password) {
                showNotification('비밀번호가 틀렸습니다! ❌');
                return;
            }

            if (pendingQTAction.type === 'qtNote') {
                if (pendingQTAction.action === 'edit') {
                    editingQTNote = targetItem;
                    document.getElementById('qtModalTitle').textContent = 'QT 노트 수정';
                    document.getElementById('qtSubmitBtn').textContent = '수정 완료';
                    document.getElementById('qtSubmitBtn').onclick = createQTNote;
                    document.getElementById('qtNoteTitle').value = targetItem.title;
                    document.getElementById('qtNoteContent').value = targetItem.content;
                    document.getElementById('qtNotePassword').value = targetItem.password;
                    document.getElementById('qtNoteModal').style.display = 'flex';
                } else if (pendingQTAction.action === 'delete') {
                    qtNotes = qtNotes.filter(n => n.id !== pendingQTAction.noteId);
                    updateQTNotes();
                    showNotification('QT 노트가 삭제되었습니다! 🗑️');
                    saveProgress();
                }
            } else if (pendingQTAction.type === 'comment') {
                const note = qtNotes.find(n => n.id === pendingQTAction.noteId);
                if (!note) return;

                if (pendingQTAction.action === 'edit') {
                    const newContent = prompt('새로운 댓글 내용을 입력하세요:', targetItem.content);
                    if (newContent !== null) { // User didn't cancel
                        targetItem.content = newContent.trim();
                        targetItem.time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) + ' (수정됨)';
                        showNotification('댓글이 수정되었습니다! ✏️');
                    }
                } else if (pendingQTAction.action === 'delete') {
                    note.comments = note.comments.filter(c => c.id !== pendingQTAction.commentId);
                    showNotification('댓글이 삭제되었습니다! 🗑️');
                }
                updateQTNotes();
                saveProgress();
            }

            closeQTPasswordModal();
        }

        // --- Badge Functions ---
        function grantBadge(badgeName) {
            if (!userBadges.includes(badgeName)) {
                userBadges.push(badgeName);
                showNotification(`🏆 뱃지 획득: ${badgeName}!`);
                updateUI();
                saveProgress();
            }
        }

        // --- Chat Functions ---
        function openChat() {
            const container = document.getElementById('chat-container');
            container.innerHTML = createChatInterface('chat');
            updateChatMessages('chat');
            document.getElementById('mission-btn-chat').style.display = 'none';
            // 채팅 참여 완료 시 미션 완료 처리 (한 번만)
            if (!document.getElementById('mission-btn-chat').disabled) {
                completeMission(document.getElementById('mission-btn-chat'), '길드원과 대화 완료! 공동체 버프를 받았습니다! 💬', 30, '대화의 시작');
            }
        }

        function showGuildChat() {
            const container = document.getElementById('guild-chat-container');
            container.innerHTML = createChatInterface('guild');
            updateChatMessages('guild');
        }
        
        function createChatInterface(prefix) {
            return `
                <div class="chat-container">
                    <div class="chat-messages" id="${prefix}Messages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="${prefix}Input" placeholder="길드원들과 대화해보세요..." onkeypress="handleChatKeyPress(event, '${prefix}')">
                        <button class="image-upload-btn" onclick="document.getElementById('${prefix}FileInput').click()">📷</button>
                        <button class="chat-send-btn" onclick="sendMessage('${prefix}')">전송</button>
                        <input type="file" id="${prefix}FileInput" class="hidden-file-input" accept="image/*" onchange="handleImageUpload(event, '${prefix}')">
                    </div>
                </div>
            `;
        }

        function updateChatMessages(prefix) {
            const messagesContainer = document.getElementById(`${prefix}Messages`);
            if (!messagesContainer) return;
            
            if (chatMessages.length === 0) {
                messagesContainer.innerHTML = `<div style="text-align: center; color: var(--text-color); padding: 20px;"><p>첫 번째 메시지를 보내보세요! 💬</p></div>`;
            } else {
                messagesContainer.innerHTML = chatMessages.map(msg => {
                    let messageContent = `<div class="message-bubble">${msg.message}</div>`;
                    if (msg.image) {
                        messageContent += `<img src="${msg.image}" alt="업로드된 이미지" class="message-image" onclick="showImageModal('${msg.image}')">`;
                    }
                    
                    return `
                        <div class="message ${msg.sender === userName ? 'user' : 'other'}">
                            <div class="message-header">
                                <div class="message-avatar">${msg.avatar || '👤'}</div>
                                <div class="message-sender">${msg.sender}</div>
                                <div class="message-time">${msg.time}</div>
                            </div>
                            ${messageContent}
                        </div>
                    `;
                }).join('');
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleImageUpload(event, prefix) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) { // 5MB 제한
                showNotification('이미지 크기는 5MB 이하만 업로드 가능합니다! 📷');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                chatMessages.push({ 
                    sender: userName, 
                    avatar: userAvatar, 
                    message: '사진을 업로드했습니다 📷', 
                    image: e.target.result,
                    time: timeString 
                });
                
                if (document.getElementById('chatMessages')) updateChatMessages('chat');
                if (document.getElementById('guildChatMessages')) updateChatMessages('guild');
                
                showNotification('사진이 업로드되었습니다! 📷');
                saveProgress();
            };
            reader.readAsDataURL(file);
            
            // 파일 입력 초기화
            event.target.value = '';
        }

        function showImageModal(imageSrc) {
            // 이미지 확대 보기 모달 생성
            const existingModal = document.getElementById('imageViewModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'imageViewModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%; padding: 20px;">
                    <div class="modal-title">이미지 보기</div>
                    <img src="${imageSrc}" style="max-width: 100%; max-height: 70vh; border-radius: 10px;">
                    <div class="modal-buttons" style="margin-top: 15px;">
                        <button class="modal-button secondary" onclick="closeImageModal()">닫기</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 모달 배경 클릭으로 닫기
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeImageModal();
            });
        }

        function closeImageModal() {
            const modal = document.getElementById('imageViewModal');
            if (modal) modal.remove();
        }

        function sendMessage(prefix) {
            const input = document.getElementById(`${prefix}Input`);
            const message = input.value.trim();
            if (message) {
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                chatMessages.push({ sender: userName, avatar: userAvatar, message: message, time: timeString });
                input.value = '';
                
                if (document.getElementById('chatMessages')) updateChatMessages('chat');
                if (document.getElementById('guildChatMessages')) updateChatMessages('guild');
                
                saveProgress();
            }
        }

        function handleChatKeyPress(event, prefix) {
            if (event.key === 'Enter') sendMessage(prefix);
        }

        // --- Minigame (Quiz) Functions ---
        let currentQuizIndex = 0;

        function showMinigameModal(gameType) {
            const minigameContent = document.getElementById('minigame-content');
            minigameContent.innerHTML = ''; // Clear previous content

            if (gameType === 'quiz') {
                if (quizCompletedToday) {
                    minigameContent.innerHTML = `
                        <div class="modal-title">오늘의 퀴즈</div>
                        <p style="color: var(--text-color); margin-bottom: 20px;">오늘은 이미 퀴즈를 완료했습니다! 내일 다시 도전해주세요. 😊</p>
                        <div class="modal-buttons">
                            <button class="modal-button secondary" onclick="closeMinigameModal()">닫기</button>
                        </div>
                    `;
                    document.getElementById('minigameModal').style.display = 'flex';
                    return;
                }
                startQuiz();
            }
        }

        function closeMinigameModal() {
            document.getElementById('minigameModal').style.display = 'none';
        }

        function startQuiz() {
            currentQuizIndex = 0;
            displayQuizQuestion();
            document.getElementById('minigameModal').style.display = 'flex';
        }

        function displayQuizQuestion() {
            const minigameContent = document.getElementById('minigame-content');
            const questionData = quizQuestions[currentQuizIndex];

            if (!questionData) {
                // All questions answered
                minigameContent.innerHTML = `
                    <div class="modal-title">퀴즈 완료!</div>
                    <p style="color: var(--text-color); margin-bottom: 20px;">모든 퀴즈를 완료했습니다. 대단해요! 🎉</p>
                    <div class="modal-buttons">
                        <button class="modal-button primary" onclick="completeQuizMission()">보상 받기</button>
                        <button class="modal-button secondary" onclick="closeMinigameModal()">닫기</button>
                    </div>
                `;
                return;
            }

            let optionsHtml = questionData.options.map(option => `
                <button class="quiz-option" onclick="checkAnswer('${option}')">${option}</button>
            `).join('');

            minigameContent.innerHTML = `
                <div class="modal-title">신앙 퀴즈 (${currentQuizIndex + 1}/${quizQuestions.length})</div>
                <p style="color: var(--text-color); margin-bottom: 20px; font-weight: bold;">${questionData.question}</p>
                <div>${optionsHtml}</div>
            `;
        }

        function checkAnswer(selectedOption) {
            const questionData = quizQuestions[currentQuizIndex];
            if (selectedOption === questionData.answer) {
                showNotification('정답입니다! 🥳');
                currentQuizIndex++;
                setTimeout(displayQuizQuestion, 500); // Show next question after a short delay
            } else {
                showNotification('오답입니다. 다시 시도해보세요. 😔');
            }
        }

        function completeQuizMission() {
            addExperience(50, '퀴즈 미션 완료! 지혜가 +50 증가했습니다! 🧠');
            grantBadge('퀴즈 마스터');
            quizCompletedToday = true; // Mark quiz as completed for the day
            document.getElementById('mission-btn-quiz').textContent = '완료!';
            document.getElementById('mission-btn-quiz').disabled = true;
            closeMinigameModal();
            saveProgress();
        }

        // --- Icebreaker Functions ---
        let currentIcebreakerStage = null;

        function showIcebreakerModal(stageNumber, promptText) {
            currentIcebreakerStage = stageNumber;
            document.getElementById('icebreakerPrompt').textContent = promptText;
            document.getElementById('icebreakerInput').value = ''; // Clear previous input
            document.getElementById('icebreakerModal').style.display = 'flex';
        }

        function closeIcebreakerModal() {
            document.getElementById('icebreakerModal').style.display = 'none';
            currentIcebreakerStage = null;
        }

        function completeIcebreaker() {
            const answer = document.getElementById('icebreakerInput').value.trim();
            if (!answer) {
                showNotification('답변을 입력해주세요!');
                return;
            }

            if (!completedIcebreakers.includes(currentIcebreakerStage)) {
                completedIcebreakers.push(currentIcebreakerStage);
                showNotification(`아이스브레이크 완료! 스테이지 ${currentIcebreakerStage}의 문이 열렸습니다!`);
                saveProgress();
            }
            
            closeIcebreakerModal();
            _showStageContentDetails(currentIcebreakerStage); // Proceed to show stage content
        }

        // --- Modal Functions ---
        function showNameModal() {
            const modal = document.getElementById('nameModal');
            document.getElementById('nameInput').value = userName;
            modal.style.display = 'flex';
            document.getElementById('nameInput').focus();
        }
        function closeNameModal() { document.getElementById('nameModal').style.display = 'none'; }
        function changeName() {
            const newName = document.getElementById('nameInput').value.trim();
            if (newName && newName.length > 0 && newName.length <= 10) {
                userName = newName;
                updateUI();
                closeNameModal();
                showNotification('닉네임이 변경되었습니다! 🎉');
                saveProgress();
            } else {
                showNotification('닉네임은 1~10자 사이로 입력해주세요!');
            }
        }

        function showAvatarModal() { document.getElementById('avatarModal').style.display = 'flex'; }
        function closeAvatarModal() { document.getElementById('avatarModal').style.display = 'none'; }
        function selectAvatar(emoji) {
            userAvatar = emoji;
            updateUI();
            closeAvatarModal();
            showNotification('프로필 사진이 변경되었습니다! ✨');
            saveProgress();
        }

        function showResetModal() { document.getElementById('resetModal').style.display = 'flex'; }
        function closeResetModal() { document.getElementById('resetModal').style.display = 'none'; }
        function confirmReset() {
            if (document.getElementById('adminPassword').value === '0000') {
                try {
                    safeRemoveItem('blueWindProgress');
                } catch (error) {
                    console.error('데이터 삭제 실패:', error);
                }
                // 메모리 저장소도 초기화
                memoryStorage = {};
                
                setInitialState();
                updateUI();
                resetMissionUI();
                closeResetModal();
                showNotification('모든 데이터가 초기화되었습니다. 🔄');
            } else {
                showNotification('비밀번호가 틀렸습니다! ❌');
            }
        }

        // --- Theme Toggle Function ---
        function toggleTheme() {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                currentTheme = 'dark-mode';
                showNotification('다크 모드로 전환되었습니다 🌙');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                currentTheme = 'light-mode';
                showNotification('라이트 모드로 전환되었습니다 ☀️');
            }
            saveProgress();
        }

        // --- App Initialization ---
        function initApp() {
            try {
                loadProgress();
                
                setTimeout(() => {
                    showNotification(`${userName}님, 푸른나라학교에 오신 것을 환영합니다! 🌟`);
                }, 1000);

                // Check if quiz was completed today
                const lastQuizDate = safeGetItem('lastQuizDate');
                const today = new Date().toDateString();
                if (lastQuizDate === today) {
                    quizCompletedToday = true;
                    const quizButton = document.getElementById('mission-btn-quiz');
                    if (quizButton) {
                        quizButton.textContent = '완료!';
                        quizButton.disabled = true;
                    }
                } else {
                    quizCompletedToday = false;
                    const quizButton = document.getElementById('mission-btn-quiz');
                    if (quizButton) {
                        quizButton.textContent = '퀴즈 시작';
                        quizButton.disabled = false;
                    }
                }

                // Modal close events
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });

                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                        closeImageModal();
                    }
                    if (e.key === 'Enter') {
                        const nameModal = document.getElementById('nameModal');
                        const resetModal = document.getElementById('resetModal');
                        const noticeModal = document.getElementById('noticeModal');
                        const qtNoteModal = document.getElementById('qtNoteModal');
                        const qtPasswordModal = document.getElementById('qtPasswordModal');
                        const minigameModal = document.getElementById('minigameModal');
                        const icebreakerModal = document.getElementById('icebreakerModal');
                        
                        if (nameModal.style.display === 'flex') {
                            e.preventDefault();
                            changeName();
                        } else if (resetModal.style.display === 'flex') {
                            e.preventDefault();
                            confirmReset();
                        } else if (noticeModal.style.display === 'flex') {
                            e.preventDefault();
                            createNotice();
                        } else if (qtNoteModal.style.display === 'flex') {
                            e.preventDefault();
                            createQTNote();
                        } else if (qtPasswordModal.style.display === 'flex') {
                            e.preventDefault();
                            confirmQTAction();
                        } else if (minigameModal.style.display === 'flex' && document.getElementById('minigame-content').querySelector('.quiz-option')) {
                            // Prevent default Enter key behavior in quiz modal if an option is focused
                            // This part needs more sophisticated handling if quiz options are focusable
                            // For now, it will just close the modal if no specific action is tied to Enter
                        } else if (icebreakerModal.style.display === 'flex') {
                            e.preventDefault();
                            completeIcebreaker();
                        }
                    }
                });
            } catch (error) {
                console.error('앱 초기화 실패:', error);
                showNotification('앱 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
            }
        }

        // 페이지 로드 후 안전하게 초기화
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // 데이터 저장을 안전하게 처리
        window.addEventListener('beforeunload', () => {
            try {
                saveProgress();
            } catch (error) {
                console.error('종료 시 데이터 저장 실패:', error);
            }
        });

    </script>
</body>
</html>
