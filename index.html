<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‘¸ë¥¸ë‚˜ë¼í•™êµ - ì‹ ì•™ RPG</title>
    <!-- Web App Manifest for 'Add to Home Screen' -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="í‘¸ë¥¸ë‚˜ë¼í•™êµ">
    
    <style>
        /* General styling for the entire page */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Main application container */
        .app-container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header section with user profile */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .character-avatar {
            width: 80px;
            height: 80px;
            background: #fff;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .character-avatar:hover {
            transform: scale(1.05);
        }

        .user-name {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .user-name:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 14px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            font-size: 18px;
        }

        /* Bottom navigation bar */
        .navigation {
            display: flex;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .nav-item {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            color: #495057;
        }

        .nav-item.active {
            background: #4facfe;
            color: white;
        }

        .nav-item:hover {
            background: #e9ecef;
        }

        .nav-item.active:hover {
            background: #3d8bfe;
        }

        /* Main content area */
        .content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        /* Notice board styling */
        .notice-card {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notice-title {
            font-weight: bold;
            color: #856404;
        }

        .notice-date {
            font-size: 12px;
            color: #856404;
            opacity: 0.8;
        }

        .notice-content {
            color: #856404;
            line-height: 1.5;
        }

        .admin-button {
            position: absolute;
            top: 5px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 12px;
            opacity: 0.7;
            cursor: pointer;
            color: #856404;
        }

        /* Styling for mission cards on the home tab */
        .mission-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mission-title {
            font-weight: bold;
        }

        .mission-reward {
            background: #ffd700;
            color: #333;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .mission-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .mission-button {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .mission-button:hover {
            background: #3d8bfe;
            transform: scale(1.05);
        }

        .mission-button:disabled {
            background: #28a745;
            cursor: not-allowed;
            transform: none;
        }

        /* Utility class to hide elements */
        .hidden {
            display: none;
        }

        /* Floating notification style */
        .floating-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 25px;
            font-weight: bold;
            animation: slideInDown 0.3s ease;
            z-index: 1001; /* Ensure it's above modals */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* 10-10-10 prayer card styling */
        .prayer-time-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .prayer-time-title {
            font-size: 18px;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 15px;
        }

        .prayer-time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .prayer-time-slot {
            background: rgba(255,255,255,0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prayer-time-slot:hover {
            border-color: #8b4513;
            transform: scale(1.05);
        }

        .prayer-time-slot.completed {
            background: #d4edda;
            border-color: #28a745;
        }

        /* Scripture display card */
        .scripture-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #2196f3;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scripture-text {
            font-size: 16px;
            line-height: 1.6;
            color: #1565c0;
            margin-bottom: 10px;
            font-style: italic;
        }

        .scripture-reference {
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
        }

        /* Chat interface styling */
        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            height: 350px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.other {
            align-items: flex-start;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            display: inline-block;
        }
        
        .message.user .message-bubble {
            background: #4facfe;
            color: white;
        }

        .message.other .message-bubble {
            background: #f1f3f4;
            color: #333;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
            padding: 0 5px;
        }

        .message-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            margin-right: 8px;
        }
        
        .message.user .message-avatar { background: #3d8bfe; }
        .message.other .message-avatar { background: #6c757d; }

        .message-sender {
            font-weight: bold;
        }

        .message-time {
            margin-left: 8px;
            opacity: 0.7;
            font-size: 10px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #4facfe;
            outline: none;
        }

        .chat-send-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .chat-send-btn:hover {
            background: #3d8bfe;
        }

        /* QT Note styling */
        .qt-note-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .qt-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .qt-note-title {
            font-weight: bold;
            color: #4facfe;
        }

        .qt-note-date {
            font-size: 12px;
            color: #666;
        }

        .qt-note-content {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #333;
        }

        .qt-note-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .like-button {
            background: none;
            border: none;
            color: #e91e63;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-button:hover {
            color: #c2185b;
        }

        .note-buttons {
            display: flex;
            gap: 5px;
        }

        .note-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .note-btn.edit { background: #ffc107; }
        .note-btn.delete { background: #dc3545; }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 380px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4facfe;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .modal-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .modal-input:focus, .modal-textarea:focus {
            border-color: #4facfe;
            outline: none;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-button.primary {
            background: #4facfe;
            color: white;
        }

        .modal-button.primary:hover {
            background: #3d8bfe;
        }

        .modal-button.secondary {
            background: #6c757d;
            color: white;
        }

        .modal-button.secondary:hover {
            background: #5a6268;
        }

        /* Stage lesson content styling */
        .lesson-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            animation: slideInUp 0.4s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .lesson-icon {
            font-size: 30px;
            margin-right: 15px;
        }

        .lesson-title {
            font-size: 18px;
            font-weight: bold;
            color: #4facfe;
        }

        .lesson-content {
            line-height: 1.7;
            color: #333;
            font-size: 15px;
        }

        .lesson-content h4 {
            color: #4facfe;
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .lesson-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .lesson-content li {
            margin-bottom: 8px;
        }

        .lesson-content p {
            margin-bottom: 12px;
        }

        .lesson-content strong {
            color: #2c5aa0;
        }
        
        /* Stage selection cards */
        .stage-card {
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stage-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        /* Avatar selection modal */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .avatar-option {
            font-size: 30px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        .avatar-option:hover {
            background: #e9ecef;
        }
        
        /* Discussion Questions Styling */
        .discussion-container {
            background: #f1f8e9;
            border-left: 5px solid #8bc34a;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
        }
        .discussion-container h4 {
            color: #33691e;
            margin-bottom: 15px;
        }
        .discussion-container ol {
            padding-left: 20px;
            line-height: 1.8;
            color: #555;
        }
        
        /* Badge Styling */
        #badge-container span {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin: 3px;
        }

        /* Minigame Modal Styling */
        #minigame-canvas {
            border-radius: 10px;
            background: #e0f7fa;
            cursor: pointer;
        }

        #minigame-content .quiz-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid #4facfe;
            background: white;
            color: #4facfe;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #minigame-content .quiz-option:hover {
            background: #e3f2fd;
        }
        
        .stage-completed-notice {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
            border-radius: 10px;
            border: 2px dashed #a5d6a7;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="character-avatar" id="headerAvatar" onclick="showAvatarModal()">ğŸŒŸ</div>
            <div class="user-name" onclick="showNameModal()">
                <span id="userName">í‘¸ë¥¸ì´</span>
                <span>âœï¸</span>
            </div>
            <div class="user-stats">
                <div class="stat">
                    <div class="stat-value" id="userLevel">1</div>
                    <div>ë ˆë²¨</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userExp">0</div>
                    <div>ê²½í—˜ì¹˜</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="userStreak">1</div>
                    <div>ì—°ì†ì¼</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content">
                <!-- Notice Board -->
                <div id="notice-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>ğŸ“¢ ê³µì§€ì‚¬í•­</h3>
                        <button style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showNoticeModal()">+ ê³µì§€ ì‘ì„±</button>
                    </div>
                    <div id="notices-container">
                        <!-- ê³µì§€ì‚¬í•­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">ğŸ“‹ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</h3>
                
                <div class="prayer-time-card">
                    <div class="prayer-time-title">â° 10-10-10 ê¸°ë„ë²•</div>
                    <div class="prayer-time-grid">
                        <div class="prayer-time-slot" onclick="completePrayerTime('morning', this)">
                            <div>ğŸŒ… ì•„ì¹¨</div>
                            <div style="font-size: 12px;">10ë¶„</div>
                        </div>
                        <div class="prayer-time-slot" onclick="completePrayerTime('noon', this)">
                            <div>â˜€ï¸ ì ì‹¬</div>
                            <div style="font-size: 12px;">10ë¶„</div>
                        </div>
                        <div class="prayer-time-slot" onclick="completePrayerTime('evening', this)">
                            <div>ğŸŒ™ ì €ë…</div>
                            <div style="font-size: 12px;">10ë¶„</div>
                        </div>
                    </div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">ğŸ“– ì„±ê²½ ë§ì”€ ì½ê¸°</div>
                        <div class="mission-reward">+70 EXP</div>
                    </div>
                    <div class="mission-description">í‘¸ë¥¸ë°”ëŒì˜ ëƒ‰ì¥ê³ ì—ì„œ ì˜¤ëŠ˜ì˜ ì˜ì–‘ë¶„ì„ ì„­ì·¨í•˜ì„¸ìš”</div>
                    <button class="mission-button" id="mission-btn-scripture" onclick="showScripture()">ë§ì”€ ë³´ê¸°</button>
                    <div id="scripture-container"></div>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">ğŸ¯ ì˜ˆë°° ì°¸ì—¬í•˜ê¸°</div>
                        <div class="mission-reward">+100 EXP</div>
                    </div>
                    <div class="mission-description">í•˜ë‚˜ë‹˜ì„ ë§Œë‚˜ëŠ” ê³µì‹ ì±„ë„ì—ì„œ ì–‘ë°©í–¥ ì†Œí†µí•˜ì„¸ìš”</div>
                    <button class="mission-button" id="mission-btn-worship" onclick="completeMission(this, 'ì˜ˆë°° ì°¸ì—¬ ì™„ë£Œ! ìš©íŠ¹ìƒˆ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤! ğŸ™', 100, 'ì˜ˆë°° ì°¸ì„')">ì°¸ì—¬ ì™„ë£Œ</button>
                </div>

                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">ğŸ‘¥ ê¸¸ë“œì›ê³¼ ëŒ€í™”í•˜ê¸°</div>
                        <div class="mission-reward">+30 EXP</div>
                    </div>
                    <div class="mission-description">ë³‘ì•„ë¦¬ ê³µë™ì²´ì—ì„œ ê¸¸ë“œ ë²„í”„ë¥¼ ë°›ì•„ë³´ì„¸ìš”</div>
                    <button class="mission-button" id="mission-btn-chat" onclick="openChat()">ì±„íŒ… ì°¸ì—¬</button>
                    <div id="chat-container"></div>
                </div>
            </div>

            <!-- Stages Tab -->
            <div id="stages-tab" class="tab-content hidden">
                 <div id="stage-list">
                    <h3 style="margin-bottom: 20px;">ğŸ¯ í•™ìŠµ ìŠ¤í…Œì´ì§€</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 20px;">
                        êµì¬ ë‚´ìš© ê¸°ë°˜ í•™ìŠµ ë‹¨ê³„ì…ë‹ˆë‹¤
                    </p>
                    
                    <div class="stage-card" onclick="launchMinigame(1)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">1. íŒ¨ì¹˜ ì‹œìŠ¤í…œ</div>
                        <div style="font-size: 14px; opacity: 0.9;">ê±°ë¶€í•  ìˆ˜ ì—†ëŠ” íŠ¹ê¶Œ</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">ì˜ˆë°°í•˜ê¸° â€¢ ì„±ê²½ì½ê¸° â€¢ ê¸°ë„í•˜ê¸°</div>
                    </div>

                    <div class="stage-card" onclick="launchMinigame(2)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">2. ê¸¸ë“œ ì‹œìŠ¤í…œ</div>
                        <div style="font-size: 14px; opacity: 0.9;">ìš°ë¦¬, ê°™ì´ í•´ë³¼ê¹Œìš”</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">ì„¸ë¡€ë°›ê¸° â€¢ ê³µë™ì²´ ì†í•˜ê¸° â€¢ ì„±ë ¹ ë”°ë¥´ê¸°</div>
                    </div>

                    <div class="stage-card" onclick="launchMinigame(3)">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">3. ì‹¤ì „ ì‹œìŠ¤í…œ</div>
                        <div style="font-size: 14px; opacity: 0.9;">ì¸ìƒì€ ì¥ë‚œì´ ì•„ë‹ˆë‹ˆê¹Œ</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">ì´ë¡ ì—ì„œ í˜„ì‹¤ë¡œ â€¢ ë§¤ì¼ ê·¸ë¶„ê³¼ â€¢ ì¼ìƒì„ í•¨ê»˜</div>
                    </div>
                </div>
                
                <div id="stage-detail" class="hidden">
                    <div id="stage-content"></div>
                    <button style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; width: 100%;" onclick="backToStages()">â† ìŠ¤í…Œì´ì§€ ëª©ë¡ìœ¼ë¡œ</button>
                </div>
            </div>

            <!-- Guild Tab -->
            <div id="guild-tab" class="tab-content hidden">
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; position: relative;">
                    <h3>ğŸ‘¥ í‘¸ë¥¸ë°”ëŒë‹¨</h3>
                    <strong>ê¸¸ë“œ ë ˆë²¨: <span id="guildLevel">1</span></strong><br>
                    <small>ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ <span id="guildExp">0</span>/500 EXP</small>
                </div>

                <!-- QT Note Section -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4>ğŸ“” QT ë…¸íŠ¸</h4>
                        <button style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" onclick="showQTNoteModal()">+ QT ë…¸íŠ¸ ì‘ì„±</button>
                    </div>
                    <div id="qt-notes-container">
                        <!-- QT ë…¸íŠ¸ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <h4 style="margin-bottom: 15px;">ğŸŸ¢ í˜„ì¬ ì ‘ì† ì¤‘ì¸ ê¸¸ë“œì›</h4>
                <div style="background: #f8f9fa; border-radius: 15px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: white; border-radius: 10px;">
                        <div id="guildUserAvatar" style="width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid #4facfe; background: #4facfe; color: white;">ğŸŒŸ</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 2px;"><span id="guildUserName">í‘¸ë¥¸ì´</span> (ë‚˜)</div>
                            <div style="font-size: 12px; color: #666;">ë ˆë²¨ <span id="guildUserLevel">1</span> <span id="guildUserJob">í‘¸ë¥¸ì´</span> â€¢ <span id="guildUserStreak">1</span>ì¼ ì—°ì† ì ‘ì†</div>
                        </div>
                    </div>
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <p>ë‹¤ë¥¸ ê¸¸ë“œì›ë“¤ì´ ì ‘ì†í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                        <p>ì¹œêµ¬ë“¤ì„ ì´ˆëŒ€í•´ë³´ì„¸ìš”! ğŸ‰</p>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 10px; font-weight: bold;" onclick="showGuildChat()">
                        ğŸ’¬ ê¸¸ë“œ ì±„íŒ… ì°¸ì—¬í•˜ê¸°
                    </button>
                    <div id="guild-chat-container" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-content hidden">
                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 50px; cursor: pointer; border: 3px solid #4facfe; background: white;" id="profileAvatar" onclick="showAvatarModal()">ğŸŒŸ</div>
                        <div>
                            <h4 id="profileUserName" style="margin-bottom: 5px; color: #333;">í‘¸ë¥¸ì´</h4>
                            <p style="color: #666; font-size: 14px;">ë ˆë²¨ <span id="profileLevel">1</span> <span id="profileJob">í‘¸ë¥¸ì´</span></p>
                            <p style="color: #666; font-size: 14px;">ì‹ ì•™ ì—¬ì • <span id="profileStreak">1</span>ì¼ì°¨</p>
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">ğŸ† ì—…ì  ë° ë±ƒì§€</h4>
                    <div style="background: white; padding: 15px; border-radius: 10px;">
                        <div id="badge-container" style="margin-bottom: 10px; min-height: 25px;">
                           <!-- Badges will be dynamically inserted here -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                            <span>ì™„ë£Œí•œ ë¯¸ì…˜</span>
                            <strong id="completedMissionsCount">0</strong>ê°œ
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h4>
                    <div style="background: white; padding: 15px; border-radius: 10px;">
                        <button style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;" onclick="showResetModal()">
                            ğŸ”„ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                        <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">
                            ëª¨ë“  ì§„í–‰ ìƒí™©ì´ ë¦¬ì…‹ë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-item active" onclick="showTab('home', this)">
                ğŸ <br>í™ˆ
            </button>
            <button class="nav-item" onclick="showTab('stages', this)">
                ğŸ®<br>ìŠ¤í…Œì´ì§€
            </button>
            <button class="nav-item" onclick="showTab('guild', this)">
                ğŸ‘¥<br>ê¸¸ë“œ
            </button>
            <button class="nav-item" onclick="showTab('profile', this)">
                ğŸ‘¤<br>í”„ë¡œí•„
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ë‹‰ë„¤ì„ ë³€ê²½</div>
            <input type="text" id="nameInput" class="modal-input" placeholder="ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNameModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" onclick="changeName()">ë³€ê²½</button>
            </div>
        </div>
    </div>

    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</div>
            <div class="avatar-grid">
                <div class="avatar-option" onclick="selectAvatar('ğŸŒŸ')">ğŸŒŸ</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸ˜Š')">ğŸ˜Š</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸ™')">ğŸ™</div>
                <div class="avatar-option" onclick="selectAvatar('âœ¨')">âœ¨</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸ•Šï¸')">ğŸ•Šï¸</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸ“–')">ğŸ“–</div>
                <div class="avatar-option" onclick="selectAvatar('â¤ï¸')">â¤ï¸</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸŒ…')">ğŸŒ…</div>
                <div class="avatar-option" onclick="selectAvatar('â­')">â­</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸµ')">ğŸµ</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸŒ¸')">ğŸŒ¸</div>
                <div class="avatar-option" onclick="selectAvatar('ğŸŒˆ')">ğŸŒˆ</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeAvatarModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ê´€ë¦¬ì ì¸ì¦</div>
            <input type="password" id="adminPassword" class="modal-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="4">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeResetModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" onclick="confirmReset()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ê³µì§€ì‚¬í•­ ì‘ì„±</div>
            <input type="password" id="noticePassword" class="modal-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (0000)" maxlength="4">
            <input type="text" id="noticeTitle" class="modal-input" placeholder="ê³µì§€ì‚¬í•­ ì œëª©">
            <textarea id="noticeContent" class="modal-textarea" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeNoticeModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" onclick="createNotice()">ê³µì§€ ë“±ë¡</button>
            </div>
        </div>
    </div>

    <!-- QT Note Modal -->
    <div id="qtNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="qtModalTitle">QT ë…¸íŠ¸ ì‘ì„±</div>
            <input type="text" id="qtNoteTitle" class="modal-input" placeholder="QT ë…¸íŠ¸ ì œëª©">
            <textarea id="qtNoteContent" class="modal-textarea" placeholder="ì˜¤ëŠ˜ì˜ QT ë‚´ìš©ì„ ê¸°ë¡í•´ë³´ì„¸ìš”..."></textarea>
            <input type="password" id="qtNotePassword" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (ìˆ˜ì •/ì‚­ì œìš©)" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTNoteModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" id="qtSubmitBtn" onclick="createQTNote()">ì‘ì„± ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- QT Note Password Modal -->
    <div id="qtPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</div>
            <p id="passwordModalText">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:</p>
            <input type="password" id="qtActionPassword" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸" maxlength="10">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeQTPasswordModal()">ì·¨ì†Œ</button>
                <button class="modal-button primary" onclick="confirmQTAction()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="minigameModal" class="modal">
        <div class="modal-content" id="minigame-content">
            <!-- Minigame content will be injected here -->
        </div>
    </div>
    
    <script>
        // --- Global State Variables ---
        let userLevel, userExp, userStreak, completedMissions, userName, userAvatar, userJob, userBadges, completedStages;
        let guildLevel, guildExp;
        let currentStage = null;
        let chatMessages = [];
        let prayerTimes = {};
        let notices = [];
        let qtNotes = [];
        let editingQTNote = null;
        let pendingQTAction = null;
        let activeGame = { id: null, interval: null, stage: 0 };

        // --- Data Definitions ---

        const scriptures = [
            { text: "ë‚´ ì•ˆì— ë¨¸ë¬¼ëŸ¬ ìˆì–´ë¼. ê·¸ë¦¬í•˜ë©´ ë‚˜ë„ ë„ˆí¬ ì•ˆì— ë¨¸ë¬¼ëŸ¬ ìˆê² ë‹¤. ê°€ì§€ê°€ í¬ë„ë‚˜ë¬´ì— ë¶™ì–´ ìˆì§€ ì•„ë‹ˆí•˜ë©´ ìŠ¤ìŠ¤ë¡œ ì—´ë§¤ë¥¼ ë§ºì„ ìˆ˜ ì—†ëŠ” ê²ƒê³¼ ê°™ì´, ë„ˆí¬ë„ ë‚´ ì•ˆì— ë¨¸ë¬¼ëŸ¬ ìˆì§€ ì•„ë‹ˆí•˜ë©´ ì—´ë§¤ë¥¼ ë§ºì„ ìˆ˜ ì—†ë‹¤.", reference: "ìš”í•œë³µìŒ 15:4" },
            { text: "ë‚˜ëŠ” ì°¸ í¬ë„ë‚˜ë¬´ìš”, ë‚´ ì•„ë²„ì§€ëŠ” ë†ë¶€ì´ì‹œë‹¤.", reference: "ìš”í•œë³µìŒ 15:1" },
            { text: "ë„ˆí¬ê°€ ë‚˜ì˜ ë§ì— ë¨¸ë¬¼ëŸ¬ ìˆìœ¼ë©´, ë„ˆí¬ëŠ” ì°¸ìœ¼ë¡œ ë‚˜ì˜ ì œìë“¤ì´ë‹¤. ê·¸ë¦¬ê³  ë„ˆí¬ëŠ” ì§„ë¦¬ë¥¼ ì–»ê²Œ ë  ê²ƒì´ë©°, ì§„ë¦¬ê°€ ë„ˆí¬ë¥¼ ììœ ë¡­ê²Œ í•  ê²ƒì´ë‹¤.", reference: "ìš”í•œë³µìŒ 8:31-32" },
            { text: "ê·¸ëŸ¬ë¯€ë¡œ ë„ˆí¬ëŠ” ê°€ì„œ, ëª¨ë“  ë¯¼ì¡±ì„ ì œìë¡œ ì‚¼ì•„ì„œ, ì•„ë²„ì§€ì™€ ì•„ë“¤ê³¼ ì„±ë ¹ì˜ ì´ë¦„ìœ¼ë¡œ ì„¸ë¡€ë¥¼ ì£¼ê³ , ë‚´ê°€ ë„ˆí¬ì—ê²Œ ëª…ë ¹í•œ ëª¨ë“  ê²ƒì„ ê·¸ë“¤ì—ê²Œ ê°€ë¥´ì³ ì§€í‚¤ê²Œ í•˜ì—¬ë¼.", reference: "ë§ˆíƒœë³µìŒ 28:19-20" },
            { text: "ì‚¬ëŒì€ ë§ˆìŒìœ¼ë¡œ ë¯¿ì–´ì„œ ì˜ì— ì´ë¥´ê³ , ì…ìœ¼ë¡œ ê³ ë°±í•´ì„œ êµ¬ì›ì— ì´ë¥´ê²Œ ë©ë‹ˆë‹¤.", reference: "ë¡œë§ˆì„œ 10:10" }
        ];

        const stageContents = {
            1: {
                title: "1ê°•: íŒ¨ì¹˜ ì‹œìŠ¤í…œ - ê±°ë¶€í•  ìˆ˜ ì—†ëŠ” íŠ¹ê¶Œ",
                lessons: [
                    {
                        icon: "ğŸ›¡ï¸",
                        title: "ì˜ˆë°°í•˜ê¸° - í•˜ë‚˜ë‹˜ì„ ë§Œë‚˜ëŠ” ê³µì‹ ì±„ë„",
                        content: `<h4>ğŸ“Œ ì˜ˆë°°ëŠ” ì–‘ë°©í–¥ ì†Œí†µ</h4><p>ì˜ˆìˆ˜ë‹˜ì€ ìš°ë¦¬ì—ê²Œ ìƒˆë¡œìš´ ìƒëª…ì„ ì£¼ì‹¤ ë¿ë§Œ ì•„ë‹ˆë¼, "ë” ë„˜ì¹˜ê²Œ" ëˆ„ë¦¬ë©° ì‚´ê²Œ í•˜ê¸° ìœ„í•´ ìê¸° ëª©ìˆ¨ì„ ë²„ë¦¬ê² ë‹¤ê³  ë§ì”€í•˜ì…¨ìŠµë‹ˆë‹¤.</p><h4>ğŸ’¡ ì˜ˆë°°ì˜ ì˜ë¯¸</h4><ul><li>í•˜ë‚˜ë‹˜ì´ ìš°ë¦¬ ì¼ìƒì— ì–¼ë§ˆë‚˜ ê´€ì‹¬ì´ ë§ì€ì§€ ì•Œ ìˆ˜ ìˆëŠ” ì‹œê°„</li><li>ìš°ë¦¬ë¥¼ ì–¼ë§ˆë‚˜ ì†Œì¤‘íˆ ì—¬ê¸°ëŠ”ì§€ ê¹¨ë‹«ëŠ” ì‹œê°„</li><li>í•˜ë‚˜ë‹˜ì˜ ê³„íšì—ì„œ ìš°ë¦¬ê°€ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œ ì‚¬ëŒì¸ì§€ ë°œê²¬í•˜ëŠ” ì‹œê°„</li></ul>
                        
                        <h4>âš”ï¸ ê±°ì§“ ìœ„í˜‘ vs ì§„ì§œ ëª©ì†Œë¦¬ (ìš©íŠ¹ìƒˆ)</h4>
                        <p><strong>ê±°ì§“ ìœ„í˜‘:</strong> "ë„ˆëŠ” ì™œ ê·¸ê±°ë°–ì— ì•ˆ ë˜ëƒ?", "ë„ˆ ë”°ìœ„ëŠ” ì—¬ê¸°ì„œ ì‹¤íŒ¨í•˜ë©´ ë°”ë¡œ ëì´ì•¼"</p>
                        <p><strong>ì§„ì§œ ëª©ì†Œë¦¬ (ìš©íŠ¹ìƒˆ):</strong></p>
                        <ul>
                            <li>ê·¸ë¦¬ìŠ¤ë„ ì•ˆì—ì„œ ë‹¹ì‹ ì€ <strong>ìš©ë‚©</strong>ë˜ì—ˆìŠµë‹ˆë‹¤</li>
                            <li>ê·¸ë¦¬ìŠ¤ë„ ì•ˆì—ì„œ ë‹¹ì‹ ì€ <strong>íŠ¹ë³„í•œ</strong> ì¡´ì¬ì…ë‹ˆë‹¤</li>
                            <li>ê·¸ë¦¬ìŠ¤ë„ ì•ˆì—ì„œ ë‹¹ì‹ ì€ <strong>ìƒˆë¡œìš´</strong> ê³µë™ì²´ì— ì†í–ˆìŠµë‹ˆë‹¤</li>
                        </ul>
                        <p>ì˜ˆë°°ë¥¼ ë“œë¦¬ë©´ì„œ, ê¹¨ì§„ ì„¸ìƒì´ ì£¼ëŠ” ê±°ì§“ ìœ„í˜‘ê³¼ëŠ” ì „í˜€ ë‹¤ë¥¸, ë‹¹ì‹ ì„ í–¥í•œ ì§„ì§œ ëª©ì†Œë¦¬ì— ê·€ë¥¼ ê¸°ìš¸ì´ì„¸ìš”. ë‹¹ì‹ ì„ í–¥í•´ ë¶ˆì–´ì˜¤ëŠ” í‘¸ë¥¸ë°”ëŒì˜ ë©”ì‹œì§€ëŠ” ì–´ë–¤ ê³µê²©ì—ë„ ë„ë–¡ì—†ëŠ” ì²´ë ¥ì„ ì£¼ê³  ì‰´ë“œê°€ ë©ë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "âš¡",
                        title: "ì„±ê²½ì½ê¸° - í‘¸ë¥¸ë°”ëŒì˜ ëƒ‰ì¥ê³ ",
                        content: `<h4>ğŸ¯ ë‚˜ì˜ íŒ¨ì¹˜, ë‚˜ì˜ íŠ¹ê¶Œ</h4><p>ì„±ê²½ì€ í‘¸ë¥¸ë°”ëŒì˜ ë‚˜ë¼ ì—ë„ˆì§€ì›ì´ ê°€ë“í•œ ëƒ‰ì¥ê³ ì…ë‹ˆë‹¤. ì•„ë¬´ë¦¬ ëƒ‰ì¥ê³ ì— ë¨¹ì„ ê²ƒì´ ê°€ë“í•´ë„ êº¼ë‚´ ë¨¹ì§€ ì•Šìœ¼ë©´ ì•„ë¬´ ì†Œìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p><h4>ğŸ” ì„±ê²½ì„ êº¼ë‚´ ë¨¹ëŠ” ê¿€íŒ</h4><ul><li>í•˜ë‚˜ë‹˜ì€ ì–´ë–¤ ë¶„ì¼ê¹Œ? (í•˜ë‚˜ë‹˜ì˜ ì„±í’ˆê³¼ ë§ì”€ê³¼ í•˜ì‹  ì¼)</li><li>ì˜ˆìˆ˜ë‹˜ì€ ì–´ë–¤ ë¶„ì¼ê¹Œ? (ì˜ˆìˆ˜ë‹˜ì˜ ê°€ë¥´ì¹¨ê³¼ ì‚¶ê³¼ í–‰ë™)</li><li>ì„ ë°°ë“¤ì€ ì–´ë–»ê²Œ ì‚´ì•˜ì„ê¹Œ? (ê·¸ë“¤ì˜ ë¯¿ìŒê³¼ ê¸°ë„, ì‹¤ìˆ˜ì™€ íšŒë³µê³¼ êµí›ˆ)</li><li>ê·¸ëŸ¬ë©´ ë‚˜ëŠ” ì–´ë–»ê²Œ ì‚´ì•„ì•¼ í• ê¹Œ? (ë‚´ í˜„ì‹¤ì— ì ìš©í•  ìˆ˜ ìˆëŠ” ì„±ê²½ ì›ë¦¬)</li></ul>`
                    },
                    {
                        icon: "ğŸ”Œ",
                        title: "ê¸°ë„í•˜ê¸° - ì‹ ì—ê²Œ ë¹¨ëŒ€ ê½‚ê¸°",
                        content: `<h4>ğŸŒ³ í¬ë„ë‚˜ë¬´ì™€ ê°€ì§€ì˜ ê´€ê³„</h4><p>ì˜ˆìˆ˜ë‹˜ì€ ìš°ë¦¬ë¥¼ "ê°€ì§€"ë¼ê³  ë¶€ë¥´ì‹œë©°, ìì‹ ì—ê²Œ ë”± ë¶™ì–´ ìˆìœ¼ë¼ê³  í•˜ì‹­ë‹ˆë‹¤. ë‚˜ë­‡ê°€ì§€ì˜ ìµœê³  íŠ¹ê¶Œì€ ë†ë¶€(í•˜ë‚˜ë‹˜)ê°€ ë•€ í˜ë ¤ ì¼í•˜ê³  ë‚˜ë¬´(ì˜ˆìˆ˜ë‹˜)ê°€ ì—´ì‹¬íˆ ê³µê¸‰í•œ ì–‘ë¶„ì„ ê·¸ëƒ¥ ë°›ì•„ ëˆ„ë¦¬ëŠ” ê²ƒì…ë‹ˆë‹¤.</p><h4>ğŸ• 10-10-10 ê¸°ë„ë²•</h4><p>ì•„ì¹¨, ì ì‹¬, ì €ë… 10ë¶„ì”© ì˜ˆìˆ˜ë‹˜ê³¼ ëŒ€í™”í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”. ë¶€ë‹´ ì—†ì´, ê·¸ì € ë§ì„ ê±°ëŠ” ê²ƒë¶€í„° ì‹œì‘í•˜ë©´ ë©ë‹ˆë‹¤.</p>`
                    }
                ],
                discussionQuestions: [
                    "ì˜ˆë°°, ì„±ê²½ ì½ê¸°, ê¸°ë„ ì¤‘ì—ì„œ ìš”ì¦˜ ë‚˜ì—ê²Œ ê°€ì¥ ê°€ê¹ê²Œ ëŠê»´ì§€ëŠ” ê²ƒê³¼ ê°€ì¥ ë©€ê²Œ ëŠê»´ì§€ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”? ê·¸ ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?",
                    "ë‚˜ë¥¼ í–¥í•œ í•˜ë‚˜ë‹˜ì˜ 'ì§„ì§œ ëª©ì†Œë¦¬'(ìš©íŠ¹ìƒˆ: ìš©ë‚©, íŠ¹ë³„í•¨, ìƒˆë¡œìš´ ê³µë™ì²´)ë¥¼ ì˜ì‹¬í•˜ê²Œ ë§Œë“œëŠ” 'ê±°ì§“ ìœ„í˜‘'ì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆì—ˆë‚˜ìš”?",
                    "ì˜¤ëŠ˜ ë°°ìš´ '10-10-10 ê¸°ë„ë²•'ì„ ë‚´ì¼ë¶€í„° ë‹¹ì¥ ì‹¤ì²œí•´ë³¸ë‹¤ë©´, ì–´ë–¤ ì ì´ ê¸°ëŒ€ë˜ê³  ì–´ë–¤ ì ì´ ê±±ì •ë˜ë‚˜ìš”?"
                ]
            },
            2: {
                title: "2ê°•: ê¸¸ë“œ ì‹œìŠ¤í…œ - ìš°ë¦¬, ê°™ì´ í•´ë³¼ê¹Œìš”",
                lessons: [
                     {
                        icon: "ğŸ¯",
                        title: "ì„¸ë¡€ë°›ê¸° - ê¸¸ë“œ ê°€ì…í•˜ê¸°",
                        content: `<h4>ğŸ° ê¸¸ë“œ ê°€ì…ì˜ ì˜ë¯¸</h4><p>í•˜ë‚˜ë‹˜ ë‚˜ë¼ ì‚¬ëŒì´ ë˜ëŠ” ê²ƒê³¼ ê·¸ ë‚˜ë¼ ë°©ì‹ëŒ€ë¡œ ì‚¬ëŠ” ê²ƒ ì‚¬ì´ì— 'ì„¸ë¡€'ê°€ ìˆìŠµë‹ˆë‹¤. ê¸°ë…êµëŠ” ìì‹ ë§Œì˜ ì „ì¸ê²©ì  ê³ ë°±ì´ í•„ìš”í•œ ì¢…êµì´ë©°, ì ˆëŒ€ ë‚¨ì—ê²Œ ë¬»ì–´ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><h4>ğŸ’ ë¹„ë°€ ì—°ì• ì—ì„œ ê³µì‹ ë°œí‘œë¡œ</h4><p>ì„¸ë¡€ë¥¼ ì¢€ ë” ì„¤ë ˆëŠ” ë²„ì „ìœ¼ë¡œ ì„¤ëª…í•˜ë©´, ë¹„ë°€ ì—°ì• ë¥¼ í•˜ëŠ” ì—°ì¸ì´ ì‚¬ê·„ë‹¤ê³  ê³µì‹ì ìœ¼ë¡œ ë°íˆëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤. ì´ ì‚¬ëŒì´ë¼ê³  í™•ì‹ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "ğŸ‘¥",
                        title: "ê³µë™ì²´ ì†í•˜ê¸° - ë³‘ì•„ë¦¬ ê³µë™ì²´",
                        content: `<h4>ğŸ£ ë³‘ì•„ë¦¬ê°€ ì‚´ì•„ë‚¨ëŠ” ë²•</h4><p>í•™êµ ì•ì—ì„œ ì‚° ë³‘ì•„ë¦¬ê°€ ì‚´ì•„ë‚¨ëŠ” ë¹„ê²°ì€ 'ê³µë™ì²´'ì˜€ìŠµë‹ˆë‹¤. ê³µë™ì²´ë¥¼ í†µí•´ ë¬´ì—‡ì„ ë¨¹ê³ , ì–´ë–»ê²Œ ì‚´ì•„ì•¼ í•˜ëŠ”ì§€ ë°°ìš°ë©° ê±´ê°•í•´ì§‘ë‹ˆë‹¤.</p><h4>ğŸ® ê¸¸ë“œ ë²„í”„ ë°›ëŠ” ë°©ë²•</h4><p>ê³µë™ì²´ ì•ˆì—ì„œ ë§ì”€ì„ ë“£ê³  ë°°ìš°ëŠ” ë²„í”„, ë‹¤ë¥¸ ì‚¬ëŒì˜ ì‚¶ì„ ë³´ê³  ë°°ìš°ëŠ” ë²„í”„ë¥¼ í†µí•´ í•¨ê»˜ ì„±ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "ğŸ•Šï¸",
                        title: "ì„±ë ¹ ë”°ë¥´ê¸° - ìš°ë¦¬ í˜ë§Œìœ¼ë¡œëŠ” ì–´ë ¤ì›Œ",
                        content: `<h4>ğŸ¤ ëŠ˜ í•¨ê»˜í•˜ëŠ” ì°¸ ì¢‹ì€ ìŠ¤ìŠ¹</h4><p>ìš°ë¦¬ í˜ë§Œìœ¼ë¡œëŠ” ì–´ë µìŠµë‹ˆë‹¤. ì„±ë ¹ë‹˜ì€ ìš°ë¦¬ì™€ ì¸ê²©ì ì¸ ê´€ê³„ë¥¼ ì›í•˜ì‹œë©°, ìš°ë¦¬ê°€ ìë°œì ìœ¼ë¡œ í•˜ë‚˜ë‹˜ì˜ ëœ»ì„ ì„ íƒí•˜ë„ë¡ ë„ìš°ì‹œëŠ” ë¶„ì…ë‹ˆë‹¤.</p><h4>ğŸ“–â•ğŸ•Šï¸ ì„±ê²½ê³¼ ì„±ë ¹ì˜ ì½¤ë³´</h4><p>ì„±ê²½ê³¼ ì„±ë ¹ë‹˜ì€ ë”°ë¡œ ë–¼ì–´ë†“ê³  ìƒê°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„±ë ¹ë‹˜ì€ ì„±ê²½ ë§ì”€ì„ ê¹¨ë‹«ê³  ìˆœì¢…í•˜ë„ë¡ ë„ìš°ì‹­ë‹ˆë‹¤.</p>`
                    }
                ],
                discussionQuestions: [
                    "ë‚˜ì—ê²Œ ì‹ ì•™ ê³µë™ì²´(ê¸¸ë“œ)ëŠ” ì–´ë–¤ ì˜ë¯¸ì¸ê°€ìš”? ê³µë™ì²´ë¥¼ í†µí•´ 'ê¸¸ë“œ ë²„í”„'ë¥¼ ë°›ì•˜ë˜ ê²½í—˜ì´ ìˆë‹¤ë©´ ë‚˜ëˆ ì£¼ì„¸ìš”.",
                    "ì„¸ë¡€ë¥¼ 'ë¹„ë°€ ì—°ì• ì—ì„œ ê³µì‹ ë°œí‘œë¡œ' ë¹„ìœ í•œ ê²ƒì²˜ëŸ¼, ë‚˜ì˜ ì‹ ì•™ì„ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ê³µê°œì ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” ê²ƒì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ë‚˜ìš”?",
                    "ì„±ë ¹ë‹˜ì„ 'ëŠ˜ í•¨ê»˜í•˜ëŠ” ì°¸ ì¢‹ì€ ìŠ¤ìŠ¹'ìœ¼ë¡œ ì¸ê²©ì ìœ¼ë¡œ ì‹ ë¢°í•˜ê³  ë”°ë¥´ê¸° ìœ„í•´, êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë…¸ë ¥ì„ í•  ìˆ˜ ìˆì„ê¹Œìš”?"
                ]
            },
            3: {
                title: "3ê°•: ì‹¤ì „ ì‹œìŠ¤í…œ - ì¸ìƒì€ ì¥ë‚œì´ ì•„ë‹ˆë‹ˆê¹Œ",
                lessons: [
                    {
                        icon: "ğŸ“–â†’ğŸŒ",
                        title: "ì´ë¡ ì—ì„œ í˜„ì‹¤ë¡œ - ì„±ê²½ì€ ê·¸ë¦¼ì˜ ë–¡ì´ ì•„ë‹ˆë‹¤",
                        content: `<h4>ğŸ“š ë¬´ì±…ì„í•œ ë™í™”ì—ì„œ ì±…ì„ê° ì©ŒëŠ” í˜„ì‹¤ë¡œ</h4><p>ì‹ ì•™ì€ 'ì˜¤ë˜ì˜¤ë˜ í–‰ë³µí•˜ê²Œ ì‚´ì•˜ë‹µë‹ˆë‹¤'ì—ì„œ ëë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ í›„ì˜ ì‚¶ì„ í•˜ë‚˜ë‹˜ ë‚˜ë¼ ë°©ì‹ìœ¼ë¡œ ì‚´ì•„ë‚´ëŠ” ê²ƒì´ ì§„ì§œ ì´ì•¼ê¸°ì…ë‹ˆë‹¤.</p><h4>ğŸ¯ ëë‚  ë•Œê¹Œì§€ ëë‚œ ê²Œ ì•„ë‹ˆë‹¤</h4><p>ì¼ìƒì—ì„œ ì„±ê²½ ì›ë¦¬ë¥¼ ì ìš©í•˜ê³ , ì‹¤íŒ¨ë¥¼ ë‘ë ¤ì›Œí•˜ì§€ ë§ê³ , ê³„ì†í•´ì„œ í•˜ë‚˜ë‹˜ì„ ì•Œì•„ê°€ë©° ì‹ ë¢°ë¥¼ ìŒ“ì•„ê°€ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "â°",
                        title: "ë§¤ì¼ ê·¸ë¶„ê³¼ - ë£¨í‹´! ì¬ë°Œê³  ê¾¸ì¤€í•˜ê²Œ",
                        content: `<h4>ğŸ“… ì¼ëŒ€ì¼ ë§Œë‚¨ì´ë¼ë‹ˆ</h4><p>í•˜ë‚˜ë‹˜ê³¼ì˜ ê°œì¸ì ì¸ ë§Œë‚¨ ì‹œê°„, ì¦‰ íí‹°(QT, Quiet Time)ë¥¼ ê¾¸ì¤€íˆ ê°€ì§€ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ì¬ë°Œê³  ê¾¸ì¤€í•˜ê²Œ ìì‹ ë§Œì˜ ë£¨í‹´ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p><h4>ğŸ“– íí‹°, ì‹œì‘í•´ë³¼ê¹Œìš”</h4><p>ì„±ê²½ ì½ê¸° â†’ í•˜ë‚˜ë‹˜ ì•Œê¸° â†’ ë©”ì‹œì§€ ì°¾ê¸° â†’ ì ìš©í•˜ê¸° â†’ ê¸°ë„í•˜ê¸° ìˆœì„œë¡œ íí‹°ë¥¼ ì§„í–‰í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`
                    },
                    {
                        icon: "ğŸ¤—",
                        title: "ì¼ìƒì„ í•¨ê»˜ - ì–´, ì‚´ì•„ì„œ ì›€ì§ì´ë„¤",
                        content: `<h4>âœ¨ ì°¬ë€í–ˆë˜ ê·¸ ìˆœê°„ê³¼ ì–´ë‘ ì˜ ì‹œê°„</h4><p>ì¸ìƒì˜ ì¢‹ì€ ìˆœê°„ê³¼ í˜ë“  ìˆœê°„ ëª¨ë‘ í•˜ë‚˜ë‹˜ê³¼ í•¨ê»˜í•˜ë©° ì‹ ì•™ì˜ ê·¼ìœ¡ì„ í‚¤ì›Œë‚˜ê°€ì•¼ í•©ë‹ˆë‹¤.</p><h4>ğŸŒˆ ê±°ë£©í•œ ìƒìƒ</h4><p>í•˜ë‚˜ë‹˜ ë‚˜ë¼ì˜ ì™„ì„±ëœ ëª¨ìŠµì„ ì†Œë§í•˜ë©° ì˜¤ëŠ˜ì˜ ì–´ë ¤ì›€ì„ ê²¬ë””ê³ , ì´ ë•…ì—ì„œ í•˜ë‚˜ë‹˜ ë‚˜ë¼ë¥¼ ë§›ë³´ë©° ì‚´ì•„ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`
                    }
                ],
                discussionQuestions: [
                    "ì„±ê²½ ë§ì”€ì„ 'ê·¸ë¦¼ì˜ ë–¡'ì´ ì•„ë‹Œ, ë‚´ ì‚¶ì˜ 'ì±…ì„ê° ì©ŒëŠ” í˜„ì‹¤'ë¡œ ë§Œë“¤ê¸° ìœ„í•´ ì–´ë–¤ ë…¸ë ¥ì„ í•˜ê³  ìˆë‚˜ìš”? ë˜ëŠ” ì–´ë–¤ ì ì´ ê°€ì¥ ì–´ë µë‚˜ìš”?",
                    "ë§¤ì¼ í•˜ë‚˜ë‹˜ê³¼ ë§Œë‚˜ëŠ” 'íí‹°' ì‹œê°„ì„ ê¾¸ì¤€íˆ ê°–ê¸° ìœ„í•´ ë‚˜ì—ê²Œ ê°€ì¥ í•„ìš”í•œ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”? (ì˜ˆ: ì‹œê°„, ì¥ì†Œ, ì˜ì§€, ì¢‹ì€ êµì¬ ë“±)",
                    "ìµœê·¼ ë‚˜ì˜ ì‚¶ì—ì„œ ê²½í—˜í•œ 'ì°¬ë€í–ˆë˜ ìˆœê°„'ê³¼ 'ì–´ë‘ ì˜ ì‹œê°„'ì€ ê°ê° ë¬´ì—‡ì´ì—ˆë‚˜ìš”? ê·¸ ì‹œê°„ë“¤ì„ í†µí•´ í•˜ë‚˜ë‹˜ì— ëŒ€í•´ ë¬´ì—‡ì„ ë°°ìš°ê²Œ ë˜ì—ˆë‚˜ìš”?"
                ]
            }
        };

        // --- Job System ---
        function getUserJobTitle(level) {
            if (level >= 90) return 'ë§ˆìŠ¤í„°';
            if (level >= 60) return 'ì²­ëŒ€ì¥';
            if (level >= 30) return 'ì²­ê¸°ì‚¬';
            return 'í‘¸ë¥¸ì´';
        }

        // --- Core App Functions ---

        function showTab(tabName, navElement) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            navElement.classList.add('active');

            if (tabName === 'stages') backToStages();
            if (tabName === 'guild') updateQTNotes();
            if (tabName === 'home') updateNotices();
        }

        function enterStageContent(stageNumber) {
            currentStage = stageNumber;
            const stageData = stageContents[stageNumber];
            
            if (!stageData) {
                showNotification('ìŠ¤í…Œì´ì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            document.getElementById('stage-list').classList.add('hidden');
            document.getElementById('stage-detail').classList.remove('hidden');
            
            let contentHtml = stageData.lessons.map(lesson => `
                <div class="lesson-container">
                    <div class="lesson-header">
                        <div class="lesson-icon">${lesson.icon}</div>
                        <div class="lesson-title">${lesson.title}</div>
                    </div>
                    <div class="lesson-content">${lesson.content}</div>
                </div>
            `).join('');

            if (stageData.discussionQuestions) {
                contentHtml += `
                    <div class="discussion-container">
                        <h4>ğŸ¤” í•¨ê»˜ ë‚˜ëˆŒ ì§ˆë¬¸</h4>
                        <ol>
                            ${stageData.discussionQuestions.map(q => `<li>${q}</li>`).join('')}
                        </ol>
                    </div>
                `;
            }

            if (completedStages.includes(stageNumber)) {
                contentHtml += `<div class="stage-completed-notice">âœ”ï¸ ì´ ìŠ¤í…Œì´ì§€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</div>`;
            } else {
                contentHtml += `<button id="complete-stage-btn" class="modal-button primary" style="width:100%; margin-top:20px; background-color: #28a745;" onclick="completeStage(${stageNumber})">ìŠ¤í…Œì´ì§€ ì™„ë£Œ ë° ë³´ìƒ ë°›ê¸° ğŸ†</button>`;
            }
            
            const stageContentElement = document.getElementById('stage-content');
            stageContentElement.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #4facfe;">${stageData.title}</h3>
                ${contentHtml}
            `;
            
            document.querySelector('.content').scrollTop = 0;
        }

        function backToStages() {
            document.getElementById('stage-detail').classList.add('hidden');
            document.getElementById('stage-list').classList.remove('hidden');
            currentStage = null;
        }

        function completeStage(stageNumber) {
            if (completedStages.includes(stageNumber)) return;

            let badgeName = '';
            let levelGain = 0;
            let itemName = '';

            switch (stageNumber) {
                case 1:
                    badgeName = 'ìš©íŠ¹ìƒˆ';
                    itemName = 'ìš©íŠ¹ìƒˆ ë©”ì‹œì§€';
                    levelGain = 10;
                    break;
                case 2:
                    badgeName = 'ê¸¸ë“œ ë²„í”„';
                    itemName = 'ê¸¸ë“œ ë²„í”„';
                    levelGain = 15;
                    break;
                case 3:
                    badgeName = 'ì„±ë ¹ì˜ ì—´ë§¤';
                    itemName = 'ì„±ë ¹ì˜ ì—´ë§¤';
                    levelGain = 20;
                    break;
            }

            if (badgeName) {
                grantBadge(badgeName);
                addExperience(levelGain * 10, `ğŸ‰ ìŠ¤í…Œì´ì§€ ${stageNumber} ì™„ë£Œ! ${itemName} íšë“! ë ˆë²¨ +${levelGain}!`);
                completedStages.push(stageNumber);
                
                const button = document.getElementById('complete-stage-btn');
                if (button) {
                    button.remove();
                    enterStageContent(stageNumber);
                }

                updateUI();
                saveProgress();
            }
        }

        function completePrayerTime(timeSlot, element) {
            if (prayerTimes[timeSlot]) {
                showNotification('ì´ë¯¸ ì™„ë£Œí•œ ê¸°ë„ ì‹œê°„ì…ë‹ˆë‹¤!');
                return;
            }
            
            prayerTimes[timeSlot] = true;
            element.classList.add('completed');
            
            let message = '';
            let expGain = 30;
            
            switch(timeSlot) {
                case 'morning': message = 'ğŸŒ… ì•„ì¹¨ ê¸°ë„ ì™„ë£Œ! í•˜ë£¨ë¥¼ ì£¼ë‹˜ê³¼ í•¨ê»˜ ì‹œì‘í•˜ì„¸ìš”!'; break;
                case 'noon': message = 'â˜€ï¸ ì ì‹¬ ê¸°ë„ ì™„ë£Œ! í•˜ë£¨ ì¤‘ë°˜, ì£¼ë‹˜ê»˜ ê°ì‚¬ë“œë ¤ìš”!'; break;
                case 'evening': message = 'ğŸŒ™ ì €ë… ê¸°ë„ ì™„ë£Œ! í•˜ë£¨ë¥¼ ì£¼ë‹˜ê»˜ ë§¡ê²¨ë“œë ¤ìš”!'; break;
            }
            
            addExperience(expGain, message);
            grantBadge('ì²« ê¸°ë„');
            
            if (prayerTimes.morning && prayerTimes.noon && prayerTimes.evening) {
                setTimeout(() => {
                    addExperience(50, 'ğŸ‰ 10-10-10 ê¸°ë„ë²• ì™„ì£¼! ë³´ë„ˆìŠ¤ ê²½í—˜ì¹˜ +50!');
                }, 1000);
            }
            
            completedMissions++;
            updateUI();
            saveProgress();
        }

        function showScripture() {
            const container = document.getElementById('scripture-container');
            const randomScripture = scriptures[Math.floor(Math.random() * scriptures.length)];
            
            container.innerHTML = `
                <div class="scripture-card">
                    <div class="scripture-text">"${randomScripture.text}"</div>
                    <div class="scripture-reference">- ${randomScripture.reference} -</div>
                </div>
                <button class="mission-button" onclick="completeMission(this, 'ë§ì”€ ë¬µìƒ ì™„ë£Œ! ì˜ì–‘ë¶„ì„ ì–»ì—ˆìŠµë‹ˆë‹¤! ğŸ“–', 70, 'ì„±ê²½ ë…ì')" style="margin-top: 10px;">ë¬µìƒ ì™„ë£Œ</button>
            `;
            document.getElementById('mission-btn-scripture').style.display = 'none';
        }
        
        function completeMission(button, message, expGain = 50, badgeToGrant = null) {
            button.textContent = 'ì™„ë£Œ!';
            button.disabled = true;
            
            addExperience(expGain, message);
            if (badgeToGrant) grantBadge(badgeToGrant);
            
            completedMissions++;
            updateUI();
            saveProgress();
        }

        function addExperience(amount, notificationMessage) {
            userExp += amount;
            
            if (notificationMessage) {
                showNotification(notificationMessage);
            }

            while (userExp >= 100) {
                userLevel++;
                userExp -= 100;
                setTimeout(() => showNotification(`ğŸ‰ ë ˆë²¨ì—…! Lv.${userLevel} ë‹¬ì„±!`), 500);
            }
            updateUI();
        }

        // --- Notice Functions ---
        function showNoticeModal() {
            document.getElementById('noticeModal').style.display = 'flex';
            document.getElementById('noticePassword').focus();
        }

        function closeNoticeModal() {
            document.getElementById('noticeModal').style.display = 'none';
            document.getElementById('noticePassword').value = '';
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
        }

        function createNotice() {
            const password = document.getElementById('noticePassword').value;
            const title = document.getElementById('noticeTitle').value.trim();
            const content = document.getElementById('noticeContent').value.trim();

            if (password !== '0000') {
                showNotification('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤! âŒ');
                return;
            }

            if (!title || !content) {
                showNotification('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const notice = {
                id: Date.now(),
                title: title,
                content: content,
                date: new Date().toLocaleDateString('ko-KR')
            };

            notices.unshift(notice);
            updateNotices();
            closeNoticeModal();
            showNotification('ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¢');
            saveProgress();
        }

        function updateNotices() {
            const container = document.getElementById('notices-container');
            if (notices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            } else {
                container.innerHTML = notices.map(notice => `
                    <div class="notice-card">
                        <div class="notice-header">
                            <div class="notice-title">ğŸ“¢ ${notice.title}</div>
                            <div class="notice-date">${notice.date}</div>
                        </div>
                        <div class="notice-content">${notice.content}</div>
                    </div>
                `).join('');
            }
        }

        // --- QT Note Functions ---
        function showQTNoteModal() {
            editingQTNote = null;
            document.getElementById('qtModalTitle').textContent = 'QT ë…¸íŠ¸ ì‘ì„±';
            document.getElementById('qtSubmitBtn').textContent = 'ì‘ì„± ì™„ë£Œ';
            document.getElementById('qtSubmitBtn').onclick = createQTNote;
            document.getElementById('qtNoteTitle').value = '';
            document.getElementById('qtNoteContent').value = '';
            document.getElementById('qtNotePassword').value = '';
            document.getElementById('qtNoteModal').style.display = 'flex';
        }

        function closeQTNoteModal() {
            document.getElementById('qtNoteModal').style.display = 'none';
        }

        function createQTNote() {
            const title = document.getElementById('qtNoteTitle').value.trim();
            const content = document.getElementById('qtNoteContent').value.trim();
            const password = document.getElementById('qtNotePassword').value.trim();

            if (!title || !content || !password) {
                showNotification('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (editingQTNote) {
                // ìˆ˜ì • ëª¨ë“œ
                editingQTNote.title = title;
                editingQTNote.content = content;
                editingQTNote.password = password;
                editingQTNote.date = new Date().toLocaleDateString('ko-KR');
                showNotification('QT ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœï¸');
            } else {
                // ìƒˆ ì‘ì„± ëª¨ë“œ
                const qtNote = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    password: password,
                    author: userName,
                    date: new Date().toLocaleDateString('ko-KR'),
                    likes: 0,
                    likedBy: []
                };
                qtNotes.unshift(qtNote);
                showNotification('QT ë…¸íŠ¸ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“');
            }

            updateQTNotes();
            closeQTNoteModal();
            saveProgress();
        }

        function updateQTNotes() {
            const container = document.getElementById('qt-notes-container');
            if (qtNotes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <p>ì‘ì„±ëœ QT ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>ì²« ë²ˆì§¸ QT ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”! ğŸ“</p>
                    </div>
                `;
            } else {
                container.innerHTML = qtNotes.map(note => `
                    <div class="qt-note-card">
                        <div class="qt-note-header">
                            <div class="qt-note-title">${note.title}</div>
                            <div class="qt-note-date">${note.date}</div>
                        </div>
                        <div class="qt-note-content">${note.content}</div>
                        <div class="qt-note-actions">
                            <button class="like-button" onclick="toggleLike(${note.id})">
                                ${note.likedBy.includes(userName) ? 'â¤ï¸' : 'ğŸ¤'} ${note.likes}
                            </button>
                            ${note.author === userName ? `
                                <div class="note-buttons">
                                    <button class="note-btn edit" onclick="editQTNote(${note.id})">ìˆ˜ì •</button>
                                    <button class="note-btn delete" onclick="deleteQTNote(${note.id})">ì‚­ì œ</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleLike(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            if (note.likedBy.includes(userName)) {
                // ì¢‹ì•„ìš” ì·¨ì†Œ
                note.likedBy = note.likedBy.filter(name => name !== userName);
                note.likes--;
                showNotification('ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤ ğŸ’”');
            } else {
                // ì¢‹ì•„ìš” ì¶”ê°€
                note.likedBy.push(userName);
                note.likes++;
                showNotification('ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤! â¤ï¸');
            }

            updateQTNotes();
            saveProgress();
        }

        function editQTNote(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            pendingQTAction = { action: 'edit', noteId: noteId };
            document.getElementById('passwordModalText').textContent = 'QT ë…¸íŠ¸ë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function deleteQTNote(noteId) {
            const note = qtNotes.find(n => n.id === noteId);
            if (!note) return;

            pendingQTAction = { action: 'delete', noteId: noteId };
            document.getElementById('passwordModalText').textContent = 'QT ë…¸íŠ¸ë¥¼ ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:';
            document.getElementById('qtPasswordModal').style.display = 'flex';
            document.getElementById('qtActionPassword').focus();
        }

        function closeQTPasswordModal() {
            document.getElementById('qtPasswordModal').style.display = 'none';
            document.getElementById('qtActionPassword').value = '';
            pendingQTAction = null;
        }

        function confirmQTAction() {
            if (!pendingQTAction) return;

            const password = document.getElementById('qtActionPassword').value;
            const note = qtNotes.find(n => n.id === pendingQTAction.noteId);

            if (!note || note.password !== password) {
                showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤! âŒ');
                return;
            }

            if (pendingQTAction.action === 'edit') {
                editingQTNote = note;
                document.getElementById('qtModalTitle').textContent = 'QT ë…¸íŠ¸ ìˆ˜ì •';
                document.getElementById('qtSubmitBtn').textContent = 'ìˆ˜ì • ì™„ë£Œ';
                document.getElementById('qtSubmitBtn').onclick = createQTNote;
                document.getElementById('qtNoteTitle').value = note.title;
                document.getElementById('qtNoteContent').value = note.content;
                document.getElementById('qtNotePassword').value = note.password;
                document.getElementById('qtNoteModal').style.display = 'flex';
            } else if (pendingQTAction.action === 'delete') {
                qtNotes = qtNotes.filter(n => n.id !== pendingQTAction.noteId);
                updateQTNotes();
                showNotification('QT ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ—‘ï¸');
                saveProgress();
            }

            closeQTPasswordModal();
        }

        // --- Badge Functions ---
        function grantBadge(badgeName) {
            if (!userBadges.includes(badgeName)) {
                userBadges.push(badgeName);
                showNotification(`ğŸ† ë±ƒì§€ íšë“: ${badgeName}!`);
                updateUI();
                saveProgress();
            }
        }

        // --- Chat Functions ---
        function openChat() {
            const container = document.getElementById('chat-container');
            container.innerHTML = createChatInterface('chat');
            updateChatMessages('chat');
            document.getElementById('mission-btn-chat').style.display = 'none';
        }

        function showGuildChat() {
            const container = document.getElementById('guild-chat-container');
            container.innerHTML = createChatInterface('guild');
            updateChatMessages('guild');
        }
        
        function createChatInterface(prefix) {
            return `<div class="chat-container"><div class="chat-messages" id="${prefix}Messages"></div><div class="chat-input-container"><input type="text" class="chat-input" id="${prefix}Input" placeholder="ê¸¸ë“œì›ë“¤ê³¼ ëŒ€í™”í•´ë³´ì„¸ìš”..." onkeypress="handleChatKeyPress(event, '${prefix}')"><button class="chat-send-btn" onclick="sendMessage('${prefix}')">ì „ì†¡</button></div></div>`;
        }

        function updateChatMessages(prefix) {
            const messagesContainer = document.getElementById(`${prefix}Messages`);
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = chatMessages.length === 0 ? `<div style="text-align: center; color: #666; padding: 20px;"><p>ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”! ğŸ’¬</p></div>` : chatMessages.map(msg => `<div class="message ${msg.sender === userName ? 'user' : 'other'}"><div class="message-header"><div class="message-avatar">${msg.avatar || 'ğŸ‘¤'}</div><div class="message-sender">${msg.sender}</div><div class="message-time">${msg.time}</div></div><div class="message-bubble">${msg.message}</div></div>`).join('');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage(prefix) {
            const input = document.getElementById(`${prefix}Input`);
            const message = input.value.trim();
            if (message) {
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                chatMessages.push({ sender: userName, avatar: userAvatar, message: message, time: timeString });
                input.value = '';
                
                if (document.getElementById('chatMessages')) updateChatMessages('chat');
                if (document.getElementById('guildChatMessages')) updateChatMessages('guild');
                
                saveProgress();
            }
        }

        function handleChatKeyPress(event, prefix) {
            if (event.key === 'Enter') sendMessage(prefix);
        }

        // --- Modal Functions ---
        function showNameModal() {
            const modal = document.getElementById('nameModal');
            document.getElementById('nameInput').value = userName;
            modal.style.display = 'flex';
            document.getElementById('nameInput').focus();
        }
        function closeNameModal() { document.getElementById('nameModal').style.display = 'none'; }
        function changeName() {
            const newName = document.getElementById('nameInput').value.trim();
            if (newName && newName.length > 0 && newName.length <= 10) {
                userName = newName;
                updateUI();
                closeNameModal();
                showNotification('ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                saveProgress();
            } else {
                showNotification('ë‹‰ë„¤ì„ì€ 1~10ì ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            }
        }

        function showAvatarModal() { document.getElementById('avatarModal').style.display = 'flex'; }
        function closeAvatarModal() { document.getElementById('avatarModal').style.display = 'none'; }
        function selectAvatar(emoji) {
            userAvatar = emoji;
            updateUI();
            closeAvatarModal();
            showNotification('í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
            saveProgress();
        }

        function showResetModal() { document.getElementById('resetModal').style.display = 'flex'; }
        function closeResetModal() { document.getElementById('resetModal').style.display = 'none'; }
        function confirmReset() {
            if (document.getElementById('adminPassword').value === '0000') {
                localStorage.removeItem('blueWindProgress');
                setInitialState();
                updateUI();
                resetMissionUI();
                closeResetModal();
                showNotification('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ”„');
            } else {
                showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤! âŒ');
            }
        }

        // --- Minigame Functions ---
        function launchMinigame(stageNumber) {
            const modal = document.getElementById('minigameModal');
            const content = document.getElementById('minigame-content');
            activeGame.stage = stageNumber;

            let gameHtml = '';
            switch(stageNumber) {
                case 1:
                    gameHtml = `
                        <div class="modal-title">ë¯¸ë‹ˆê²Œì„: ë§ì”€ì˜ ë¹„</div>
                        <p style="margin-bottom: 15px;">ë°”êµ¬ë‹ˆë¥¼ ì›€ì§ì—¬ 'ì‚¬ë‘', 'ë¯¿ìŒ', 'ì†Œë§' ë‹¨ì–´ë¥¼ ë°›ê³ , 'ë¯¸ì›€', 'ì˜ì‹¬' ë‹¨ì–´ëŠ” í”¼í•˜ì„¸ìš”!</p>
                        <canvas id="minigame-canvas" width="320" height="240"></canvas>
                        <div class="modal-buttons" style="margin-top:15px;">
                           <button class="modal-button secondary" onclick="closeMinigame(false)">ê·¸ë§Œí•˜ê¸°</button>
                        </div>
                    `;
                    content.innerHTML = gameHtml;
                    modal.style.display = 'flex';
                    initGame1();
                    break;
                case 2:
                    gameHtml = `
                        <div class="modal-title">ë¯¸ë‹ˆê²Œì„: ê³µë™ì²´ ì‡ê¸°</div>
                        <p style="margin-bottom: 15px;">ê°™ì€ ì•„ì´ì½˜ë¼ë¦¬ ì„ ìœ¼ë¡œ ì—°ê²°í•´ì„œ ê³µë™ì²´ë¥¼ ì™„ì„±í•˜ì„¸ìš”!</p>
                        <canvas id="minigame-canvas" width="320" height="240"></canvas>
                        <div class="modal-buttons" style="margin-top:15px;">
                           <button class="modal-button secondary" onclick="closeMinigame(false)">ê·¸ë§Œí•˜ê¸°</button>
                        </div>
                    `;
                    content.innerHTML = gameHtml;
                    modal.style.display = 'flex';
                    initGame2();
                    break;
                case 3:
                     gameHtml = `
                        <div class="modal-title">ë¯¸ë‹ˆê²Œì„: ì‚¶ì˜ ê°ˆë¦¼ê¸¸</div>
                        <p id="quiz-question" style="margin-bottom: 15px;">ê¸¸ì—ì„œ ë„ì›€ì´ í•„ìš”í•œ ì‚¬ëŒì„ ë§Œë‚¬ìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <div id="quiz-options">
                           <button class="quiz-option" onclick="handleQuizAnswer(true)">ë”°ëœ»í•œ ìŒë£Œì™€ í•¨ê»˜ ìœ„ë¡œì˜ ë§ì„ ê±´ë„¨ë‹¤.</button>
                           <button class="quiz-option" onclick="handleQuizAnswer(false)">ë°”ìœ ì¼ì´ ìˆì–´ ê·¸ëƒ¥ ì§€ë‚˜ê°„ë‹¤.</button>
                        </div>
                         <div class="modal-buttons" style="margin-top:15px;">
                           <button class="modal-button secondary" onclick="closeMinigame(false)">ê·¸ë§Œí•˜ê¸°</button>
                        </div>
                    `;
                    content.innerHTML = gameHtml;
                    modal.style.display = 'flex';
                    break;
            }
        }
        
        function closeMinigame(isSuccess) {
            if (activeGame.interval) {
                clearInterval(activeGame.interval);
                activeGame.interval = null;
            }
            document.getElementById('minigameModal').style.display = 'none';
            if (isSuccess) {
                showNotification('ë¯¸ë‹ˆê²Œì„ ì„±ê³µ! ë³´ë„ˆìŠ¤ ê²½í—˜ì¹˜ +50 EXP ğŸ‰');
                addExperience(50);
                saveProgress();
            }
            enterStageContent(activeGame.stage);
        }

        function initGame1() { // ë§ì”€ì˜ ë¹„
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            let score = 0;
            let basket = { x: canvas.width / 2 - 25, y: canvas.height - 30, width: 50, height: 10 };
            let words = [];

            function moveBasket(e) {
                const rect = canvas.getBoundingClientRect();
                basket.x = e.clientX - rect.left - basket.width / 2;
                if (basket.x < 0) basket.x = 0;
                if (basket.x > canvas.width - basket.width) basket.x = canvas.width - basket.width;
            }
            canvas.addEventListener('mousemove', moveBasket);

            function gameLoop() {
                // Add new word
                if (Math.random() < 0.05) {
                    const isGood = Math.random() > 0.4;
                    words.push({
                        text: isGood ? ['ì‚¬ë‘', 'ë¯¿ìŒ', 'ì†Œë§'][Math.floor(Math.random()*3)] : ['ë¯¸ì›€', 'ì˜ì‹¬'][Math.floor(Math.random()*2)],
                        x: Math.random() * (canvas.width - 30),
                        y: 0,
                        speed: Math.random() * 1 + 1,
                        isGood: isGood
                    });
                }

                // Update and draw
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw basket
                ctx.fillStyle = '#4a148c';
                ctx.fillRect(basket.x, basket.y, basket.width, basket.height);

                // Draw words
                for (let i = words.length - 1; i >= 0; i--) {
                    let word = words[i];
                    word.y += word.speed;
                    
                    ctx.font = '16px Pretendard';
                    ctx.fillStyle = word.isGood ? '#007bff' : '#dc3545';
                    ctx.fillText(word.text, word.x, word.y);

                    // Collision detection
                    if (word.y > basket.y && word.x > basket.x && word.x < basket.x + basket.width) {
                        score += word.isGood ? 10 : -10;
                        words.splice(i, 1);
                    } else if (word.y > canvas.height) {
                        words.splice(i, 1);
                    }
                }
                
                // Draw score
                ctx.fillStyle = '#000';
                ctx.fillText(`ì ìˆ˜: ${score}`, 10, 20);

                if (score >= 50) {
                    canvas.removeEventListener('mousemove', moveBasket);
                    closeMinigame(true);
                }
                 if (score < -20) {
                    canvas.removeEventListener('mousemove', moveBasket);
                    closeMinigame(false);
                }
            }
            activeGame.interval = setInterval(gameLoop, 1000 / 60);
        }

        function initGame2() { // ê³µë™ì²´ ì‡ê¸°
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            const icons = ['ğŸ˜Š', 'ğŸ™', 'ğŸ•Šï¸', 'â¤ï¸'];
            let points = [];
            let selectedPoint = null;
            let lines = [];
            let pairs = icons.length;

            // Create pairs of points
            icons.forEach(icon => {
                for(let i=0; i<2; i++) {
                    points.push({
                        x: Math.random() * (canvas.width - 40) + 20,
                        y: Math.random() * (canvas.height - 40) + 20,
                        icon: icon,
                        id: Math.random(),
                        connected: false
                    });
                }
            });

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '24px Pretendard';
                // Draw lines
                lines.forEach(line => {
                    ctx.beginPath();
                    ctx.moveTo(line.p1.x, line.p1.y);
                    ctx.lineTo(line.p2.x, line.p2.y);
                    ctx.strokeStyle = '#28a745';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                });
                // Draw points
                points.forEach(p => {
                    ctx.fillStyle = p.connected ? '#9e9e9e' : (p === selectedPoint ? '#ffd700' : '#4facfe');
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(p.icon, p.x, p.y);
                });
            }

            function handleClick(e) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                for (let p of points) {
                    const dist = Math.sqrt((p.x - mouseX)**2 + (p.y - mouseY)**2);
                    if (dist < 15 && !p.connected) {
                        if (!selectedPoint) {
                            selectedPoint = p;
                        } else {
                            if (selectedPoint.icon === p.icon && selectedPoint.id !== p.id) {
                                // Match found
                                selectedPoint.connected = true;
                                p.connected = true;
                                lines.push({p1: selectedPoint, p2: p});
                                selectedPoint = null;
                                pairs--;
                                if (pairs === 0) {
                                    draw();
                                    canvas.removeEventListener('click', handleClick);
                                    setTimeout(() => closeMinigame(true), 500);
                                }
                            } else {
                                // No match
                                selectedPoint = null;
                            }
                        }
                        draw();
                        return;
                    }
                }
            }
            
            canvas.addEventListener('click', handleClick);
            draw();
        }

        function handleQuizAnswer(isCorrect) {
            if (isCorrect) {
                closeMinigame(true);
            } else {
                document.getElementById('quiz-question').textContent = "ì•„ì‰½ë„¤ìš”. í•˜ë‚˜ë‹˜ ë‚˜ë¼ì˜ ë°©ì‹ì€ ì´ì›ƒì„ ì‚¬ë‘í•˜ëŠ” ê²ƒì´ëë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!";
                document.getElementById('quiz-options').innerHTML = `<button class="quiz-option" onclick="closeMinigame(false)">í•™ìŠµìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>`;
            }
        }

        // --- UI and Utility Functions ---
        function updateUI() {
            // Update job title based on level
            userJob = getUserJobTitle(userLevel);
            
            // Header
            document.getElementById('userName').textContent = userName;
            document.getElementById('headerAvatar').textContent = userAvatar;
            document.getElementById('userLevel').textContent = userLevel;
            document.getElementById('userExp').textContent = userExp;
            document.getElementById('userStreak').textContent = userStreak;
            
            // Profile Tab
            document.getElementById('profileUserName').textContent = userName;
            document.getElementById('profileAvatar').textContent = userAvatar;
            document.getElementById('profileLevel').textContent = userLevel;
            document.getElementById('profileJob').textContent = userJob;
            document.getElementById('profileStreak').textContent = userStreak;
            document.getElementById('completedMissionsCount').textContent = completedMissions;
            
            // Guild Tab
            document.getElementById('guildUserName').textContent = userName;
            document.getElementById('guildUserAvatar').textContent = userAvatar;
            document.getElementById('guildUserLevel').textContent = userLevel;
            document.getElementById('guildUserJob').textContent = userJob;
            document.getElementById('guildUserStreak').textContent = userStreak;
            document.getElementById('guildLevel').textContent = guildLevel;
            document.getElementById('guildExp').textContent = guildExp;
            
            // Badges
            const badgeContainer = document.getElementById('badge-container');
            if(userBadges.length > 0) {
                badgeContainer.innerHTML = userBadges.map(b => `<span>${b}</span>`).join('');
            } else {
                badgeContainer.innerHTML = `<p style="color: #999; font-size: 14px;">ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        }
        
        function resetMissionUI() {
            // Reset prayer slots
            document.querySelectorAll('.prayer-time-slot').forEach(slot => slot.classList.remove('completed'));
            // Reset mission buttons
            document.querySelectorAll('.mission-button').forEach(btn => {
                btn.disabled = false;
                if(btn.id === 'mission-btn-worship') btn.textContent = 'ì°¸ì—¬ ì™„ë£Œ';
            });
            document.getElementById('mission-btn-scripture').style.display = 'inline-block';
            document.getElementById('scripture-container').innerHTML = '';
            document.getElementById('mission-btn-chat').style.display = 'inline-block';
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('guild-chat-container').innerHTML = '';
        }

        function showNotification(message) {
            const existingNotif = document.querySelector('.floating-notification');
            if(existingNotif) existingNotif.remove();
            const notification = document.createElement('div');
            notification.className = 'floating-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // --- Data Persistence ---
        function saveProgress() {
            const data = {
                userName, userAvatar, userJob, userLevel, userExp, userStreak,
                completedMissions, userBadges, completedStages, guildLevel, guildExp, 
                chatMessages, prayerTimes, notices, qtNotes,
                lastLogin: new Date().toDateString()
            };
            localStorage.setItem('blueWindProgress', JSON.stringify(data));
        }

        function loadProgress() {
            const saved = localStorage.getItem('blueWindProgress');
            if (saved) {
                const data = JSON.parse(saved);
                userName = data.userName || 'í‘¸ë¥¸ì´';
                userAvatar = data.userAvatar || 'ğŸŒŸ';
                userLevel = data.userLevel || 1;
                userExp = data.userExp || 0;
                userStreak = data.userStreak || 1;
                completedMissions = data.completedMissions || 0;
                userJob = data.userJob || getUserJobTitle(userLevel);
                userBadges = data.userBadges || [];
                completedStages = data.completedStages || [];
                guildLevel = data.guildLevel || 1;
                guildExp = data.guildExp || 0;
                chatMessages = data.chatMessages || [];
                notices = data.notices || [];
                qtNotes = data.qtNotes || [];
                
                const today = new Date().toDateString();
                const lastLogin = data.lastLogin || today;

                if (lastLogin !== today) {
                    const lastDate = new Date(lastLogin);
                    const todayDate = new Date(today);
                    const diffTime = todayDate - lastDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        userStreak++;
                        grantBadge(`${userStreak}ì¼ ì—°ì†`);
                    } else if (diffDays > 1) {
                        userStreak = 1;
                    }
                    prayerTimes = { morning: false, noon: false, evening: false };
                } else {
                    prayerTimes = data.prayerTimes || { morning: false, noon: false, evening: false };
                }

                Object.keys(prayerTimes).forEach(timeSlot => {
                    if (prayerTimes[timeSlot]) {
                        const slots = document.querySelectorAll('.prayer-time-slot');
                        if (timeSlot === 'morning' && slots[0]) slots[0].classList.add('completed');
                        if (timeSlot === 'noon' && slots[1]) slots[1].classList.add('completed');
                        if (timeSlot === 'evening' && slots[2]) slots[2].classList.add('completed');
                    }
                });
            } else {
                setInitialState();
            }
            updateUI();
            updateNotices();
            updateQTNotes();
        }
        
        function setInitialState() {
            userLevel = 1;
            userExp = 0;
            userStreak = 1;
            completedMissions = 0;
            userName = 'í‘¸ë¥¸ì´';
            userAvatar = 'ğŸŒŸ';
            userJob = 'í‘¸ë¥¸ì´';
            userBadges = [];
            completedStages = [];
            guildLevel = 1;
            guildExp = 0;
            chatMessages = [];
            prayerTimes = { morning: false, noon: false, evening: false };
            notices = [];
            qtNotes = [];
            saveProgress();
        }

        // --- App Initialization ---
        function initApp() {
            loadProgress();
            
            setTimeout(() => {
                showNotification(`${userName}ë‹˜, í‘¸ë¥¸ë‚˜ë¼í•™êµì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸŒŸ`);
            }, 1000);

            // Modal close events
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        if (modal.id === 'minigameModal') return; // Don't close minigame on background click
                        modal.style.display = 'none';
                    }
                });
            });

            // Keyboard events
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (activeGame.interval) return; // Don't allow escape during canvas games
                    document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                }
                if (e.key === 'Enter') {
                    const nameModal = document.getElementById('nameModal');
                    const resetModal = document.getElementById('resetModal');
                    const noticeModal = document.getElementById('noticeModal');
                    const qtNoteModal = document.getElementById('qtNoteModal');
                    const qtPasswordModal = document.getElementById('qtPasswordModal');
                    
                    if (nameModal.style.display === 'flex') {
                        e.preventDefault();
                        changeName();
                    } else if (resetModal.style.display === 'flex') {
                        e.preventDefault();
                        confirmReset();
                    } else if (noticeModal.style.display === 'flex') {
                        e.preventDefault();
                        createNotice();
                    } else if (qtNoteModal.style.display === 'flex') {
                        e.preventDefault();
                        createQTNote();
                    } else if (qtPasswordModal.style.display === 'flex') {
                        e.preventDefault();
                        confirmQTAction();
                    }
                }
            });
        }

        window.addEventListener('load', initApp);
        window.addEventListener('beforeunload', saveProgress);

    </script>
</body>
</html>
